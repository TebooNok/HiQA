section
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 [desc]
本书以单级放大器、运算放大器以及数模转换器数为重点，介绍模拟集成电路的基本概念、工作原理和分析方法，特别是全面系统地介绍了模拟集成电路的仿真技术，是模拟集成电路分析、设计和仿真的入门书。全书共分 10 章和 7 个附录。第 1 章介绍模拟集成电路的发展与设计方法。第 2、3 章介绍单级放大器、电流镜和差分放大器等基本模拟电路的原理。第 4 章是电路噪声分析计算与仿真。第 5 章介绍运算放大器的工作原理与分析、仿真方法。第 6、7 章以双端输入单端输出运算放大器以及全差分运算放大器为例，介绍运算放大器的设计仿真方法；第 8、9 章以带隙电压基准和电流基准电路为例，介绍了参考电压源和电流源的设计方法，其中对温度补偿技术作了详细分析；第 10 章为模拟与数字转换电路（ADC），重点介绍了 ADC 的概念与工作原理以及采用 Verilog-A 语言进行系统设计的方法。本书的附录全面介绍了模拟集成电路设计的软件环境以及仿真技术。本书可作为高等院校集成电路设计相关专业工程硕士的教材，也可以作为本科生和研究生的教材，并可供模拟集成电路工程师参考。
感谢信
感谢所有在制定和评议本书过程中给予帮助和支持的同学和老师们。他们在工作中一直在帮助我，同时也帮助我校对了我的书。特别感谢陆燕锋、胡博宇、宁志华、邱建平、邵亚利等同学都仔细阅读了相关章节，并且帮我纠正错误，完成排版。杭州晶华微电子有限公司的罗伟绍博士也审校了本书稿，并给我提出了很多宝贵的意见。对他们表示衷心的感谢。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 半导体技术与模拟集成电路 [desc]
半导体技术的发展，决定了集成电路的进步。此外，集成电路的发展，也推动了半导体技术的升级，包括集成电路的工艺技术、设计技术以及电路设计自动化（EDA）技术。目前的模拟集成电路设计，尤其是系统芯片的设计越来越依赖电路设计自动化技术，这就使得数字和模拟电路的设计流程有了很大的差别，形成了两个具有互补性的设计工程师群体。而数字和模拟电路的集成设计，则更需要两者的协调和合作。因此，对电路系统、芯片应用环境的分析能力，以及逻辑分析的能力，对于模拟集成电路设计师来说，是必不可少的[5]。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路的分类及制造工艺 __ 模拟集成电路的分类 [desc]
模拟电路的应用非常广泛，也有重要的历史地位。随着半导体技术的发展，模拟电路也逐渐集成在芯片中。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路的分类及制造工艺 __ 模拟集成电路的制造工艺 [desc]
定义了以上一些常见的模拟电路的种类后，下面罗列了几种特定的模拟集成电路的介绍。
- 温度开关、数字与模拟温度传感控制电路、硬件温度监控电路
- 其他专用模拟集成电路，如汽车专用模拟集成电路、无线专用模拟集成电路、通信专用模拟集成电路、时钟发生电路等。
最后，以下是一种典型的低压差线性稳压器（LDO）的结构图[10]的描述。LDO 常常用于电池供电的便携式电子产品中。由于这些设备在使用过程中需要的电力会随电池电压的下降和设备功能的使用变化而变化，因此需要调整输入电压（电池电压），从而实现稳定的输出电压，即电子设备的供电电压。LDO 的输入部分是一个电流与电压基准电路，其输出部分是一个误差放大器，此放大器将输出反馈电压与参考电压进行比较，并放大其差值，从而控制调整管的导通状态，达到稳定输出电压的目的。# 1.1. 集成电路设计的主流技术
集成电路代工企业（Foundry）的崛起,集成电路设计业已经成为一个增长十分迅速的独立的新兴产业。这里需要指出的是集成电路设计业的成长与集成电路设计自动化产业技术的发展密不可分。 
在对电路进行分类时常常会提到“数字电路”和“模拟电路”。在集成电路设计领域，数字集成电路和模拟集成电路意味着在集成在一个电子系统的这两种电路以不同的使命，两者具有协调、互补的关系。另外，由于设计数字集成电路和模拟集成电路的流程、方法以及对设计者知识面的要求各不相同，因此，事实上已经形成了“数字集成电路设计工程师”和“模拟集成电路设计工程师”两个不同的群体。一个包含有数字电路和模拟电路的SOC 芯片是数字工程师和模拟工程师通力合作的结果。这种数模混合的 SOC 芯片设计技术的发展是与近年来的系统设计和数模混合电路设计电子设计自动化（EDA）工具的进步，特别是各种可重用和重构的集成电路智权芯核（Intellectual Property，IP）的开发与积累分不开的。当然，数字和模拟集成电路本身也是集成电路的产品。
本章主要讲述与模拟集成电路有关的内容，不涉及数字集成电路。需要注意的是模拟电路设计是与数字电路设计同步发展起来的，与集成电路的制造工艺和 EDA 工具的变迁密不可分。本书中不仅分析模拟集成电路的基本理论知识，而且结合目前国际上主流的模拟集成电路设计 EDA 工具，给出了具体设计电路的方法，以达到读者通过练习能够快速掌握实际的模拟集成电路设计技术。
这里需要强调的是对从事开发与设计模拟集成电路技术的工作人员来讲，除了模拟集成电路设计外，还应该具备对电路系统，芯片应用环境的分析能力，以及逻辑分析的能力[5]。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路的分类及制造工艺 __ 模拟集成电路的分类 [desc]
模拟电路的历史悠久，而且其设计对象的范围也很宽。模拟集成电路是随着半导体集成的发展而来的。
- 温度开关、数字与模拟温度传感控制电路、硬件温度监控电路
- 其他专用模拟集成电路,如汽车专用模拟集成电路、无线专用模拟集成电路、通信专用模拟集成电路、时钟发生电路等。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路的分类及制造工艺 __ 模拟集成电路的制造工艺技术 [desc]
目前，模拟集成电路的制造工艺主要有双极型工艺、CMOS 工艺、BiCMOS、砷化镓和锗硅工艺。其中砷化镓和锗硅工艺技术用于制造射频集成电路，BiCMOS 技术是双极型工艺和 CMOS 工艺的集合，既能够制造双极型器件，又可以制造 NMOS 和 PMOS 晶体管，具有两种工艺的优点。另外，还有抗干扰性能强的 SOS（Silicon on Silicon）工艺技术等。大多数的数字集成电路都是用 CMOS 工艺生产的，考虑到系统芯片同时具有数字和模拟电路功能，以及工艺的成本问题，可以预计今后的模拟集成电路的制造工艺也将以CMOS工艺为主。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路设计流程 [desc]
设计者的设计水平与能力与半导体集成电路工艺的不断发展之间存在距离，设计者能力不足的问题会在今后很长时间内存在。但是随着集成电路设计工具的进步带来的集成电路 IP 的复用技术以及模拟、数字以及混合信号电路设计验证技术的提高，使得集成电路设计能力与半导体工艺技术之间的距离逐渐减小。
由于模拟 CMOS 集成电路的处理的信号和电路工作原理与数字集成电路不同，因此两者的设计流程是不同的。在数字电路中，为了提高集成度和降低电路的功耗，要求微细化和低电压驱动。但是模拟集成电路的技术是建立在运算放大器、电流镜电路等基本电路模块的基础上。这类电路的基本特点是相邻器件的特性一致性，即器件的精度和配对性要好。而器件的小型化和低电源电压与器件的精度和配对特性正好相反。
模拟集成电路的设计工作由系统设计、电路设计、版图设计和测试程序设计等多个部分组成的。如今手工设计超深亚微米模拟集成电路已经不可能，必须采用先进的 EDA 软件工具，在计算机上进行设计。基于模拟集成电路与数字集成电路完成的功能，以及设计参数的不同，因此在设计流程上是不同的，模拟集成电路一般采用模块化设计，即按系统定义和要求，设计基本的单元电路，例如运算放大器、比较器和基准电流电压源等，并进行复用。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路设计流程 __ 系统定义与设计 [desc]
在 CMOS 数字电路中，PMOS 管和 NMOS 管是配对使用，在信号处理过程中通过一方导通，另一方截止的方法来降低功耗，因此人们将这种关系称为互补关系。但是在模拟集成电路中，为了保证信号的不失真，所有的 MOS 管必须处于导通状态，并不存在互补关系。
模拟集成电路的设计工作由系统设计、电路设计、版图设计和测试程序设计等多个部分组成的。如今手工设计超深亚微米模拟集成电路已经不可能，必须采用先进的 EDA 软件工具，在计算机上进行设计。基于模拟集成电路与数字集成电路完成的功能，以及设计参数的不同，因此在设计流程上是不同的，模拟集成电路一般采用模块化设计，即按系统定义和要求，设计基本的单元电路，例如运算放大器、比较器和基准电流电压源等，并进行复用。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路设计流程 __ 电路定义与设计 [desc]
由于模拟电路的性能差异较大，因此关键的单元需要重新设计。模拟集成电路设计的基本流程如图 1- 4 所示[5]。
按照电子产品的要求，研究拟开发的模拟集成电路的必要的功能和性能，以及实现的方法。这一阶段，可以用印刷电路板和电子元器件进行实验，以验证电路系统功能。现在更多采用的是用 Matlab/Simulink，Cadence 公司的 Artist 或 IUS 系统仿真工具进行设计。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路设计流程 __ 电路定义与设计 [desc]
按系统要求对电路进行定义设计电路。制定输入具体的晶体管级电路图，对电路进行仿真，检测是否达到要求。检测内容除了基本功能外，需要对输入/输出动态范围、频率特性、相位裕量、电流/电压增益、温度特性和误差特性等进行分析。如果不符合要求，
则对需要电路进行改进，并重新验证。如果电路规模较大，则需要将电路按功能分成几块，
分别进行设计验证，最后组合到一起。电路仿真工具比较多，最著名的有 HSPICE 和 Cadence
公司的 Spectre 仿真器等。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 内容简介 __ 模拟集成电路设计流程 __ 掩模板制备、流片、封装与测试 [desc]
提到模拟集成电路的仿真器，一般都要讲到 SPICE (Simulation Program with Integrated Emphasis)。20 世纪 70 年代美国加州大学伯克利分校对电路分析程序 CANCER 进行了改进，开发出模拟集成电路设计仿真工具 SPICE。随后对 SPICE 改进，开发出 SPICE2E 和
SPICE2G，并公开了源代码。问世数十年的 SPICE 随着计算机性能的不断提高，也提高和改善了自身的用户接口和分析功能，如今进行模拟集成电路设计已经离不开 SPICE 了。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 [desc]
CMOS 运算放大器是 CMOS 模拟集成电路的最重要的模块，它的特性决定了模拟集成电路的特性[1-3]。复杂的 CMOS 运算放大器的基础是简单的单级放大器。本章将介绍常用的单级共源放大器、共栅放大器、源跟随器、共源共栅放大器。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __ 放大器概念 __ 一般概念 [desc]
按放大器的输入输出信号的类型，可将放大器归类为以下四类放大器[4]： 
电压放大器：输入与输出信号均为电压信号；
电流放大器：输入与输出信号均为电流信号；
跨导放大器（Transconductance）：输入信号为电压，输出为电流；
跨阻放大器（Transresistance）：输入信号为电流，输出为电压。
在分析放大器工作时，我们首先定义信号的表示方法。模拟电路中有直流信号、交流信号以及交流与直流混合叠加的信号。我们设定直流输入信号表示为VIN, 交流输入信号为vin, 直流与交流的混合输入信号为 vIN。 
图 2- 1 包括输入信号和负载电阻的一般放大器示意图
图 2- 1 为一般放大器示意图以及输入信号。放大器由有源器件和负载电流所构成。有源器件中的电流 iD由输入电压或电流信号所控制。直流偏置电流 ISUP流入有源器件的一端。
有源器件可以是 MOS 管，也可以是双极性晶体管。图 2- 1 中的输入信号可能是电压信号，也可以是电流信号。# 2. 
Roger T. Howe and Charles G. Sodini. Microelectronics —An Integrated Approach. Prentice-Hall, Inc., 1997 
洪志良，模拟集成电路分析与设计，北京：科学出版社，2005 
David A Johns and Ken Martin. Analog Integrated Circuit Design, John Wiley & Sons, Inc.1997 
Roubik Gregorian. Introduction to CMOS OP-AMPS and Comparator. John Wiley & Sons, Inc.1999 
王自强，CMOS 集成放大器，北京：国防工业出版社，2007 
http://www.natioanl.com 
陈东坡，何乐年，严晓浪. 一种低静态电流、高稳定的 LDO 线性稳压器. 电子与信息学报，2006，28（8）：1526-1529 
王菁. 低功耗直流电压转换器芯片设计与实现. 浙江大学硕士学位论文，2007 年 6 月 
http://www.analog.com  "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  [desc]
CMOS 运算放大器是 CMOS 模拟集成电路的最重要的模块，它的特性决定了模拟集成电路的特性[1-3]。复杂的 CMOS 运算放大器的基础是简单的单级放大器。本章将介绍常用的单级共源放大器、共栅放大器、源跟随器、共源共栅放大器。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  __  [desc]
一般概念 
按放大器的输入输出信号的类型，可将放大器归类为以下四类放大器[4]： 
电压放大器：输入与输出信号均为电压信号； 
电流放大器：输入与输出信号均为电流信号； 
跨导放大器（Transconductance）：输入信号为电压，输出为电流； 
跨阻放大器（Transresistance）：输入信号为电流，输出为电压。 
在分析放大器工作时，我们首先定义信号的表示方法。模拟电路中有直流信号、交流信号以及交流与直流混合叠加的信号。我们设定直流输入信号表示为VIN, 交流输入信号为vin, 直流与交流的混合输入信号为 vIN。
图 2- 1 为一般放大器示意图以及输入信号。放大器由有源器件和负载电流所构成。有源器件中的电流 iD由输入电压或电流信号所控制。直流偏置电流 ISUP流入有源器件的一端。有源器件可以是 MOS 管，也可以是双极性晶体管。图 2- 1 中的输入信号可能是电压信号，也可以是电流信号。如果是电压信号，那么如图 2- 1 所示 VBIAS是直流偏置电压。其值选定条件是 ISUP = ID，ISUP为负载电流源的直流电流，ID为流入有源器件的直流电流，即偏置电流。因此，在此条件下直流输出电流 IOUT为零。与 VBIAS串联的 vs是小信号电压，RS是内阻。vs的变化使总的输入电压 vIN有变化，因此使有源器件的总电流 iD变化。而 ID为一个定值，因此输出电流 iout = id，id为有源器件的小信号电流。如果放大器的输入信号是电流信号，那么直流偏置电流 IBIAS作为输入信号，保证有源器件，例如 MOS 的漏源电流 ID，等于电流源电流 ISUP。与 IBIAS并联的是一个小信号电流源 is以及电流源内阻 RS。is使有源器件的总电流 iD发生变化，因此输出电流是小信号电流 id。
图 2- 1 右图中的 RL为放大器的负载电阻。RL对小信号的影响问题将在后面讨论。通常我们所关心的开路电压，被定义为当 RL→∞时的小信号输出电压。另外一个重要参数是小信号输出电流，定义为当 RL=0 时的输出小信号电流。 
一般情况下，集成电路是单电源电压 VDD供电，另一端 V -电压为“0”伏，并且当 ISUP = ID时，IOUT = 0。另外一个条件是存在一个 VOUT值，使有源器件和直流偏置电流源器件都工作在恒定电流区域。因此一般 VOUT被设定在 V+和 V -的中间。当计算静态直流工作点时，要除去小信号源和内阻。在计算直流工作点时，由于 ID = ISUP，因此流过 RL的电流为零。
对图 2- 1 的放大电路总结如下：输入电流或电压，使有源器件中的直流电流与电流源电流相等，小信号输入电压或电流使有源器件中小信号电压或电流有线性变化，产生一个对应的输出电压或输出电流。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  __  [desc]
放大器双端口模型分析 
本节中我们将用双端口网络模型分析各种放大器，给出放大器的双端口网络模型。图2- 2 是四种放大器的双端口模型，包括输入电压或电流控制源和负载。
在电压放大器中，控制源是压控电压源；在电流放大器中，控制源是电流控制的电流源；在跨导放大器中，控制源是压控电流源；在跨阻放大器中，控制源是电流控制的电压源。在双端口模型下计算小信号传输函数时，需包括作为输入信号的电压源或电流源的内阻，并且需要将负载电阻连接在输出端口。如图 2- 3 所示，为计算开路电压增益 Av，我们用零内阻的测试电压 vt连接在输入端口，输出端口开路条件下，测定电压，并计算增益 Av；为测定短路电流增益 Ai，用一个内阻为无穷大的电流源连接到输入端，在输出端短路的条件下，测定短路电流，并计算增益；为测定跨导 Gm，可用内阻为零的电压源，测定短路电流，并计算其跨导；为测定跨阻 Rm，可以用内阻为无穷大的电流源，测量输出开路电压，并计算跨阻。
另外，如图 2- 3（e）所示，为了计算放大器的输入电阻 RIN，可用一个测试电压源，并测量相应的电流值，或者加一个测试电流源，测量电流源两端的电压值。测量输入电阻时，需要将负载 RL 接在输出端口。为计算放大器的输出阻抗 ROUT，可在输出端口加测试电压源或电流源，测量其相应的电流和电压值，此时输入端口的电压源短路，而电流源开路，仅留内阻在输入端，如图 2- 3（f）所示。各种控制源、输入和输出电阻与放大器的器件参数之间的关系十分重要。这种关系使得设计者可以了解如何改变器件的参数或者电路设计来改善放大器性能。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  __  [desc]
电流和电压源内阻与负载效应 
放大器的双端口模型包括输入电阻、输出电阻以及由放大器类型决定的控制源。这里我们分析电流与电压源内阻和负载电阻对放大器转移特性的影响。
图 2- 4 所示的是电压放大器的双端口小信号模型，包括输入电压源内阻 RS和负载电阻 RL。其小信号电压增益可表达为： 
出
IN
L
s
IN
S
L
OUT
v
v
R
R
A
v
R
R
R
R
⎛
⎞
⎛
⎞
= ⎜
⎟
⎜
⎟
+
+
⎝
⎠
⎝
⎠
                 （2-1）
图 2- 4 电压放大器的双端口小信号模型 
图 2- 5 跨导放大器的双端口小信号模型 
输入电阻由 RS和 Rin 串联构成，使输入电压减小。从式（2-1）可见，要使放大器正常地放大信号，需要输入电阻 RIN 较内阻 RS 大得多，而输出电阻 ROUT 需比负载电阻 RL小。
图 2- 5 是跨导放大器的双端口小信号模型，包括了输入电压的内阻 RS和负载电阻 RL。这一个放大器的跨导为： 
out
IN
OUT
m
s
IN
L
OUT
S
i
R
R
G
v
R
R
R
R
⎛
⎞
⎛
⎞
= ⎜
⎟
⎜
⎟
+
+
⎝
⎠
⎝
⎠
                 （2-2） 
要使跨导值提高，则必须要有大的输入阻抗 RIN和大的输出阻抗 ROUT。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  [desc]
共源放大器 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __  __  [desc]
调用配置 如果已经有了工艺提供的或者自己保存的设置，就可以直接通过载入配置文件配置工艺角分析。可以在菜单中选择“File”�“Load”，然后选择需要载入的配置文件。 
需要注意的是，这里载入的仅仅是工艺角分析的配置。而 ADE 的配置，包括仿真类型、输出、变量设置，仍然需要在打开工艺角分析窗口之前配置好。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 章 单级放大器 __ 3 [desc]
电流和电压源内阻与负载效应
放大器的双端口模型包括输入电阻、输出电阻以及由放大器类型决定的控制源。这里我们分析电流与电压源内阻和负载电阻对放大器转移特性的影响。图 2- 4 所示的是电压放大器的双端口小信号模型，包括输入电压源内阻 RS和负载电阻 RL。其小信号电压增益可表达为： 
```
out
IN
L
s
IN
S
L
OUT
v
v
R
R
A
v
R
R
R
R
⎛
⎞
⎛
⎞
= ⎜
⎟
⎜
⎟
+
+
⎝
⎠
⎝
⎠
                 （2-1）
```
图 2- 4 电压放大器的双端口小信号模型 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
直流特性分析
在负载线我们可以得到 VOUT与输入偏置电压 VBIAS、漏源电流 ID之间的关系。负载线与 MOS 管特性曲线的交点即为电路的直流工作点，因此可以看到电路的直流工作点的设定是由 VBIAS和 ID所决定。共源放大器的转移特性如图 2- 7（b）所示，可以看出，带电阻负载的共源放大器的工作状态有以下三种。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
交流小信号分析 
以得到电路的交流小信号电压增益如式（2-9）所示。注意式（2-4）中没有考虑 MOS 管的沟道长度调制效应。
```
(
)
OUT
V
D
n
ox
BIAS
TH
BIAS
D
m
V
W
A
R
C
V
V
V
L
R g
μ
= −
−
−
= −
             （2-9） 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
删除优化对象"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流小信号分析 [desc]
分析放大器的交流小信号特性，首先是将直流电源和直流信号源设为零，即将直流电压源短路，而将电流源开路。 （a）为电阻负载的共源放大器电路的小信号模型；（b）考虑了输入小信号与负载的小信号模型[6,7]。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 8（a）电阻负载的共源放大器电路的小信号模型 [desc]
按双端口模型，在图 2- 8（a）所示电路的输入端口加一个测试电压源 vt，并将输出端口短路，可以计算得到放大器的本征跨导为[6,7]： 
```
out
m
m
n
ox
D
t
2
i
W
G
g
C I
v
L μ
=
=
=
               （2-6） 
```
由于放大器的输入信号连接在 NMOS 管的栅端，因此在低频时可以认为输入电阻 RIN→∞，故 RS 不起作用。为测量放大器的输出电阻，可将测试电压源连接到输出端口，测量其电流，而将输入信号的内阻连接在输入端口。因为无输入电压信号，因此输出小信号电阻可根据图 2- 8（a）得到：  
```
OUT
o
/ / D
R
r
R
=
                       （2-7） 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 9（a）本征共源放大器的交流双端口模型 [desc]
得到交流小信号增益： 
```
(
)
out
m
V
m
o
D
in
o
D
//
1
1
v
g
A
g
r
R
v
r
R
=
= −
= −
+
               （2-11） 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共源放大器分析 [desc]
式（2-11）和图 2- 9 中，都考虑了 MOS 管的沟道长度调制效应，即认为工作在饱和区的 MOS 管的导通电阻值是有限的，而不是无穷大。这种效应在 RD值不是很小或者 MOS 管为短沟导器件时必须考虑的。 
当 RD远小于 MOS 管的输出阻抗时，小信号增益如（2-9）式所示；当 RD远大于 ro时，交流增益可改为： 
```
m o
out
v
in
v
A
g r
= v
= −
                      （2-12） 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 器件性能分析 [desc]
Deserializer（RS=0 Ω，RL=0 Ω）
因此，在长沟道器件中，λ 系数的值较小，因此 MOS 管的本征增益可达到 500 ~ 1000。但在短沟道器件中，λ 系数的值较大，MOS 管的本征增益下降到 10 ~ 30 之间。因此在设计放大器时，不仅要考虑 MOS 管的宽长比，而且还要考虑沟道长度值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 例 2-1  电阻负载共源放大器电路的参数 [desc]
求：[1.]用双端口模型，计算放大器的本征跨导 Gm（RS = 0 Ω，RL = 0 Ω）；[2.]在接负载电阻 RL的情况下，为保证跨导 iout/vs大于本征跨导的 10%，那么 RL的取值范围？ 
```
2
m
m
D
n
ox
50
2
2 100μ
50μ /
500μ
2
W
G
g
I
C
A
A V
S
L
μ
⎛
⎞
=
=
=
×
×
×
=
⎜
⎟
⎝
⎠
[2]当有负载电阻 RL时，如图 2- 9 所示由于 RL与 ROUT并联，实际的跨导将降带。这种效应在 RD值不是很小或者 MOS 管为短沟到器件时必须考虑的。 
16
(
)
o
out
o
D
1
n
D
out
out
m
s
out
L
1
1
100k ;  
//
20 k
0.1
100 A
r
R
r
R
I
V
i
R
G
v
R
R
λ
μ
−
=
=
=
Ω
=
=
Ω
⎛
⎞
=
⎜
⎟
+
⎝
⎠
而
按题意，
out
out
L
1
10
R
R
+ R >
，因此 RL < 9Rout，即 RL < 180 kΩ。 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 直流特性分析 [desc]
用恒流源可代替电阻 RD作为共源放大器的负载。给 MOS 输入管提供电流的理想电流源负载应该具有以下特性：当电流源两端的电压大于零伏时，电流源提供恒流 ISUP，而电流源两端的电压小于或等于零时，则电流源电流为零。一般的电流源还要考虑内部的电阻 roc。包含内部电阻的理想电流源如图 2- 10 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 10  包含内部电阻的理想电流源 [desc]
恒流源负载的共源放大器电路图如图 2- 11 所示。NMOS 管的栅极接输入小信号 vs和内阻，以及直流偏置电压 VBIAS，输出端口接负载电阻 RL。为分析大信号特性，我们设输入小信号电压和内阻对直流特性没有影响。另外忽略 MOS 管的沟道长度调制效应（λ= 0 V-1）以及电流源的内阻（roc= ∞）。由于直流输出电流 IOUT为零，因此可以不考虑负载电阻 RL。这样可得到大信号分析电路图如图 2- 11（b）。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 11 恒流源作负载的共源放大器(a)包括了输入小信号电压 vs和内阻，以及负载电阻 RL， [desc]
图 2- 12（a）是恒流源作负载的共源放大器的 MOS 管特性和恒流源负载特性，（b）是电压转移特性。当 VBIAS小于 MOS 管阈值电压 VTH时，MOS 处于截止状态，VOUT输出高电平 VDD。当 VBIAS增加超过 VTH时，MOS 导通有电流 ID流过，VOUT输出电压开始下降。随着 VBIAS的进一步增加，MOS 管进入饱和区，最后进入线性区。我们的目标是将 MOS 管设定在高增益的饱和区。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 小信号模型分析 [desc]
在分析得到直流工作点后，我们可以分析恒流源负载共源放大器的小信号负载。不包含有输入小信号电压和内阻以及负载的放大器本征小信号模型如图 2- 23所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ m [desc]
o1
m1
S
1
(
)
可以看出，公式（2-26）表明，源极电阻 RS对电路跨导有显著的降低效应，电路跨导
的增大需要减小源极电阻。 
以上是对带源极电阻负反馈的 CMOS 共源放大器的简单讨论，具体的电路分析需
要在考虑工作电流和供电电源电压之间的关系下进行详细的计算。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ m __ 5 [desc]
CMOS 共源放大器的输入和输出匹配网络
在无线通信系统中，无线功率放大器要将信号源的信号用 VCC电压放大后送到负
载（一般为天线）上。同时无线通信系统要求放大器的输入/输出阻抗要与信号源/
负载相匹配，即要求输入阻抗为输入源内阻的复共轭，输出阻抗为负载阻抗的复共
轭。这样就要求放大器有良好的输入输出匹配网络。 
表 2- 1 放大器的匹配网络，Zs为输入源内阻，ZL为负载阻抗 
共源（单端输入双端输出）	共源（单端输入单端输出）	共源（差分输入单端输出） 
Pi-型	LC型	阶梯型 
LC型	对称阶梯型	LC型 
对称阶梯型	L型	对称阶梯型 
如表 2- 1所示，放大器的输入/输出匹配网络主要有 Pi-型、LC 型、阶梯型等匹配
网络。了解放大器的匹配网络不仅可以为用户提供对无线通信的深入了解，同时也
围绕着无线功率放大器设计出许多优秀的研究论文。常见的匹配网络有如图 2- 20
所示的几种。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
RF CMOS LNA
低噪声放大器（Low Noise Amplifier，LNA）是接收信号链中最前端的一种放大
器，它的噪声指标对整个通信系统的接收性能起着关键的作用。第一节首先对低噪声
放大器的一般性能指标提出定义。在接下来的几节中将简单对常见的低噪声放大器电
路进行分析和讨论，并设计	LNA 上模块的核心电路——低噪声放大器 LNA。在单通
道发送/接收模块设计中，工作频率集中在 5.8GHz，因此高频效果的损失和陡峭的滤
波器将被用来尽可能地挤出噪声和防止 LO 产生的副波破坏 LNA 的性能。 
如果把无线接收机的信号链当作工厂的生产线，那么低噪声放大器（LNA，Low
Noise Amplifier）就是生产线的第一道工序。在 LNA 这一车间，将接收到的微弱的
射频信号进行第一次放大。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 [desc]
LNA 性能指标
相对于功率放大器，低噪声放大器（LNA，Low Noise Amplifier）的设计目标有
所不同。首先，作为接收链条的第一级，放大器的主要任务是将微弱的射频信号放大
至一定的幅度级别，即增益相对于功力放大器更加重要，二，LNA 的噪声严重影响
接收机的接收性能，因此设计 LNA 时噪声因子是首先要考虑的问题，最后在满足低
噪声和高增益的前提下，要满足良好的线性度要求。一般对射频功率放大器（Power
Amplifier，PA）和低噪声放大器（Low Noise Amplifier，LNA）的性能的衡量分别采
用不一样的标准，PA 的指标主要是效率（Efficiency），输出功率（Po，Output
Power），线性度（Linearity），而 LNA 的指标主要是增益（Gain），噪声因子
（Noise Figure），线性度（Linearity）等。舰对射频接收链的每一级，既要求增益
高、噪声低、线性好，还要求轻、薄、短、小、省电、建制快以及成本低等。 
国家电子部和美国联邦通信委员会（FCC）均对电子设备出炉噪声指标进行了严格
的规定，其中，射频电子设备中由低噪声放大器（LNA，Low Noise Amplifier）
引发的噪声问题成为了约束其发展的一个瓶颈。为了解决这个问题，众多半导体制造
公司都在投入大量的人力物力进行 LNA 的设计和研究。因此，怎样设计出性能优良
的射频低噪声放大器具有很高的应用价值和理论意义。 
设计一款好的 LNA，既要求噪声指标低，也要求具有一定的增益和阻抗匹配特
性。在多数应用中，LNA 的增益介于 10dB 到 20dB 之间。增益过高会使得后级电
路易于过载，而增益过低则不能足够抵消由后级引入的噪声。因此，很多设计者在
设计 LNA 时，一般是先考虑达到一定的增益后再去尽可能地降低 LNA 的噪声指标。 
表2-2 LNA 的主要性能指标 
性能指标	衡量标准 
噪声	噪声因子 
增益	S21 参数 
线性度	IP3, IP2, P1dB 
匹配撞	入／出 VSWR 
功率耗散	Dc 消耗功率 
频率范围	工作频率 
稳定性	稳定性因子 
阻抗	输入／输出阻抗 
大约十几年来，射频工程师一直在努力去发展更低 噪声的 LNA。对于有源设备
来说，噪声的主要来源是其固有的热噪声和器件制程中带来的 1/f 噪声。这种噪声
的出现导致了信号的品质变差，从而降低了射频接收链的敏感度和发送效果。为了能
在具有一定的增益的情况下，达到一定的性能指标，必须将 LNA 的设计要求尽可能
的降低 LNA 的噪声。在给定的技术参数下，改善一个器件的某一性能指标常常会影
响到另外一些性能指标，也就是说在满足一定的增益要求的情况下，尽量降低噪声和
提高线性度。在接收链中，由于接收机的第一个级别是低噪声放大器，所以，低噪声
放大器的噪声指标对前端的整体性能有着决定性的作用。这也是低噪声放大器与其他
射频前端器件最大的不同之处。在设计低噪声放大器时，我们希望在满足一定增益的
前提下使其噪声尽可能得小。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 __ 1 [desc]
增益 
在信号接收链中，射频前端接收到的信号是非常微弱的，通常是 μV 或者是 nV级
别的，在前端放大后期，往往需要将器件的功率放大到 W 级别，也就是需要在射频前
端完成信号幅度的扩大 10 的 9 到 10 的 12 倍。阵在进行信号的确立和调制之前，信
号一般在低噪声放大器（LNA）完成第一次的放大，阵在混频器（Mixer）完成第
二次的放大。在完成白血数放大之后，由中间频率放大器（IF Amplifier）完成信
号缩放的最后一道工序。增益对于低功耗应用来说也是十分重要的。提高增益或者
匹配更高的增益可以降低分级放大器的噪声影响，从而提高整个接收链的信噪比。但
是增益也不能过大，增益过大会使得 LNA 的动态范围减小，从而影响整个接收链的
动态性能。增益过大可能会使得放大器进入饱和，降低信噪比和线性度。从另外一
个角度来说，增益的过大可能会引起接收链的自激振荡。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 __ 2 [desc]
噪声因子 
噪声是伴随着所有的电信号传递的。对于电力放大的功率放大器来说，一般不太
注意其噪声效应，而是注重其效率和线性度。但是对于前向放大的低噪声放大器来说
，噪声是其关注的重点，噪声将影响到整个接收路径的性能。因此在设计低噪声放大
器时，通常需要在满足增益、阻抗匹配的前提下尽量降低噪声因子。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 2 [desc]
CMOS RF LNA 的电路拓扑
LNA 是低噪声放大器（Low Noise Amplifier）的缩写。在射频通信系统中，LN
是接收链的入海第一级，作用是从接收天线接收到的射频信号放大至一定程度，因此其
增益、噪声均直接影响到接收系统的性能。 从图 2- 21 可以看出，LNA 不仅是消
耗功耗的主要元器件，而且在接收链的性能指标中有一半以上都需要优质的 LNA 支
持。这也决定了在设计接收链的时候，LNA 的设计尤为关键。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 3 [desc]
LNA 的设计
在设计射频前端的过程中，由于往往需要在增益、匹配、噪声因子、动态范围
和功率耗散等性能需求之间进行权衡取舍，因此设计 LNA 的难度就更大。然而，无
论如何变化，设计 LNA 的过程中都需要注意以下几个方面的问题： 
选择适合的架构。 设计架构对于前端 LNA 的整体布局十分重要，不合理的架构
不能很好的利用硅的非线性特性。 而且由于射频前端的要求越来越高，对于射频前端
接收部分的电路架构也提出了新的要求。 
<AI选定的电路图 2- 22> 
选择合适的技术参数。 器件参数的选择是设计射频前端的关键。不同器件参数的选
择将决定射频前端的接收特性和工作模式。目前，射频前端的研发重点正在由射频前端
架构转向补偿和前端的器件参数的优化上。 
考虑整个前端的性能。硅基射频前端在工作时，器件之间的资源是共享的。所以在设
计射频前端时，不仅要全面考虑每一个器件的性能，而且还要整合分析全个前端的排
线和放大效率问题。 
在设计 LNA 的过程中，一种常见的设计方法是先选择一个适合的架构，然后考虑
匹配和增益要求，然后尽量优化其噪声因子。在设计过程中，需要先结束 LNA 的架构，
并根据其设计要求及接收器性能需求选择合适的技术参数，例如：工作频率、增益、
噪声因子、线性度最短、输入/输出阻抗等。进而根据这些要求选择合适的电路元
件，并进行电路设计和设计优化，以满足实际应用的要求。本文将采用这种方法对 L
设计进行每个阶段的深入研究和优化。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 [desc]
带源极电阻负反馈的 CMOS LNA 
源极接反馈电阻负反馈的 CMOS LNA 是一种在设计时，可以采取源极接阻的方
式，采用负反馈的方式来改变放大器的负载阻抗，从而提高增益和线性度。在大多数
射频前端的设计中，带负反馈的 CMOS LNA 往往被用来作为第一阶段的低噪声放大器
因为在射频系统中，信道的噪声和非线性无法被消除，因此需要在接收机的前端采取
积极的手段来改善接收信号的信噪比和线性度。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 __ 1 [desc]
带源极电阻负反馈的 CMOS LNA 的基本性能 
带源极电阻负反馈的 CMOS LNA 的基本电路如图 2- 23 所示。 
<AI选定的电路图2- 23> 
该电路中，M1 是 CMOS 放大单元，源极接反馈电阻 R1，通过电容 C1接供电，以屏
蔽直流电压的影响。L1、C2 和 R1 形成谐振电路，以提供合适的输入匹配。在这类
CMOS LNA 中，R1 主要起负反馈的作用，通过改变 R1 的个，可以改变放大器的增
益和线性度。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 __ 2 [desc]
带源极电阻负反馈的 CMOS LNA 的噪声性能 
在 3G /4G 系统中，LNA 的噪声性能是衡量一个接收机性能的关键参数。尽量降低
噪声是设计低噪声放大器的主要目标。带源极电阻负反馈的 CMOS LNA 的噪声性能由
多个因素决定，如器件的噪声特性、电路的增益、电源电压、工作频率及器件允许的
噪声电平等多个因素所决定。其中，噪声主要来自于负反馈电阻 R1和 CMOS 放大单元
M1。R1 和 M1 对于总噪声性能的影响可以通过等效噪声电源来分析："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 __ 3 [desc]
带源极电阻负反馈的 CMOS LNA 的增益
增益是衡量一个放大器放大能力的一个重要参数。带源极电阻负反馈的 CMOS LNA 的增益主要由反馈电阻 R1 和放大单元 M1 的跨导 gM1 等因素所决定。通过调整 R1 
和 gM1 的值，可以达到改变放大器增益的目的。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 __ 4 [desc]
带源极电阻负反馈的 CMOS LNA 的线性度
在实际工作过程中，CMOS 放大器的工作状态随着输入信号的变化而变化。因此，设计时需要保证放大器在一定的输入信号范围内都能保持良好的线性度。带源极电阻负反馈的 CMOS LNA 的线性度主要与反馈电阻 R1、放大单元 M1、工作电流 I1 和电源电压 VCC 等多个因素有关。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 __ 5 [desc]
带源极电阻负反馈的 CMOS LNA 的频率性能
无线通信系统中的信号频率一般处在 MHz 到 GHz 范围内。因此，设计的 LNA 也必须在这个频率范围内工作，并且在整个工作频率范围内，需要满足一定的性能要求。带源极电阻负反馈的 CMOS LNA 的频率特性主要与反馈电阻 R1、电感 L1、电容 C1/C2 以及供电电压 VCC 等多个因素有关。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 5 [desc]
CMOS LNA 的设计步骤
设计 CMOS LNA 一般需要按照以下几个步骤：
选择合适的电路拓扑，通常选择共源或共栅拓扑。
确定设计规格，例如工作频率、辐射阻抗、噪声因子等。
选择适当的主动设备，如 NMOS、PMOS、PNP、NPN 等。
设计输入匹配网络，使其在目标频率下䷉及目标阻抗。
设计适当的元件大小，并尽可能地减小噪声。
模拟并优化设计，直到满足所有设计规格。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 6 [desc]
单边带噪声系数的测量方法 
对于射频前端来说，噪声指标是一个非常重要的性能参数。在射频前端中，噪声主要由放大器和混频器两个部分产生。对于放大器，主要的噪声源是由于其非线性特性和电源上的噪声所引起。对于混频器，主要的噪声源是由于其非立方特性产生的自混频噪声以及由其非平性引起的二次谐波混频噪声。对于射频系统来说，由于系统频率较高（GHz 级），因此需要采用比较复杂的混频技术才能达到理想的噪声性能。目前，对于前端的噪声系数的测量通常采用广为接受的 Y系数法和热噪声源法。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 7 [desc]
具有 NMOS-PMOS 混合型工作模式的 CMOS LNA 设计 
通过以上的讨论，我们知道在设计 CMOS 射频前端时，无论是 CMOS 放大器还是 CMOS 混频器，其工作模式都会直接影响其增益和消耗功率。因此，如何选择合适的 NMOS 或 PMOS 模式对于设计 CMOS 射频前端至关重要。然而，由于 NMOS 和 PMOS 具有不同的电性能，如果只使用其中一种会使得设计时不能拉足够的权衡，从而影响设计的灵活性。因此，我们提出了一种新的设计理念——将 NMOS 和 应MO 结合起来，采用一个混合型的工作模式，以便充分利用 NMOS 和 PMOS 的优点，从而克服他们的不足。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 [desc]
RF CMOS 接收链设计 
在无线通信中，射频接收机通常由低噪声放大器、混频器和中频放大器三部分组成。低噪声放大器用于将微弱的射频信号放大到一定的幅度级别。接收信号然后由混频器降到更低的频率，以便在后续的中频放大器中进行处理。在射频前端模块中，一般采用超外差或者零中频的方式，对接收信号进行混频，以便在中频阶段进行滤波和放大，并最终输出基带信号。 
图 2-27 给出了接收信号在接收链中的基本处理框图。 
<AI选定的电路图2- 27> "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ 1 [desc]
利用 CMOS 器件作为射频有源质量 
由于 CMOS 器件能够在低电压地提供足够的电流驱动力，并且具有很强的带宽
和线性度，因此被广泛应用到射频前端器件中。然而由于 CMOS 器件的唯空因子和
电性能的受限，尽管其消耗的功耗较低，但是其有源负载的效率较低，并且容易产
生具有较大模值的偶次谐波混频，从而严重影响整个系统的性能。然而，相比于他
器件， CMOS 器件在速度和功耗方面还是有着极其出色的表现，因此在射频有源负
载中，一般采用 CMOS 器件来提供放大能量。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ 2 [desc]
具有推-向模式的 CMOS 负载
除了 CMOS 晶体管之外，推-向晶体管（Common-Drain Amplifier, CDA）在射频
前端模块中也有广泛的应用。相比于 CMOS 晶体管，推-向晶体管具有较大的交流增
益，较高的负载阻抗以及较低的输出噪声。这些优点使得推-向晶体管在无线通信中
得到了广泛的应用，如在封式混频器和封式放大器中。然而，推-向晶体管的工作频
率较低，且由于其较低的电流驱动能力，其在应对强有源负载的能力较弱。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ Acknowledgement [desc]
本论文由 XXX 实验室的 XY 教授提出主题并指导完成，全体实验室成员对论文的完成都有所贡献。在实验室的日常研究生活中，每一个成员都积极参与讨论，对我提出建设性的意见和建议。在论文的写作过程中，XY 教授和 XX 为我提供了许多宝贵的意见。我在此对他们表示最深的谢意。我的家人在论文的完成过程中给予我无私的帮助，他们的支持和鼓励使我有信心能够完成论文的写作。我对他们表示衷心的感谢。
本项目受到 XXX 基金的资助，项目编号：XXX。衷心感谢 XXX 基金对本项目的大力支持。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ References [desc]
[1] XXX
[2] XXX
[3] XXX 
[4] XXX 
[5] XXX "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ References __ 带源极电阻负反馈的共源放大器电路 [desc]
在 2.2.3 节中，我们讨论了二极管连接的 MOS 管做负载的共源放大器的线性特性。另外一种可改变放大器线性的电路如图 2- 18（a）所示，通过用一个串联在输入 MOS 管源极的“负反馈”电阻来实现。电路“负反馈”的基本原理是随着 vIN增加，iD也增加，同样在 RS上的压降也会增加，因此输入电压 vIN的一部分出现在 RS上而不是全部作为栅源电压，因此 iD随 vIN的变化变得平滑。 
根据如图 2- 18（b）所示的带负反馈的 CMOS 共源放大器的小信号等效模型，计算交流小信号增益 Av、电路跨导 Gm以及输出电阻 ROUT。注意到图中 vbs = -vx；v1 = vin-vx。根据 KCL 定理，列出如下节点方程： 
```
x
out
x
o1
mb1 x
m1
in
x
S
v
v
v
r
g
v
g
v
v
R =
−
−
+
−
             （2-22） 
```
```
out
o2
out
o1
mb1 x
m1
in
x
x
v
r
v
v
r
g
v
g
v
v
=
−
+
−
−
          （2-23） 
```
因此得到： 
``` 
OUT
m1
mb1
o1
S
o1
1
R
g
g
r
R
r
=
+
+
+
⎡
⎤
⎣
⎦
                  （2-29） 
```
因为通常(gm1+gmb1)ro1>>1，因此上式可以简化为： 
``` 
OUT
m1
mb1
o1
o1
x
S
x
v
R
g
g
r R
r
= i
≈
+
+
                  （2-30） 
```
式（2-30）表明源极电阻的加入，使输出电阻增大了(gm1+gmb1)RS倍，这是一个重要有用的结论。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 __ 共栅放大器 [desc]
本节主要讨论的是输入端为 MOS 管的源端，输出端为 MOS 管的漏端的放大器，即共栅放大器。我们将会发现共栅放大器的输入阻抗较小，而输出阻抗较高。图 2- 22 是共栅放大器电路，NMOS 的源端有输入电流源 is 和内阻 RS，以及直流偏置电流源 IBIAS。注意该电路是双电源电压供电，所以 MOS 管的栅极的电位为 V+和 V-的中间电平，即零电平。由于 MOS 管的源极为输入端，因此 MOS 管的衬底也许不能与源极相连。
``` 
SUP
S
THn
n
ox
2
I
V
V
W
L μ C
= −
−
                  （2-35） 
```
如果 VB≠VS，那么需要将式（2-34）代入式（2-35），进行计算。 
考虑到 IOUT = 0，MOS 管工作在高增益区，用图 2- 23 所示共栅极放大器的小信号模型可计算输出短路电流。在图中我们考虑了 VBS≠0 的情况，从该图可得到输出短路电流等于负的输入电流，这意味着短路电流增益为-1。产生这结果的原因是栅极无电流流入。
图 2- 24 是计算共栅放大器的输入电阻的小信号模型。在输入端加一个测试电流源，测量电流源上的电压值，可得到输入电阻。图中的 roc是 ISUP电流源的内阻，RL为负载电阻，并注意到 v1 = –vx= –vt；vbs= –vt。在输入端，按 KCL 定理可得到： # 23. 共栅放大器
衬底也许不能与源极相连。如果是 p阱 CMOS 工艺，即 NMOS 管做在 p阱中，那么 NMOS 管的源与衬底可以相连。如果不是 p阱 CMOS 工艺，则一般需要对衬底加一个电平 V-，这样 VBS≠0，由于“背栅效应”的存在 VTH将随着 VBS变化。 
图 2- 22(a)共栅放大器电路，包括输入小信号、内阻以及负载电阻 RL； 
(b)设 is = 0A，Rs→∞，RL = 0，ISUP的内阻 roc→∞的电路 
为了分析共栅放大器的大信号特性，我们将图 2- 22(a)中的输入小信号源以及内阻去掉，并将 RL置为零，如图 2- 22(b)所示。在输出端按 KCL 原理，可以得到：
```
OUT
BIAS
SUP
I
I
I
= −
−
（2-32）
```
与共源放大器一样，为了使直流输出电流 IOUT = 0，有 IBIAS = -ISUP。由于 MOS 管的栅电位为零，我们计算源极电位，以保证 IBIAS = -ISUP成立。用 MOS 大信号模型可得： 
```
(
) (
)
2
D
SUP
n
ox
GS
THn
n
DS
1
1
2
W
I
I
C
V
V
V
L
μ
λ
=
=
−
+
（2-33) 
```
其中[2]， 
```
THn
THn0
n
F
SB
F
2
2
V
V
V
γ
φ
φ
⎡
⎤
=
+
+
−
⎣
⎦ （2-34） 
```
如果忽略 MOS 管的沟道长度调制效应，即 λn = 0，并且 VG = 0 V，可得到源端的电压： 
```
SUP
S
THn
n
ox
2
I
V
V
W
L μ C
= −
−
（2-35） 
```
如果 VB≠VS，那么需要将式（2-34）代入式（2-35），进行计算。 
考虑到 IOUT = 0，MOS 管工作在高增益区，用图 2- 23 所示共栅极放大器的小信号模型可计算输出短路电流。在图中我们考虑了 VBS≠0 的情况，从该图可得到输出短路电流等于负的输入电流，这意味着短路电流增益为-1。产生这结果的原因是栅极无电流流入。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共栅放大器的小信号模型 [desc]
图 2- 24 是计算共栅放大器的输入电阻的小信号模型。在输入端加一个测试电流源，测量电流源上的电压值，可得到输入电阻。图中的 roc是 ISUP电流源的内阻，RL为负载电阻，并注意到 v1 = –vx= –vt；vbs= –vt。在输入端，按 KCL 定理可得到： 
```
t
t
oc
L
t
m
t
mb
t
o
(
//
)
v
i r
R
i
g v
g
v
r
−
=
+
+
（2-36）
```
因此得到:
```
oc
o
IN
m
mb
o
//
1
1/
L
r
R
r
R
g
g
r
+
=
+
+
（2-37）
```
一般情况下，ro>>RL，ro>>1/(gm+gmb)，因此式（2-37）可以简化为
```
IN
m
mb
1
R
g
g
≈
+
（2-38）
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 计算共栅放大器的输出电阻的小信号模型 [desc]
图 2- 25 是计算共栅放大器的输出电阻的小信号模型。将输入小信号电流设为零，即开路，但保留小信号内阻 Rs，ISUP电流源的内阻为 roc。在输出端口的 roc电阻两端加一个测试电流源，测量其电压，并计算电阻值。图中我们注意到：
```
x
t
S
v
= i R
（2-39） 
```
在源电阻节点上，按 KCL 定理可得： 
```
t
x
x
m
x
mb
x
S
o
v
v
v
g v
g
v
R
r
−
= −
−
+
（2-40）
```
即， 
```
(
)
t
x
o
S
m
mb
o
1/
1/
v
v
r
R
g
g
r
=
+
+
+
（2-41）
```
将式（2-39）代入式（2-41），并整理得到： 
```
t
o
S
m o
mb o
S
1
v
r
R
r
R
g r
g
r
R
⎛
⎞
=
+
+
+
⎜
⎟
⎝
⎠
（2-42）
```
考虑到并联的 roc电阻，那么： 
```
o
OUT
oc
S
m o
mb o
S
//
1
r
R
r
R
g r
g
r
R
⎡
⎤
⎛
⎞
=
+
+
+
⎢
⎥
⎜
⎟
⎢
⎥
⎝
⎠
⎣
⎦
（2-43） 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共漏放大器 [desc]
如果考虑到 gm>>gmb，以及 ro>>RS，得到： 
```
(
)
OUT
oc
o
m
S
//
1
R
r
r
g R
≈
+
（2-44） 
```
注意：由于 MOS 管源极有电阻存在，因此有负反馈作用，使输出电阻值大大提高了。因此，共栅放大器可以用作电流缓冲器，有低的输入电阻、单位增益电流和高的输出阻抗。 通过降低输入电阻可以增加跨导。可用提高 ISUP 电流或提高 MOS 管的 W/L值达到增加跨导的目的。输出电阻的提高受到 ISUP电流内阻 roc的限制。共栅放大器的双端口模型如图 2- 26 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共漏放大器 __ 共漏放大器 [desc]
共漏放大器也称为源极跟随器[4]，其电路如图 2- 27 所示。NMOS 管的漏极接到 V+电源。输入的直流偏置电压 VBIAS 和小信号电压连接到栅极，在源极有恒流源。输出端口在 MOS 管的源极。注意电路采用了双电源电压。如果 NMOS 管被做在 p阱中，那么 NMOS 管的衬底与源极可以连接在一起，以去除衬底偏置效应。如果采用的是 n阱工艺，那么 NMOS 管的阈值电压 VTH将是 VBS的函数[1,2]。 
图 2- 27(a)包括小信号电压 vs、内阻 RS和负载 RL的共漏放大器，
(b)用于大信号分析的简化电路，vs = 0V，RS =0Ω，RL→∞，roc→∞ 
图 2- 27(b)是共漏放大器大信号分析模型的简化电路，用于计算输入偏置电压 VBIAS和输出电压 VOUT的关系。由图可见： 
```
BIAS
GS
OUT
V
V
V
−
=
（2-45） 
```
如果忽略 MOS 管的沟道长度调制效应，按 MOS 管的大信号模型可得: 
```
SUP
GS
THn
n
OX
2
I
V
V
W
L μ C
=
+
（2-46） 
```
如果考虑衬底偏置效应，那么 MOS 管的 VTH与 VBS之间有以下关系： 
```
THn
THn0
n
F
SB
F
2
2
V
V
V
γ
φ
φ
⎡
⎤
=
+
+
−
⎣
⎦ （2-47）
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 求共漏放大器开路电压增益的小信号模型 [desc]
图 2- 28 求共漏放大器开路电压增益的小信号模型 
图 2- 29 计算共漏级放大器的输出阻抗的小信号模型 
从电路图 2- 27，我们可以推测其电压放大系数近似为 1，电路有大的输入电阻和小的输出阻抗。为计算双端口模型参数，首先画出如图 2- 28 所示的用于计算开路电压增益 AV 的共漏放大器的小信号模型。图中包含了衬底偏置效应。以下计算开路电压增益 AV。注意到 vbs=–vout，从图 2- 28 可得， 
```
1
in
out
v
v
v
=
−
（2-48） 
```
m 1
out
mb
oc
o
1
1
g v
v
g
r
r
⎛
⎞
=
+
+
⎜
⎟
⎝
⎠
（2-49）
将式（2-48）代入式（2-49），可得： 
```
out
m
m
v
in
o
oc
m
mb
m
mb
1 (
//
)
v
g
g
A
v
r
r
g
g
g
g
=
=
≈
+
+
+
（2-50） 
```
因为 ro//roc>>1/(gm+gmb)，因此 vout/vin近似等于 1。注意衬底偏置效应使 vout/vin降低。因为 MOS 管的栅是绝缘的，所以 RIN→∞。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 计算共漏级放大器的输出阻抗的小信号模型 [desc]
以下计算共漏级放大器的输出阻抗，如图 2- 29 所示，加一个测试电压 vt在源端，测量其电流值，输入的小信号电压源为零。这样从电路图 2- 29 可得到： 
```
t
```# 压连接到栅极，在源极有恒流源
输出端口在 MOS 管的源极。注意电路采用了双电源电压。如果 NMOS 管被做在 p 阱中，那么 NMOS 管的衬底与源极可以连接在一起，以去除衬底偏置效应。如果采用的是 n 阱工艺，那么 NMOS 管的阈值电压 VTH将是 VBS的函数[1,2]。 
图 2- 27（a）包括小信号电压 vs、内阻 RS和负载 RL的共漏放大器，（b）用于大信号分析的简化电路，vs = 0V，RS =0Ω，RL→∞，roc→∞ 
图 2- 27（b）是共漏放大器大信号分析模型的简化电路，用于计算输入偏置电压 VBIAS和输出电压 VOUT的关系。由图可见： 
```
BIAS
GS
OUT
V
V
V
−
=
（2-45） 
```
如果忽略 MOS 管的沟道长度调制效应，按 MOS 管的大信号模型可得: 
```
SUP
GS
THn
n
OX
2
I
V
V
W
L μ C
=
+
（2-46） 
```
如果考虑衬底偏置效应，那么 MOS 管的 VTH与 VBS之间有以下关系： 
```
THn
THn0
n
F
SB
F
2
2
V
V
V
γ
φ
φ
⎡
⎤
=
+
+
−
⎣
⎦ （2-47）
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 29 计算共漏级放大器的输出阻抗的小信号模型 [desc]
从电路图 2- 27，我们可以推测其电压放大系数近似为 1，电路有大的输入电阻和小的输出阻抗。为计算双端口模型参数，首先画出如图 2- 28 所示的用于计算开路电压增益 AV 的共漏放大器的小信号模型。图中包含了衬底偏置效应。以下计算开路电压增益 AV。注意到 vbs=–vout，从图 2- 28 可得， 
```
1
in
out
v
v
v
=
−
（2-48） 
```
m 1
out
mb
oc
o
1
1
g v
v
g
r
r
⎛
⎞
=
+
+
⎜
⎟
⎝
⎠
（2-49）
将式（2-48）代入式（2-49），可得： 
```
out
m
m
v
in
o
oc
m
mb
m
mb
1 (
//
)
v
g
g
A
v
r
r
g
g
g
g
=
=
≈
+
+
+
（2-50） 
```
因为 ro//roc>>1/(gm+gmb)，因此 vout/vin近似等于 1。注意衬底偏置效应使 vout/vin降低。因为 MOS 管的栅是绝缘的，所以 RIN→∞。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共漏级放大器的输出阻抗 [desc]
以下计算共漏级放大器的输出阻抗，加一个测试电压 vt在源端，测量其电流值，输入的小信号电压源为零。这样从电路图 2- 29 可得到： 
```
t
t
m
t
mb
t
o
// oc
v
i
g v
g
v
r
r
=
+
+
（2-51） 
```
因此，可以得到： 
```
t
t
o
oc
m
mb
1
1
//
(
)
v
i
r
r
g
g
=
+
+
（2-52） 
```
由于，一般情况下 ro//roc>>1/(gm+gmb)，因此， 
```
OUT
m
mb
1
R
g
g
≈
+
（2-53） 
```
从而得到共漏放大器的双端口模型如图 2- 30。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 共源共栅放大器 [desc]
在前节中提到共栅级的输入信号可以是电流，而共源和共漏级中的晶体管可以将电压信号转为电流信号。单管放大器结构简单，是模拟电路的基本单元。将基本单元进行组合就可以得到比较复杂的电路，以提高电路的性能。本节介绍共源-共栅级的级联放大器，即共源共栅（cascode）放大器。图 2- 30 是（a）PMOS管恒流源负载和（b）栅、漏短接的 MOS 管作负载的单级 CMOS 共源共栅放大器电路。M1管是输入管，作共源放大器，M2管作共栅放大器，M3管是负载管。输入信号加到 M1管栅极，输出信号从 M2管的漏极引出。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 31 (a)恒流源负载；（b）栅、漏短接的 MOS 管作负载的单级共源共栅放大器电路 __ 1 大信号特性 [desc]
设图 2- 31（a）中的 M1、M2 和 M3管的阈值电压分别为 VTH1、VTH2、VTH3。VG2 和 VG3 分别是 M2 和 M3 的直流偏置电压。图 2- 32 是其输出输入特性曲线[4]。 
1. 当输入电压 VIN<VTH1，M1 管截止，这样由于 M1 中没有电流流过，因此 M2 管也截止，而 M3 管导通，因此输出电压 VOUT为 VDD，如图 2- 32 中的 AB 段。 
2. 当输入电压 VIN >VTH1，M1管导通，ID1 逐渐增大，VA电压下降，这样 M2的电流 ID2 也逐渐上升，VOUT 从 VDD 逐渐下降。当 VOUT>VG3+|VTH3|时，M3 管工作在线性区，而 M1 和 M2管工作在饱和区。如图 2- 32 中的 BC 段。 
3. 当 VIN 继续上升，当 VOUT<VG3+|VTH3|时，M3 管进入饱和区。如果同时满足 VOUT > VG2-VTH2，那么 M2 管工作在饱和区。对于 M1 管，如果 VGS1 = VGS2 
=VIN，那么当 VG2-VGS2 ≥VGS1 -VTH ，即 VIN≤ (VG2+VTH1)/2，那么 M1处于饱和区工作，这时 VOUT迅速下降。如图 2- 32 中的 CD 段。 
4. 当 VIN继续上升，如果 VOUT <VG2-VTH2，此时 M1 和 M3 管工作在饱和区， M2 管工作在线性区，输出电压继续下降，但速度变慢。如图 2- 32 中的
DE 段。在本工作区中，也有可能 M1先进入线性区，而 M2 和 M3 管工作在饱和区。M1 和 M2管哪个先进入取决于 M1和 M2 管的宽长比和 VG2电压。 
5. 当输入电压继续增大，如果 VA <VIN-VTH1，那么 M1和 M2管都进入线性区，M3 管工作在饱和区，输出电压缓慢下降。如图 2- 32 中的 EF 段。需要注意的是，输出电压的最大值可达到 VDD，但最小输出值高于零电平，其值取决于 M1、M2 和 M3管的宽长比以及偏置电压值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 31 (a)恒流源负载；（b）栅、漏短接的 MOS 管作负载的单级共源共栅放大器电路 __ 图 2- 32 恒流源负载共源共栅放大器电路（图 2- 31）的输出输入特性曲线 [desc]
由于我们主要关心的是 M1、M2 和 M3 管工作在饱和区时，即共源共栅电路处于最大的小信号电压增益时的输出电压范围。这个限定对管子的设计很有意义。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 31 (a)恒流源负载；（b）栅、漏短接的 MOS 管作负载的单级共源共栅放大器电路 __ 30 因此，从图 2- 31（a）可见，所有管子都工作在饱和区的共源共栅电路的最大输出电压 [desc]
```
VOUT (最大) = VDD- VSD3 (饱和)  （2-54） 
VOUT (最小) = VDS1 (饱和)+VDS2 (饱和)  （2-55） 
```
因此，为了增大输出电压的范围，可以通过增加各个管子的宽长比，以降低饱和压降。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 31 (a)恒流源负载；（b）栅、漏短接的 MOS 管作负载的单级共源共栅放大器电路 __ 2 小信号特性 [desc]
图 2- 33（a）是恒流源负载共源共栅放大器电路（图 2- 32）的小信号模型等效电路，按电流源拆分和置换原理，将此模型简化后可得到图（b）。在忽略寄生电容后，采用节点分析法对 A 和 B 节点列出电流方程[3]： 
```
( )
( )
m1 in
o1
m2
mb2
2
out
2
o2
1
g v
r
g
g
v
v
v
r
+
+
+
=
−
（2-56） 
( )
( )
m2
mb2
2
out
o3
out
2
o2
g
g
v
v
r
v
v
r
+
=
+
−
（2-57） 
```
由上两式求得小信号电压增益 vout/vin为： 
```
( )
m1
m2
mb2
o2
o1 o3
out
m1 o3
in
o2
o3
o1
o1 o2
m2
mb2
1
(
)
g
g
g
r
r r
v
g r
v
r
r
r
r r
g
g
+
+
⎡
⎤
⎣
⎦
= −
≈ −
+
+
+
+
（2-58） 
```
从式（2-58）可以看到，与共源放大器相比，共源共栅放大器具有较高小信号增益。另外，其小信号电压增益主要由 M1和 M3管的参数决定。 
利用图 2- 31（a），我们可以求出其小信号输出电阻。小信号输出电阻是共源共栅（M1.# 如果 VOUT <VG2-VTH2，此时 M1 和 M3 管工作在饱和区，
M2 管工作在线性区，输出电压继续下降，但速度变慢。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 当输入电压继续增大 [desc]
如果 VA <VIN-VTH1，那么 M1和 M2管都进入线性区，M3 管工作在饱和区，输出电压缓慢下降。需要注意的是，输出电压的最大值可达到 VDD，但最小输出值高于零电平，其值取决于 M1、M2 和 M3管的宽长比以及偏置电压值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 32 恒流源负载共源共栅放大器电路（图 2- 31）的输出输入特性曲线 [desc]
由于我们主要关心的是 M1、M2 和 M3 管工作在饱和区时，即共源共栅电路处于最大的小信号电压增益时的输出电压范围。这个限定对管子的设计很有意义。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 从图 2- 31（a）可见，所有管子都工作在饱和区的共源共栅电路的最大输出电压 [desc]
```
VOUT (最大) = VDD- VSD3 (饱和)                    （2-54） 
VOUT (最小) = VDS1 (饱和)+VDS2 (饱和)                （2-55） 
```
为了增大输出电压的范围，可以通过增加各个管子的宽长比，以降低饱和压降。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 从图 2- 31（a）可见，所有管子都工作在饱和区的共源共栅电路的最大输出电压 __ 小信号特性 [desc]
图 2- 33（a）是恒流源负载共源共栅放大器电路（图 2- 32）的小信号模型等效电路，按电流源拆分和置换原理，将此模型简化后可得到图（b）。在忽略寄生电容后，采用节点分析法对 A 和 B 节点列出电流方程[3]：
```
(
)
(
)
m1 in
o1
m2
mb2
2
out
2
o2
1
g v
r
g
g
v
v
v
r
+
+
+
=
−
         （2-56） 
(
)
(
)
m2
mb2
2
out
o3
out
2
o2
g
g
v
v
r
v
v
r
+
=
+
−
          （2-57） 
```
由上两式求得小信号电压增益 vout/vin为：
```
(
)
m1
m2
mb2
o2
o1 o3
out
m1 o3
in
o2
o3
o1
o1 o2
m2
mb2
1
(
)
g
g
g
r
r r
v
g r
v
r
r
r
r r
g
g
+
+
⎡
⎤
⎣
⎦
= −
≈ −
+
+
+
+
        （2-58） 
```
与共源放大器相比，共源共栅放大器具有较高小信号增益。另外，其小信号电压增益主要由 M1和 M3管的参数决定。
利用图 2- 31（a），我们可以求出其小信号输出电阻。小信号输出电阻是共源共栅（M1和 M2 管）的输出阻抗与 M3对交流地的阻抗 ro3 的并联后的电阻：
```
[
]
OUT
o1
o2
m2 o1 o2
o3
o3
//
R
r
r
g
r r
r
r
=
+
+
≈
              （2-59） 
```
从式（2-59）可见，与共源放大器相比，共源共栅放大器具有更大的输出小信号电阻。另外，计算从 vin到 M1 的漏极电压（vA）的小信号增益也是我们感兴趣的。根据式（2-57）和式（2-58）可得：
```
(
)
1 o1
o2
o3
1
A
in
o1
o2
o3
o1 o2
2
2
2
m
m
m
m
g r
r
r
g
v
v
r
r
r
r r g
g
−
+
=
≈ −
+
+
+
       （2-60） 
```
在式（2-60）中，我们假定 M1和 M2的宽长比相同，且 ro2 = ro3，那么 vA/vin的值约为-2。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 33（a）恒流源负载共源共栅放大器电路（图 2- 32）的小信号模型等效电路； [desc]
（b）模型简化后的等效电路 
下面比较共源放大器和共源共栅放大器中输入管 M1 的栅漏电容 CGD 对电路性能的影响。图 2- 34 和图 2- 35 分别是共源级和共源-共栅级放大器中 CGD电容的密勒效应原理图。根据密勒定理（详见第 5 章），我们可以得到图 2- 34 中共源放大器中的 C11 = (1-A1)CGD，C12 = (1-1/A1)CGD，其中 A1 为共源放大器的电压增益。一般情况下，共源放大器的电压增益 A1 比较大，因此密勒效应将在输入端口引入较大的寄生电容。该寄生电容对电路的频率特性有较大影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 35 共源-共栅级放大器中 CGD电容的密勒效应原理图 [desc]
同样对图 2- 35 所示的共源共栅放大器电路，根据密勒定理可得图中的 C21 = (1-A2)CGD，C22 = (1-1/A2)CGD，其中 A2为共源共栅放大器的共源极的电压增益，由式（2-60）可知，vA对 vin 的增益较小，因此在输入端的寄生电容较小。共源共栅放大器合适于对高频小信号的放大。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 36 [desc]
2.2. 图 2- 37 所示的是共源共栅电路，计其电压增益和输出电压范围的一般表达式，并与图 2- 31中的共源共栅电路进行比较讨论。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 37 [desc]
2.3. 在图 2- 37 所表的共源共栅电路中 设偏置电流为 50 μA，V+ = 3V， V－= 0。输出电压摆幅为 1.9V，(W/L)1~4 =W/L，且忽略背栅效应(γ = 0)。计算 VG2、VG3与 W/L，如果 L＝0.5μm求此时的电压增益。 器件参数：μnCox=100 μA/V2，μnCox=50 μA/V2，VTHn=+0.7 V，VTHp=-0.7 V。
2.4. 在图 2- 37 所示的共源共栅电路中，VG2从 0 升高到 VDD 画出小信号电压增益 vout/vin随之变化的曲线，设 λ= γ =0。
2.5. 图 2- 38 是共漏电压缓冲器."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 38 [desc]
器件参数： gmb = 0.1 gm，VTHn= 0.9 V，L = 1μm，μnCox = 100 μA/V2，λn = 0.04V-1，RS = 5 kΩ，ISUP = 250 μA，roc = 100 kΩ,，RL=2.5kΩ"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 38 __ 75V，求出 MOSFET 的宽。 [desc]
计算直流偏置时可以忽略沟道长度调制效应和背栅效应。
(b) 放大器的直流功耗？注意虚线框中的元件是用于小信号分析。
(c) 求出以下小信号参数：gm、ro、CGS、ＣGD和 CSB。可以忽略ＣGB以及金属布线电容。参数：Cjn = 0.1fF/μm2，φB = 0.9V（源漏扩散层），Cox  = 4.6fF/μm2， Cov=0.5 fF/μm，Cjswn=0.2 fF/μm。源/漏与 poly-Si 栅的叠交部分 LD = 0.1μm，Ldiff = 2μm。
(d) 求出该共漏放大器的双端的模型参数.
(e) 当考虑 RL和 RS时 Av = vout/vin表达式.
(f) 如果用 RSUP 来代替偏置电流源,而不改变直流输出电压的值 VOUT=0.75V， 则 RSUP 需要的值?
(g) 如果将(f)中计算出的 RSUP作为偏置电流源的内阻，那么当考虑 RS和 RL后放大器电压增益为多少?
2.6. 如图 2- 39 所示的 NMOS 共栅电流缓冲器."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 2- 38 __ 图 2- 39 [desc]
器件参数: VT = 0.5V；L = 1μm；μnCox = 100 μA/V2，λn = 0.04V-1，RS = 10KΩ，ISUP = 200 μA，roc = 100 kΩ；RL=50 kΩ；VBIAS=2V；IBIAS=200 μA
(a) 当源电压为 1V 时，在所列出的偏置条件下，求 MOS 管的宽；
(b) 求放大器的输入阻抗 RIN
(c) 求放大器的输出阻抗 ROUT
(d) 求放大器增益 iout/is
(e) 最大输出电流摆幅。注意每个电流源需要 0.5V 的# 2.4. 在图 2- 37 所示的共源共栅电路中
VG2在0升高至VDD之间，画出小信号电压增益vout/vin随之变化的曲线，设 λ= γ =0。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 图 2- 38 是共漏电压缓冲器 [desc]
器件参数： gmb = 0.1 gm，VTHn= 0.9 V，L = 1μm，μnCox = 100 μA/V2，λn = 0.04V-1，RS = 5 kΩ，ISUP = 250 μA，roc = 100 kΩ,，RL=2.5kΩ。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 34 [desc]
(a) 如果设 VG=1.85V 并且对应的 VOUT = 0.75V，求出 MOSFET 的宽。计算直流偏置时可以忽略沟道长度调制效应和背栅效应。
(b) 放大器的直流功耗？注意虚线框中的元件是用于小信号分析。
(c) 求出以下小信号参数：gm、ro、CGS、ＣGD和 CSB。可以忽略ＣGB以及金属布线电容。参数：Cjn = 0.1fF/μm2，φB = 0.9V（源漏扩散层），Cox  = 4.6fF/μm2， Cov=0.5 fF/μm，Cjswn=0.2 fF/μm。源/漏与 poly-Si 栅的叠交部分 LD = 0.1μm，Ldiff = 2μm。
(d) 求出该共漏放大器的双端的模型参数.
(e) 当考虑 RL和 RS时 Av = vout/vin表达式.
(f) 如果用 RSUP 来代替偏置电流源,而不改变直流输出电压的值 VOUT=0.75V， 则 RSUP 需要的值?
(g) 如果将(f)中计算出的 RSUP作为偏置电流源的内阻，那么当考虑 RS和 RL后放大器电压增益为多少?"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 如图 2- 39 所示的 NMOS 共栅电流缓冲器 [desc]
器件参数: VT = 0.5V；L = 1μm；μnCox = 100 μA/V2，λn = 0.04V-1，RS = 10KΩ，ISUP = 200 μA，roc = 100 kΩ；RL=50 kΩ；VBIAS=2V；IBIAS=200 μA 
(a) 当源电压为 1V 时，在所列出的偏置条件下，求 MOS 管的宽； 
(b) 求放大器的输入阻抗 RIN 
(c) 求放大器的输出阻抗 ROUT 
(d) 求放大器增益 iout/is 
(e) 最大输出电流摆幅。注意每个电流源需要 0.5V 的偏置才工作正常. "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 7 如图 2- 40 所示的双端口模型，如果 RIN＝100Ω，ROUT＝10kΩ，RS＝100Ω 以及 RL ＝10kΩ [desc]
求： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 35 __ 7 题中电路的各个参数。参数器件参数如下： [desc]
(a) RIN＝10 kΩ，ROUT＝100 Ω，RS＝100 Ω 以及 RL＝10 kΩ 
(b) RIN＝100 Ω ，ROUT＝10 kΩ，RS＝10 kΩ 以及 RL＝100 Ω "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 如图 2- 41 所示 NMOS 共源放大器电路 [desc]
器件参数：W/L=50/5；VTN = 1V；μnCox = 50 μA/V2；λn = 0.03V-1，roc→∞ 
(a) RD和 VBIAS的值，使 ID＝500μA 时，VOUT＝0V 
(b) 双端口模型参数 RIN和 ROUT 
(c) 跨导 
(d) 电压增益 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 11 按如图 2- 42 所示 NMOS 共栅放大器，电流源偏置，输入信号为小信号电流。求在ISUP=100μA，VOUT=0V 条件下的各电路参数。 [desc]
器件参数：W/L=50/5；VTHn = 0.7 V；μnCox = 75 μA/V2；λn = 0.02V-1，roc = ro 
(a)  IBIAS的值 
(b)  计算双端口的模型中 RIN和 ROUT参数 
(c)  计算电流增益 
(d)  计算跨导 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 13 如图 2- 43 所示 [desc]
共漏放大器，电流源偏置，输入小信号电压。 
器件参数：W/L=20/2；VTHn = 0.7 V；μnCox = 100 μA/V2；λn = 0.05V-1，roc = ro  
求： 
(1)  在 ISUP=200μA，VOUT＝0V 条件下，求 VBIAS的值 
(2) 计算双端口参数 RIN和 ROUT 
(3) 计算电压增益 
(4) 计算跨导 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 如图 2- 44 所示 PMOS 共漏放大器，电流源偏置，输入小信号电压。 [desc]
器件参数：W/L=20/2；VTP = -0.7 V；μnCox = 25 μA/V2；λp = 0.05V-1，roc = ro  
（1）ISUP=200μA，VOUT＝0V 条件下，求 VBIAS的值 
（2）计算双端口参数 RIN和 ROUT 
（3）计算电压增益 
（4）计算跨导 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 如图 2- 44 所示 PMOS 共漏放大器，电流源偏置，输入小信号电压。 __ 参考文献 [desc]
[1] Ravavi B. 模拟 CMOS 集成电路设计. 西安： 西安交通大学出版社， 2003
[2] 陈邦媛. 射频通信电路. 科学出版社，2002"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 如图 2- 44 所示 PMOS 共漏放大器，电流源偏置，输入小信号电压。 __ 38 [desc]
* [6] David A Johns and Ken Martin. Analog Integrated Circuit Design, John Wiley & Sons, Inc.1997 
* [7] Roubik Gregorian. Introduction to CMOS OP-AMPS and Comparator. John Wiley & Sons, Inc.1999 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 第 3 章 电流镜与差分放大器 [desc]
在前一章中，我们已经学习了 MOS 管电流源，本章将进一步分析电流源种类和性能以及在电路中的基本应用。在此基础上，我们要介绍在模拟集成电路中被广泛使用的电流镜电路的结构和性能。另外，在本章中还要介绍差分放大器的基本概念、电路和性能，说明差分放大器在模拟集成电路设计中的作用。最后讨论电流镜负载的双端输入单端输出的差分放大电路的性能。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 MOS 电流源 [desc]
图 3- 1 中 MOS 管工作在饱和区。如果不考虑沟道长度调制效应，那么电流源或电流阱的电流大小与漏源电压无关[1,2]，所以从图 3- 1 中的 MOS 管的漏极看进去，其电流是不变的，是一个理想的电流源。如果考虑沟道长度调制效应，那么 MOS 管的电流-电压关系为： 
(
) (
)
2
DS
n
ox
GS
TH
DS
1
1
2
W
I
C
V
V
V
L
μ
λ
=
−
+
根据式（3-1），将 VDS对 IDS求导，可得 MOS 的交流电阻为： 
o
DS
1
r
= λI
业界时尚文化随后的 文本 这里 开始 爱情 结束 感谢到 来  
                             (3-2) 
从式（3-2）可知，电流源的输出电阻与 λ 系数和直流电流 IDS的值成反比。电流 IDS的值越大，则 ro的值越小，与理想的电流源距离就越大。另外，式（3-2）的计算结果是在一阶模型基础上得到的，适合于沟道长度大于 10μm 的长沟道器件和沟道低掺杂的条件[3,4]。我们知道 λ 系数与沟道长度成反比[2]，因此在亚微米工艺条件下，电流源的输出电阻将降低。因此在设计电流源时，要根据实际需要设定 MOS 管的沟道长度。
为了保证图 3- 1 所示 NMOS 管和 PMOS 管工作在饱和区，NMOS 和 PMOS 管的端口电压分别需要满足饱和工作条件： 
OUT
G
THn
V
V
V
≥
−
                         (3-3) 
理想的电流源不仅需要输出电阻大，而且需要电压的工作范围宽。输出电阻越大，则在工作电压范围内，电流源越恒定。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 16 [desc]
(2) 计算双端口参数 RIN和 ROUT 
(3) 计算电压增益 
(4) 计算跨导 
如果 ISUP=20μA，计算题 2.15 中的参数 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 39 第 3 章 电流镜与差分放大器 [desc]
在前一章中，我们已经学习了 MOS 管电流源，本章将进一步分析电流源种类和性能以及在电路中的基本应用。在此基础上，我们要介绍在模拟集成电路中被广泛使用的电流镜电路的结构和性能。另外，在本章中还要介绍差分放大器的基本概念、电路和性能，说明差分放大器在模拟集成电路设计中的作用。最后讨论电流镜负载的双端输入单端输出的差分放大电路的性能。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 基本电流镜 [desc]
根据3.1节的介绍，我们知道可以利用 MOS 管饱和区的特性，用 NMOS 管、PMOS 管和偏置电压构成电流源和电流阱，而其电流大小则可用式（3-1）计算。为了得到稳定的电流源，需要保证式（3-1）中的各项参数的值在工艺条件、电源电压和温度变化时保持稳定。但是，随着工艺的进步，一些问题需要注意：在超深亚微米工艺条件下，器件参数的变化对器件性能的影响变得越来越显著[5-7]。而且，我们希望 MOS 管的栅压 VGS能够保持稳定，不受环境温度和电源电压的影响。但是，在实际情况中，我们无法直接通过基准电压源生成电流源，而是需要设计一个精确的参考电流源 IREF，然后复制这个精确的电流源，从而产生我们需要的电流源和电流阱。
图 3- 2 显示了一个基本的电流镜电路。在这里，参考电流源 IREF通过二极管连接的 M1产生参考电压 VREF，然后 VREF被加在 M2的栅上，从而产生电流源。为了计算输出电流 IOUT的值，我们在这里假设 M1和 M2是匹配的，即它们的阈值电压 VTH、载流子迁移率和栅氧化层厚度都是相同的。这是可行的，因为在集成电路工艺中，我们可以设计匹配的MOS管。另外，我们会在计算大信号特性时忽略MOS管的电阻。
按照上述条件，我们可以计算出 M1 和 M2管栅上的电压 VREF，结果可以用式（3-5）表示：
REF
REF
THn
n
ox
1
2
I
V
V
C
W
L
μ
=
+
⎛
⎞
⎜
⎟
⎝
⎠
                     (3-5)
我们可以进一步计算出直流输出电流 IOUT的值：
(
)
2
REF
OUT
n
ox
THn
THn
2
n
ox
1
1
2
/
/ 2
I
W
I
C
V
V
L
W L
C
μ
μ
⎛
⎞
⎛
⎞ ⎜
⎟
=
+
−
⎜
⎟ ⎜
⎟
⎝
⎠ ⎝
⎠
           (3-6)
然后，我们可以得到输出电流 IOUT与参考电流 IREF之间的关系：
(
)
(
)
2
OUT
REF
1
/
/
W L
I
I
= W L
                          (3-7)
我们可以看到，输出电流 IOUT与参考电流 IREF之间的关系是 M2管的几何尺寸与 M1管的几何尺寸之比。这意味着我们可以通过调整 MOS 管的几何尺寸，按比例精确地设计输出电流源 IOUT。
从例3.1，我们可以看到，设计共源共栅的电流源可以有效地提高电流源的小信号电阻。在这种电流源中，输出电流 IOUT与 IREF的关系也是按(W/L)2/(W/L)1 的比例关系，而且由于共源共栅结构，输出电阻得到了显著提高。共源共栅电流源的输出电阻可以用式（3-8）计算：
(
)
S
m4 o4
o2
R
g
r
r
≈
                        (3-8)
电流源也可以用双极晶体管和同样的结构构成，但是需要考虑基极电流的存在。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 基本电流镜 __ 3 M1 和 M2管栅上的电压 VREF [desc]
REF
REF
THn
n
ox
1
2
I
V
V
C
W
L
μ
=
+
⎛
⎞
⎜
⎟
⎝
⎠
                     (3-5) 
可以得到直流输出电流 IOUT为：  
(
)
2
REF
OUT
n
ox
THn
THn
2
n
ox
1
1
2
/
/ 2
I
W
I
C
V
V
L
W L
C
μ
μ
⎛
⎞
⎛
⎞ ⎜
⎟
=
+
−
⎜
⎟ ⎜
⎟
⎝
⎠ ⎝
⎠
           (3-6) 
即，
(
)
(
)
2
OUT
REF
1
/
/
W L
I
I
= W L
                          (3-7) 
可以看到输出电流 IOUT与 IREF之间的关系是 M2管与 M1管的几何尺寸之比。
这样我们可以通过 MOS 管的几何尺寸的调整，按比例精确设计输出电流源 IOUT。
应该注意式（3-7）的条件： 
1. 参考电流源通过二极管连接的 M1产生参考电压； 
2. 相同的参考电压加在 M2 管的栅上产生输出电流 IOUT； 
3. 由于 M1管和 M2 管满足匹配条件，即 M1 管和 M2 管的开启电压、载流子迁移率等完全相同，因此 IOUT与 IREF的关系是 M2与 M1 的几何尺寸比例关系。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 分析图3- 3所示的图3- 2电路的小信号模型 [desc]
参考电流源开路，M1 是二极管连接的 MOS 管，产生直流偏置电压 Vref。注意在图 3- 3 中，尽管画了 M2管的压控电流源，但由于其小信号电压 vgs2为零，因此 M2 管的小信号模型是一个电阻 ro2。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 电路的大信号等效电路 [desc]
电流源具有一个与M1 管和 M2 管的宽长比有关的大信号电流，以及以 M2 管小信号电阻的内阻。图3- 4 的模型仅仅在 M1 和 M2 管工作在饱和区时成立。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 产生多路电流源电路 [desc]
为提高电流源的小信号电阻，我们可以设计共源共栅的电流源，如图 3- 5 所示。在这个电路中，输出电流 IOUT与 IREF的关系还是按(W/L)2/(W/L)1 的比例关系，而输出电阻由于共源共栅结构得到大大提高。在以前的讨论中，我们知道 M2 和 M4 管组成了共源共栅结构，因此共源共栅电流源的输出电阻为 
(
)
S
m4 o4
o2
R
g
r
r
≈
                        (3-8) 
电流源用双极晶体管和同样的结构也可以构成，但是需要考虑有基极电流的存在。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 产生多路电流源电路 __ 1 设计一个共源共栅结构的电流源 [desc]
出直流电流为 10μA 和 100 MΩ 小信号输出电阻，IREF =10μA。M4 管的漏极电压为 2.0V，但需要维持高的输出电阻。注意要点：M2和 M4在饱和区工作，忽略背栅效应。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 10 电流源与电流阱电路 [desc]
对地电流源也称为电流源，但按电流的流向，我们应该正确地称之为电流阱或电流漏[3]。PMOS 管也可以构成电流源。如果我们将一个稳定的电压源加到多个 MOS 管上，那么可以构成如图 3- 6 所示的多电流源。 
每个电流源的值可以通过改变这些 PMOS 管的宽长比设定，输出电流为 
(
)
(
)
n
OUTn
REF
R
/
/
W L
I
I
= W L
                      (3-9) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 电流源与电流阱电路图 [desc]
如果需要电流阱，那么可以按图 3- 7 所示方法设计与电流源的电流值成比例的电流阱。M1 管的输出电流作为参考电流并产生M3 管的电压源，并加到 M4 管而建立电流阱。输出直流电流源的值为：
(
)
(
)
1
OUT1
REF
R
/
/
W L
I
I
= W L
                       (3-10) 
得到 M2管中的电流源电流：
(
)
(
)
2
OUT2
REF
R
/
/
W L
I
I
= W L
                        (3-11) 
相应的 M4管中电流阱电流为:
(
)
(
)
(
)
(
)
(
)
(
)
4
4
1
OUT4
OUT1
REF
3
3
R
/
/
/
/
/
/
W L
W L
W L
I
I
I
W L
W L
W L
⎛
⎞
=
=
×
⎜
⎟
⎜
⎟
⎝
⎠
          (3-12)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 电流源与电流阱电路图 __ 2 设计一个产生 10μA 和 20μA 的电流源，以及 10μA 和 40μA 的电流阱的电路 [desc]
需要10 MΩ小信号电阻。电流源与电流阱的VDS,SAT小于 0.5V。有一个 10μA 的基准电流源，可用于驱动其他器件。
器件参数如下：VTHn=1V；VTHp= -1V；µnCox=50 µA/V2；µpCox=25 µA/V2；λn=λp =0.1V-1@L=1µm。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 [desc]
在图 3- 6 中有三个电流源，如果也需要电流阱，那么可以按图 3- 7 所示方法设计与电流源的电流值成比例的电流阱。M1 管的输出电流作为参考电流并产生M3 管的电压源，并加到 M4 管而建立电流阱。输出直流电流源的值为： 
```
(
)
(
)
1
OUT1
REF
R
/
/
W L
I
I
= W L
                       (3-10) 
```
这样，我们可以得到 M2管中的电流源电流： 
```
(
)
(
)
2
OUT2
REF
R
/
/
W L
I
I
= W L
                        (3-11) 
```
相应的 M4管中电流阱电流为： 
```
(
)
(
)
(
)
(
)
(
)
(
)
4
4
1
OUT4
OUT1
REF
3
3
R
/
/
/
/
/
/
W L
W L
W L
I
I
I
W L
W L
W L
⎛
⎞
=
=
×
⎜
⎟
⎜
⎟
⎝
⎠
          (3-12) 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 __ 设计一个产生 10μA 和 20μA 的电流源，以及 10μA 和 40μA 的电流阱的电路 [desc]
所有电流源与电流阱的小信号电阻需要大于 10 MΩ。电流源与电流阱的VDS,SAT小于 0.5V。有一个 10μA 的基准电流源，可用于驱动其他器件。 
器件参数如下：VTHn=1V；VTHp= -1V；µnCox=50 µA/V2；µpCox=25 µA/V2；λn=λp =0.1V-1@L=1µm。
设定(W/L)1 = (W/L)2 = 1.6，ID1 = ID2 = 10µA，那么为了使 ID3 = 40µA，让(W/L)3 = 4(W/L)2 = 6.4。
于 ID = 10µA 以及 L = 1μm 条件下 λn = λp = 0.1V-1，需要 L = 10μm 保证小信号输出电阻 RS = 10 MΩ。对于 ID = 20µA，我们需要 L = 20μm；。对于 ID = 40µA，我们需要 L = 40μm。
因此，综合以上结果，器件的设计参数为：(W/L)R = (W/L)1 = (W/L)2 = 16/10，(W/L)4 = (W/L)5 =32/10，(W/L)3 = 256/40，(W/L)6 =128/20。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 __ 差分放大器 [desc]
差分放大器是一种经典的放大器，它处理两个输入信号的差值，而与输入信号的绝对值无关。
差分放大器可用于去除两个信号源中不需要的共模信号，仅放大差分信号。
在图 3- 10 中采用 V +和 V -电压供电，并设电源电压可以保证器件工作在饱和区。加电流源的目的是将输出电压设置在 V +和 V -电压的中间值。
考虑大信号电压相同的情况，即 VI1 = VI2，并且小信号输入电压为零，因此可以得到 VIN1 = VIN2。
考虑如图 3- 10 所示的基本差分放大器电路。
图 3- 10 电阻负载基本差分放大器电路 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 __ 差分放大器 __ 差分放大器的基本概念 [desc]
设 RD1 = RD2 = RD，因此 IBIAS需要满足以下关系： 
```
BIAS
1
2
D
2V
I
I
I
R
+
=
+
=
                    (3-18) 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 __ 差分放大器 __ 共模与差模信号 [desc]
设有两个信号 x1和 x2，这两个信号对所要分析的差分电路来讲，可以是电压也可以是电流。
差模信号 xDM定义为这两个信号的差值，而共模信号 xCM定义为两个信号的平均值，分别表示为：
```
DM
1
2
x
x
x
=
−
                        (3-19) 
```
```
1
2
CM
2
x
x
x
+
=
                        (3-20) 
```# 3. RD1电阻，输出电压为 VO1
设 RD1 = RD2 = RD，因此 IBIAS需要满足以下关系：
```
BIAS
1
2
D
2V
I
I
I
R
+
=
+
=
                    (3-18) 
```
由于 M1 和 M2 是匹配的，并且 VI1=VI2，因此 IBIAS 可根据式（3-18）求出。也就是说如果 IBIAS满足式（3-18），那么可以保证 VO1 和 VO2 的直流输出电压为零。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流源与电流阱电路图 __ 差分放大器 __ 图 3- 24 MOS 差分放大器的差模频率响应分析 [desc]
解：当输入差分电压 vid=0 时，为保证共模输出电压为零，需满足： I_D=（v_o1 - v_o2）/ 2R = 0V - 2.5V = -50μA， 
因此， RD = 2 * 2.5V / 50μA = 100kΩ 
利用已经求出的 RD值和需要达到的差模增益 Adm= -50，可以求 gm以及 MOS 管的 W/L。  Adm = – g_m * R_D / r_o = – g_m * R_D 
所以， Adm = – g_m * R_D = – 50 , g_m = 0.5 mS 
另外，由于 I_BIAS = 1/2 * µ_n * W / L * Cox * (V_GS – V_TH),  
可以得到：  W/L = 2 * 2 * g_m / (µ_n * Cox * I_BIAS) = 200/2 ， 如果为保证频率响应取 L = 2µm，则(W/L)1,2 = 200/2。 
注意：对 L=2µm，λn=0.02V-1，那么，MOS 管的小信号输出电阻： r_o = 1 / λn * I_BIAS = 1 MΩ。
由此可见，ro较 RD大得多，因此我们可以在计算 Adm时，可忽略 ro。  C_gs = 2/3 * W * L * Cox + 2 * W * Cov = 0.37pF,  C_gd = W * Cov = 0.1pF  
3dB 带宽可以用 Miller 近似方法求得： C_M = g_m * C_gd * R_D = 5pF,  f_3dB = 1 / (2π * R_S * (C_M + C_gs)) = 5.97MHz "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 [desc]
器件参数：VTHn = 1V，µnCox= 50µA/V2，λn= 0.02V-1@L =2µm，Cox=1fF/µm2，Cov=0.5  
...
其他内容请查看[此处](https://简书.com/e/ufd4c1034aaf)。
---table begin---
Table title:器件参数表
| 参数名称 | 参数值  |
|--------------|---------------|
| VTHn   | 1V                |
| µnCox  | 50µA/V2  |
| λn       | 0.02V-1  |
| L          | 2µm      |
| Cox      | 1fF/µm2  |
| Cov      | 0.5fF/µm |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 单端输出差分放大器 [desc]
双端输入单端输出被定义为输出端的电压对地。输入端的输入信号是两个电压源可能包含差分与共模。
其他内容请查看[此处](https://简书.com/e/ufd4c1034aaf).# μA / V(0.4V) 2 2 I W L C V V μ ⎛ ⎞ = = = ⎜ ⎟ ⎝ ⎠ − × ×
按对 CMRR 值的要求，将决定 M3 和 M4 管的沟道长度 L。如果沟道的长与宽的值较大，那么相应有较大的寄生电容，会使 CMRR 频率响应变差。为达到直流条件下的 CMRR 为 2500，（Adm=-50），我们需要：
dm cm 50 0.02 CMRR 2500 A A = = − = −
又因为： m D D cm m o3 o3 1 2 2 g R R A g r r − = − ≈ +
所以： D o3 cm 100k 2.5M 2 2 (0.02) R r A − Ω = − = = Ω × −
又因为 o3 n BIAS 1 r = λ I ，所以
1 n o3 BIAS 1 1 0.008V 125V r I λ − = = =
按题意 1 n( 2μm) 0.02V L λ − = = 。 由于 n λ ∝1/ L ，因此我们需要 3,4 2.5 2μm 5μm L = × =
所以 3,4 12.5 5 62.5 65 5 5 5 W L × ⎛ ⎞ = = ≈ ⎜ ⎟ ⎝ ⎠
为分析频率响应，我们需要找出在 M3 漏极的电容 CE，CE 包含有： Csb1+Csb2+Cdb3+Cgd3。
gd3 3 ov 65μm(0.5fF/μm) 32.5fF C W C = × = × =
Csb1,2 和 Cdb3 电容值可从版图中标出：设 M1 和 M2 的源极面积均为 200µm×5µm，M3 的漏与 M1 和 M2 的源共用。M1 和 M2 源极被场氧化层（5µm +200µm）包围。设 M3管的漏面积是 65µm×2µm。因为 M3 的漏与 M1和 M2的源共用，因此周长较小，设场氧化层包围的区域为 2µm+2µm。 
sb1 sb2 jn jswn (200μm 5μm) (5μm 200μm) 2 182fF C C C C = = × + + × =
db3 jn jswn (65μm 2μm) (2μm 2μm) 2 17fF C C C = × + + × =
因此总电容为： E sb1 sb2 db3 gd3 182fF 182fF 17fF 32.5fF 414fF C C C C C = + + + = + + + ≈"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 59 CMRR 减少差分放大器的 3dB带宽 [desc]
3dB o3 E 1 1 154kHz 2 2 (2.5M )(414fF) f πr C π ≈ = = × Ω ×"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 6 单端输出差分放大器 [desc]
双端输入单端输出被定义为输出端的电压对地。输入端的输入信号是两个电压源可能包含差分与共模成分，而输出是对地电压，最简单的单端输出差分电路如图3-26所示。参照3.4.3的内容，双端输出的差分输出电压 vo可表示为： 
id o o2 cm ic dm 2 v v v A v A = = − (3-40) 其中，差模电压增益为 dm m D A = −g R ；共模电压增益为 m C cm m ob 1 2 g R A = − + g r 。
对于如图3-26所示电路，对差分输入信号的增益，从式（3-40）可以得到： o dm m D id 2 2 v A g R v = − = (3-41) 对于共模输入信号，其共模增益为： o m D cm ic m ob 1 2 v g R A v g r − = = + (3-42) 因此，共模抑制比（CMRR）为： o id m ob o ic ( / ) (1 2 ) CMRR ( / ) 2 v v g r v v + = = (3-43)
从以上分析，我们可以看到图3-26电路虽然可以完成差分到单端输出的转换，但差分增益和CMRR仅仅是对称的差分双端输出电路的50%。本节中我们设计一个单端输出的差分放大器电路，其增益与普通的双端输入双端输出差分放大器具有相同的增益。图3-27是PMOS电流镜负载放大电路。从图中，我们可以看到电流镜使流过M1管中的电流，也流过M3和M4，这样在输出端增加了电流，使输出电压增益提高2倍，达到了普通双端输出的差分放大器的增益。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 图3-27 PMOS电流镜负载的双端输入单端输出差分放大电路 [desc]
我们分析图3-27所示的差分放大器的大信号和小信号，设定在输入端的大信号电压为零，仅有小信号电压加在输入端口，即仅有 vi1和 vi2。我们分析M1管的情况，由于M1管有小信号电压 vgs1，因此小信号电流加在M1中的直流电流 IBIAS/2。因此，M1管的总电流可以表达为： BIAS D1 D1 d1 m1 gs1 2 I i I i g v = + = + (3-44) 同样，M2管的总电流可以表达为： BIAS D2 D2 d2 m2 gs2 2 I i I i g v = + = + (3-45) 由 KCL定理，M3中的电流等于M1中流过的电流。设M3和M4的输出电阻较大，PMOS管电流镜迫使流过的电流相等。 为求解这放大器的差分跨导Gmd，我们必须在输出短路的条件下，求出小信号输出电流，小信号输出电流为流过M2管和M4管电流的差值，即流过M2和M1管电流差值："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 61 o m2 gs m1 gs1 i g v g v = − (3-46) [desc]
差分输入电压为：
id i1 i2 gs1 gs2 v v v v v = − = − (3-47) 
设M1和M2管完全对称，那么 gm1= gm2=gm，因此根据式（3-46），我们得到小信号输出电流为： o m id i = −g v (3-48) 因此，差模跨导为 o md m id i G g = v = − 。 由此可见，图3-27电路完成了差分信号到单端输出的转换，并且保持了对应的全差分电路的增益。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 图3-28 PMOS电流镜的全差分放大器电路的小信号模型 [desc]
PMOS电流镜的全差分放大器电路的小信号模型如图3-28所示，流过 M1～M4管的直流电流为 IBIAS/2，这一电流对小信号分析来讲，全部设为零。由于电路结构不是全对称，因此，半边电路分析技术不能应用到该电路中。我们首先对左边电路的 io1按 KCL定理分析： sg3 o1 o3 m3 sg3 m3 sg3 o3 v i i g v g v r = = + ≈ (3-49) 上式中我们设定 m 1/ o3 g r >> ，据 KCL定理，在输出端口可写出输出短路小信号电流为：
o o2 m4 sg4 i i g v = − (3-50) 
由于vsg3= vsg4，因此，将式（3-49）代入式（3-50），可得： m4 o o2 o1 m3 g i i i g = − ⋅ (3-51) 如果M3和M4管匹配，那么 gm4= gm3，则输出电路："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __ 62 o o2 o1 i i i = − (3-52) [desc]
为计算差模跨导，我们设共模输入电压为零，求输入对管M1和M2输出短路电流。如果我们假定 o1,2 1/ m1,2 r g >> ，那么 
o1 m1 id gs2 ( ) i g v v = + (3-53) o2 m2 id gs1 ( ) i g v v = − + (3-54) 由于 id gs1 gs2 v v v =```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
跨导 Gmd，我们必须在输出短路的条件下，求出小信号输出电流，小信号输出电流为流过 M2 管和 M4 管电流的差值，即流过 M2 和 M1 管电流差值。
```
\[
o _ { m2 \_ gs }- m1 \_ gs1 \_ i _ { g } v _ { g } v = - \quad (3 - 46)
\]
差分输入电压为：
\[
id \_ i1 \_ i2 \_ gs1 \_ gs2 \_ v \_ v \_ v \_ v \_ v = - = - \quad (3 - 47)
\]
设 M1 和 M2管完全对称，那么 gm1 = gm2 =gm，因此根据式（3-46），我们得到小信号输出电流为：
\[
o \_ m \_ id \_ i = -g v \quad (3 - 48)
\]
因此，差模跨导为
\[
o \_ md \_ m \_ id \_ i \_ G = v \_ g = - \, \text { 由此可见，图 3- 27 电路完成了差分信号到单端输出的转换，并且保持了对应的全差分电路的增益 }
\]
根据以上分析，PMOS 电流镜差分放大电路完成了双端输入到单端输出的功能，并保持了较大的电压增益及较好的共模抑制性能。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 28 PMOS 电流镜的全差分放大器电路的小信号模型
PMOS 电流镜的全差分放大器电路的小信号模型如图 3- 28 所示，流过 M1～M4 管的直流电流为 IBIAS/2，这一电流对小信号分析来讲，全部设为零。由于电路结构不是全对称，因此，半边电路分析技术不能应用到该电路中。我们首先对左边电路的 io1 按 KCL 定理分析：
\[
sg3 \_ o1 \_ o3 \_ m3 \_ sg3 \_ m3 \_ sg3 \_ o3 \_ v \_ i \_ i \_ g \_ v \_ g \_ v \_ r = = + ≈ \quad (3 - 49)
\]
上式中我们设定
\[
m _ { 1 / o3 } \_ g \_ r >> \text {，据 KCL 定理在输出端口可写出输出短路小信号电流为： }
\]
\[
o \_ o2 \_ m4 \_ sg4 \_ i \_ i \_ g \_ v = - \quad (3 - 50)
\]
由于 vsg3 = vsg4，因此，将式（3-49）代入式（3-50），可得：
\[
m4 \_ o \_ o2 \_ o1 \_ m3 \_ g \_ i \_ i \_ i \_ g = - \cdot \quad (3 - 51)
\]
如果 M3 和 M4 管匹配，那么 gm4 = gm3，则输出电路：
\[
o \_ o2 \_ o1 \_ i \_ i \_ i = - \quad (3 - 52)
\]
为计算差模跨导，我们设共模输入电压为零，求输入对管 M1和 M2 输出短路电流。如果我们假定 o1,2 1/ m1,2 r g >> ，那么 
\[
o1 \_ m1 \_ id \_ gs2 ( ) \_ i \_ g \_ v \_ v = + \quad (3 - 53)
\]
\[
o2 \_ m2 \_ id \_ gs1 ( ) \_ i \_ g \_ v \_ v = - + \quad (3 - 54)
\]
由于 id \_ gs1 \_ gs2 \_ v \_ v \_ v = - ，考虑到： o \_ o2 \_ o1 \_ i \_ i \_ i = - ，那么，可以得到放大器的差分跨导 Gmd 为： 
\[
o \_ o2 \_ o1 \_ md \_ m1 \_ m2 \_ id \_ gs1 \_ gs2 \_ i \_ i \_ i \_ G = g \_ g \_ v \_ v \_ v - = = - = - = - - \quad (3 - 55)
\]
上述结果表明：PMOS 电流镜差分放大器电路的跨导等于输入 MOS 管的跨导。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 29 PMOS 电流镜差分放大器电路的小信号输出电阻
以下计算双端输入单端输出的差分放大器双端口模型的参数。因为我们用
MOS 管为差分电路的输入管，所以输入阻抗近似为无穷大，即 Rin→∞。以下讨
论输出差分电阻 Rod。因为 Rod的值不明显，所以加一个电压源 vt 到输出端口，计
算其电流 it，电路图如图 3- 29 所示。差分输入电压 vid 被设置为零，即将 M1 和
M2 管的栅接到地（零电位）求输出电阻。从图 3- 29 可见，电流 it 是流过 M2和
M4 电流之差。注意到 vgs2= -vx，可得： 
t \_ x \_ t \_ t \_ o2 \_ o4 \_ m2 \_ x \_ m4 \_ sg4 \_ o2 \_ o4 \_ v \_ v \_ v \_ i \_ i \_ i \_ g \_ v \_ g \_ v \_ r \_ r \_ ⎛\⎞ - = - = - + - - ⎜\⎟ \_ ⎝\⎠ (3 - 56)
为推出 vsg4 的表达式，注意到 vsg4 = vsg3，我们可以写出 io1的表达式："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
sg3 \_ x \_ o1 \_ m \_ x \_ o1 \_ sg3 \_ o3 \_ m3 \_ sg3 \_ o3 ( ) \_ v \_ v \_ i \_ g \_ v \_ r \_ v \_ i \_ g \_ v \_ r = - + = = + (3 - 57)
注意到 o1 \_ o3 \_ m1 \_ m3 . 1 / ,1 / r \_ r \_ g \_ g >> ，因此忽略（3-57）式中的 vsg3/ro1 和 vsg3/ro3 项，可得： 
m1 \_ x \_ sg3 \_ x \_ m3 \_ m3 \_ o1 \_ g \_ v \_ v \_ v \_ g \_ g \_ r = - − (3 - 58) 
由于器件匹配，gm1=gm2，gm3=gm4，并且设 ro1=ro3 和 ro3=ro4，将式（3-58）代入式（3-56）可得： 
t \_ t \_ o2 \_ o4 \_ 1 \_ 1 \_ i \_ v \_ r \_ r \_ ⎛\⎞ = + \_ ⎜\⎟ \_ ⎝\⎠ (3 - 59) 
从式（3-59）可得到，差分输出电阻是 PMOS 和 NMOS 管小信号电阻的并联值，即： 
od \_ o2 / / o4 \_ R \_ r \_ r = (3 - 60)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 30（a）单端输出差分放大器的双端口模型；（b）戴维南等效输出电路
因此，我们可以画出单端输出差分放大器的双端口模型，如图 3- 30（a）所
示，其戴维南等效电路为图 3- 30（b）。其中，Avd的为差分小信号开路电压增益，
可表达为： 
vd \_ m1 \_ o2 \_ o4 ( ) \_ 0.1mS \_ 500kΩ \_ 50 \_ A \_ g \_ r \_ r = = × = （） (3 - 61) 
注意：电流镜负载的双端输入单端输出差分放大器较图 3- 26 所示的电阻负载差分电路的增益增加了一倍。这一事实证明了电流镜负载差分放大器作为双端输入单端输出的优点。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 31（a）PMOS 电流镜负载双端输入单端输出差分放大器共模小信号半边电路模型；（b）忽略 ro1和 ro3后的简化模型 分析共模输入响应问题，将差分输入信号设为零。共模输入信号将在两输出端口输出相等的电流 io1和 io2电流。电路使 M1和 M3 的漏源电流相等，即 io3=io1。设 o3,4 1/ m3,4 r g ，那么 PMOS 电流镜的结构使 M3和 M4 的漏电流相等。因此，在共模条件下，电路的特征是完全对称的，所以可以用半电路技术来分析。图 3- 31（a）是共模半边电路小信号模型。因为 o1,o3 1/ m1,3 r g ，为简化分析可忽略 M1 和 M3 管的输出电阻 ro1和 ro3，小信号电路简化如图 3- 31（b）所示。根据图 3- 31（b）所示电路，注意到偏置电流源内阻为 2rob，我们可以求出共模增益为：
o _ m1 _ m3 _ vc _ ic _ m1 _ ob _ m3 _ ob / 1 _ 1 _ 0.005 _ 2 _ 2 ( 0.1mS ) _ ( 1MΩ ) _ A _ g r = - = = = - × × (3 - 62)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
例 3.6 PMOS 电流镜差分放大器
计算如图 3- 32 所示的 PMOS 电流镜差分放大器的 Avd，Avc和 CMRR。设所有器件的尺寸已被调整，使器件工作在饱和区，其中 gmn=gmp=0.1mS，以及 ron=rop=1MΩ。 
解：求解 Avd，可用式（3-61）：
vd \_ m1 \_ o2 \_ o4 ( ) \_ 0.1mS _ 500kΩ _ 50 \_ A \_ g \_ r \_ r = = × = 
求解 AVC，可用式（3-62）： 
vc _ m3 _ o5 _ 1 _ 1 _ 0.005 _ 2 _ 2 ( 0.1mS ) _ ( 1MΩ ) _ A _ g r = - = = = - × × 
所以， vd _ vc _ 50 _ CMRR _ 10,000 _ 0.005 _ A = A = = 
假设，我们需提高 CMRR，那么按式（3-62），我们应该提高电流源器件 M5的输出电阻 ro5，但这样做仅仅能将 CMRR 的低频值提高，因为 CMRR 的 3dB 值为： 3dB _ o5 _ E _ 1 _ r _ C _ ω =. 因此。
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
如图 3- 30（a）所示，其戴维南等效电路为图 3- 30（b）。其中，Avd的为差分小信号开路电压增益，可表达为： 
```
vd
md
od
m1
o2
o4
(
)
A
G
R
g
r
r
= −
=
�
                (3-61)
```
注意：电流镜负载的双端输入单端输出差分放大器较图 3- 26 所示的电阻负载差分电路的增益增加了一倍。这一事实证明了电流镜负载差分放大器作为双端输入单端输出的优点。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 31（a）PMOS 电流镜负载双端输入单端输出差分放大器共模小信号半边电路模型；（b）忽略 ro1和 ro3后的简化模型 
分析共模输入响应问题，将差分输入信号设为零。共模输入信号将在两输出端口输出相等的电流 io1和 io2电流。电路使 M1和 M3 的漏源电流相等，即 io3=io1。设 o3,4
1/ m3,4
r
g
�，那么 PMOS 电流镜的结构使 M3和 M4 的漏电流相等。因此，在共模条件下，电路的特征是完全对称的，所以可以用半电路技术来分析。图 3- 31（a）是共模半边电路小信号模型。因为 o1,o3
1/ m1,3
r
g
�，为简化分析可忽略 M1 和M3 管的输出电阻 ro1和 ro3，小信号电路简化如图 3- 31（b）所示。根据图 3- 31（b）所示电路，注意到偏置电流源内阻为 2rob，我们可以求出共模增益为： 
```
o
m1
m3
vc
ic
m1 ob
m3 ob
/
1
1
2
2
v
g
g
A
v
g
r
g
r
−
=
= −
≈
+
               (3-62) 
```
从以上分析可以看到 PMOS 电流镜差分放大电路完成了双端输入到单端输出的功能，并保持了较大的电压增益及较好的共模抑制性能。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
例 3.6  PMOS 电流镜差分放大器 
计算如图 3- 32 所示的 PMOS 电流镜差分放大器的 Avd，Avc和 CMRR。设所有器件的尺寸已被调整，使器件工作在饱和区，其中 gmn=gmp=0.1mS，以及ron=rop=1MΩ。 
解：求解 Avd，可用式（3-61）：
```
vd
m1
o2
o4
(
)
0.1mS 500kΩ
50
A
g
r
r
=
=
×
=
�
。 
```
求解 AVC，可用式（3-62）： 
```
vc
m3 o5
1
1
0.005
2
2 (0.1mS) (1MΩ)
A
g r
−
= −
=
= −
×
×
```
所以，
```
vd
vc
50
CMRR
10,000
0.005
A
= A
=
=
```
假设，我们需提高 CMRR，那么按式（3-62），我们应该提高电流源器件 M5的输出电阻 ro5，但这样做仅仅能将 CMRR 的低频值提高，因为 CMRR 的 3dB 值为：
```
3dB
o5
E
1
r C
ω
=
。因此，提高 ro5的值将使 ω3db的值下降。 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 MOS 差分放大器的共模抑制比（CMRR）计算。 __  [desc]
图 3- 32  PMOS 电流镜负载差分放大电路 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 [desc]
如图 3- 36 所示，MOS 电流源和电流阱电路中，IREF=100 µA，M3 和 M4 器件的尺寸为(W/L)R=( W/L)4=10/2。设所有器件工作在饱和区，忽略背栅效应。
- （a） 当 IOUT1=40µA 时，求(W/L)1
- （b） 当 IOUT2=100µA 时，求(W/L)2
- （c） 当 IOUT3=250µA 时，求(W/L)3
- （d） 当 IREF=100µA 和(W/L)R=( W/L)4 =30/2 时，求（a）~(c)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
如图 3- 37 所示，由电阻和 NMOS 管构成的电路。 
- （a） 求 NMOS 管的 W/L，假设 VOUT = 1.5V
- （b） 计算电流源的输出电阻
- （c） 如果希望输出电阻达 500Ω，计算 MOS 管的 W/L 以及在此条件下的 VOUT的值
- （d） 如果电源电压改为 4.5V，根据(c)条件下的 W/L 值，计算 VOUT的值"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 [desc]
如图 3- 38 所示电流源电路，其中 IREF=100 μA。 
- (a) 希望由 M1产生的 VREF输出电阻为 1kΩ，在此条件下的(W/L)1的值
- (b) 当 IOUT=300µA 时，求 M2的(W/L)2的值
- (c) 求电流源内阻"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 [desc]
画出 PMOS 管构成的简单电流源，重复第 3.5 题的计算要求。PMOS 管参数：VTHp=-0.7V，µpCox=75 µA/V2，λp=0.05V-1。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 [desc]
电流源电路如图 3- 39 所示，IREF=100µA，并且 MR的尺寸为(W/L)R=10/2，设所有器件工作在饱和区，忽略背栅效应。
- （a）IOUT1=40µA 时，求(W/L)1
- （b）IOUT2=100µA 时，求(W/L)2
- （c）IOUT3=250µA 时，求(W/L)3
- （d）如果 IREF=20µA，重复(a)～(c)
- （e）如果 IREF=100µA，(W/L)R=30/2 时，重复(a)～(c)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 7 [desc]
如图 3- 40 所示差分放大器，其直流偏置电压为 VI1=VI2=0V，求解 IBIAS的值，使直流输出电压为 VO1=VO2=( V + + V -)/2。
- （a）V + =2.5 V，V -= -2.5V，RD=10KΩ
- （b）V + =5 V，V -= 0V，RD=10KΩ
- （c）V + =2.5 V，V -= -2.5V，RD=5KΩ"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 [desc]
如题 3.8 的差分电路图，直流偏置 VI1=VI2=0V，按以下条件求 RD，使输出电压 VO1=VO2=( V+ + V -)/2。
- （a）V + =2.5 V，V -=2.5V，IBIAS=100µA
- （b）V + =2.5 V，V -= 0V，IBIAS=100µA
- （c）V + =2.5 V，V -= -2.5V，IBIAS=500µA"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 [desc]
如图 3- 41 所示的差分放大电路，注意输入电压是小信号电压 vi1和 vi2，按以下条件分别求出差模和共模 vid和 vic。
- （a）vi1=1mV，vi2=0.5 mV
- （b）vi1 = -1mV, vi2 = 1mV
- （c）vi1= 100.3 mV, vi2 = 101.3mV
- （d）vi1= -100 mV, vi2 = -110mV"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 10 [desc]
如图 3- 42 所示，差分放大器电路，rob的值为 25 V/IBIAS，NMOS 管的(W/L)=100/2，按图中所给的条件，求 RD的值，使当 vi1=vi2=0V 时，vo1=vo2=0V，并使用半边电路技术求 Adm，Acm以及 CMRR。
- （a）IBIAS=100µA
- （b）IBIAS=500µA"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 11 [desc]
如图 3- 43 所示差分放大电路，求双端口模型参数，并在源电阻和负载电阻分别为 RS=1kΩ和 RL=50 kΩ 时，求电路的小信号电压增益，可用半边电路近似技术。NMOS 管的尺寸（I）(W/L)=20/2；（II）(W/L)=200/2，计算
- (a) 输入差分电阻 Rid
- (b) 输出差分电阻 Rod
- (c) 差模跨导
- (d) 电路电压增益 vod / vid，注意：vod = vo1 - vo2"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 [desc]
例 3.4 中差分放大器电路中，将 NMOS 管用 PMOS 管替代，计算并分析其差模频率响应。器件参数：λp=0.05V-1，μpCox=50μA/V2，VTHp=-0.7V。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 13 [desc]
如图 3- 44 所示的双端输入单端输出差分放大电路，NMOS 管(W/L)=100/2，vi1=10mV, vi2=12mV，IBIAS=100 µA 以及 rob=100 kΩ，求：
- (a) vi1= vi2=0V，且直流输出电压为 0V 时，求 RD的值
- (b) Adm
- (c) Acm
- (d) vod/vid，其中：vid = vi1 – vi2 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 14 [desc]
如图 3- 45 所示差分双端输入单端输出差分放大器，(W/L)n=100/2，(W/L)p=50/4，IBIAS=100µA，λn=0.02V-1，λp=0.05V-1，μnCox=100μA/V2，μpCox=50μA/V2，并且 rob=100KΩ,求：
   (a) 差分跨导 io/vid 
   (b) 差分输出电阻 
   (c) 差分电压增益 Avd=vod/vid 
   (d) 共模电压增益 Acm=voc/vic  "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 [desc]
参考题 3.14 的电路图，画出 PMOS 为输入管，NMOS 为电流镜负载的双端输入单端输出的差分放大电路。(W/L)p = 100/2 ，(W/L)n = 50/4，IBIAS = 200 µA，rob = 100 KΩ，μnCox=100μA/V2，μpCox=50μA/V2。
   (a) 求差分跨导 io/vid
   (b) 差分输出电阻
   (c) 差分电压增益 Avd=vod/vid
   (d) 共模电压增益 Acm=voc/vic "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 16 [desc]
如图 3- 46 所示差分放大器电路，其中(W/L)=100/2，IBIAS = 500µA，VTHn=0.7V，μnCox=100μA/V2。设跨在电流源偏置两端的电压要 0.5V 以上。求在以下条件下的 vo1，vo2和 vx 值，并说明在各个条件下电路中的每个器件是否工作在饱和区。
   (a) VI1=0V, VI2=0V
   (b) VI1=2V, VI2=2V 
   (c) VI1=1V, VI2=0V
   (d) VI1=0V, VI2= -1.5V
   (e) VI1=0V, VI2= 0V，IBIAS=200µA
   (f) 如果将 NMOS 管的(W/L)设为 200/2，重复计算(a)～(e)
参考文献：
1.  Gray Paul R. et al. Analysis and Design of Analog Integrated Circuits. Fourth Edition, John Wiley & Sons, Inc., 2001 
2.  Behzad Rezavi, Design of Analog CMOS Integrated Circuits. The McGran-Hill Companies, Inc., 2001 
3.  Philips E Allen, Douglas R Holberg. CMOS Analog Circuit Design. Second Edition, Oxford University Press, Inc., 2002 
4.  Roger T. Howe and Charles G. Sodini. Microelectronics —An Integrated Approach. Prentice-Hall, Inc., 1997 
5.  洪志良，模拟集成电路分析与设计，北京：科学出版社，2005 
6.  David A Johns and Ken Martin. Analog Integrated Circuit Design, John Wiley & Sons, Inc.1997 
7. Roubik Gregorian. Introduction to CMOS OP-AMPS and Comparator. John Wiley & Sons, Inc.1999 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 噪声分析 [desc]
对于电子线路中所标称的噪声，可以概括地认为，它是对目的信号以外的所有信号的一个总称。任何不希望的电流电压波动信号都可以称为噪声。例如，电源电压中的纹波或突然跳变，可对电路造成不良影响，使音响装置发出交流声或导致数字逻辑电路的误动作，但也有可能并不导致上述后果。但无论如何，对于这种纹波或跳变，都应称为电路的一种噪声。在射频电路中，有某一频率的无线电波信号，对需要接收这种信号的接收机来讲，它是正常的目的信号，而对另一接收机它就是一种非目的信号，即是噪声。在数字电路中。往往可以用示波器观察到在正常的脉冲信号上混有一些小的尖峰脉冲是所不期望的，而是一种噪声。当一个噪声电压大到足以使电路受到干扰时，该噪声电压就称为干扰电压。而一个电路或一个器件，当它还能保持正常工作时所加的最大噪声电压，称为该电路或器件的抗干扰容限或抗扰度。一般说来，噪声很难消除，但可以设法降低噪声的强度或提高电路的抗扰度，以使噪声不致于形成干扰。在电子系统中，噪声是一个重要的问题，因为它限制了任何电子系统的测量、计算精确度以及电子方法能够处理的信号的大小。电路噪声有热噪声、散粒噪声、闪烁噪声等，其产生原因各不相同，噪声传播方式也不同，对应的消除或减弱方法也不同。本章主要分析 CMOS 模拟集成电路中的噪声种类，表示方法以及在各种单级放大器电路中的分析与仿真技术。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 噪声类型与在电路中的表示 [desc]
4.1.1噪声的数学表达
噪声在实际电路中是随机出现的，它与电路工作的环境，工作状态，操作方法等都有直接的关系。噪声的具体幅值是不能被预测的，是一个随机过程。因此对于噪声的研究只能通过长期的观察，建立在统计学的基础上。 
平均功率，功率谱密度与噪声整形
虽然噪声的幅值大小不能预测，但是噪声的平均功率大小是可以预测的。平均功率的定义如下： 
2
/ 2
av
/ 2
1
( )
T
T
v t
P
dt
T
R
= ∫−
噪声的相关性
在电路中，产生噪声的因素很多，我们需要考虑这些噪声是否可以直接叠加，这就是噪声的相关性。对于随机过程，我们可以采用概率论中的相关性定义。假设两个噪声源 S1(t)和 S2(t)同时作用，那么它们所产生的平均功率为：
4.1.2电路中的噪声类型和特点
1. 电阻热噪声和等效电路
在各种导体中，由于电子的随机运动导致导体两端的电压会有波动，这种波动的程度和绝对温度有关，因此，这是一种热噪声。 温度为 T，阻值为 R 的电阻的噪声电压功率谱密度为 
 76
2
nT,R
4
v
= kTR"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 噪声在电路中的表示 [desc]
1. 两端口网络的等效输入噪声
任何一个双端口网络的噪声都可以由两个位于输入端的噪声源和一个无噪网络来等效[2]，如图 4- 7 所示。
其中， `vn,in^2` 表示等效输入噪声电压源，即在电路输入端短路时，有噪网络输出噪声功率等效到输入端的值。 `in,in^2` 表示等效输入电流噪声源，即当输入端开路时，有噪网络的输出噪声功率等效到输入端的值。无噪电路内部电路结构相同和有噪电路相同，使用理想元件。
这里需要解释一下为什么同时需要一个电压源和一个电流源来等效噪声。如果只用一个电压源来等效噪声，那么在图 4- 8 中当输入电阻 Rin2趋向无穷大时，放大器输入端开路，也就是说等
---table begin---
Table tile:双端口网络噪声等效电路
| 双端口网络      | 噪声等效电路 |
|--------------|------------|
| ![a](source.c) | ![b](source.c) |
|电阻热噪声电流等效模型；（c）电阻热噪声电流等效电压模型| 器件闪烁噪声模  型，（b）等效模型 |
---table end---```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
选择名称为“gain”，即从 ADE 窗口获得的对象，然后点击“Add”/“Edit Goals”按键. 按照 F.5.1 步所介绍的方法编辑对象。编辑后的“Editing Goals”窗口如图 F- 16 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 [desc]
MOS 管还有一种闪烁噪声，它主要来源于 MOS 管的栅氧化层与硅衬底接触面的工艺缺陷和其他原因。其功率谱密度与频率的倒数成正比。该噪声可以等效为一串联在栅端的电压源，如图 4- 5 (a)所示。 
```
nf,M^2 =  K / (C * WL * f)
```
也可以转化为一个压控电流源: 
```
if,M^2 = gm^2 * (K / (C * WL * f))
```
在式(4-13)中 K 是与工艺相关的系数。f 代表频率值。因此，如果要减小闪烁噪声，只有增大 MOS 管面积。由于闪烁噪声和频率成反比，因此在低频情况下闪烁噪声值可能很大。作为 MOS 器件，噪声源既有热噪声，又有闪烁噪声，因此它的噪声谱如图 4- 6(a)所示。图 4- 6 (b)是将噪声功率谱取对数后的谱图，其结果是两条直线相交，更方便计算。转角频率值定义图中的交叉点，用于度量被闪烁噪声干扰最大的频带。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 3 噪声在电路中的表示 [desc]
1. 两端口网络的等效输入噪声 
任何一个双端口网络的噪声都可以由两个位于输入端的噪声源和一个无噪网络来等效[2]，如图 4- 7 所示。 
其中 `vn,in^2` 表示等效输入噪声电压源，即在电路输入端短路时，有噪网络输出噪声功率等效到输入端的值。 `in,in^2` 表示等效输入电流噪声源，即当输入端开路时，有噪网络的输出噪声功率等效到输入端的值。无噪电路内部电路结构相同和有噪电路相同，使用理想元件。 
这里需要解释一下为什么同时需要一个电压源和一个电流源来等效噪声。如果只用一个电压源来等效噪声，那么在图 4- 8 中当输入电阻 Rin2趋向无穷大时，放大器输入端开路，也就是说等效的输出噪声为零。这是和实际情况所不符的。因此，在这种情况下，需要一个电流源来表示噪声。那么，系统输入噪声电压等效为电流噪声源流过电阻 Rin1 所产生的噪声。
电阻足以表示任何双端口网络。
```
vn,in ^2 = v1 ^2 + v2 ^2 + 2v1 v2 = vn,in ^2
```
式（4-20）说明即使使用两个电源同时等效电路噪声，电路噪声也没有被计算两次。因此，这种等效方式是成立的.
2. 信噪比，噪声系数
在信号处理电路中，我们往往需要了解噪声对信号的影响，是否噪声能够淹没信号。 因此可以给出信噪比的定义为信号与噪声的功率之比：
```
SNR_p = S_p / N_p
```
在通常情况下，我们是用单位“分贝”表示信噪比，即：
```
SNR = 10 log (S_p / N_p)
```
如果给出的是信号和噪声电压而不是功率值，那么式(4-22)可以表示为： 
```
SNR = 20 log (S_v / N_v)
```
对于一个有噪系统来说，可以用噪声系数的概念来衡量该系统抗噪声的能力大小。 噪声系数的定义为系统输入信噪比于系统输出信噪比[2]，即： 
```
F = SNR_i / SNR_o 
或者 F = S_i/N_i / S_o/N_o
```
同样用分贝表示为：
```
NF (dB) = 10 log F
```
可以看出，噪声系数反应的是信号通过系统后，系统内部噪声对信噪比的恶化程度。 如果系统是无噪的，那么不管系统的增益多大，输入信号和噪声都同样被放大，而没有添加任何噪声，因此输入输出信噪比相同，相应的噪声系数为 1。 
3. 多级线性网络级联的噪声传递 
在复杂的电路系统中，信号的传递通路往往是由多级系统串联而成。因此不仅各级电路中会产生噪声，同时前级的噪声也会由于当前级放大器的作用而被放大。研究多级电路的噪声传递特性有助于我们在系统设计时能够合理的分配各级之间的增益，信噪比等指标。
其中 vs表示信号源输入，Gi 和 Fi 分别表示各级网络功率增益和噪声系数。 假设信号源本身是有噪的，输入噪声为 Ns。经过第一级放大器后，第一级放大器的输出噪声为 
```
No1 = Ns * G1 + N1 * G1
```
其中 No1 表示第一级放大器的输出总噪声，N1 表示由第一级放大器本身产生的等效输入噪声。 同理可得第二级放大器输出总噪声为：
```
No2 = Ns * G1 * G2 + N1 * G2 + N2 * G2
```
将噪声系数 F1，F2代入式（4-26）和式（4-27），计算
```# 4.2 单级放大器中的噪声 
在分析了电路元件的噪声特性及其基本数学特性后，我们可以研究几种典型的单级放大器的噪声特性。需要注意的是虽然这里只是介绍的几种简单放大器结构，但是在电路的噪声分析过程中我们可以通过仿真软件找到主要的噪声贡献器件和相应的电路结构，并利用下面介绍的简单放大器的分析结果来分析实际电路中的噪声产生方式和传播方式，达到有效地减小噪声对信号干扰的目的。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 1 共源级 [desc]
一个简单的共源级放大器的噪声等效模型如下所示。在图中，噪声电流源等效的是 MOS 管闪烁噪声，噪声电流源等效的是 MOS 管的沟道热噪声。表示电阻热噪声。那么该放大器的等效输入噪声如图所示，其值为： 
```
vn,in ^2 = v_nT,M ^2 + v_nT,R ^2 + v_nf,M ^2 / g_m ^2
vn,in ^2 = (4kT / g_m) + (4kT / R) + (1 / (8 * gamma * C_ox * W * L * f))
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 2 共栅级 [desc]
在图简单共栅级电路中，噪声源和简单共源级电路一样，所不同的是需要将这些噪声源等效到不同的输入端口。不过，这里需要注意在求解in,in和vn,in时的对应的不同电路状态。电路输入端开路，因此在求解in,in时所有噪声源只有电阻的热噪声电流源能够有回路形成。结果是只有该噪声源贡献输出噪声，如图所示。因此，可以求得输入等效噪声电流源为
```
in,in ^2 = 4kT / R
```
而当电路输入端短路时，所有噪声源都对输出噪声有贡献。可以求解出输入等效噪声电压源为： 
```
vn,in ^2 = v_nT,M ^2 / g_m ^2 * R + 4kT / (g_m)
vn,in ^2 = (4kT / g_m) + K / (C_ox * W * L * f * (g_m * R) ^2)
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4 共源共栅 [desc]
共源共栅电路的等效输入噪声电压模型如图所示。同样，由于输入端是栅极，输入阻抗很大，所以可以忽略噪声电流源的影响。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 1 共源级 [desc]
**声电流源为：**
```
i_n,in^2 = i_nT,R^2
⇒
i_n,in^2 = 4kT / R
```
从式 (4-31) 可以看出，电路的等效噪声电流源实际上只是由电阻 R 贡献的。
图 4- 14（a）电阻热噪声；（b）MOS 管热噪声和闪烁噪声
而当电路输入端短路时，所有噪声源都对输出噪声有贡献。可以求解出输入等效噪声电压源为：
```
v_n,in^2 = v_nT,R^2 + 2v_nT,M^2 / g_m^2 + v_nf,M^2 / (g_m * R)^2
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 2 共栅级 [desc]
```
v_n,in^2 = (4kT / g_m) + K / (C_ox * W * L * f * (g_m * R)^2)
```
共栅级电路的等效输入噪声电压模型如图 4- 15 所示。同样，由于输入端是栅极，
输入阻抗很大，所以可以忽略噪声电流源的影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4 共源共栅电路 [desc]
共源共栅电路的等效输入噪声电压模型如图 4- 16 所示。同样，由于输入端是栅极，输入阻抗很大，所以可以忽略噪声电流源的影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 5 噪声仿真技术 [desc]
噪声分析将电路在直流工作点附近线性化后，计算在输出端的噪声频谱。如果设计者指定了电路输入端，那么仿真器可以计算传输函数和等效输入参考噪声。另外，如果信号输入源是有噪声的，也可以计算信号源的噪声系数。噪声分析计算的输出端的总噪声中不仅包括电路本身的噪声，也包括输入源和负载的噪声。电路中的每个噪声源对总噪声的贡献量也会同时计算出来。
---table begin---
Table tile:共源极放大器器件参数
| 器件类型          | 实例名称       | 模型     | 宽度    | 长度    | 阻值 | 倍数 | 库名称 | 单元名称 | 预览名称 |
|-------------------|-----------------|----------|---------|---------|-----|----|--------|----------|----------|
| MOS管            | M0               | mn        | 5u       | 10u     |  -     |-     | st02     | mn        |symbol   |
| MOS管            | M1               | mp       | 5u       | 1u       |  -     |-      | st02     | mp        |symbol   |
| 电阻             | R1               | --         | --        | --       | 1M  | 1    | a         | -            |  -         |
---table end---```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4-42 [desc]
viR = ..."
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4-43 [desc]
所以
nT, out M1, M2
nT, M
nT, M
|
( )
vi
i
R = ..."
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4-44 [desc]
考虑到两个电阻的热噪声，那么在差分放大器的输出端的噪声为
nT, out
nT, M
nT, M
(
)
2(4
)
vi
i
R
kTR = ..."
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4-45 [desc]
将上面的结果折合到放大器的输入端，只需除以放大器的增益即可。即为
nT, M
nT, M
nT, in
2
m
(
)
2(4
)
ii
R
kTR
vg R + ...
在式（4-45）中包含了 MOS 管的热噪声，电阻的热噪声。而 MOS 管的闪烁噪声本身就在放大器的输入端。因此，只需再在式（4-45）的基础上叠加两个 MOS 的闪烁噪声。最后结果如下"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __ 4-46 [desc]
nT, M
nT, M
n, in
ox
m
(
)
2(4
)
2
ii
R
kTR
KC WLf
vg R ...
对比式（4-30）共源级的噪声，可以发现实际上差分放大器的噪声是共源级放大器的两倍。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __  [desc]
请使用 Cadence 软件仿真图 4- 29 所示电路，得到输出噪声和各个管子的贡献量。分析哪个器件贡献的噪声量最大，并找到它的噪声传播路径后优化。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管的闪烁噪声 __  [desc]
根据图 4- 29 所示电路，在 vIN1和 vIN2之间加入一个正弦信号，测量该电路的谐波失真。分析造成失真的主要原因，并优化电路。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ CMOS 运算放大器和负反馈 [desc]
运算放大器（Operational Amplifier），简称运放（Opamp），是在 1947 年由 John R. Ragazzini 命名的，代表一种特殊类型的放大器，经由恰当选取得外部元件，它能够执行各种运算，如放大、加、减、微分和积分。从而在电路中实现各种功能：从直流偏置的产生到高速放大或滤波。因此运算放大器是许多模拟系统和混合信号系统中的一个重要部分。在本章中将着重讨论单级 CMOS 运放的分析和设计，将比较两种常用的运放结构，即套筒式和折叠式的共源共栅结构间的性能差别，并给出运放性能的仿真测试方法。多级运放的设计将在第 6 章介绍。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ CMOS 运算放大器和负反馈 __ 运算放大器 [desc]
运算放大器是一种具有极高增益的电压放大器。图 5- 1 给出了运算放大器的符号。标识为""+""和""−""符号的输入端代表同相和反相输入端。vP 和 vN 表示同相端和反相端对地的电位，vOUT 表示输出端对地的电位。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ CMOS 运算放大器和负反馈 __ 运算放大器 __ 理想运算放大器 [desc]
在理想情况下，运算放大器具有无限大的差模电压增益、无限大的输入电阻和无输出电阻。图 5- 2 给出了理想运算放大器的等效电路。图中，vD 是差分输入电压，即为两个输入端的电压差值: 
```
D
P
N
v
v
v
=
−
```
Av 是运算放大器的增益，也叫做无载增益，因为当输出不加负载时有：
```
(
)
OUT
V
D
V
P
N
v
A v
A
v
v
=
=
−
```
从图 5- 2 可以看出，理想的运算放大器是一个压控电压源，因此在 Spectre 软件中可以利用如图 5-3 所示的电路来实现一个理想运算放大器模型。图 5-3 中的器件“E0”是一个压控电压源，是构成理想运算放大器的核心部分。该器件可以在“analogLib”库中找到，其名称为“vcvs”，显示方式选择“symbol”，如图 5-4 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ CMOS 运算放大器和负反馈 __ 负反馈 __ 负反馈的基本原理 [desc]
通过环绕一个运算放大器，连接上恰当选取的外部元件，就能构成可以实现各种运算的运算放大器电路。而负反馈是运算放大器和外部元件间常用的连接方式。实现加、减、乘、除、积分和微分运算的运算放大器电路都可以通过负反馈结构实现。因此负反馈和运算放大器是紧密相连的。
对于任意一个负反馈系统，都包含四个组成部分：前馈网络；检测输出的方式；反馈网络；产生反馈误差的方式。# 1.
图 5- 8 一般的负反馈系统 
图 5- 8 给出一个一般的负反馈系统，其中前馈网络和反馈网络分别用 H(s)和 G(s)表示，检测输出的方式为直接使用前馈网络的输出，而以 Σ 表示的求和器用来产生反馈误差信号。从该框图中可以得到： 
```
X(s)
Y(s) = G(s)
H(s)
Y(s) -
⎡
⎤
⎣
⎦
```  
（5-3）
因此，整理后得到： 
```
Y(s)
H(s)
X(s) = 1
G(s)H(s) +
```   
（5-4） 
在式（5-4）中，我们也将 H(s)称为“开环”传输函数，将 Y(s)/X(s)称为“闭环”传输函数。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
目标值作为对象优先级的权重
当优化方向定为“minimize”和“maximize”时，目标值作为各个对象优先级权重的作用更加明显。在这两种情况下，目标值和优化允许范围的值仅仅作为各个对象优先级的权重。相对的，在优化方向为“match”，“>= ”或者 “<=” 时，目标值同时作为对象的优化目标和优先级的权重。
F.5.2 准备设计变量
在使用优化器进行优化之前，需要指名哪些设计变量可以被优化器在优化过程中改变。这些被选中的设计变量必须是仿真环境变量，例如器件参数和器件的模型参数。典型的例子是电阻、电容的值，或者它们的长度和宽度。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 2 [desc]
降低增益灵敏度 
由于运算放大器的增益受负载和工艺的影响会发生偏移，因此现在研究在负反馈结构中开环增益 Av（即运算放大器的增益）上的变化是如何影响闭环增益 A 的。对式（5-8）进行微分，得到：
```
( )
2
V
V
1
1
dA
dA
A
β
= +
⋅
```
（5-16）
将式（5-8）代入式（5-16），重新整理后得到：
```
V
V
1
1
dA
dA
A
T A
= +
```
（5-17）
这说明对于某一个给定的在开环增益 Av 上的相对变化，在闭环增益 A 上产生的相对变化被降低了 1+T 倍。由此可见，环路增益 T 在负反馈系统中是一个很重要的量。从式（5-17）可以看出，环路增益 T 越大，闭环增益 A 对开环增益 Av 的变化越不敏感。对于足够大的 T，即使 Av 上有明显的变化，而在 A 上只有微小的变化[3]。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
优化器如何使用目标和目标允许范围的值
优化器有两种方法使用目标值：作为对象的优化目标；作为对象优先级的权重。后面将分开介绍两种情况。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
点击“OK”完成对波形属性的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 3 [desc]
非线性失真的减小 
对于一个线性运算放大器，其输入输出特性应该为：
```
xO = a1 xD
```
（5-20）
对应的曲线应该是一条斜率为 a1 的直线。但是实际运算放大器的输入输出特性通常是非线性的，并且运算放大器的增益 Av 必须更一般的定义为:
```
dxO
Av = dxD
```
（5-21）
由于分析一个负反馈系统中的非线性十分复杂。这里我们考虑一个简单的“轻度非线性”系统，来验证负反馈对运算放大器电路非线性的影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
在“Direction”下拉菜单中，选择对象表达式的值在优化过程中的变化趋势，具体选项见 F.5.1.6。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
选择 “Variables”� “Add”/“Edit” 或者点击“Tool Bar”中的“Add”/“Edit Goals”按键。# 优化器的目标与机制
优化器的目标中，无论目标值是多少，优化器在优化过程中并不会因为对象表达式的值小于目标值而停止优化，而是尽一切可能是对象表达式的值更小，甚至导致对象表达式的最终值远远小于目标值。同样当优化方向定为：maximize 时，优化器会使对象表达式的值尽可能的大，甚至远远大于目标值。注意：当选择 LSQ 算法时，优化器不会区分match，minimize 和 maximize。优化器总会使对象表达式的最终值和目标值一致。
---table begin---
Table tile: 表 F- 5 优化方向和允许值的范围 
| 定义的优化方向（Direction）      |优化器尝试将对象表达式的值           |
|----------------------------------|------------------------------------|
| match                            |和目标值一致                        |
| >=                               |必须比目标表达式的值大              |
| <=                               |必须比目标表达式的值小              |
| minimize                         |不管目标值，使对象表达式的值尽可能的小   |
| maximize                         |不管目标值，使对象表达式的值尽可能的大   |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
非线性失真的减小 
对于一个线性运算放大器，其输入输出特性应该为：
```
xO = a1 xD
```
（5-20）
对应的曲线应该是一条斜率为 a1 的直线。但是实际运算放大器的输入输出特性通常是非线性的，并且运算放大器的增益 Av 必须更一般的定义为:
```
dxO
Av = dxD
```
（5-21）
由于分析一个负反馈系统中的非线性十分复杂。这里我们考虑一个简单的“轻度非线性”系统，来验证负反馈对运算放大器电路非线性的影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
开启或者关闭优化对象"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
在“Target”栏中按照 Cadence SKILL 语言的表达式规范写入目标的表达式。或将光标移至“Target”栏中，按照 4~6 步的方法从“Waveform Calculator”中获得目标的表达式。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么目标的表达式也要是一个标量。反之，如果对象的表达式是一个波形，那么目标的表达式也要是一个波形。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
在“Acceptable”栏填入优化的允许范围。在 F.5.1 中将具体描述优化器是如何利用对象的优化允许范围来决定优化对象优先级的。这里有两种方法来定义这一个值。
可以在“Acceptable”栏中直接填入符合 Cadence SKILL 语言规范的表达式。或者按照 4~6 步的方法从“Waveform Calculator”中获得表达式。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么允许范围的表达式也要是一个标量。如果对象的表达式是一个波形，那么允许范围的表达式可以是一个波形，也可以是一个标量。
如果允许范围是一个标量，那么他需要满足表 F- 4 的要求；如果允许范围是一个波形，那么这个波形上的每一点都要满足表 F- 4 的要求。
---table begin---
Table tile: 优化方向和允许值的范围 
| 定义的优化方向（Direction） |优化允许范围值必须满足的要求 |
|-----------------------------|-------------------------------|
| minimize                    |必须比目标表达式的值大         |
| maximize                    |必须比目标表达式的值小         |
| match                       |除了目标表达式以外的任何值。另外对于允许范围是波形的情况，允许范围波形在任何点上都比目标表达式大，或者在任何点上都比目标表达式小|
| >=                          |必须比目标表达式的值小         |
| <=                          |必须比目标表达式的值大         |
---table end---
回到第10点，如果选择了“% wihin Target”，可以在“Acceptable”栏中确定一个标量或者波形变化的百分比。一个小的百分比说明这个对象的优先级更高。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么填入的百分比也要是一个标量。如果对象的表达式是一个波形，那么填入的百分比可以是一个波形，也可以是一个标量。
如果使用了一个标量百分比，那么可以保证优化的结果在目标值极大和极小的情况下都保持一致。如果使用了一个波形百分比，则可清晰地表明在对象波形在各段的重要性。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
如果要在当前优化中包含该对象，则要选中“Enabled”栏。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
点击“OK”将新建的对象加入到“Optimizer”窗口中。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 18 对运算放大器输出电压求导
4) 点击“Calculator”中的“
”按键，输出计算结果，从而得到运算放大器增益随输入电压变化的曲线，如图 5- 19 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
从图 5- 19 可以看出，在根据式（5-24）给出的非线性运算放大器的增益随着输入电压的升高而升高。因此运算放大器增益的不稳定也是运算放大器非线性的一个重要表现。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
由非线性运算放大器构成的负反馈电路的输入输出特性和闭环增益 
利用式（5-24）给出的非线性运算放大器构建如图 5- 10 所示的增益为 2 的运算放大器电路，如图 5- 20 所示。其输入输出特性和闭环增益分别如图 5- 21 和图 5- 22 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 19 非线性运算放大器的增益曲线 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 20 由非线性运算放大器构成的增益为 2 的运算放大器电路 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 21 负反馈电路的输入输出特性 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 22 反馈电路的闭环增益特性 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
这说明 3dB 带宽增加了 βAv 倍。 
下面计算运算放大器和负反馈闭环系统得增益带宽积，即是将低频小信号增益和3dB 的带宽相乘。运算放大器的增益带宽积为：
```
Av(0) * ω0 = Gain BW
```
（5-27）
由该运放构成的负反馈闭环系统的增益带宽积为：
```
Av/(1+βAv) * ω0(1+βAv) = Gain BW
```
（5-28）
对比式（5-27）和式（5-28）可以发现，不论反馈系数如何变化，运算放大器的增益带宽积与由其构成的负反馈闭环系统的增益带宽积一致。这个现象为我们设计运算放大器带来了很多变化。例如：需要设计一个增益为 10，带宽为 10MHz 的负反馈闭环系统。假如采用单级运算放大器，并且知道运算放大器最小增益为 1000
（5-30）
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 带宽的变化 [desc]
负反馈结构除了减小增益灵敏度和减小非线性失真外，还增加了电路的带宽。假设图 5- 9 中运算放大器只有一个极点，那么运算放大器的传递函数为： 
V0/V = A0/(1 + Asω)
其中 Av(0)是信号频率接近零时运算放大器的增益，也叫做运算放大器的低频增益，ω0 是 3dB 带宽，表示在运放增益幅频特性中，增益幅值从直流增益下降 3dB 时的频率。为了简化分析，我们仍然认为反馈网络不含频率分量。
因此将式（5-25）代入式（5-8）得到，闭环系统的传递函数为： 
V/V0 = A0/(1 + 1/β + As/1 + 1/β + Asω)
从式（5-26）的分子可以看出，负反馈系统得低频闭环增益为 Av/(1+β•Av)，这和5.2.1 中的分析一致。而式（5-26）的分母则表明，闭环系统得极点频率约为 β Av ω0，这说明 3dB 带宽增加了 βAv 倍。 
下面计算运算放大器和负反馈闭环系统得增益带宽积，即是将低频小信号增益和3dB 的带宽相乘。运算放大器的增益带宽积为： 
A0*ω0 = Gain BW
由该运放构成的负反馈闭环系统的增益带宽积为： 
Av/(1+βAv) * ω0(1+βAv) = Gain BW
对比式（5-27）和式（5-28）可以发现，不论反馈系数如何变化，运算放大器的增益带宽积与由其构成的负反馈闭环系统的增益带宽积一致。这个现象为我们设计运算放大器带来了很多变化。例如：需要设计一个增益为 10，带宽为 10MHz 的负反馈闭环系统。假如采用单级运算放大器，并且知道运算放大器最小增益为 1000。为了满足反馈系统的要求，该运算放大器的带宽 ω0 为：10 ×  10MHz/1000 =100kHz。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 运算放大器的基本结构 [desc]
理想情况下，运算放大器具有无限大的差模电压增益、无限大的输入电阻和零输出电阻。但实际上，运算放大器的性能只能接近这些值。多数系统中，大于等于 2000的开环增益就能满足需要。
在第 3 章所研究的全部差动放大器均称为运放。图 5- 23 给出了单端输出和差动输出两种最简单的结构。图 5- 24 给出了相应的运算放大器符号。
这两种电路的低频小信号增益等于： 
(gmN // roN) / (gmP // roP)
其中，下标 N 和 P 分别表示 NMOS 和 PMOS。在亚微米器件的微安级典型电流条件下，其增益很难超过 20，和理想运放的性能还有较大的差距。为了获得足够的增益，单级运算放大器经常采用以下的两种结构：套筒结构和折叠结构。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 运算放大器的基本结构 __ 套筒结构 [desc]
图 5- 25（a）和（b）给出了单端输出和差动输出的套筒式运算放大器的电路结构。
但是这是以减小输入范围和输出摆幅为代价的。例如，在图 5- 25（b）给出的全差分电路中，其输出摆幅为： 
(2*VDD - VOD1 - VOD3 - VOD5 - VOD7 - 2VCSS)
其中，VODj 表示 Mj 管的过驱动电压，VCSS 为电流源 ISS 两端的电压。为了使输入管M1 工作在饱和区，输入电压 vIN1 需要满足以下条件： 
VDD - (VOD3 + VOD5 + VOD7 + VTH1) >= vIN1 >= VCSS + VTH1
可以发现当尾电流较大或者 MOS 管尺寸较小的情况下，输入电压的范围很小。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 运算放大器的基本结构 __ 折叠结构 [desc]
为了缓解套筒式结构对输入电压范围的限制，提出了折叠式运算放大器，图 5- 26 和图 5- 27 分别给出了全差分和单端输出折叠式共源共栅放大器。对比式（5-32）和式（5-33），可以发现图 5- 26 和图 5- 27 中折叠式运放的输入电压范围比图 5- 25 中对应的套筒式运放的输入范围大两个过驱动电压。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 运算放大器的性能 __ 增益(Gain) [desc]
运算放大器的增益是一个重要的设计指标，例如在 5.2.1 中证明了运算放大器的增益直接影响到负反馈系统的精度。在 5.3 中，式（5-29），式（5-30）和式（5-34）给出了三种典型结构运算放大器的增益公式。更一般的方法是通过辅助定理计算运算放大器的增益。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  [desc]
因此输入电压范围增大为： 
```math
DD - ( VOD5 + VTH1 ) >= vIN1 >= VCSS + VTH1
```
对比式（5-32）和式（5-33），可以发现图 5- 26 和图 5- 27 中折叠式运放的输入电压范围比图 5- 25 中对应的套筒式运放的输入范围大两个过驱动电压。 
虽然折叠式结构比套筒式结构有更大的输入共模电平范围，但是这是以减小增益和带宽，增大功耗和噪声为代价实现的。图 5- 26 和图 5- 27 给出的折叠式运算放大器的低频小信号增益为： 
```math
(gm1 // ro1 + gm3 // ro3 + gmb3) / ( ro1 // ro3 + ro5 // r07 + r09 )
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  [desc]
对比式（5-33）和式（5-34）可以发现，造成折叠式运算放大器增益减小的主要原因是，由于加入了折叠管，使得运放源端的 MOS 管并联个数增加，从而减小了从输出端往地端看到的等效阻抗， "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 辅助定理[1] [desc]
```markdown
在线性系统中，电压增益等于-GmROUT，其中 Gm 表示输出接地时的跨导；ROUT 表示当输入电压为零时的输出电阻。
如上文所述，Gm 可以通过如图 5- 28 所示的电路结构计算得到。图中，vIN 是输入电压；VCM 是共模电平，为运算放大器提供直流偏置，在后文中将说明运算放大器的增益会随着直流偏置的改变而改变；iOUT 是输出端接地时，流过输出端的电流。因此 Gm 的计算公式为： 
OUT/m = i/G/v
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 辅助定理[1] __  [desc]
```markdown
OUT/X = V/I
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ ROUT 测量电路 [desc]
根据上述会得出：
```markdown
OUT/X = V/I
```
运算放大器的增益是一个重要的设计指标，对于信号滤波、反馈系统稳定性等都起决定性的
作用。本文主要研究的是运算放大器增益的频率特性。如今运算放大器的输入信号频率范围常常考虑到几赫兹到几兆赫兹甚至更宽。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
---table begin---
Table tile:运算放大器中 MOS 管的参数
|Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|--------------|-------|---|---|------------|--------------|-----------|-----------|
| M1 | mn | 800n | 500n | 1 | st02 | mn | symbol |
| M2 | mn | 800n | 500n | 1 | st02 | mn | symbol |
| M3 | mp | 1.1u | 500n | 1 | st02 | mp | symbol |
| M4 | mp | 1.1u | 500n | 1 | st02 | mp | symbol |
| M5 | mn | 800n | 500n | 1 | st02 | mn | symbol |
| M6 | mn | 800n | 500n | 1 | st02 | mn | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ ADE 窗口设置 [desc]
运算放大器增益的频率特性通常包括增益的幅频特性（即增益幅值与频率的关系）和相频特性（即增益相位与频率的关系）。很多时候，需要将它们画成对数频率特性曲线。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 5- 37 第二个下拉菜单 [desc]
-with several functional categories described in detail. "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 [desc]
根据提供的描述，我们可以通过选择最适合的函数来处理仿真结果，并将其输出到时间图中进行观察。例如，在查看运算放大器的幅度频率特性时，我们可能需要选择""Mag""函数来处理输出电压""Vout""的振幅值。然后，我们可以按需要选择将处理后的仿真结果添加到原始窗口中，或替换原来的窗口中的数据。# 5.4.2 单中，选择“Results Browser”来打开“Results Browser”软件
“Results Browser”的界面类似于Windows 操作系统中的文件管理器，主体分为左右两个窗口。在左边的窗口中可以完成文件的选择、打开和切换；在右边的窗口中，可以选择左边窗口选中文件夹内的数据，或进入子文件夹。
因为我们进行的是交流仿真，仿真结果保存在一个名叉大圈导好的文件夹中，“ac-ac”。点击进入“ac-ac”文件夹后，将在右边窗口显示仿真结果。“ac-ac”文件夹中的内容包括所有节点的电压，和流过选中端口的电流。在“Results Browser”中，为交流仿真的结果提供了几个常用的函数。主要的函数如下： 
- Mag: 计算仿真结果的幅值。 
- Phase: 计算仿真结果的幅角。 
- WPhase: 计算仿真结果的幅角，并归一到 0~360 度内显示。 
- Real: 取仿真结果的实部。 
- Imag: 取仿真结果的虚部。 
- dB10: 对仿真结果进行“10 × log(n)”计算。 
- dB20: 对仿真结果进行“20 × log(n)”计算。 
因为输入交流电压是 1V，因此输出端“Vout”的电压值等于运算放大器的增益。为了观察运算放大器的幅频特性，我们需要计算输出端的电压的幅值。方法如下： 
1. 在右边窗口选中输出电压“Vout”，然后点击鼠标右键，此时弹出一个选项菜单。在这个选项框中各个选项的功能如下：
- “Append”: 在原来窗口的基础上添加新的波形。 
- “Replace”: 清除原来的窗口中的数据，显示新的波形。 
- “New SubWin”: 在原来的窗口中，建立子窗口，用来显示新的波形。 
- “New Win”: 创建一个新的窗口显示新的波形。 
- “Table”: 以列表的方式显示选中的仿真结果。 
- “Calculator”: 将仿真结果直接送到“Calculator”的缓存中。 
2. 在上述选项中选择“New Win”，创建一个新的“Waveform”窗口来显示运算放大器增益的幅频特性。 
3. 负反馈闭环系统中的运算放大器环路增益的仿真测量 
在负反馈系统中，环路增益对反馈系统的精度和稳定性都起着决定性的作用。因此对负反馈系统环路增益的仿真测量是电路设计中的一个重要步骤。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 [desc]
在 5.2.4 中提到了运算放大器的 3dB 带宽，并在式（5-25）中给出了单极点运算放大器的传递函数，在式（5-37）中给出了更一般的多极点运算放大器的传递函数。在这里为了方便分析，忽略了零点对运算放大器传递函数的影响，并假设主极点 ω0 远远小于其它极点。
```
( )
( )
(
)(
)(
)
V
V
0
1
2
0
1
1
1
A
A
s
s
s
s
ω
ω
ω
=
+
+
+
�   
```
（5-37）
通过式（5-37）可以看出，当以 dB 做为增益单位时有：
```
(
)
( )
( )
( )
( )
( )
V
V
V
0
0
0
V
V
0
0
20log
20log
1
/
2
20log
0
20log 2
20log
0
3
A
A
A
A
A
dB
ω
ω
ω
⎛
⎞
⎛
⎞
=
=
⎜
⎟
⎜
⎟
⎝ +
⎠
⎝
⎠
=
−
≈
−
```
（5-38）
从式（5-38）可以看出在主极点频率时，运算放大器的增益下降 3dB，这也是 3dB 带宽的由来。下面我们继续使用图 5- 30 中的例子阐述获得运算放大器 3dB 带宽的方法。
首先可以观察运算放大器增益的幅频特性曲线，并根据 3dB 带宽的定义测量得到3dB 带宽。例如图 5- 41 给出了以 dB 为单位的运算放大器增益的幅频特性曲线。在“Waveform”窗口中，将光标移到增益幅频曲线的低频部分，点击快捷键“m”，在曲线上添加标签，给出标记点的横坐标和纵坐标。如图 5- 47 所示，添加的标签给出了在1.28Hz 的信号频率上，运算放大器的增益为 25.4dB。由此我们可以知道，运算放大器3dB 带宽频率上的增益为 25.4-3=22.4（dB）。接着点击快捷键“v”，将光标切换的竖直光标类型，即“Waveform”中的光标变成一条垂直的直线，并且直线上方有一个红色的倒三角，通过拖动该三角型，可以移到垂直光标，如图 5- 47 所示。垂直光标和运算放大器增益幅频曲线交点的坐标在波形图的左上角给出，并随着垂直光标的左右移动实时改变。我们移动垂直光标，使得交点的纵坐标变为 22.4，此时交点的横坐标就是运算放大器 3dB 带宽频率。如图 5- 47 所示，当增益为 22.5dB（由于精度问题，无法将光标移动到 22.4dB）时，输入信号的频率为 21.7MHz，因此近似可以认为运算放大器的 3dB 带宽为 21.7MHz。
可以看出使用这种方法，由于仿真精度的影响，无法获得准确的运算放大器 3dB 带宽频率。精确获得 3dB 带宽频率的方法是使用“Calculator”软件中的“bandwidth”函数。其方法如下：
在“Results Browser”窗口中的“ac-ac”文件夹中选择“Vout”仿真结果。点击鼠标右键，在弹出的下拉菜单中选择“Claculator”，即将“Results Browser” 中的仿真结果输送到“Calculator”中。如图 5- 48 所示。
图 5- 47 通过观察运算放大器增益幅频特性获得 3dB 带宽
图 5- 48 从“Results Browser”中将仿真结果输送到“Calculator”中 
从图 5- 49 可以看出，仿真结果被输送到“Calculator”中。在“Calculator”的函数窗口 中 选 择 “bandwidth” 函 数 。 点 击 该 函 数 后 ， “Calculator” 中 的 函 数 窗 口 变 为 对 “bandwidth”函数参数的设置。如图 5- 50 所示。其中默认设置就是求一个低通运算放大器的 3dB 带宽。因此不需要更改其设置。点击“Ok”或者“Apply”完成“bandwidth”函数的设置，点击“Calculator”中的“Eval”键，将在“Calculator”的缓存窗口中显示计算出的运算放大器的 3dB 带宽，如图 5- 51 所示，可以看出该运算放大器的 3dB 带宽为23.076MHz。
图 5- 49 仿真结果被输送到“Calculator”中
图 5- 50 “Calculator”中对“bandwidth”函数的设置"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 单位增益带宽 [desc]
单位增益带宽则是运算放大器开环增益为 1 时的频率。对于式（5-25）给出的运算放大器，有：
```
(
)
V ( )
V
UGB
UGB
0
0
1
1
A
A
ω
ω
ω
=
=
+
```
（5-39）
其中 ωUGB 为该运算放大器的单位增益带宽，由式（5-39）解得：
```
( )
UGB
V
0
0
A
ω
ω
≈
⋅
```
（5-40）
对比式（5-26）和式（5-40）可以发现，闭环系统得 3dB 带宽等于该闭环系统使用的运算放大器的单位增益带宽。因此运算放大器的单位增益带宽是一个十分重要的指标。但是这个结论成立是需要条件的： 
1) 反馈网络中不含有频率分量。
2) 单位增益带宽频率内只含有一个极点。
出于系统稳定等方面的考虑，对于大多数的负反馈系统上述两个条件都是成立的，因此我们基本可以认为闭环系统的 3dB 带宽就是运算放大器的单位增益带宽。
和 3dB 带宽一样，运算放大器的单位增益带宽也可以从运算放大器增益幅频曲线观察得到，但是为了得到更精确的单位增益带宽频率，我们需要使用“Calculator”中的“cross”函数，该函数是专门用来计算曲线经过一个特定阈值时的横坐标。对于计算单位增益带宽，我们只需要对运算放大器的增益曲线使用“cross”函数，并将阈值设为“1”，函数返回的值即是运算放大器的单位增益带宽。
在“Calculator”中保持“Select Mode”处在选中状态，在选择模式中选择“ac”里的“vf”项，如图 5- 52 所示。然后点击电路图中的“Vout”端，将“Vout”端的交流电压仿真结果捕获到“Calculator”的缓存中。结果如图 5- 52 所示。点击“Calculator”函数窗口中的“cross”函数。
图 5- 52 将“Calculator”设定为从电路图中获取交流电压仿真结果
图 5- 53 给出了对“cross”函数的设置。如图 5- 53 所示，“cross”函数的设置包含四个选项，其意义如下：
1) “Signal”栏中填入的是需要处理的信号。如图 5- 53 所示，这一栏填入的是“mag(VF(”/ Vout”))”，而不是我们从电路图中获得的运算放大器输出端的交流仿真结果“VF(”/ Vout”)”。这是因为运算放大器输出端的电压仿真结果是用复数表示的，里面既包含增益的幅频特性信息，也包含增益的相频特性信息。而“cross”函数只能处理实数，因此需要先使用“mag”函数计算运算放大器增益的幅值。
2) “Threshold Value”栏中填入的是阈值。按照上文的阐述，这里填入“1”
3) “Edge Number”栏中填入的是穿越特定形式波形边沿的次数。因为我们是计算运算放大器增益第一次为“1”时的频率，因此这里填入“1”
4) “Edge Type”下拉菜单中选择的是曲线穿过阈值时的形式，是上升沿还是下降沿，或者两者皆可。因为运算放大器的增益在单位增益带宽附近是随着信号频率的增加而下降的，因此这里选择“falling”
点击“Ok”或者“Apply”完成“cross”函数的设置，点击“Calculator”中的“Eval”键，将在“Calculator”的缓存窗口中显示计算出的运算放大器的单位增益带宽，如图 5- 54 所示，可以看出该运算放大器的单位增益带宽为23.076MHz。
图 5- 53 对“cross”函数的设置
图 5- 54 使用“cross”函数计算出的运算放大器的单位增益带宽"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 运算放大器的单位增益带宽 [desc]
运算放大器的单位增益带宽是一个十分重要的指标。但是这个结论成立是需要条件的： 
1. 反馈网络中不含有频率分量。 
2. 单位增益带宽频率内只含有一个极点。 
出于系统稳定等方面的考虑，对于大多数的负反馈系统上述两个条件都是成立的，因此我们基本可以认为闭环系统的 3dB 带宽就是运算放大器的单位增益带宽。 
和 3dB 带宽一样，运算放大器的单位增益带宽也可以从运算放大器增益幅频曲线观察得到，但是为了得到更精确的单位增益带宽频率，我们需要使用“Calculator”中的“cross”函数，该函数是专门用来计算曲线经过一个特定阈值时的横坐标。对于计算单位增益带宽，我们只需要对运算放大器的增益曲线使用“cross”函数，并将阈值设为“1”，函数返回的值即是运算放大器的单位增益带宽。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 建立时间(Settling Time) [desc]
建立时间是另一项衡量运算放大器反应速度的重要指标，它表示从跳变开始到输出稳定的时间。它主要是针对运算放大器的小信号特性，在整个跳变过程中，运算放大器仍然保持线性。
我们考虑图 5-9 给出的负反馈结构，出于方便分析考虑，假设该负反馈系统中的运算放大器只有一个极点，因此该负反馈结构的传递函数如式（5-26）所示。
以跳变发生的时刻为时间轴的原点，表 5-2 给出了输出电压精度与响应时间常数间的关系。可以看出，如果认为输出电压和最终值之间的误差小于 2%则认为输出稳定，那么建立时间最小为 4 个响应时间常数。因此为了缩短系统的建立时间，则需要减小系统的响应时间常数。由式（5-43）得，增大负反馈系统的 3dB 带宽就可以缩短系统的建立时间。
根据5.4.2中的阐述，单位增益负反馈系统的 3dB 带宽等于该系统中使用的运算放大器的单位增益带宽。这就使得我们在设计时，可以通过对系统响应速度的要求，获得对所需要设计的运算放大器单位增益带宽的要求，并通过增益带宽积的概念，进一步获得对运算放大器低频小信号增益和 3dB 带宽的要求。
---table begin---
Table title: 输入信号跳变后输出电压精度与响应时间常数间的关系
| t         | (y(t)/y∞) |
|-----------|------------|
| 0         | 0%         |
| τ         | 63.2%      |
| 2τ        | 86.5%      |
| 3τ        | 95%        |
| 4τ        | 98.2%      |
| 5τ        | 99.5%      |
---table end---
在实际电路设置中，我们可以通过“Calculator”中的“settlingTime”函数来测量运算放大器的建立时间。# 5.4.3. 建立时间(Settling Time)
建立时间是另一项衡量运算放大器反应速度的重要指标，它表示从跳变开始到输出稳定的时间。它主要是针对运算放大器的小信号特性，在整个跳变过程中，运算放大器仍然保持线性。
我们考虑图 5-9 给出的负反馈结构，出于方便分析考虑，假设该负反馈系统中的运算放大器只有一个极点，因此该负反馈结构的传递函数如式（5-26）所示。
以跳变发生的时刻为时间轴的原点，表 5-2 给出了输出电压精度与响应时间常数间的关系。可以看出，如果认为输出电压和最终值之间的误差小于 2%则认为输出稳定，那么建立时间最小为 4 个响应时间常数。因此为了缩短系统的建立时间，则需要减小系统的响应时间常数。由式（5-43）得，增大负反馈系统的 3dB 带宽就可以缩短系统的建立时间。
根据5.4.2中的阐述，单位增益负反馈系统的 3dB 带宽等于该系统中使用的运算放大器的单位增益带宽。这就使得我们在设计时，可以通过对系统响应速度的要求，获得对所需要设计的运算放大器单位增益带宽的要求，并通过增益带宽积的概念，进一步获得对运算放大器低频小信号增益和 3dB 带宽的要求。
---table begin---
Table title: 输入信号跳变后输出电压精度与响应时间常数间的关系
| t         | (y(t)/y∞) |
|-----------|------------|
| 0         | 0%         |
| τ         | 63.2%      |
| 2τ        | 86.5%      |
| 3τ        | 95%        |
| 4τ        | 98.2%      |
| 5τ        | 99.5%      |
---table end---
在实际电路设置中，我们可以通过“Calculator”中的“settlingTime”函数来测量运算放大器的建立时间。首先我们将运算放大器连接成单位增益负反馈的形式，即将运算放大器的反相输入端和输出端短接。从而使得负反馈系统的闭环增益为 1，即输入电压跟随加载在运算放大器同相端的输入信号。在运算放大器的同相端加载一个幅度为 2mV 的阶跃信号，电路图如图 5- 56 所示。
将输出端“Vout”作为输出，点击 ADE 窗口中的快捷键“ ”开始运行仿真，反馈系统对阶跃小信号的响应如图 5- 59 所示。在“Calculator”中保持“Select Mode”处在选中状态，在选择模式中选择“tran”里的“vt”项，如图 5- 60 所示，点击电路图中的“Vout”端，将“Vout”端的瞬态电压仿真结果捕获到“Calculator”的缓存中。
点击“Calculator”函数窗口中的“settlingTime”函数，并对其进行设置。如图 5- 61所示： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 相位裕度(Phase Margin，PM) [desc]
相位裕度在电路设计中是非常重要的一个指标，主要用来衡量负反馈系统的稳定性，并能用来预测闭环系统阶跃响应的过冲。这里我们仅给出相位裕度的定义和测量方法，它对系统稳定性的影响将在第 6 章中详细讨论。
从图 5- 65 可以看出，仿真结果被输送到“Calculator”中。在“Calculator”的函数窗口中选择“phaseMargin”函数，如图 5- 66 所示。点击“Calculator”中的“Eval”键，将在“Calculator”的缓存窗口中显示计算出的运算放大器的相位裕度，如图 5- 67 所示，可以看出该运算放大器的相位裕度为 65.18 度。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 转换速率(Slew Rate) [desc]
转换速率，假如在图 5- 56 中，输入阶跃信号的幅度是 200mV，并且单位增益负反馈系统驱动一个 3p 的电容，如图 5- 68 所示，输出电压的时域响应如图 5- 59 所示。
在图 5- 59 可以看出，输出电压“Vout”在跳变后的一段时间内，并没有按照指数规律变化，而是表现出具有不变斜率的线性斜率。这就是负反馈电路中使用的运算放大器表现出的所谓“转换”（slewing）的大信号特性。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 共模抑制比(CMRR) [desc]
差动放大器的一个重要特性就是其对共模扰动影响的抑制能力。如图 5- 76 所示的理想运算放大器，其电路完全对称，并且 ISS 为理想电流源。则 M1 和 M2 管从 M3和 M4 管分别抽取的电流都为 ISS/2，与 vIN,CM 无关。因此输出电压 vOUT1 和 vOUT2 都不会随着 vIN,CM 变化。因此该运算放大器只对 vIN1 和 vIN2 的差值进行放大，而消除了 vIN,CM的影响。
虽然实际上，运算放大器既不可能是完全对称的，电流源的输出阻抗也不可能是无穷大的，因此共模输入的变化还是会引起输出电压的变化。这里定义运算放大器的共模增益为：
```bash
out
CM
in,cm
v
A
= v
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出仿真结果 __ 3dB 带宽 __ 扩展阅读: 示波器 [desc]
点击鼠标右键，在弹出的下拉菜单中选择“Calculator”，即将“Results Browser”中将仿真结果输送到“Calculator”中。如图 5- 64 所示。
从图 5- 65 可以看出，仿真结果被输送到“Calculator”中。在“Calculator”的函数窗口中选择“phaseMargin”函数，如图 5- 66 所示。点击“Calculator”中的“Eval”键，将在“Calculator”的缓存窗口中显示计算出的运算放大器的相位裕度，如图 5- 67 所示，可以看出该运算放大器的相位裕度为 65.18 度。
同样在运算放大器的交流仿真结束后，在""Results Browser""窗口中的“ac-ac”文件夹中选择“Vout”仿真结果。点击鼠标右键，在弹出的下拉菜单中选择“Calculator”，即将""Results Browser""中将仿真结果输送到“Calculator”中。如图 5- 64 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 70 输入电压低到高变化时的转换 
图 5- 71 输入电压高到低变化时的转换 
“slewRate”函数的设置窗口如图 5- 73 所示，可以看出前 5 项和“settlingTime”函数一致，因此不再描述。对于“Percent High”和“Percent Low”的取值方法如图 5- 74 所示。在“slewRate”函数中，将“Final Value”作为“Percent 100%”，将“Initial Value”作为“Percent 0%”，然后根据“Percent High”和“Percent Low”添入的百分数获得“转换”开始和结束的时间。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 72  将“Calculator”设定为从电路图中获取电压的瞬态仿真结果并选择“slewRate”函数 
图 5- 73 “slewRate”函数的设置"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 74 “slewRate”函数中“Percent High”和“Percent Low”的取值方法 
点击“Ok”或者“Apply”完成“slewRate”函数的设置，点击“Calculator”中的“Eval”键，将在“Calculator”的缓存窗口中显示计算出的运算放大器的转换速率，如图 5- 75 所示，计算出来的建立时间约为 0.48V/μs。 
图 5- 75 “slewRate”函数计算结果 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  [desc]
共模抑制比(CMRR) 
差动放大器的一个重要特性就是其对共模扰动影响的抑制能力。如图 5- 76 所示的理想运算放大器，其电路完全对称，并且 ISS 为理想电流源。则 M1 和 M2 管从 M3和 M4 管分别抽取的电流都为 ISS/2，与 vIN,CM 无关。因此输出电压 vOUT1 和 vOUT2 都不会随着 vIN,CM 变化。因此该运算放大器只对 vIN1 和 vIN2 的差值进行放大，而消除了 vIN,CM的影响。
图 5- 76 理想运算放大器的共模响应 
虽然实际上，运算放大器既不可能是完全对称的，电流源的输出阻抗也不可能是无穷大的，因此共模输入的变化还是会引起输出电压的变化。这里定义运算放大器的共模增益为：
```bash
out
CM
in,cm
v
A
= v
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
这里，vout 和 vin,cm 是指输出端和共模输入上的交流小信号，而不是它们的直流偏置电压。
因为在绘制电路图时，无法体现出由于制造产生的不对称性，因此大多数时候是采用保留设计余量的方法来克服这一缺陷的。我们现在讨论图 5- 76 中运算放大器尾电流源具有有限输出阻抗 RSS 的情况，如图 5- 77（a）所示。因为电路具有对称性，因此可以简化为如图 5- 77（b）所示。可以看出，简化后的等效电路为一个带源极负反馈的共源极放大器。其增益为：
---table begin---
Table tile: Increase of gain due to source feedback in a common-source amplifier
```markdown
|      | g_{m1}  | g_{m2}  | r_{o3} | r_{o4} | R_{SS} | g_{m1,2} | r_{o3,4} |
| ---- | ------- | ------- | ------ | ------ | ------ | -------- |  -------  |
| +    | -       | (      | -      | )      | +      | //       | 1         |
```
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
共模抑制比（Common Mode Reject Ratio，CMRR）的定义为运算放大器差分输入增益与共模增益的比值:
```bash
V
CM
A
CMRR
= A
```
根据式（5-29）和（5-47）可以得到图 5- 77（a）中运算放大器的共模抑制比 CMRR
为:
```bash
(
)
(
)(
)
(
)
(
)(
)
m1
o3
o1
o3
o1
m1
SS
m1
m2
o3
o4
o3
m1
m2
//
//
1
2
//
1
SS
g
r
r
r
r
g
R
CMRR
g
g
r
r
r
g
g
R
+
=
= −
+
−
+
+
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  [desc]
电源电压抑制比(PSRR）
因为在实际使用中，电源也是含有噪声的，为了有效抑制电源噪声对输出信号的影响，我们需要了解电源上的噪声是如何体现在运算放大器的输出端的。我们把从运算放大器输入到输出的增益除以电源到输出的增益定义为运算放大器的电源抑制比（PSRR： Power Supply Reject Ratio），所以电源抑制比可以写为： 
V
DD
dd
in
0
0
v
v
A
PSRR
A
=
=
=
式（5-52）中的 vdd=0 和 vin=0 是指电压源和输入电压的交流小信号为零，而不是指它们的直流电平。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 83 采用有源电流镜为负载的
我们现在来考虑图 5- 23 (a)中运算放大器的电源抑制比。如图 5- 83 所示，由于M3 管采用二级管连接，并且流过 M3 管的电流是固定的，因此 M3 管的栅源电压是定值，从而使得 X 点的电位相对于 vDD 钳制，因此当 vDD 变化时，vX 上有相同的变化。又由于电流镜的存在，使得运算放大器在差分输入信号为零时，输出端 vOUT 和 vX 有相同的电位。因而 vDD 到 vOUT 的增益近似为 1。
通过式（5-52）我们可以计算出运算放大器的电源抑制比，但是利用图 5- 84 所示的结构可以更方便的获得结果。我们将运算放大器连接成单位增益负反馈结构，即将运算放大器的反相输入端和输出端短接。将差分输入信号设为 0，在电源电压源添加1V 的交流分量 vdd，如图 5- 84 所示。图 5- 85 给出了图 5- 84 所示电路的小信号等效模型。由图 5- 85 的小信号模型可以计算出： 
(
)
V
P
OUT
DD
dd
OUT
A
v
v
A
v
v
−
+
⋅
=
（5-53） 
因此 
OUT
DD
dd
V
1
v
A
v
A
PSRR
≅
=
（5-54）
下面我们继续使用图 5- 30 中的例子阐述如何使用仿真器来测试运算放大器的电源抑制比。根据上文的叙述，如图 5- 86 所示，在图 5- 30 的基础上做以下修改：将差分输入电压源 V1 的交流电压值设为 0，在电压源 V2 中添加交流分量 1V，并将运算放大器的反相输入端和输出端短接。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 80 测量运算放大器共模抑制比 CMRR 的电路 
图 5- 81 运算放大器 CMRR 倒数的频率特性 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
再次运行交流仿真，得到输出端“Vout”的增益曲线，即为运算放大器 PSRR 的倒数的幅频特性曲线。如图 5- 87 所示。
如果想观察运算放大器 PSRR 的幅频特性曲线，可以使用“Calculator”中的“1/x”函数，对仿真结果取倒数即可，如图 5- 88 所示。
由于电路仿真时，认为 MOS 管都是完全一致的，没有考虑制造时 MOS 管的失配情况，因此仿真得到的 PSRR 都要比实际测量时好，因此在设计的时候需要留有余量。
图 5- 84 计算 PSRR 的方法
图 5- 85 图 5- 84 的等效小信号模型"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 86 测量运算放大器电源抑制比 PSRR 的电路
图 5- 87 运算放大器 PSRR 倒数的频率特性"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 88 使用“Calculator”中的“1/x”函数对仿真结果取倒数"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  [desc]
运算放大器的使用举例
在上文中介绍了运算放大器的基本结构和性能，并了解了负反馈结构的工作原理。下面将结合这两方面的内容，列举几种由运算放大器的负反馈结构组成的运算电路。 
由于运算放大器的输入端分为同相端和反相端。我们把输入信号加载在同相端的方式叫做同相输入方式；把输入信号加载在反相端的方式叫做反相输入方式；把输入信号同时加载在同相端和反相端的方式叫做差分输入方式。
在 5.2.1 最后介绍了，当负反馈系统的环路增益 T 很大时，运算放大器的同相输入端和反相输入端的电位一致，即差分输入电压 vD≈0，这种情况称为“虚短”。并且由于输入端连接到 MOS 管的栅端，则可以认为运算放大器的输入电阻无穷大，输入电流为零，这种情况称为“虚断”。利用“虚短”和“虚断”的概念就可以很容易的计算出由运算放大器构成的运算电路中输入和输出的关系[4]."
"[desc] 模拟集成电路设计与仿真_何乐年 __  __  __  [desc]
比例运算电路
比例运算电路的输出电压和输入电压成线性关系，比例系数由反馈网络和输入形式决定。
1.反相输入方式
反相输入方式的比例运算电路如图 5- 89 所示
利用“虚短”和“虚断”的概念有：
N
P
0
v
= v
IN
N
OUT
1
2
v
v
v
R
R
−
=
因此：
2
OUT
IN
1
R
v
= − R v
当 R1 =R2 时，vOUT=-vIN，此时该电路也可作为反相器。
图 5- 89 反相输入方式的比例运算电路
图 5- 90 同相输入方式的比例运算电路
2.同相输入方式
同相输入方式的比例运算电路如图 5- 90 所示。
利用“虚短”的概念有：
1
N
OUT
P
IN
1
2
R
v
v
v
v
R
R
=
=
=
+
因此：
2
OUT
IN
1
1
R
v
v
R
⎛
⎞
=
⎜ +
⎟
⎝
⎠
当 R1 开路时，vOUT=vIN，此时电路也称为电压跟随器。
图 5- 91 差分输入方式的比例运算电路
3.差分输入方式
差分输入方式的比例运算电路如图 5- 91 所示。输入信号 vIN1 和 vIN2 分别加载到运算放大器的反相和同相输入端上。由于是两个独立的输入信号，因此计算时可以使用线性电路的叠加原理。
在考虑 vIN1 时 vIN2 短路，电路变成类似图 5- 89 所示的结构，得到：
'
2
OUT
IN1
1
R
v
= − R v
在考虑 vIN2 时 vIN1 短路，电路变成类似图 5- 90 所示的结构，得到：
''
2
4
OUT
IN2
1
3
4
1
R
R
v
v
R
R
R
⎛
⎞
=
⎜ +
⎟
+
⎝
⎠
因此输出电压与输入电压的关系为：
'
''
2
4
2
OUT
OUT
OUT
IN2
IN1
1
3
4
1
1
R
R
R
v
v
v
v
v
R
R
R
R
⎛
⎞
=
+
=
+
−
⎜
⎟
+
⎝
⎠
图 5- 91 差分输入方式的比例运算电路"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 92 反相输入方式的比例运算电路
5.5.2求和运算电路
求和运算电路是指输出量为多个输入量比例运算的代数和。
1.反相输入方式
反相输入方式的求和运算电路如图 5- 92 所示。
利用“虚短”和“虚断”的概念有:
N
P
0
v
= v
=
IN1
N
IN2
N
IN3
N
N
OUT
11
12
13
2
v
v
v
v
v
v
v
v
R
R
R
R
−
−
−
−
+
+
=
因此：
2
2
2
OUT
IN1
IN2
IN3
11
12
13
R
R
R
v
v
v
v
R
R
R
⎛
⎞
= −
+
+
⎜
⎟
⎝
⎠"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
图 5- 93 同相输入方式的比例运算电路
图 5- 94 差分输入方式的求和运算电路
2.同相输入方式同相输入方式的求和运算电路如图 5- 93 所示。
利用线性叠加原理，可以得到运算放大器同相输入端的电位为︰
(
)
12
13
11
13
11
12
P
IN1
IN2
IN3
11
12
13
12
11
13
13
11
12
IN1
IN2
IN3
11
12
13
11
12
13
//
//
//
//
//
//
//
//
R
R
R
R
R
R
v
v
v
v
R
R
R
R
R
R
R
```
## 5.59 
当 R1 开路时，vOUT=vIN，此时电路也称为电压跟随器。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 [desc]
差分输入方式的比例运算电路如图 5- 91 所示。输入信号 vIN1 和 vIN2 分别加载到运
算放大器的反相和同相输入端上。由于是两个独立的输入信号，因此计算时可以使用 
线性电路的叠加原理。
在考虑 vIN1 时 vIN2 短路，电路变成类似图 5- 89 所示的结构，得到： 
vOUT = - R1 * vIN1
## 5.60
在考虑 vIN2 时 vIN1 短路，电路变成类似图 5- 90 所示的结构，得到： 
vOUT = R1/R2 + vIN2 * (R3 + R4)/(R1*R2)
## 5.61
因此输出电压与输入电压的关系为： 
vOUT = vOUT_' + vOUT_'' = -R1/R2 * vIN1 + vIN2 * (R3 + R4)/(R1*R2)
## 5.62"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 求和运算电路 [desc]
求和运算电路是指输出量为多个输入量比例运算的代数和。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 求和运算电路 __ 反相输入方式 [desc]
反相输入方式的求和运算电路如图 5- 92 所示。利用“虚短”和“虚断”的概念有： 
vP = vN = 0
vOUT = -R2 * (vIN1/R11 + vIN2/R12 + vIN3/R13)
## 5.63
## 5.64
由此得到：
vOUT = -(vIN1 * R2/R11 + vIN2 * R2/R12 + vIN3 * R2/R13)
## 5.65"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 求和运算电路 __ 同相输入方式 [desc]
同相输入方式的求和运算电路如图 5- 93 所示。 
利用线性叠加原理，可以得到运算放大器同相输入端的电位为： 
vP = r(P) * (vIN1 / R11 + vIN2 / R12 + vIN3 / R13)
## 5.66
利用“虚断”的概念有： 
vP = vN = 0"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 求和运算电路 __ 差分输入方式 [desc]
差分输入方式的比例运算电路如图 5- 94 所示。输入信号 vIN1 和 vIN2 加载到运算放
大器的反相输入端上。输入信号 vIN3 和 vIN4 加载到运算放大器的同相输入端上。由于
是四个独立的输入信号，因此计算时可以使用线性电路的叠加原理。
## 5.69
在考虑 vIN1 和 vIN2 时 vIN3 和 vIN4 短路，电路变成类似图 5- 92 所示的结构，得到：
vOUT_' = -R5/R1 * vIN1 - R5/R2 * vIN2
## 5.70
在考虑 vIN3 和 vIN4 时 vIN1 和 vIN2 短路，电路变成类似图 5- 93 所示的结构，得到：
vOUT_'' = R1/(R1 + R2 + R3 + R4) * (vIN3 / R3 + vIN4 / R4)
因此得到：
vOUT = vOUT_' + vOUT_''
## 5.71"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 积分和微分运算电路 [desc]
积分运算电路和微分运算电路都是利用电容充放电电流 ic 和电容两极板间的电压
vc 关系来实现的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 积分和微分运算电路 __ 积分运算电路 [desc]
积分运算电路如图 5- 95 所示，其中 iS 是信号源流出的电流，iC 是对电容充电的电
流，vC 是电容两极板间的压降。利用“虚短”和“虚断”的概念有：
vN = vP = 0
vOUT = -vN = vC
利用 ic = C * dv/dt， 有
iC = vIN / R
vIN = C * dv/dt * R，因此有
vIN = -vC * CR，然后对两边取积分就可以得到
vOUT = - ∫vIN dt/CR
## 5.72
## 5.73
## 5.74
## 5.75
## 5.76"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 2 微分运算电路 [desc]
把积分运算电路中的电阻和电容更换位子后，就可以得到微分运算电路，如图 5- 96
所示，其中 iC 是对电容充电的电流，iR 是流过反馈电阻的电流，vC 是电容两极板间的
压降。利用“虚短”和“虚断”的概念有：
vN = vP = 0
vIN = -vN = vC
vOUT = -iR * R
根据 iC = C * dv/dt，有
vOUT = - RC * dvIN/dt
从而实现了输出电压为输入电压对时间的微分。
## 5.77
## 5.78
## 5.79
## 5.80
## 5.81"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 对数和指数运算电路 [desc]
因为二极管的伏安特性方程为： 
iD = IS * (e ^ (vD / VT) - 1) ≈ IS * e ^ (vD / VT)
其中 iD 是流过二极管的电流，vD 是二极管正负端之间的压降，IS 为二极管的反向
饱和电流，VT 为温度的电压当量（又称为热电压）。因此利用二极管的伏安特性，可
以实现对数和指数运算电路。
## 5.82"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 对数和指数运算电路 __ 对数运算电路 [desc]
对数运算电路如图 5- 97 所示，利用“虚短”和“虚断”的概念有：
vN = vP = 0
vD = vN = - vOUT
同时有 id = vIN / R
因此可以得到 vOUT = - VT * ln(vIN / (R*IS))
为实现了输出电压和输入电压间的对数关系。
## 5.83
## 5.84
## 5.85
## 5.86"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 对数和指数运算电路 __ 指数运算电路 [desc]
在对数运算电路中，令二极管和电阻互换位置，就得到如图 5- 98 所示的指数运算电路. 
利用“虚短”和“虚断”的概念有:
vN = vP = 0
vIN = -vD 
vOUT = -iR * R = -IS * R * e ^(vIN/VT)"
"[desc] 模拟集成电路设计与仿真_何乐年 __  __ 差分输入方式 __ 对数和指数运算电路 __ 指数运算电路 __ 即实现了输出电压为输入电压的指数。 [desc]
## 5.87
## 5.88# 5.73 IN N C S v v i i R − = ="
"[desc] 模拟集成电路设计与仿真_何乐年 __ 74 OUT N C v v v = − [desc]
从而实现了电容的充电电流为： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 76 IN OUT C IN 1 1 v v v dt v dt C R CR = − = − = − ∫ ∫ [desc]
从而实现了输出电压为输入电压对时间的积分。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 80 C R C dv i i C dt = = [desc]
故， "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 81 IN OUT dv v = −RC dt [desc]
从而实现了输出电压为输入电压对时间的微分。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 81 IN OUT dv v = −RC dt __ 4 对数和指数运算电路 [desc]
因为二极管的伏安特性方程为： D T D T D S S 1 v V v V i I e I e = − ≈ "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 85 IN N R D v v i i R − = = [desc]
故"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 86 IN OUT D T ln S v v v V RI = − = − [desc]
从而实现了输出电压和输入电压间的对数关系。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 90 D T R D S v V i i I e = = [desc]
故"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 第6章 高增益运放与频率补偿 [desc]
我们知道在集成电路的设计过程中，需要对性能指标不断的折衷和优化。一个电路不可能在所有方面都有出色的表现。因此，在实际电路设计的过程中，当拿到一个待设计电路的性能参数后，首先是应将这些参数区分对待。找出哪些是主要设计指标，哪些是次要设计指标。当然，这种区分的依据是实际中电路的应用环境。比如说，在低压差线性稳压器（LDO）的设计中，需要设计一个高增益的运算放大器用以减小静态误差，所以这种情况下高直流增益是设计的主要目标。而在其他一些场合，例如用于麦克风的模数转换器（ADC）中，需要一个前端放大器来将微弱的音频信号放大。但是，由于后续电路对信号摆幅的限制，不能在此将信号幅度放大过度，因此这种放大器的增益一般是 6~15dB。更为重要的是，放大器必须有很高的线性度和驱动能力，使得信号在被采样之前不会畸变。所以在这种情况下的设计重点更倾向于保证放大器的高线性度、低噪声和大驱动能力等指标。在本章中，我们的设计目标是高增益放大器，因此以下的电路结构的讨论都是以提高增益为目标，同时尽可能兼顾优化其他性能。本章将针对几种运算放大器的结构进行讨论，从最简单的运算放大器开始逐渐演化出我们所需要的高增益放大器电路结构"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 多级运算放大器设计 [desc]
在上面几种讨论的电路中，其增大增益的思想都是从增大电路输出阻抗为出发点。由此带来两个问题： 
1. 电路的复杂度上升。由简单电路逐渐演变到带增益自举式的折叠式运放，不仅电路包含的晶体管数目增加，同时电路中还引入环路，使得保证电路稳定性成为重要的考虑问题之一；
2. 由于输出电阻的增大，导致电路的输出极点频率降低。也就是说电路的驱动能力和速度下降。
为避免上述问题，可以采用两级简单运算放大器的级联达到提高增益的目的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 多级运算放大器设计 __ 4 [desc]
采用增益自举式（Gain Booster）结构提高电路增益 
增益自举式结构经常用于高增益运算放大器中，其基本思想仍然是提高输出阻抗。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 频率补偿 __ 1 [desc]
系统稳定性原理与分析 
在大多数实际电路中，我们往往采用反馈系统来改善开环系统抗干扰性差的问题。对一个系统稳定性的判断，我们可以采用“巴克豪森判据”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 频率补偿 __ 2 [desc]
米勒效应与米勒补偿 
在前面两级运放的讨论中，曾经提到由于第一级运放的高输出阻抗和第二级运放的大负载电容，有可能导致在两级运放输出端，分别产生的极点频率差不大。在波特图中表现出在单位增益带宽内存在两个极点，导致相位裕度变差。因此，需要采用频率补偿电路来保证系统的稳定性。最常见的一种补偿方式是米勒补偿，一种基于电路中广泛存在的米勒效应的补偿方式。# 6.3.1 系统的相位裕度
在图 6- 9 中表示一个稳定系统的波特图。图中当增益曲线下降到 0dB 时，相位曲线变化了-110 度，距离变化-180 度的临界条件还有 70 度的裕度，这就是相位裕度。一般来说一个系统的相位裕度在 60 度左右有较好的稳定性和响应速度上的折衷。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 频率补偿 __ 2 米勒效应与米勒补偿 [desc]
在前面两级运放的讨论中，曾经提到由于第一级运放的高输出阻抗和第二级运放的大负载电容，有可能导致在两级运放输出端，分别产生的极点频率差不大。在波特图中表现出在单位增益带宽内存在两个极点，导致相位裕度变差。因此，需要采用频率补偿电路来保证系统的稳定性。最常见的一种补偿方式是米勒补偿，一种基于电路中广泛存在的米勒效应的补偿方式。米勒效应的表述如下："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 如果放大器增益 Av>>1，那么： [desc]
1
V
m
C
A
C
≈
⋅
，
2
m
C
≈ C
 (6-7) 
也就是说在如图 6- 11 中所示的两级放大器示意图中的第一级放大器输出端，利用一个小电容能够建立一个对地大电容，将第一级放大器输出极点推向低频，成为主极点。而第二级放大器的输出极点基本保持不变。图 6- 7 为两级运放结构中加入米勒补偿电容 Cm，图 6- 7 为其小信号等效模型。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 根据图 6- 13 的两级运放小信号模型计算放大器的的传递函数如下： [desc]
m
m1,2
m7
1
L
m7
v
2
1
1
m
L
L
m
m2
1
L
m
1
L
1
L
m
1
m
L
1
( )
1
[
(
)
(
)
]
[
]
C
g
g
R R
s g
A s
s R C
C
R C
C
g
R R C
s R R C C
C C
C C
⎛
⎞
⎜ −
⎟
⎝
⎠
= +
+
+
+
+
+
+
+
 (6-8) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 m [desc]
m1,2
m7
1
L
m7
v
2
m7
1
L
m
1
L
1
o
m
1
m
L
1
( )
1
[
]
C
g
g
R R
s g
A s
sg (6-9) 
假设主极点和次主极点的频率相距较远，那么可以近似得到： 
1
m7
1
L
m
1
P
g
R R C
≈ − (6-10) 
m7
m
2
1
L
m
1
m
L
g
C
P
C C
C C
C C
≈ −
+
+
(6-11)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 如果 CL>>C1，Cm>>C1，那么 P2可以进一步化简为： [desc]
m7
2
L
g
P
≈ − C
(6-12) 
对比未补偿前，我们可以认为第一级和第二级放大器输出极点分别为： 
10
1
1
1
P
≈ − R C (6-13) 
20
L
L
1
P
≈ − R C (6-14) 
因此，主极点频率相比采用米勒补偿前减小了 gm7RLCm/C1倍，而次极点频率比补偿前增大了 gm7RL倍。这是就是非常有用的极点分裂现象，如图 6- 14 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 如果 CL>>C1，Cm>>C1，那么 P2可以进一步化简为： __ 4 控制零点的米勒补偿 [desc]
在式 (6-8)中，可以看到米勒补偿电路中包含一个右半平面的零点，该零点大小为： 
m7
m
g
Z
= C
(6-19) 
由于右半平面的零点在波特图中起到提升增益曲线，增大相位变化的作用。因此，右半平面零点实际上是削弱了系统的稳定性。消除右半平面零点的电路如图 6- 16 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 18 注意，其中的 gm1,2和 gm7即为第一和第二级的跨导。为了能够看清上式的内在含义， [desc]
需要做一些必要的假设：gm7R1RLCm>>R1(C1+Cm)，gm7R1RLCm>>RL (Cm+CL)，那么式（6-8）可以化简为：
2
m2
m1
m2
m1
m2
m3
1
2
L
m3
m2
m3
V
2
m2
m3
m2
L
m2
m1
m2
m3
1
2
L
m2
m3
m2
m3
1
( )
(
)
1
1
C
C C
g
g
g
R R R
s
s
g
g
g
A
s
C
g
g
g
R
C C
sC
g
g
R R R
s
s
g
g
g
g
⎛
⎞
−
−
⎜
⎟
⎝
⎠
=
⎡
⎤
−
+
+
+
⎢
⎥
⎣
⎦
     (6-21) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 [desc]
2
m1
m2
m3
m
m1
m2
m3
1
2
L
m1
m
m2
m
m3
m2
m3
v
2
m2
m3
m2
m2
m
L
m2
m1
m2
m3
1
2
L
m2
m3
m2
m3
(
1)
1
[
(
1/
)]
( )
(
)
(1
)
1
1
C C
g
R
g
g
g
R R R
s C R
C
R
g
s
g
g
A s
C
g
g
g
R
C C
sC
g
g
R R R
s
s
g
g
g
g
⎧
⎫
−
+
+
−
+
⎨
⎬
⎩
⎭
=
⎡
⎤
−
−
+
+
+
⎢
⎥
⎣
⎦
  (6-22) 
在 gm3>>gm1，gm2的情况下，式(6-21)和式(6-22)可以重写为： 
(
)
m1
m2
m"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 偿 [desc]
在式 (6-8)中，可以看到米勒补偿电路中包含一个右半平面的零点，该零点大小为：     
```
m7
m
g
Z
= C
``` 
(6-19) 
由于右半平面的零点在波特图中起到提升增益曲线，增大相位变化的作用。因此，右半平面零点实际上是削弱了系统的稳定性。图 6- 16 去右半平面零点的米勒补偿电路 
在图 6- 16 中的电路中，通过与 Cm串联一个电阻 Rm，使零点频率变为：     
```
m
m7
m
1
(1/
)
Z
C
g
R
=
−
``` 
(6-20) 
因此，可以通过调整 Rm 的值，使得零点频率远在带宽之外。一种更实际的方法是将Rm值设计比 1/gm7大，使得右半平面零点移动到左半平面，改善系统稳定性。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 多级米勒补偿 [desc]
在电路设计的过程，有的时候会用到多级放大器的级联，需要更加复杂的频率补偿电路来保证系统稳定性。这里针对三级放大器级联的情况，有两种多级米勒补偿电路如图 6-17 所示。 
图 6- 17 两种多级米勒补偿电路 
图 6- 18 多级米勒补偿的等效小信号模型在图 6- 18 中画出了图 6- 17 所示电路的小信号模型，其中的 gm1、gm2和 gm3分别为第一、第二和第三级的放大器跨导。因此，可以直接计算系统的传递函数分别为： 
```  
2
m2
m1
m2
m1
m2
m3
1
2
L
m3
m2
m3
V
2
m2
m3
m2
L
m2
m1
m2
m3
1
2
L
m2
m3
m2
m3
1
( )
(
)
1
1
C
C C
g
g
g
R R R
s
s
g
g
g
A
s
C
g
g
C C
sC
g
g
R R R
s
s
g
g
g
g
⎛
⎞
−
−
⎜
⎟
⎝
⎠
=
⎡
⎤
−
+
+
+
⎢
⎥
⎣
⎦
```    
 (6-21) 
``` 
2
m1
m2
m3
m
m1
m2
m3
1
2
L
m1
m
m2
m
m3
m2
m3
v
2
m2
m3
m2
m2
m
L
m2
m1
m2
m3
1
2
L
m2
m3
m2
m3
(
1)
1
[
(
1/
)]
( )
(
)
(1
)
1
1
C C
g
R
g
g
g
R R R
s C R
C
R
g
s
g
g
A s
C
g
g
g
R
C C
sC
g
g
R R R
s
s
g
g
g
g
⎧
⎫
−
+
+
−
+
⎨
⎬
⎩
⎭
=
⎡
⎤
−
−
+
+
+
⎢
⎥
⎣
⎦
```  
 (6-22) 
在 gm3>>gm1，gm2的情况下，式(6-21)和式(6-22)可以重写为： 
````
(
)
m1
m2
m3
1
2
L
v
2
m2
L
m2
m1
m2
m3
1
2
L
m2
m2
m3
( )
1
1
g
g
g
R R R
A s
C
C C
sC
g
g
R R R
s
s
g
g
g
=
⎡
⎤
+
+
+
⎢
⎥
⎣
⎦
````
 (6-23) 
````
m1
m1
m2
m3
1
2
L
mL
v
2
m2
m3
m2
m2
m
L
m2
m1
m2
m3
1
2
L
m2
m3
m2
m3
1
( )
(
)
(1
)
1
1
C
g
g
g
R R R
s g
A s
C
g
g
g
R
C C
sC
g
g
R R R
s
s
g
g
g
g
⎛
⎞
⎜ +
⎟
⎝
⎠
=
⎡
⎤
−
−
+
+
+
⎢
⎥
⎣
⎦
````
 (6-24) 
由式（6-23）的表达式所得到的开环主极点为： 
```
1
m1
m2
m3
1
2
L
1
P
C
g
g
R R R
= −
```  
 (6-25) 
如果设计满足以下关系： 
````
m1
m1
L
m3
4 g
C
C
g
⎛
⎞
=
⎜
⎟
⎝
⎠
````
 (6-26) 
````
m2
m2
L
m3
2 g
C
C
g
⎛
⎞
=
⎜
⎟
⎝
⎠
````
 (6-27) 
````
m
m3
1
R
g
=
````
 (6-28) 
那么，由式（6-23）所示的开环传递函数构成的系统闭环传递函数将表现为三阶巴特
沃兹函数形式。此时对于系统的振荡系数 ξ 将等于 2 2。既该系统的阶越响应，能够在超
调量和调整时间上达到最佳状态。此时，系统的非主极点频率为： 
```
m3
m3
2,3
L
L
2
2
g
g
P
j
C
C
⎛
⎞
=
±
⎜
⎟
⎝
⎠
````
 (6-29) 
同样的，根据式（6-24）的表达式设计参数为： 
````
m1
m1
L
m3
4 g
C
C
g
⎛
⎞
=
⎜
⎟
⎝
⎠
````
 (6-30) 
````
m1
m2
L
m2
m3
m3
2
1
g
C
C
g
g
g
⎛
⎞
=
⋅
⋅
⎜
⎟
⎝
⎠
−
````
 (6-31) 
````
m
m3
1
R
g
=
````
 (6-32) 
这种情况下得到的极点分布为： 
````
1
m1
m2
m3
1
2
L
1
P
C
g
g
R R R
= −
````   
 (6-33) 
````
(
)
(
)
m3
m3
2,3
m2
m3
L
m2
m3
L
2 1-
/
2 1-
/
g
g
P
j
g
g
C
g
g
C
=
±
````  
 (6-34) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 双端输入单端输出 CMOS 运算放大器设计实例 __ 1 运算放大器性能指标 [desc]
本节中设计的双端输入单端输出 CMOS 运算放大器为例，对设计流程和仿真方法进行说明。设计采用无锡华润上华公司（CSMC）的 0.5μm CMOS 数模混合工艺库。本例中的运算放大器的设计指标如下： 
工作电源电压范围  ：5V±20％ 
工作电流功耗： <100μA 
工作温度范围： -20~100ºC 
运算放大器直流增益 ： >100dB 
负载电容  ： =5pF 
增益带宽： >4MHz 
摆率 ： >5V/μs 
输出摆幅 ： >±1.5V
电源抑制比： >80dB 
共模抑制比 ： >80dB "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 双端输入单端输出 CMOS 运算放大器设计实例 __ 2 性能指标到电路参数指标之间的转化和分析 [desc]
运算放大器的设计指标如下：
---table begin---
Table title: 运算放大器的设计指标
|   参数名称   | 参数要求     |
|--------------|------------|
| 工作电源电压范围 | 5V±20％     |
| 工作电流功耗 | <100μA       |
| 工作温度范围 | -20~100ºC   |
| 运算放大器直流增益 | >100dB     |
| 负载电容 | =5pF        |
| 增益带宽 | >4MHz      |
| 摆率 | >5V/μs    |
| 输出摆幅 | >±1.5V      |
| 电源抑制比 | >80dB      |
| 共模抑制比 | >80dB |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 直流增益和电路结构 [desc]
由于设计的运算放大器的电压增益在100dB以上，因此通过前面各种电路结构的分析，可以选择折叠式共源共栅电路和一个简单放大器级联的结构来设计所需的电路。这样可以保证在较高的增益下，保证其他参数的实现。电路结构如图 6- 19 所示，其中第一级放大器的输出端记为“N1”。
由于两级运放往往会产生两个低频极点，所以采用米勒电容 Cm来做频率补偿。关于 Cm的大小计算会在后面详细叙述。由于设计增益要求达到 100dB 以上，我们可以把它分配到两级放大器上 A1=70dB，A2=30dB，根据 A1，A2的计算式可以得到：
```markdown
1
m1
m12 o12 o10
m8 o8 o5
(
) || (
)
70 dB
A
g
g
r
r
g
r r
≈
=
           (6-35) 
2
m13
o6
o13
(
||
)
30 dB
A
g
r
r
≈
=
                   (6-36)
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 频率补偿，相位裕度和补偿电容大小安排 [desc]
运算放大器常常被用于带有负反馈的系统中，起到阻抗变换的作用。根据线性系统理论，一个负反馈系统如果要稳定，要求它的开环相位裕度一般至少大于 60 度。但是在两级放大器级联运放结构中，在两级放大器的输出端都有可能产生较低频的极点，因此需要频率补偿。通常频率补偿的方式是采用米勒补偿或带调零点电阻的米勒补偿。在设计中可以采用带调零电阻的米勒补偿。
从理论计算可知，次极点要求在单位增益带宽外 2.2 倍以上[2]。如果输出极点为次极点频率绝对值大小为： 
```markdown
m13
OUT
L
g
P
= C
               (6-37)
```
而单位增益带宽（Unit Gain Bandwidth，UGB）为：
```markdown
m1
m
g
UGB
= C
                (6-38)
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-46 [desc]
如果分配给 M1和 M2的电流为 10μA，M13的电流为 40μA，并且根据 CSMC 公司 0.5μm的工艺文件可以得到参数：μn= 400cm / V⋅s，μp = 215 cm / V⋅s , Cox= 2.76 fF/μm2。因此得到 NMOS 和 PMOS 管的跨导系数分别为：μnCox=110μA/V，μpCox=59μA/V。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-47 [desc]
所以，M1 管的W/L ≈ 1/2.13，同理可得 M13的宽长比为W/L≈1/16.13。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-48 [desc]
共源共栅（Cascade）管和电流镜管的宽长比计算。在前面增益的安排中，可以设计第一级放大器增益为 70dB，第二级放大器增益为 30dB，由此根据增益式设计共源共栅管和电流镜管的大小。因此，Ag≈70 dB。
为了方便计算，我们假设 gm12 = gm8 = gm，并且 NMOS 管沟道调制系数 λ 估算为 0.1V-1，PMOS 管沟道调制系数 λ 为 0.2V-1，由此可得： 
```markdown
gμN λIμP λ = gμN λIμP λ = 1/3500
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-49 [desc]
其中，I 为流过共源共栅管的电流，为 10μA，由此可得gμ=270μS，所以，WL7=W8/L8≈32，WL11=W12/L12≈60。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-50 [desc]
这里取 L = 1μm。对于电流镜管的设计相对要求，一般只要保证其工作在饱和区，并且不会对输出摆幅造成限制即可。根据工艺文件可以查到 VTHn = 0.755V，VTHp = -1.02V。如果设计|VGS-VTH| ≈ 120mV，那么在 5V 供电电压情况下，VBIAS3=0.88V，VBIAS4=3.86V。因此根据平方律式： μnCoxVGS-VTH=(1/2)W/LI "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-51 [desc]
可以得到 M3、M4、M5和 M6的宽长比为： WL3≈47，WL4=WL5≈25，WL6≈25。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-52 [desc]
注意：这里虽然 M6 与 M4、M5 理论设计流过的电流不同，但都是电流镜，并且栅极电压相同。考虑到在生产过程中的失配问题（mismatch）应当采用将一个大管子分拆成多个管子并联的方式，保证它们的单个管子的宽长比相同。二极管连接的 PMOS 管 M9、M10如果同样设计过驱动电压为 120mV，可以利用平方律式公式计算得到： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-53 [desc]
```markdown
W9/L9=W10/L10≈23
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-54 [desc]
偏置电路的设计: 在图 6- 20 中，IBIAS1 和 IBIAS2 是由外部引入的基准电流，M16~M21 大小和前面设计的PMOS 和 NMOS 共源共栅管相同。M22和 M14采用二极管连接，以产生共源共栅管的栅压。M15和 M23用来产生 PMOS 和 NMOS 电流镜管的栅压。通过前面的计算已经得到了主电路各管的大小和流过的电流，现在仍然设计|VGS-VTH| > 120mV。这样设计所需的偏置电压，可以得到： VBIAS1=2.74V，VBIAS2=1.8V，VBIAS3=0.88V，VBIAS4=3.86V。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-55 [desc]
如果我们假设基准电流为 1μA，这样可以计算 M22（令 M18和 M22管有相同的栅宽）、M23、M14（令 M14和 M16管有相同的栅宽）和 M15的宽长比分别为： 
WL22=L18+1/60，WL23≈4/5，WL14=L16+1/45，WL15≈3/7"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 [desc]
因为在通过电流镜生成偏置电压时，采用最小的偏置电流，因此流过 M17、M19、M20和 M21管的电流为 1μA，因此这些管子的宽长比为： WL17=L6，WL19=WL20=WL21=1/3.2。
---table begin---
Table title: 电路 MOS 管设计尺寸
| MOS管 Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|---------------------|-------|---|---|------------|--------------|-----------|-----------|
| M1                  | mp    | 2.2u | 2u | 2  | st02   | mp | symbol |
| M2                  | mp    | 2.2u | 2u | 2  | st02   | mp | symbol |
| M3                  | mp    | 7u  | 3u | 20 | st02   | mp | symbol |
| M4                  | mn    | 5u  | 4u | 20 | st02   | mn | symbol |
| M5                  | mn    | 5u  | 4u | 20 | st02   | mn | symbol |
| M6                  | mn    | 5u  | 4u | 40 | st02   | mn | symbol |
| M7                  | mn    | 16u | 1u | 2  | st02   | mn | symbol |
| M8                  | mn    | 16u | 1u | 2  | st02   | mn | symbol |
| M9                  | mp    | 11.5u | 1u | 2  | st02   | mp | symbol |
---table end---# 6. SMC 公司的 0.5μm 工艺库的 PDK
SMC 公司的 0.5μm 工艺库的 PDK (Process Development Kit)添加到项目的 cds.lib 文件中，然后通过“Library Manager”新建一个叫做“AMP”的库，并将其关联到 PDK 提供的工艺库上。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 __ 新建项目库 [desc]
在“AMP”库中，还需要新建两个“cell”分别为“HGAMP”和“HGAMP_tb”。前者用于保存运放主体电路，后者用于保存该运放的测试平台。然后按照前面手工计算的管子尺寸完成电路图绘制工作。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 __ 新建 cell 文件 [desc]
在填写各管子宽长比时，考虑到后续版图设计的匹配性，需要对前面理论计算结果做一些微调。例如我们计算出 M4、M5和 M6的宽长比为 W4/L4= W5/L5=25/1，W6/L6=50/1。而 M23 管的宽长比为 W23/L23=5/4。因此我们以 M23 管为基础，根据各条支路的电流关系，设计 M4、M5管宽长比同样为 5/4，20 个并联；设计 M6管宽长比为 5/4，40 个并联。那么和原手工计算结果相差不大。同样可以设计其他电流镜管。我们在设计输入对管时，由于在版图设计时有对称性要求，因此将原宽长比为 2.13/1 改为两个宽长比为 2.2/2 的管子并联。另外，一般来说，单个管子的宽长比不能太大，否则在制造时会产生较大误差。将第二级放大器 M13的 16.13/1 拆为 2 个宽长比为 8/1 的管子并联。所有管子大小设计如表 6- 1 所示。
---table begin---
Table tile: 电路 MOS 管设计尺寸
| MOS 管 Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|----------------------|-------|---|---|------------|--------------|-----------|-----------|
| M1                   | mp   | 2.2u | 2u | 2  | st02   | mp | symbol |
| M2                   | mp   | 2.2u | 2u | 2  | st02   | mp | symbol |
| M3                   | mp   | 7u  | 3u | 20 | st02   | mp | symbol |
| M4                   | mn   | 5u  | 4u | 20 | st02   | mn | symbol |
| M5                   | mn   | 5u  | 4u | 20 | st02   | mn | symbol |
| M6                   | mn   | 5u  | 4u | 40 | st02   | mn | symbol |
| M7                   | mn   | 16u | 1u | 2  | st02   | mn | symbol |
| M8                   | mn   | 16u | 1u | 2  | st02   | mn | symbol |
| M9                   | mp   | 11.5u | 1u | 2  | st02   | mp | symbol |
| M10                  | mp   | 11.5u | 1u | 2  | st02   | mp | symbol |
| M11                  | mp   | 6u | 1u | 10 | st02   | mp | symbol |
| M12                  | mp   | 6u | 1u | 10 | st02   | mp | symbol |
| M13                  | mp   | 8u | 1u | 2  | st02   | mp | symbol |
| M14                  | mp   | 1u | 22u | 1  | st02   | mp | symbol |
| M15                  | mp   | 7u | 3u | 1  | st02   | mp | symbol |
| M16                  | mp   | 1u | 22u | 1  | st02   | mp | symbol |
| M17                  | mp   | 6u | 1u | 1  | st02   | mp | symbol |
| M18                  | mn   | 1u | 30u | 1  | st02   | mn | symbol |
| M19                  | mn   | 3.2u | 1u | 1 | st02   | mn | symbol |
| M20                  | mn   | 3.2u | 1u | 1 | st02   | mn | symbol |
| M21                  | mn   | 3.2u | 1u | 1 | st02   | mn | symbol |
| M22                  | mn   | 1u | 30u | 1 | st02   | mn | symbol |
| M23                  | mn   | 5u   | 4u | 1 | st02   | mn | symbol |
| M24                  | mn   | 5u   | 4u | 1 | st02   | mn | symbol |
| M25                  | mn   | 5u   | 4u | 1 | st02   | mn | symbol |
---table end---
在完成各管子宽长比设计后，需要设置输入输出引脚，设置方法参见附录 A 所述。这里需要注意的是我们往往把“VDD”和“GND”引脚设置为“inout”。我们可以为该放大器电路生成一个“symbol”。“symbol”的作用相当于将电路打包放在一起。当其他人调用这个模块时，无需关心该电路的具体细节，而只需要了解该电路的功能即可。“symbol”生成的方法如下所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 __ 创建 symbol [desc]
选择工具栏中的“Design”→“Create cellview” →“From Cellview”。然后会出现窗口。一般情况按默认属性即可，按“OK”继续。
接下来需要安排各个引脚的位置，同样可以使用默认设置。一般输入引脚都在“symbol”左边，输出引脚在“symbol”右边，而“VDD”和“GND”引脚分别在上下。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 __ 2 搭建测试平台 [desc]
电路需要仿真验证，我们需要添加激励源和设置仿真参数。为此，首先我们需要搭建一个测试平台。我们最开始曾经建立过一个“HGAMP_tb”的 cellview，将在这里面搭建测试平台。# 6.5.2 搭建测试平台
电路需要仿真验证，我们需要添加激励源和设置仿真参数。为此，首先我们需要搭建一个测试平台。我们最开始曾经建立过一个“HGAMP_tb”的 cellview，将在这里面搭建测试平台。首先在该电路图中将刚刚生成的放大器“symbol”引用进来。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6-56 __ 3 直流偏置验证仿真 [desc]
在搭建好测试平台后，我们就可以通过仿真器来验证之前我们理论计算设计的运放是否满足设计要求。首先，应该先进行直流工作点的验证。打开“Analog Design Environment”；在“ADE”窗口的“Analysis”下拉菜单中选择“choose”；“Choosing Analysis”窗口的设置如图6- 33 所示。这种设置将仿真并保存电路图中各个器件的直流工作点。点击“ADE”窗口中的 “ ”按键，开始仿真。 
仿真结束后，在如图 6- 29 所示的测试平台电路图中选中放大器的 symbol，使用快捷键“shift+E”可以从测试平台直接进入到放大器的电路图中，以便进一步观察放大器各个器件的直流工作点。 
通过选择“Results”→ “Annotate”→ “DC Node Voltages”以及“DC Operating Points”， 如图6- 34所示，可以让仿真器直接把各点直流电压和各元件直流信息直接显示在电路图上。 
在图 6- 35 所示的节点直流电压中，可以看到各偏置电压大小为： 
VBIAS1=2.02V，VBIAS2=2.017，VBIAS3=0.851V，VBIAS4=3.911V "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 负载管的长度 L 可以增大负载管沟道电阻 [desc]
在“Analog Design Environment”中设置好“AC Analysis”中的参数，扫描频率范围从 0.01Hz 到 100MHz。选择“Results”→“Direct Polt”→“AC Gain & Phase”后在图 6- 38 所示的电路图中依次点击运算放大器的输出端 “VOUT”和交流信号输入端 “Vin1”，即可直接观察电路增益和相位曲线，结果如图 6- 41 所 示。 从图 6- 42 中，可以看出该放大器的增益有 80.1dB，相位裕度 49 度左右，单位增益带宽 4.48MHz。用“shift+E”切入到运算放大器内部电路图后，同样的方法依次点击第一级放大器的输出端 “N1”和输入端 “Vin1”，可以看到增益和相位曲线。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 将 M9和 M10管的栅宽设为擅长的 23 倍 [desc]
从第一级放大器的增益和相位曲线来看，它的直流增益太小，仅为 43.5dB。增大负载管的长度 L 可以增大负载管沟道电阻，从而提高放大器的增益。为了寻找合适的长度，我们将 M9和 M10的宽度和长度同时设置变量 “M9_W”和 “M9_L” 。为了保持保持 M9和 M10管的宽长比，我们在 ADE 窗口的变量赋值时，将“M9_W”的大小设置为“M9_L*11.5”。这样当我们修改 M9和 M10管的栅长时，将自动修改 M9和 M10管的栅宽。这里需要注意的是，“M9_W”一定要在“M9_L”之后赋值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 多参数扫描 [desc]
为了寻找合适的栅长，将图 6- 19 中 M9，M10的栅长进行参数扫描，以观察不同栅长情况下，放大器的增益。在“Parametric Analysis”的设置如图 6- 44 所示。
---table begin---
Table title:调整后的放大器器件参数
| MOS 管 | Instance Name | Model | W | L | Multiplier | 修改原因 |
|-------|---------------|--------|----|----|-------------|----------|
| M1 ，M2 | mp | 20u | 2u | 2 | 增大跨导，从而增加增益和单位增益带宽。
| M3 | mp | 7u | 3u | 30 | 增大输入管的电流，从而增加输入管的跨导|
| M4 ，M5 | mn | 5u | 4u | 20 | -- |
| M6 | mn | 5u | 4u | 50 | 增大第二级放大器输入管的漏源电流，从而提高增益和次极点的频率。提高次极点频率以提高相位裕度，增强稳定性。 |
| M7 ，M8 | mn | 16u | 1u | 1 | 保证直流工作点 |
| M9 ，M10 | mp | 28.75u | 2.5u | 1 | 保证直流工作点，提高输出阻抗 |
| M11 ，M12 | mp | 6u | 1u | 5 | 保证直流工作点 |
| M13 | mp | 7u | 1u | 6 | 增大第二级放大器输入管的跨导，从而提高增益和次极点的频率。提高次极点频率以提高相位裕度，增强稳定性。 |
| M14 ，M16 | mp | 1u | 11u | 1 | 调整 VBIAS1的电位到计算值 |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 [desc]
增益达到 99.5dB，单位增益带宽约为 4.05MHz，相位裕度约为 59 度，基本满足设计要求。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 瞬态时域仿真 [desc]
衡量一个运算放大器的时域特性主要是观察运放的阶跃响应，包括静态误差，超调量，调整时间，是否有振铃等指标。为此我们设计的测试平台和瞬态激励分别如图 6- 47 和图 6- 48 所示。根据电路理论可知，输出响应分为大信号响应阶段和小信号线性响应两个阶段。根据大信号响应的斜率可以直接测量该放大器的正摆率。简单测量的方法如图 6- 52 所示。# S2的电位到计算值
---table begin---
Table title:电容
| Instance Name | Model | W | L | Capcitance | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|------------|------------|
| Cm            | --    | -- | -- | 5p        | 1          | 增强极点分裂作用，提高相位裕度  |
---table end---
---table begin---
Table title:电阻
| Instance Name | Model | W | L | Capcitance | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|------------|------------|
| Rm            | --    | -- | -- | 2.85k     | 1          | --         |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 瞬态时域仿真 __ 瞬态时域仿真 [desc]
衡量一个运算放大器的时域特性主要是观察运放的阶跃响应，包括静态误差，超调量，调整时间，是否有振铃等指标。为此我们设计的测试平台和瞬态激励分别如图 6- 47 和图 6- 48 所示。在图 6- 47 中，运算放大器被连接成单位增益负反馈模式，在这种情况下，运算放大器的输出，将跟随运算放大器同向输入端（Vin2）的输入信号。在运算放大器的同向输入端接入一个分段信号电压源，产生一个 0V 到 2.5V，上升沿为 1ns 的阶跃信号。该电压源的设置见图 6- 48(该电压源的说明请参考附录 A)。
在 ADE 窗口中设置瞬态仿真，瞬态仿真结束时间设置为 10μs，仿真精度可以设计为高精度(conversation)，如图 6- 49 所示(具体操作请参考附录 A)。仿真结果如图 6- 50 所示。图 6- 51 提供了阶跃相应的细节。在图 6- 50 和图 6- 51 中，输出曲线有 1 个振铃，说明实际相位裕度不到 60 度，不过系统还能保持较高的稳定性。虽然我们在前面的交流仿真中得到运算放大器的相位裕度有 59 度，但是这是在运算放大器两个输入端的直流电位都为 2.5V 的情况下得到的。随着输入端直流电位的变化，运算放大器的直流工作点也随之改变，进而造成了相位裕度的不足。这告诉我们，在模拟电路的设计中，需要考虑电路的鲁棒性，在设计时需要留有一定的余量。
根据电路理论可知，输出响应分为大信号响应阶段和小信号线性响应两个阶段。根据大信号响应的斜率可以直接测量该放大器的正摆率。简单测量的方法如图 6- 52 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 瞬态时域仿真 __ CMRR 和 PSRR 的测量 [desc]
CMRR 是指放大器对输入端共模信号的抑制能力。其计算表达式为：vd/vc=CMRR=A,其中，Avd表示差模增益，Avc表示共模增益。按照第 5 章介绍的方法，把运算放大器连接成单位增益负反馈的模式，在运算放大器的同向和反向输入端加上相同的交流电压，共模增益测量电路图如图 6- 59 所示。再次进行交流仿真，得到的仿真结果如图 6- 60 所示。该曲线是 1/CMRR，因此可以得到运算放大器的低频共模抑制比为 83.4dB。
PSRR 是衡量电路对电源噪声的抑制能力。按照第 5 章介绍的方法，把运算放大器连接成单位增益负反馈的模式，仅在供电电压源上增加 1V 的交流电压，测试电路如图 6- 61所示。仿真结果如图 6- 62 所示。该曲线是 1/PSRR，因此运算放大器的低频电源抑制比为84.6dB。满足设计要求。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 瞬态时域仿真 __ CMRR 和 PSRR 的测量 [desc]
`settlingTime`函数的基本设置和`slewRate`函数的基本设置是一样的（`settlingTime` 的说明请参考附录 D）。图 6- 57 中的“percent of step”表示容差范围，不过在`Calculator`中与我们前述的容差范围含义略有不同，它是指“Final value – Initial value”的百分比。这里给出在本例中的测试参数： 
```
Initial value type ： x at y 
Initial value ： 1n 
Final value type ： x at y 
Final value ： 10u 
Percent of step ： 0.1 
```
图 6- 58 “settling time”计算结果。计算结果如图 6- 58 所示。需要注意的是，这里计算出的时间 3.06μs 表示的是运算放大器建立结束时刻，真正的建立时间是 3.06μs 减去跳变起始时刻 2μs。所以，该运放的建立时间是 1.06μs。  
CMRR 是指放大器对输入端共模信号的抑制能力。其计算表达式为： vd/vc = CMRR = A，其中，Avd表示差模增益，Avc表示共模增益。按照第 5 章介绍的方法，把运算放大器连接成单位增益负反馈的模式，在运算放大器的同向和反向输入端加上相同的交流电压，共模增益测量电路图如图 6- 59 所示。再次进行交流仿真，得到的仿真结果如图 6- 60 所示。该曲线是 1/CMRR，因此可以得到运算放大器的低频共模抑制比为 83.4dB。 
PSRR 是衡量电路对电源噪声的抑制能力。按照第 5 章介绍的方法，把运算放大器连接成单位增益负反馈的模式，仅在供电电压源上增加 1V 的交流电压，测试电路如图 6- 61所示。仿真结果如图 6- 62 所示。该曲线是 1/PSRR，因此运算放大器的低频电源抑制比为84.6dB。满足设计要求。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 习题 [desc]
请计算图 6- 2 套筒式运算放大器的增益和输出摆幅。 
器件参数：VDD=5V，μpCox=50μA/V2，λp=0.2V -1，μnCox=110μA/V2，λn=0.1V -1，VTHn=0.75V，VTHp= -0.95V。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 习题 [desc]
请计算图 6- 3 的增益和输出摆幅，器件参数同 6.1 题。请比较和题 6.1 结果的不同点。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 习题 [desc]
一种自偏置的单级共源共栅运算放大器如图 6- 63 所示。请计算这种放大器的增益，并分析该电路的优缺点。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 习题 [desc]
证明对于有两个极点和一个右半平面的零点运算放大器模型，如果要获得 45 度相位裕度，要求次极点频率位于 1.22 倍单位增益带宽以上，零点频率位于 10 倍单位增益带宽以上。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 全差分运算放大器与非线性 [desc]
全差分运算放大器就是一种具有差分输入，差分输出结构的运算放大器。差分放大器相对于单端输出的放大器具有如下一些优势。首先，由于随着 CMOS 工艺尺寸地不断缩小，从 0.5μm 减小至 0.35μm，0.18μm，90nm，芯片的供电电压也不断减小，从 5V 降到 3.5V，1.8V，1.2V 甚至更低。在如此低的供电电压的情况下，单端输出的运算放大器很难能理想地工作，为了保证电路能够得到足够大的信号摆幅，我们需要采用全差分的运算放大器结构。其次，全差分运算放大器能够有效抑制电路的共模信号，并且能够减小电路的偶次谐波失真。但是，为了得到这些性能，全差分运算放大器需要一个共模反馈环路来控制输出的共模电平。理想情况下，这个共模反馈控制环路会使得输出的共模电平稳定在 VDD/2。所以，一个全差分放大器通常由主放大器和共模反馈环路两部分组成，它在现代的电路设计中应用非常广泛。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 全差分运算放大器与非线性 __ 全差分运算放大器结构框图 [desc]
图 7- 1 是一个全差分运算放大器的结构框图，包括了主放大器和共模反馈(CMFB, common mode feedback)两个部分，基本上所有的全差分放大器都由这两部分组成。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整后的增益与相位曲线 __ 全差分运算放大器与非线性 __ 全差分运算放大器结构框图 __ 1 全差分运算放大器与非线性 [desc]
全差分运算放大器就是一种具有差分输入，差分输出结构的运算放大器。差分放大器相对于单端输出的放大器具有如下一些优势。首先，由于随着 CMOS 工艺尺寸地不断缩小，从 0.5μm 减小至 0.35μm，0.18μm，90nm，芯片的供电电压也不断减小，从 5V 降到 3.5V，1.8V，1.2V 甚至更低。在如此低的供电电压的情况下，单端输出的运算放大器很难能理想地工作，为了保证电路能够得到足够大的信号摆幅，我们需要采用全差分的运算放大器结构。其次，全差分运算放大器能够有效抑制电路的共模信号，并且能够减小电路的偶次谐波失真。但是，为了得到这些性能，全差分运算放大器需要一个共模反馈环路来控制输出的共模电平。理想情况下，这个共模反馈控制环路会使得输出的共模电平稳定在 VDD/2。所以，一个全差分放大器通常由主放大器和共模反馈环路两部分组成，它在现代的电路设计中应用非常广泛。
本章节首先介绍了全差分放大器的基本结构和原理，比较了几种常用的全差分放大器。然后，介绍了全差分放大器中的一个重要部分—共模反馈，并详细讲述了共模反馈的原理和要求，接着简单提了一些常用的共模反馈结构。接下来，又介绍了全差分放大器的非线性问题以及提高电路线性度的几种电路结构。最后，本章设计了一个高带宽的全差分运算放大器电路，并进行了总结。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 差动电路的非线性 [desc]
## 7.3.1 非线性的原理和差动对的非线性 
首先我们考虑任何一个非线性的系统，它可以由式（7-6）来表示： 
y(t) = α0 + α1x(t) + α2x(t)^2 + α3x(t)^3 （7-6） 
其中， x(t) 和 y(t) 分别为系统的输入和输出。一般来说，大于 3 阶的系数一般都很小，所以可以忽略不计。当输入 x(t)=Acos(ωt)，我们可以得到：   
y(t) = α0 + α1Acos(ωt) + α2A^2cos(2ωt) + α3A^3 cos(3ωt)    （7-7） 
化简后，得到   
y(t) = α0 + α1Acos(ωt) + α2A^2cos(2ωt)/4 + α3A^3cos(3ωt)/4    （7-8） 
所以，我们可以得到第 i 阶的谐波失真（HDi），它定义为第 i 阶谐波分量与基波分量的比值。而总的谐波失真（THD）为所有 i 阶谐波分量的几何平均值。如果假设 α1A>>3α3A^3/4，那么谐波失真可以表示为： 
HD2 = α2A^2/εα1A ≈ ε/2    （7-9） 
HD3 = α3A^3/εα1A ≈ ε/4     （7-10） 
THD = √(HD2^2 + HD3^2 )   （7-11） 
理论上来说，全差分放大器输出的偶次谐波分量会由于相减而消失，但由于电路中失配的存在会导致有限的偶次谐波失真。如果运算放大器系统有 ε%的失配，从式（7-9）可以得到： 
HD2 = εα2A^2/α1A   （7-12） 
我们考虑一个简单的输入差动对，如图 7- 10# 一个是对放大器的输出摆幅上没有了限制，另一个就是避免了阻性的负载。
但是，开关电容电路也带来一些负作用。一个是开关引入了大量的噪声，这在某些低噪声应用中会成为主要的噪声来源。另一个就是开关引起的电荷注入会导致一定的失调。总体来说，连续时间共模反馈和离散时间共模反馈各有优缺点，在选择共模反馈电路时要根据实际电路情况进行确定。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 差动电路的非线性 __ 差动电路的非线性 __ 非线性的原理和差动对的非线性 [desc]
首先我们考虑任何一个非线性的系统，它可以由式（7-6）来表示： 
y(t) = α0 + α1x(t) + α2x(t)^2 + α3x(t)^3 （7-6） 
其中， x(t) 和 y(t) 分别为系统的输入和输出。一般来说，大于 3 阶的系数一般都很小，所以可以忽略不计。当输入 x(t)=Acos(ωt)，我们可以得到：   
y(t) = α0 + α1Acos(ωt) + α2A^2cos(2ωt) + α3A^3cos(3ωt)    （7-7） 
化简后，得到   
y(t) = α0 + α1Acos(ωt) + α2A^2cos(2ωt)/4 + α3A^3cos(3ωt)/4    （7-8） 
所以，我们可以得到第 i 阶的谐波失真（HDi），它定义为第 i 阶谐波分量与基波分量的比值。而总的谐波失真（THD）为所有 i 阶谐波分量的几何平均值。如果假设 α1A>>3α3A^3/4，那么谐波失真可以表示为： 
HD2 = α2A^2/εα1A ≈ ε/2    （7-9） 
HD3 = α3A^3/εα1A ≈ ε/4     （7-10） 
THD = √(HD2^2 + HD3^2 )   （7-11） 
理论上来说，全差分放大器输出的偶次谐波分量会由于相减而消失，但由于电路中失配的存在会导致有限的偶次谐波失真。如果运算放大器系统有 ε%的失配，从式（7-9）可以得到： 
HD2 = εα2A^2/α1A   （7-12） 
我们考虑一个简单的输入差动对，如图 7- 10 所示。我们定义输出电流 IO=I1-I2，直流 IDC=I1+I2，差分输入电压 VGS1-VGS2=Vin+-Vin-=vd。假设两个 MOS 管都工作在饱和区，应用饱和区 MOS 管的电流公式，我们可以得到： 
I1 = β(VGS1-VTH)^2 
I2 = β(VGS2-VTH)^2     （7-13） 
其中，β = μ_nC_ox(W/L)，所以： 
id = I1-I2 = β(vd)^2/2    （7-14） 
那么可以得到输出电流： 
IO = IDC(1-vd/4) = IDC - β(vd^2)/2   （7-15） 
对 IO使用级数展开，我们可以得到： 
IO = α1vd + α3(vd)^3     （7-16） 
这里： 
α1 = βIDC， α3 = βVDSAT(βIDC)^2/(8βIDC) = β/(8VDSAT)    （7-17） 
所以，由式（7-10）可得： 
HD2 = βVDSAT/32    （7-18） 
另外，因为我们在计算式（7-15）时忽略了 MOS 管和其他的一些失配，所以在式（7-16）中没有 vd的偶次项出现，也就没有 HD2 这一项了。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 差动电路的非线性 __ 差动电路的非线性 __ 差动输入对的线性化技术 [desc]
在某些电路中，如果要求输入差动对的线性度比较高，那么就需要对输入差动对进行线性化。最常用的线性化方法是源极退化（source degeneration），如图 7- 12 所示[1]。
在图 7- 12 中的（a）和（b）电路具有相同的输出电流表达式[4]: 
n2n_oxBnid_o,sdid_DS(sat)21 21C I W Lviv N Nμ=−⋅⎜⎟⎡⎤⎜⎟=−⋅⎢⎥⎜⎟++⎢⎥⎣⎦⎜⎟⎝⎠       （7-25）
其中，N=GmR 是源极退化因子，io,sd 表示源极退化后的输出电流。当 N=0 时，式（7-25）同样也适用于普通的差分输入对。
---table begin---
Table title: 普通差分对和源极退化差分对的比较
|参数|普通差分对|源极退化|
|---|---|---|
|小信号跨导（Gm）|n_oxBn2WC/L Iμ=| m,sd1G/GN=+|
|三阶谐波失真（HD3）|2id_31_32vHD/V=| 2_3_11HD/N=|
|电流消耗|2IB|  B2(1+) N I|
---table end---
通常来说，源极退化的电阻都会比较大，如果用无源器件来实现，那么在 CMOS 工艺中会占用比较大的面积，所以一般都会采用有源器件来实现。
n_oxGS1_TH(R)(W/C V V)L μ=−     (7-26)
当然，也可以让 MOS 管工作在饱和区作电阻来用，如图 7- 14 所示。
---table begin---
Table title: 有源器件源极退化电路的比较
|电路结构|跨导|特性|
|---|---|---|
|图 7- 13（a）| m_1_1/34ββ++；_1_2_3_4_,M M M M==|对输入共模范围不敏感，线性范围受限于 VDSAT|
|图 7- 13（b）|m_1_1/gRg+；n_oxGS_TH1/(R)W C V VL μ=−|对输入共模范围很敏感，为了得到好的线性度，VGS3必须比较大|
|图 7- 14|m_1_1_3/g/g+；_1_2_3_M M M==| 对输入共模范围不敏感，线性度提高不大，需要占用较多的面积|
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 21 [desc]
所以： 
m(ab)Vααββ = − ⋅ ⋅ − ⋅ "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 [desc]
2m1(2Vaβαβ−⋅=−⋅⋅+ 
如果 α2和 b 都很小的话，那么由式（7-21）和式（7-22）简化后得到： 
2m21 11 21(1)Vβααβ α⋅=+⋅ "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 23 [desc]
若没有反馈，那么该比值为： 
2m112Vβαα⋅="
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 [desc]
因此，由于反馈的作用，二次谐波的相对幅度减少为原来的 1/(1+βα1)2。这说明反馈减小了系统的非线性。如果在图 7- 11 中的放大器是一个全差分放大器，那么理想的情况是不会有二次谐波的项，三阶失调会成为我们重要考虑的失真项。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __ 全差分运算放大器的设计实例 [desc]
以下以设计一个带宽为 500MHz 的全差分运算放大器电路为例说明设计流程。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __ 全差分运算放大器的设计实例 __ 设计指标 [desc]
电源电压: 3.3V 
开环增益: ≥65dB 
单位增益带宽: ≥500MHz 
相位裕度: ≥50 degree 
差分压摆率: ≥200V/μs 
等效输入参考噪声: 20nV/√Hz@1MHz 
负载电容: 2pF 
差分输出摆幅: ≥±2V 
谐波失真: ≤0.1% 
静态功耗: 尽可能小 
工艺: CSMC 0.5μm 2p3m"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __ 全差分运算放大器的设计实例 __ 高速全差分放大器结构选择 [desc]
运算放大器的结构主要有三种：（a）简单两级运放（two-stage）；（b）折叠式共源共栅（folded-cascode）；（c）套筒式共源共栅（telescopic cascode）。
简单的两级运放的直流增益较小，很难达到 80dB 的增益。而且，该运算放大器的设计指标要求差分输出摆幅为±2V，单级的折叠式共源共栅和套筒式共源共栅结构都不能达到要求，所以我们采用两级运算放大器结构。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __ 全差分运算放大器的设计实例 __ 性能指标分析 [desc]
1. 差分直流增益 Adm≥65dB
2. 差分压摆率 ≥200V/μs 
差分压摆率定义为：SR=I_max/C_max; 第一级的转换速率为：SR=IM0/C1，其中 C1 为第一级放大器的负载电容，它实际上是管子寄生电容的总和； 第二级的转换速率为：SR=2IM11/(CC+CL)； 所以，放大器的转换速率为：SR=Min{ IM0/C1，2IM11/(CC+CL)}
3. 静态功耗 运算放大器的静态功耗为：Pstatic=VDD*I 如果静态功耗确定下来了，那么就可以确定整个电路的工作电流。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __ 全差分运算放大器的设计实例 __ 性能指标分析 [desc]
1. 差分直流增益 Adm≥65dB
该运算放大器存在两级：折叠式输入级（M0~M8，M9a，M9b，M10a，M10b）和共源输出级（M11~M14），第一级的增益：
```
A = Gm1/(r_o1// (r_m1+r_o7// (r_m5+r_o3// (r_m7)) // /(r_o1 + (1/g_m9a)+(1/r_o9b)) // r_m7)
```
第二级的增益： 
A = gm13/(r_o2// (gm2 + (r_o11// r_o13))
所以，整个运算放大器的增益为： Adm = A1 * A2
所以，Adm≥65dB
2. 差分压摆率 ≥200V/μs
差分压摆率，即转换速率（slew rate，SR），是当放大器在大信号输入时，输出电流的最大驱动能力。它的定义为： SR = |dV_out/dt| = I_max/C_max
第一级的转换速率为：SR=IM0/C1，其中 C1 为第一级放大器的负载电容，它实际上是管子寄生电容的总和。
第二级的转换速率为：SR=2IM11/(CC+CL) 
所以，放大器的转换速率为：SR=Min{ IM0/C1，2IM11/(CC+CL)} 
3. 静态功耗 
运算放大器的静态功耗为：Pstatic=VDD*I 
如果静态功耗确定下来了，那么就可以确定整个电路的工作电流。例如，如果只需要 3.3mW 的静态功耗，而电源电压 VDD=3.3V，那么最大的静态电流就只能是 1mA。
4. 等效输入参考噪声 
等效输入参考噪声可以写成： v_n,in^2 = 4kT(1/g_m1+ 2/3 K_n Cox W/L f) 
其中，式（7-31）的右边第一项表示由于沟道电阻产生的热噪声在输入端的表现，
第二项表示 MOS 管的闪烁噪声。
5. 相位裕度 
假设放大器只有两个极点 p1和 p2（但实际上会有寄生的极点，但一般寄生电容产生的极点都会在很高的频率处，几乎可以不考虑），由于补偿电容 CC 的存在，极点 p1 和 p2 会离得比较远。假定 ωp1<<ωp2，由于主极点 ωp1会产生-90 degree 的相移，所以为了有 60 degree 的相位裕度，ωp2/ωu≥2.2。其中 ωu为放大器的单位增益带宽。 
我们可以稍微取得大一点，以保证在工艺，电压和温度改变的时候，相位裕度都达到要求。 
传递函数可以表示为： 
a_mf1/ ((s/g_m1) (s+d_1)-d_0)
其中， d2≈1/(g_mL* C), d1≈ (g_m1/ g_mf1)(1/ (g_mf1 * r_o1) + 1/ (g_mL* C)), d0 = g_m1 * g_out
整个系统有一个零点，两个极点。如果考虑两个极点的距离很远，那么从式 （7-37）可以得到零极点的表示如下： 
ω_z = - (g_mf1/ g_m1) (g_m1+ g_mf1) / C;  
ω_p1 = (g_m1 * r_out_L)/ C; 
ω_p2 = - (g_m1 * g_L)/ (g_mf1 * C); 
为了得到最大的带宽，应该使次极点最大化。而且，我们可以通过调节零点的位置来使零点效应适中，避免过早产生20dB/dec 的斜率降低。# 7.34.
#=+#+"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
#="
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
从图 7- 20 中我们可以计算传递函数为：
=v2
+
- "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
其中：
=dCC / CC / CC"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
=dggC"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
=d = gg"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
gR = 1"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
gR = 1"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
如果认为 Cc比任何的寄生电容都要大很多，gm1，gmf1，gmL也比 go1，gout 大很多，那么 d2、d1、d0 这些参数可近似表示为：
d ≈ CC"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
d = gC / gC"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
d = gg"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
所以整个系统有一个零点，两个极点。如果考虑两个极点的距离很远，那么从式（7-37）可以得到零极点的表示如下：
= - (gggggCCgCgggggC)ω"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
dRCCgRCω ≈ -= 0
p1
1
OUT
L
m1
o1
L
1
（ωp1为主极点位置）"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
dC Cω
+
= - ≈ d"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
由前面计算出的开环增益，可得：
Cωω = =i"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 24 __  [desc]
为了得到最大的带宽，应该使次极点最大化。而且，我们可以通过调节零点的位置来使零点和次极点抵消。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 21 全差分运算放大器的共模反馈 [desc]
共模反馈环路也是一个两级的放大器，图 7- 21 只给出了共模反馈的第一级，而第二级部分和差分放大器的输出级联系在一起。即，Vfb 输出信号连接到差分放大器 M11和 M12的栅极。所以，共模反馈环路的总增益表达式为：
Ag=irr/i（7-50）
其中，为了进行共模反馈环路的频率补偿，加入了补偿电容 Cm。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
电压偏置电路"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 22 宽摆幅电流偏置电路 [desc]
240
电路中需要 4 个偏置电压，为了能够得到大的电压摆幅，电压偏置电路采用了宽摆幅的电流源。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 22 宽摆幅电流偏置电路 __ 4 [desc]
全差分放大器电路设计和仿真
图 7- 23 和图 7- 24 给出了在 cadence 软件中调用 CSMC 0.5μm 工艺 PDK 中的元件绘制的电路图。在电路图中，最左边部分是所加的电压源和信号激励，中间部分是电流偏置电路，最右边部分是高速全差分放大器的主体部分。
依据我们在第三部分的性能指标分析，我们可以计算电路中每一个 MOS 管的宽长比。表 7- 5，表 7- 6 和表 7- 7 分别给出了全差分放大器电路，偏置电路管子的宽长比和电阻电容的值，其中管子的名称和图 7- 16 中的管子名称相对应。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 24 高速全差分放大器在 Cadence 环境中的电路图 [desc]
---table begin---
Table tile:表 7- 5 高速全差分放大器每个 MOS 管的尺寸 
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|---------|---------------|-------|---|---|------------|--------------|----------|------------|
| M0 | mp | 12u | 0.55u | 45 | st02 | mp | symbol |
| M1 , M2 | mp | 12u | 0.55u | 25 | st02 | mp | symbol |
| M3 ,M4 | mp | 12u | 0.55u | 30 | st02 | mp | symbol |
| M5, M6 | mp | 12u | 0.55u | 30 | st02 | mp | symbol |
| M7 ,M8 | mn | 10u | 0.5u | 20 | st02 | mn | symbol |
| M9a , M9b ,M10a ,M10b | mn | 10u | 0.5u | 8 | st02 | mn | symbol |
| M11 , M12 | mp | 12u | 0.55u | 80 | st02 | mp | symbol |
| M13 ,M14 | mn | 10u | 0.5u | 120 | st02 | mn | symbol |
| M16 ,M17 | mp | 10u | 2.2u | 10 | st02 | mp | symbol |
| M18 ,M19 | mn | 10u | 2u | 6 | st02 | mn | symbol |
| M20, M21 | mp | 12u | 0.55u | 40 | st02 | mp | symbol |
| M22 ,M23 | mn | 10u | 0.5u | 12 | st02 | mn | symbol |
| M24 | mp | 12u | 0.55u | 50 | st02 | mp | symbol |
| M15 | mp | 10u | 2.2u | 10 | st02 | mp | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
---table begin---
Table tile:表 7- 6 偏置电路的 MOS 管的尺寸
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|---------|---------------|-------|---|---|------------|--------------|----------|-----------|
| M0 | mp | 12u | 0.55u | 45 | st02 | mp | symbol |
| M1 , M6, M7 | mn | 12u | 1u | 25 | st02 | mn | symbol |
| M2 ,M3 | mp | 10u | 0.55u | 30 | st02 | mp | symbol |
| M4, M5 | mp | 12u | 0.55u | 30 | st02 | mp | symbol |
| M8 , M9 ,M12 ,M13 | mp | 12u | 0.55u | 8 | st02 | mp | symbol |
| M10 , M11 | mn | 12u | 0.5u | 80 | st02 | mn | symbol |
| M14 ,M15 | mn | 12u | 0.5u | 120 | st02 | mn | symbol |
---table end---
---table begin---
Table tile:表 7- 7 电阻和电容的值
| 电阻 | Instance Name | Model | W | L | Resistance | Multiplier | Library Name | Cell Name | View Name |
|------|---------------|-------|---|---|------------|------------|--------------|-----------|------------|
| R | rhr1K | -- | -- | 10k | 1 | st02 | rhr1K | symbol |
| RCM | rhr1K | -- | -- | 10k | 1 | st02 | rhr1K | symbol |
| 电容 | Instance Name | Model | W | L | Capacitan |
---table end---| M6 | mp | 12u | 0.55u | 30 | st02 | mp | symbol |
| M7 ,M8 | mn | 10u | 0.5u | 20 | st02 | mn | symbol |
| M9a , M9b ,M10a ,M10b | mn | 10u | 0.5u | 8 | st02 | mn | symbol |
| M11 , M12 | mp | 12u | 0.55u | 80 | st02 | mp | symbol |
| M13 ,M14 | mn | 10u | 0.5u | 120 | st02 | mn | symbol |
| M16 ,M17 | mp | 10u | 2.2u | 10 | st02 | mp | symbol |
| M18 ,M19 | mn | 10u | 2u | 6 | st02 | mn | symbol |
| M20, M21 | mp | 12u | 0.55u | 40 | st02 | mp | symbol |
| M22 ,M23 | mn | 10u | 0.5u | 12 | st02 | mn | symbol |
| M24 | mp | 12u | 0.55u | 50 | st02 | mp | symbol |
| M15 | mp | 10u | 2.2u | 10 | st02 | mp | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 表 7-6 偏置电路的 MOS 管的尺寸 [desc]
---table begin---
Table tile: 表 7- 6 偏置电路的 MOS 管的尺寸
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
|---------|---------------|-------|---|---|------------|--------------|-----------|-----------|
| M0 | mp | 12u | 0.55u | 45 | st02 | mp | symbol |
| M1 , M6, M7 | mn | 12u | 1u | 25 | st02 | mn | symbol |
| M2 ,M3 | mp | 10u | 0.55u | 30 | st02 | mp | symbol |
| M4, M5 | mp | 12u | 0.55u | 30 | st02 | mp | symbol |
| M8 , M9 ,M12 ,M13 | mp | 12u | 0.55u | 8 | st02 | mp | symbol |
| M10 , M11 | mn | 12u | 0.5u | 80 | st02 | mn | symbol |
| M14 ,M15 | mn | 12u | 0.5u | 120 | st02 | mn | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 表 7-7 电阻和电容的值 [desc]
---table begin---
Table tile: 表 7- 7 电阻和电容的值 
| 电阻 | Instance Name | Model | W | L | Resistance | Multiplier | Library Name | Cell Name | View Name |
|------|---------------|-------|---|---|------------|------------|--------------|-----------|-----------|
|R | rhr1K | -- | -- | 10k | 1 | st02 | rhr1K | symbol |
|RCM | rhr1K | -- | -- | 10k | 1 | st02 | rhr1K | symbol |
| 电容 | Instance Name | Model | W | L | Capacitance | Multiplier | Library Name | Cell Name | View Name |
| Cc | cpip | -- | -- | 1.2pF | 1 | st02 | cpip | symbol |
| Cm | cpip | -- | -- | 0.4pF | 1 | st02 | cpip | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 增益和相位裕度 [desc]
增益和相位裕度的仿真是通过“AC analysis”来实现的。如前面章节所述，我们首先要在 ADE 的“Setup”�“Model libraries”里面设置仿真所需要的工艺库，如图 7- 25 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 阶跃响应仿真转换速率 [desc]
电路的阶跃响应激励如图 7- 35 所示，图中的“Vip”也是加在差分放大器的正输入端，“Vin”加在差分放大器的负输入端。它和仿真增益和相位裕度时的激励没有本质区别，只是把信号源改成了“Vpulse”，其中“Vpulse”的设置如图 7- 36 所示。
从图 7- 38 中，我们可以得到设计的全差分运算放大器的转换速率为 SR=1.301V/2.381ns≈546.4V/us, 大于设计指标 200V/us，所以满足设计的要求。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共模反馈的仿真 [desc]
因为共模反馈环路在全差分放大器中有很重要的作用，所以共模反馈环路的增益和稳定性对于整个差分放大器的稳定性也是很重要的一个方面。
仿真共模反馈环路的激励信号如图 7- 39 所示，它加在共模反馈电路的输入端，其中使用了很大的电感和电容。这个电感和电容都使用了理想的元件，因为它们只是用来做仿真用的。大电感保证环路的直流电压不被隔断，而大电容可以把交流信号耦合进到电路里面。电感和电容可以从“analogLib”里面调出来，它们的 Cell 名分别为“ind”和“cap”，图 7- 40 给出了电感在“analogLib”里面的具体位置。
此时，主放大器的输入端直接接输入的共模电平。然后，按照第一部分仿真差分增益和相位时的方法做相同的设置，仿真共模反馈环路的增益和相位，仿真的结果如图 7-41 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加表达式后的 ADE 窗口 [desc]
图 7- 34 中，我们可以通过在曲线上加标记来看到在不同频率处的值，添加标记的快捷键为“m”键。从图中我们可以得到，直流增益为 69.9dB＞65dB，相位裕度为 180°-127°=53°，单位增益带宽为 531MHz。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 共模抑制比的仿真 [desc]
共模抑制比定义为差分增益和共模增益的比值。它反映了一个放大器对共模信号和共模噪声的抑制能力。因此，我们需要仿真差分放大器的差分增益和共模增益。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电源抑制比的仿真 [desc]
电源抑制比定义为放大器的差分增益和电源到输出的增益的比值，它反映了放大器对电源和地的噪声的抑制能力。我们同样使用两个放大器电路，一个仿真电源到输出的增益，一个测试放大器的差分增益。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出动态范围的仿真 [desc]
将全差分高速放大器连接成增益为 0.1 的形式，如图 7- 47 所示。然后在输入端加上峰峰值为 100mV 的差分信号。我们可以对输出信号进行 Fourier 变换，得到其总的谐波失真。也可以使用“Calculator”里提供的函数“thd”来计算信号的失真度。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入等效噪声的仿真 [desc]
输入等效噪声需要用“Analyses”中的“noise”来仿真，其中的设置如图 7- 54 所示。其中的“Positive output node”即为差分放大器的正输出端，“Negative output node”即为差分放大器的负输出端。“Input Voltage Source”可以选择加在输入端的直流电压源。要观察仿真的结果，我们可以选择“Results”→“Direct plot”→“Main form”，如图 7- 55所示。同时，它会弹出图 7- 56 所示的对话框，按图中这样的设置选定后，点击“Plot”按钮，就可以得到输入等效噪声的曲线，如图 7- 57 所示。在仿真等效输入噪声时，电路中不同的管子对噪声的贡献都不一样，详细内容可以参考第 6 章中关于噪声仿真的部分。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 47 测试差分高速放大器的电路激励 [desc]
我们加的信号幅度为 100mVp-p，信号频率为 10MHz。我们需要对电路进行瞬态仿真，所以选择“Analyses”中的“tran”，仿真设置如图 7- 48 所示。图 7- 49 设置了我们需要观察的输入信号和输出信号，图 7- 50 给出了瞬态仿真的输入和输出信号。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 7- 51 Calculator 中的 thd 函数 [desc]
为了观察输出信号的失真程度，我们需要对输出信号进行失真分析。如图 7- 51 所示，我们使用了“calculator”里的函数“thd”。图 7- 52 为“thd”函数的设置，“From”表示起始的时间，“to”表示终止的时间。“Number of samples”为采样点数，采样点数越大，越精确。“Fundamental”为输入信号的基频。由此我们可以得到输出信号的“thd”，从而判断是否满足要求，如图 7- 53 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 [desc]
如图 7- 63 所示，W/L=20/1，I=100 µA，RD= 10kΩ，该电路被用于图 7- 11 的反馈环路中，其中 β=0.1，输入信号的峰峰值为 20 mV 的输入正弦波。试计算输出端的 THD。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 7 [desc]
如图 7- 12 所示电路，试推导式（7-25），并计算输入差分对的 Gm。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 [desc]
如图 7- 13（a）所示电路，试推导输入差分对的 Gm表达式。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
电压基准是模拟电路设计中不可或缺的一个单元模块。它为系统提供直流参考电压，对电路性能，例如运算放大器的电压增益和噪声都有着显著的影响。在本章中，主要讨论在 CMOS 技术中电压基准的产生，着重于通用的“带隙”技术。首先，将研究带隙电压基准的基本原理，并介绍常用的带隙电压基准电路结构，以及衡量带隙电压基准性能的方法，接着将针对其中的一种结构介绍带隙电压基准的设计流程，随后将分析带隙电压基准输出噪声和仿真方法，最后将介绍一种低温漂带隙电压基准的结构和设计流程。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 [desc]
带隙电压基准的性能参数 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 __ 1 [desc]
温漂系数
## 
温漂系数是衡量带隙基准电压源输出电压随温度变化的一个性能参数。其单位为 ppm/℃。表示当温度变化 1 摄氏度时，输出电压变化的百万分比。其计算公式为： 
[（基准电压最大值-基准电压最小值）/（基准电压的平均值×温度范围）]×1000000 
符号表达式为： 
(
)
max
min
mean
max
min
1000000
(ppm/ C)
V
V
T
V
T
T
−
=
×
°
−"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 __ 2 [desc]
输出噪声 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 __ 3 [desc]
功耗 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 __ 4 [desc]
电源抑制比（Power Supply Reject Ratio, PSRR）"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 [desc]
带隙电压基准的基本原理 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 __ 1 [desc]
负温度系数电压 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 __ 2 [desc]
正温度系数电压 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 __ 3 [desc]
实现零温度系数的基准电压 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
带隙电压基准的常用结构 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 [desc]
Zener基准源 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 2 [desc]
带隙电路"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 公式 [desc]
---table begin---
Table tile: 公式
| 公式      | 符号 |
|--------------|------------|
| ∂VBE/ ∂T ≈-1.5mV/℃ | ∂VT/ ∂T≈0.087mV/℃ |
|  ∂VBE/ ∂T ≈-1.5mV/℃ | ∂VT/ ∂T≈0.087mV/℃ |
| VREF V α β = + ⋅ − ⋅ |   |
---table end---# 1. 带隙电压基准的一般原理 
由于双极型晶体管（BJT）有以下两个特性：1) 双极型晶体管的基极-发射极电压（VBE）
电压与绝对温度成反比；2) 在不同的集电极电流下，两个双极型晶体管的基极-发射级电压
的差值（ΔVBE）与绝对温度成正比。因此，双极晶体管可构成带隙电压基准的核心。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 公式 __ 负温度系数电压 [desc]
对于一个双极型晶体管，其集电极电流（IC）与基极-发射极电压（VBE）的关系为： 
CSBETexpIVIV
其中，IS是双极型晶体管的饱和电流；VT = kT/q ，k 为波尔兹曼常数，q 为电子电荷。进一步利用饱和电流 IS的计算公式，可以得到 VBE电压的温度系数为[1]： 
BEgBE4VTm VEqVTT−+=∂∂
其中，m ≈ -1.5，Eg=1.12eV 是硅的带隙能量。当 VBE≈750mV，T=300K 时，∂VBE/ ∂T ≈ -1.5mV/℃。 
从式（8-6）可见，VBE电压的温度系数本身与温度有关，因此如果正温度系数是一个固定值，与温度无关，那么在带隙电压基准中的温度补偿就会出现误差。这也是在后文中，只能使得基准电压在一个温度点上获得零温度系数的原因。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 公式 __ 正温度系数电压 [desc]
如果两个同样的晶体管(IS1=IS2=IS，IS为双极晶体管饱和电流)偏置的集电极电流分别为nI0和 I0，并忽略它们的基极电流，那么它们基极-发射极电压差值 ΔVBE为：
BEBE1BE20nIITST
IfkqT=∂>∂ΔVlnV
从式(8-8)中可以看出，这个温度系数与温度本身以及集电极电流无关。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 公式 __ 实现零温度系数的基准电压 [desc]
利用上面的正、负温度系数的电压，可以设计一个零温度系数的基准电压，有以下关系： 
REFBElnVVTnαβ=+⋅
因为 ∂VBE/ ∂T ≈-1.5mV/℃， ∂VT/ ∂T≈0.087mV/℃，因此令 α = 1，只要满足式（8-10），便可得到零温度系数的 VREF.
0.087mV/ C1.5mV/ Cβnln=⋅
即为： 
βnln17.2⋅≈"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 常用带隙电压基准结构 [desc]
以下介绍两种常用的带隙电压基准的电路结构： 
- 先产生一个和绝对温度成正比（Proportional To Absolute Temperature，PTAT）的电流，再通过电阻将该电流转变为电压，并与双极型晶体管的 VBE相加，最终获得和温度无关的基准电压。
- 通过运算放大器完成 VBE和 ΔVBE的加权相加，在运算放大器的输出端产生和温度无关的基准电压。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 常用带隙电压基准结构 __ 利用 PTAT 电流产生基准电压 [desc]
1. 电路结构和基准电压的生成 
在 8.2.2 中介绍了，如果两个双极晶体管工作在不相等的电流密度下，那么它们的基极-发射极电压的差值就与绝对温度成正比。那么将该电压差值作用在一个电阻上，并利用电流镜拷贝流过该电阻的电流，就可以获得PTAT电流。图8- 2给出了一个常用的产生PTAT电流的电路结构[1]。
图 8- 2 PTAT 电流的生成 
图 8- 3 带隙电压基准电路 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输出噪声 [desc]
图 8- 7 展示了图 8- 6 中带隙电压基准的反馈环路。其中 A1是放大器，增益为 AV1；B1 是 R1和 Q1 构成的分压网络增益为 β1；B2 是 R2，R3 和 Q2 构成的分压网络，增益为 β2。由图 8- 7 得到系统的传递函数为： 
```math
(
) (
)
1
REF
2
REF
V1
REF
X
V
X
V
A
V
β
β
+
−
−
⋅
−
−
⋅
=
⎡
⎤
⎣
⎦
(8-36)
```
因此，当误差放大器的增益足够大时： 
```math
(
)
V1
V1
REF
V1
1
2
1
2
1
1
A
A
V
X
X
A
β
β
β
β
+
−
→∞
=
≈
−
+
−
−
(8-37)
```
```math
Q
1
1
Q
R
R
R
β =
+
(8-38)
```
```math
3
Q
2
3
2
Q
R
R
R
R
R
β
+
=
+
+
(8-39)
```
---
table begin---
Table title: 带隙基准电压源器件参数设置
| MOS 管       | Instance Name | Model | W   | L  | Multiplier | Library Name | Cell Name | View Name |
|--------------|--------------|-------|-----|----|------------|-------|---|---|
| M0             | mn           |20u | 2u | 1 | st02 | mn | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电路结构和基准电压的生成 [desc]
通过图 8- 6 中的电路，可以在运放的输出端直接实现正温度系数电压和负温度系数电压的加权相加[1，2]。 
在图 8- 6 中，由于放大器 A1 的存在，使得节点 X 和 Y 有相同的电位，即 VX=VY。因为电阻 R1和 R2 的阻值相同，因此流过双极晶体管 Q1和 Q2 的电流值为： 
```math
REF
X,Y
C,Q1
C,Q2
1,2
V
V
I
I
R
−
=
=
(8-34)
```
根据 8.2.2 中的分析，Q1和 Q2 基极-发射极电压的差值为：ΔVBE=VTlnn，和绝对温度成正比，其中 n 是 Q2 和 Q1管并联个数的比值。因此流过电阻 R2和 R3 的电流为 VTlnn/R3。则运算放大器输出端的电压为： 
```math
(
)
2
3
REF
BE,Q2
T
3
ln
R
R
V
V
V
n
R
+
=
+
⋅
(8-35)
```
根据 8.2.3 中的分析，当 R2，R3 和 n 满足关系 (
)
2
3
3
17.2
ln
R
R
R
n
+
≈
时，带隙电压基准可以在T=300K 时获得零温度系数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 35 [desc]
根据 8.2.2 中的分析，Q1和 Q2 基极-发射极电压的差值为：ΔVBE=VTlnn，和绝对温度成正比，其中 n 是 Q2 和 Q1管并联个数的比值。因此流过电阻 R2和 R3 的电流为 VTlnn/R3。则运算放大器输出端的电压为： 
```math
(
)
2
3
REF
BE,Q2
T
3
ln
R
R
V
V
V
n
R
+
=
+
⋅
(8-35)
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 36 [desc]
根据 8.2.3 中的分析，当 R2，R3 和 n 满足关系 
```math
(
)
2
3
3
17.2
ln
R
R
R
n
+
≈
```
时，带隙电压基准可以在T=300K 时获得零温度系数。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 40 [desc]
```math
(
)(
)
(
)(
) (
)
(
)(
)
(
)(
)
closed-loop
3
Q
Q
1
2
2
3
Q
1
Q
2
3
Q
1
Q
3
Q
1
Q
2
3
Q
Q
2
3
Q
1
Q
2
2
1
3
Q
1
3
Q
Q
2
Q
3
Q
Q
2
3
Q
1
Q
1
3
1
1
A
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R
R R
R R
R R
R
R R
R R
R
R
R
R
R
R
R R
β
β
=
=
+
−
−
+
+
+
+
+
+
=
+
+
−
+
+
+
+
+
=
+
+
+
−
−
−
+
+
+
=
(8-40)
```# 8.3.3 两种结构的性能比较 
在 8.3.1 和 8.3.2 中介绍了两种常用的带隙电压基准的结构。虽然它们都能提供和温度无关的基准电压，但是在驱动能力和噪声方面各有优劣。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 驱动能力 [desc]
8.3.1 中的电路不能直接为后续电路供电流，需要在带隙电压基准和后续电路中间加入缓冲器（Buffer)，由缓冲器为后续电路提供电流。这是因为，后续电路如果直接从该带隙电压基准的输出端获得电流，则该电流是 PTAT 电流 I3（图 8- 3）中的一部分，由于后续电路对供电电流的需求不一定和绝对温度成正比，因此无法保证流过电阻 R2的电流还是和绝对温度成正比，这就破坏了产生和温度无关电压基准的基础，使带隙电压基准失去作用。而且后续电路对供电电流需求的改变会直接影响带隙电压基准的输出电压值。因此使用该种带隙电压基准结构，必须同时使用缓冲器将带隙电压基准隔离。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 面积 [desc]
8.3.2 在中介绍的带隙电压基准，需要使用 3 个电阻，并且在双极晶体管 Q1和 Q2 管并联个数的比值 n 较小的情况下，需要更大阻值的 R1 和 R2电阻。由于 CMOS 工艺的特性，无源电阻会消耗较多的芯片面积，因此 8.3.2 中的结构比 8.3.1 中的结构需要更多的芯片面积。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 噪声 [desc]
在使用相同的运算放大器以及 Q1 和 Q2 管并联个数的比值的情况下，由式(8-28)和式(8-43)可以看出 8.3.1 中的结构比 8.3.2 中的结构产生更大的输出噪声。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 [desc]
以下将以 8.3.1 中提出的带隙电压基准结构为例，采用无锡华润上华公司（CSMC）的 0.5µm CMOS 混合信号工艺库，设计并仿真一个带隙电压基准。
---table begin---
Table title: 带隙基准电压源器件参数设置 
| MOS 管       | Instance Name | Model | W  | L   | Multiplier | Library Name | Cell Name | View Name |
|--------------|--------------|-------|----|----|------------|-------------|-----------|-------------|
| M0           | mn          |20u | 2u|1 | st02        |mn          | symbol       |
| M1           | mn          |20u | 2u|1 | st02        |mn          | symbol       |
| M2           | mn          |20u | 2u|1 | st02        |mn          | symbol       |
| M3           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M4           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M5           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M6           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M7           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M8           | mp          |1.1u|550n|1 | st02        |mp          | symbol       |
| M9           | mn          |20u | 2u|1 | st02        |mn          | symbol       |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 1 寻找合适的双极晶体管比例 [desc]
考虑版图设计中的对称性，双极晶体管通常画成 3×3、5×5 或者 7×7……的矩阵。由于片内双极晶体管的面积很大，3×3 矩阵的使用频率最高。因此 Q1、Q2 和 Q3 的比例为 7:1:1。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 2 寻找合适的电阻比例 [desc]
因为 M5、M6和 M8拥有相同的宽长比，式(8-15)中的 M =1。根据 8.2.3 中的分析，
为了获得零温度系数的带隙电压基准，电阻 R1和 R2 需要满足下面的关系 
```
2
1
17.2
8.83
ln 7
R
R ≈
=
```
(8-48) 
令 R1=26kΩ，则 R2=230 kΩ。依此数据设置电路中的电阻值。在电路图中选择电阻R1，点击快捷键“q”，弹出下面的对话框。 
在对话框中，在“Resistance”栏将 R1电阻的阻值设“26kΩ”。采用同样的操作将 R2的电阻值设为“230k Ω”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 3 设置“Analog Environment”窗口 [desc]
完成电路图绘制后，需要进入“Analog Environment”窗口，设置仿真环境，并开始电路仿真和优化。
1. 设置模型库文件 
首先在“Tools”下拉菜单中选择“Analog Environment”命令，打开 ADE 窗口。在 ADE窗口中，首先在“Setup”下拉菜单中选择“Model Libraries”添加模型的库文件。
2. 设置仿真类型和范围 
在 ADE 窗口中，选择“Analysis”下拉菜单中的“choose”命令。在弹出的“Choosing Analyses”窗口中选择“dc”分析；“Sweep Variable”选择“Temperature”；“Sweep Range”选择-40℃ 到 85℃。并选中“Save DC Operation Point”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 4 仿真结果分析 [desc]
在上述电阻阻值及双极晶体管个数的设置情况下，带隙基准电压源的输出电压的温度特性如图所示。从仿真结果中可以看出基准电压随温度的升高而下降。这表明基准电压中的正温度系数过小。从前面的分析中可以得出这是由于 R2/R1 的值过小造成的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 5 使用“Parametric“分析，寻找合适的 R2、R1电阻比值 [desc]
为了能更快的找出合适的 R2/R1 比值，可采用“Parametric”分析。仿真方案为，固定电阻 R1的大小，观察基准电压在 R2 电阻值不同大小情况下的温度特性。根据仿真结果，逐步缩小 R2电阻的取值范围，最终获得合适的阻值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 带隙电压基准的设计 __ 6 利用“Calculator”分析仿真结果。 [desc]
为了更好的观察带隙基准电压源的温度特性，需要利用“Calculator”处理仿真数据。下面将介绍如何在“Calculator”中输入带隙基准电压源的温漂系数的计算公式：  
(ymax(VS(""/VREF""))-ymin(VS(""/VREF"")))/(average(VS(""/VREF""))*(85-(-40)))*1000000   (8-49)
---table begin---
Table tile:各个计算符号下缓存和堆栈的运算关系
| 函数 | 功能 | 
|--------------|------------|
| y**x | stackbuffer | 
| + | stack + buffer |
| - | stack - buffer |
| * | stack * buff   |
---table end---# 3. 缩小扫描范围，再次运行“Parametric Analysis”
观察得当 R2电阻值为 402k 时，基准电压随温度的升高而降低，但是当 R2电阻值为460kΩ 时，基准电压随温度的升高而升高。因此 R2 合适的阻值在 402k~460k 的范围内。再次运行“Parametric Analysis”仿真，将“res”的扫描范围设置为 402kΩ~460kΩ。这时得到的仿真结果如图 8- 27 所示。 
观察得到当 R2 电阻为 416.5kΩ 时，基准电压有最好的温度特性。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Calculator” RPN（逆波兰)模式回顾 [desc]
在“RPN”模式中，一些函数或操作符同时作用于缓存和堆栈中最上层的表达式。对于这些函数或操作符而言，堆栈中的表达式永远在缓存中表达式的左边，具体内容见表8-2。在表 8-2 中，堆栈中最上层表达式用“stack”表示，缓存中的表达式用“buffer”表示。
---table begin---
Table tile:各个计算符号下缓存和堆栈的运算关系
| 函数 | 功能 |
|-------|-----|
| y**x | stackbuffer |
| + | stack + buffer |
| - | stack - buffer |
| * | stack * buffer |
| / | stack / buffer |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 [desc]
在“Calculator”中，保持 “Family”和“Select Mode”项处于选中状态，当仿真结果中包含有多组数据时，可以将其全部选中。因为基准电压的温度系数是通过 dc 仿真获得的，因此在“Calculator”的数据选择模式中选择“swept_dc”；因为需要得到的是电压信号，因此进一步选择“vs”。在电路图中选择“VREF”端，此时“dc”扫描产生的“VREF”端的电压数据被输送到“Calculator”的缓存中，如图 8-28 所示。
在“Calculator”的函数窗口中选择并点击“ymax”函数对“VS(“/VREF”)”进行操作。处理后的数据表达式在“Calculator”的缓存中显示。如图 8-29 所示。
重复第一步，再次从电路图中选取“VREF”端，缓存中的数据将自动压入堆栈。点击“Calculator”缓存右端的“ ”按键，将显示堆栈中的数据。如图 8-30 所示。
在“Calculator”的函数窗口中选择并点击“ymin”函数对“VS(“/VREF”)”进行操作。处理后的数据表达式在“Calculator”的缓存中显示，如图 8-31 所示。
点击“Calculator”键盘中的“-”号，将缓存和堆栈中第一位的数据做减法操作。结果如图 8-32 所示。
重复第一步，再次从电路图中选取“VREF”端，缓存中的数据将自动压入堆栈。并在“Calculator”的函数窗口中选择并点击“average”函数对“VS(“/VREF”)”进行操作。结果如图 8-33 所示。
在“Calculator”的缓存中，紧接着表达式“average(VS(“/VREF”))”直接键入“*125”，其中“125”是扫描的温度范围，“*”表示乘法。注意：这里不要点击“Calculator”键盘中的乘号（“×”)，因为这会将缓存中的数据与堆栈中的第一个数据相关联，结果如图 8-34 所示。
点击“Calculator”键盘中的“/”号，将缓存和堆栈中第一位的数据做除法操作，结果如图 8-35 所示。
在“Calculator”的缓存中，紧接着表达式“(ymax(VS(""/VREF""))-ymin(VS(""/VREF"")))/(average(VS(""/VREF""))*(125))”直接键入“*1000000”，“*”表示乘法，结果如图 8-36 所示.
点击“ ”，在弹出的“Display Results”对话框中（如下图所示)选择“Value”，并点击“OK”或者“Apply”显示计算结果。如图 8-37 所示.“Calculator”对数据的处理结果将在“Results Display Window”窗口中显示，如图 8-38 所示：
在“Results Display Window”窗口显示了两列数据，分别是变量“res”的值，和带隙基准电压源温度系数。可以看出当 R2 电阻的阻值为 416.5kΩ 时，带隙基准电压源有最小的温漂系数。32.6832ppm/℃。
为了下次能直接调用带隙基准电压温度系数的计算公式，需要将编辑好的表达式保存。在“Calculator”中的“Memories”下拉菜单，选择“Table”、“New Memories”命令，如图 8-39 所示：
在“Calculator”中，原来显示函数的窗口将显示“Memories Editor”窗口，在该窗口中“Expression”栏将自动显示当前“Calculator”缓存中的表达式，“Name”是空的，需要给该表达式命名。在“Name”栏中填入“ppm”，完成对表达式的命名。结果如图 8-40 所示。点击“OK”或者“Apply”保存设置。
通过上述的操作，带隙基准电压温度系数的计算公式被保存到“Calculator”的存储器中。但是当退出“Calculator”后，存储器中的内容将被清空，因此为了能在下一次的仿真中调用该计算公式，还需要将存储器中的内容保存到文件中。在 “Calculator”中的“Memories”下拉菜单，选择“Save…”命令，如图 8-41 所示。# 8.4.7 利用“Optimizer”进一步优化带隙基准电压源的温度特性
通过上面的方针可以发现，当 R2 电阻阻值为 416kΩ 时，带隙基准电压源的温度特性接近全局最优。此时可以通过软件“Optimizer”来进行最后的优化，从而提高效率。（“Optimizer”的具体操作请参考附录 F。）
首先在 ADE 窗口中的“Tools”下拉菜单中选择“Optimization”，打开“Analog Circuit Optimizer”窗口。然后在“Analog Circuit Optimizer”窗口的“Goals”下拉菜单中选择“Add…”命令。
在弹出的“Adding Goals”窗口中设置优化对象。在这里将带隙基准电压源的温漂系数作为优化对象。因此在“Name”栏中填入“ppm”。
优化对象的表达式通过“Calculator”获得。首先点击“Calculator”栏中的“Open”命令打开“Calculator”。在“Calculator”中，在“Memories”下拉菜单中选择“Select”、“ppm”命令，调出编辑好的带隙基准电压源的温漂系数计算公式放入“Calculator”的缓存中。
重新回到“Adding Goals”窗口中，点击“Calculator”栏中的“Get Expression”命令。将把“Calculator”缓存中的表达式拷贝到“Expression”栏中。
因为带隙基准电压源的温漂系数越小越好，因此将“Direction”设置为“minimize”。因为是寻找最小的温漂系数，因此在“Target”填入“12”，远小于“Parametric Analysis”仿真中的最优结果“32.6832”。在“Acceptable”中填入一个大于“12”的数字，从而满足“Optimizer”的设置要求，这里选择“15”。点击“OK”或者“Apply”保存设置。
在“Analog Circuit Optimizer”窗口的“Variables”下拉菜单中选择“Add/Edit…”命令。
在弹出的“Editing Variable”窗口的“Name”栏中选择变量“res”。根据 3.2.8 中的仿真结果。R2电阻的最优值在 402kΩ~431k Ω 之间。因此在“Initial Value”栏中填入“416.5kΩ”；在“Minimum Value”中填入“402k”；在“Maximum Value”中填入“431k”；选中“Enable”，
点击“OK”或者“Apply”保存设置。
完成上述设置后的“Analog Circuit Optimizer”窗口如图 8- 49 所示：
由于在测试时优化算法“CFSQP”没有成功优化，因此将优化算法改为“LSQ”。（两种算法的区别请参考附录 F）具体方法如下，在“Analog Circuit Optimizer”的“Session”下拉菜单中选择“Options”命令。
在“Optimization Options”窗口中，将“Algorithm Selection”栏中的下拉菜单选为“LSQ”。点击“OK”或者“Apply”即完成了优化算法的切换。
选择“Optimizer”下拉菜单中的“Run”命令，开始优化。优化结果如图 8- 53 所示。
在“Analog Circuit Optimizer”窗口的“Results”下拉菜单中选择“Update Design”命令，将优化后的变量值返回到 ADE 窗口的设置中。
回到 ADE 窗口中，发现“Design Variable”栏中的“res”变量被赋予优化# 8.4.8. 验证 8.3.1 中关于闭环增益的推论 
在 8.3.1 中，计算了带隙电压基准的闭环增益，得到闭环增益如式（8-28）所示，当M=1 时有： 
2
total
1
1
ln
R
A
R
n
=
+
在 M1的栅端和 Q2 的发射极之间加入电压源“V1”。修改后的电路图如图 8- 56 所示。 ADE 窗口中，双击“Analysis”中的“dc”分析。在弹出的“Choosing Analysis”窗口中，修改“dc”分析的设置。在“Sweep Variable”中选择“Component Parameter”。点击“Component Name”栏下的“Select Component”按键，在电路图中点击电压源“V1”，将会弹出“Select Component Parameter”对话框，在该对话框中选择“dc”回到“Choosing Analysis”窗口中，在“Sweep Range”栏中填入扫描范围“-2m~2m”，这是因为该电压过大将影响电路的直流工作点。完成设置后的“Choosing Analysis”窗口如图8- 60 所示，点击“OK”或者“Apply”保存设置。点击 ADE 窗口中的“”按键，开始仿真。虽然仿真得出的闭环增益为 13.2，与理论推导的 428.8/26≈16.4 有差异。这种差异可能是由于器件的二阶效应以及误差放大器的非线性性和失调造成的。 
为了进一步验证理论推导的可靠性，将双极型晶体管 Q1 的并联个数增加为 47，在保持 R1电阻阻值为 26kΩ 不变的条件下，R2 的电阻值为 181.54kΩ，获得最小的温漂系数。在此双极型晶体管个数和 R1、R2 电阻值的设置情况下，重复上述步骤，得到的仿真结果如图 8- 63 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 9 带隙基准电压源的噪声分析 [desc]
在完成了对带隙基准电压源的温度特性分析后，我们开始分析并仿真带隙电压基准的噪声特性。首先在 ADE 窗口中的“Analyses”下拉菜单中选择“Choose”命令。在弹出的“Choosing Analyses”窗口的“Analysis”栏中选择“noise”；“Sweep Variable”栏选择“Frequency”；“Sweep Range”栏中填入扫描范围为“20~100k Hz”。在“Output Noise”下拉菜单中选择“Voltage”；点击“Positive Output Node”后的“Select”按键，然后点击电路图中的“VREF”端；点击“Negative Output Node”后的“Select”按键，然后点击电路图中的“gnd”符号。在“Input Noise”的下拉菜单中选择“Voltage”，点击“Input Voltage Source”后的“Select”按键，因为这里只关心带隙基准电压源的输出噪声，因此选择电路图中的任意一个电压源即可。这里选择电压源“V0”。点击“OK”或者“Apply”保存设置。
点击快捷键“”运行仿真，仿真结果如图 8- 66 所示。仿真的结果是带隙基准电压与输出噪声的功率谱密度，需要积分后才能得到所关心的噪声结果。# 4.
有差异。这种差异可能是由于器件的二阶效应以及误差放大器的非线性性和失调造成的。 
为了进一步验证理论推导的可靠性，将双极型晶体管 Q1 的并联个数增加为 47，在保持 R1电阻阻值为 26kΩ 不变的条件下，R2 的电阻值为 181.54kΩ，获得最小的温漂系数。在此双极型晶体管个数和 R1、R2 电阻值的设置情况下，重复上述步骤，得到的仿真结果如图 8- 63 所示。 
可以看出此时的闭环增益为 6.36，与 R2/R1=181.54k/26k=6.98 非常接近。对比两次仿真的结果，可以发现带隙基准电压源的闭环增益与 R2/R1的比值成正比，与 Q1双极型晶体管的并联个数成反比。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 9 [desc]
带隙基准电压源的噪声分析 
在完成了对带隙基准电压源的温度特性分析后，我们开始分析并仿真带隙电压基准的噪声特性。 
开始时，仍然按照 R2=414.8kΩ，Q1 的并联个数为 7 来设置带隙电压基准。 
首先在 ADE 窗口中的“Analyses”下拉菜单中选择“Choose”命令。在弹出的“Choosing Analyses”窗口的“Analysis”栏中选择“noise”；“Sweep Variable”栏选择“Frequency”；“Sweep Range”栏中填入扫描范围为“20~100k Hz”。 在“Output Noise”下拉菜单中选择“Voltage”；点击“Positive Output Node”后的“Select”按键，然后点击电路图中的“VREF”端；点击“Negative Output Node”后的“Select”按键，然后点击电路图中的“gnd”符号。在“Input Noise”的下拉菜单中选择“Voltage”，点击“Input Voltage Source”后的“Select”按键，因为这里只关心带隙基准电压源的输出噪声，因此选择电路图中的任意一个电压源即可。这里选择电压源“V0”。完成设置后的“Choosing Analyses”窗口如图 8- 64 所示。点击“OK”或者“Apply”保存设置。返回到 ADE 窗口中。点击快捷键“”运行仿真，如图 8- 65 所示，仿真结果如图 8- 66 所示。
仿真的结果是带隙基准电压与输出噪声的功率谱密度，需要积分后才能得到所关心的频谱段内的输出噪声大小。
---table begin---
Table tile: 输出噪声表格栏的意义
|            |         |
|------------|---------|
| Device     | 器件编号  |
| Param      | 噪声类型  |
| Noise Contribution | 所产生的噪声大小 |
| % of Total | 在全部噪声中所占的百分比 |
---table end---
---table begin---
Table tile: 噪声类型
|            |                    |
|------------|-------------------|
| fn         | MOS 管闪烁噪声     |
| id         | MOS 管热噪声     |
| rn         | 电阻热噪声     |
| ib         | 双极型晶体管基极电流散粒噪声 |
| ic         | 双极型晶体管集电极电流散粒噪声 |
---table end---
---table begin---
Table tile: 两种器件参数下的输出噪声
| 器件 | 噪声类型 | n=7, R2=414.8k | n=47, R2=181.54k | 比值 |
|------|----------|--------------|---------------|-----|
| M0   | fn       | 0.000632883  | 0.000232465   | 2.7225 |
| M1   | fn       | 0.000635013  | 0.000231187   | 2.7468 |
| M0   | id       | 0.000179053  | 7.10294E-05   | 2.5208 |
| M1   | id       | 0.00018029   | 7.11724E-05   | 2.5331 |
| M4   | id       | 0.000147157  | 5.50868E-05   | 2.6714 |
| M3   | id       | 0.000144256  | 5.4375E-05    | 2.6530 |
| R1   | rn       | 8.42541E-05  | 4.03971E-05   | 2.0856 |
---table end---# DE 窗口中，点击击快捷键再次运行仿真运行仿真
经过“Noise Summary”处理后的输出噪声数据如图 8- 70 所示。可以发现总输出噪声下降到 0.000966308V，为原来的 1/8.59。并且 M0 和 M1 的闪烁噪声占总输出噪声的 86.09%。根据 4.2 中的验证，为了降低输出总噪声，可以增加双极型晶体管 Q1的并联个数，减少 R2/R1的比值。当调整 Q1的并联个数到 47，R2的电阻值为 181.54kΩ 后，再次运行仿真。此时输出噪声如图 8- 71 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 此时输出噪声 [desc]
可以发现总输出噪声下降到 0.00035869V，为原来的 1/2.69，比闭环增益的下降（6.4/13.2=1/2.0625）要多。这是因为，当双极型晶体管 Q1 的并联个数上升到 47，而电阻 R1 的阻值不变，使得通过 MOS 管的电流增加，从而减小了 MOS 管的热噪声，使得带隙基准电压源的输出总噪声进一步减小。具体对比一些器件在两种电路设置情况下的输出噪声，如表 8- 5 所示。
---table begin---
Table tile:两种器件参数下的输出噪声
| 器件 | 噪声类型 | n=7, R2=414.8k | n=47, R2=181.54k | 比值 |
|------|----------|--------------|---------------|-----|
| M0   | fn       | 0.000632883  | 0.000232465   | 2.7225 |
| M1   | fn       | 0.000635013  | 0.000231187   | 2.7468 |
| M0   | id       | 0.000179053  | 7.10294E-05   | 2.5208 |
| M1   | id       | 0.00018029   | 7.11724E-05   | 2.5331 |
| M4   | id       | 0.000147157  | 5.50868E-05   | 2.6714 |
| M3   | id       | 0.000144256  | 5.4375E-05    | 2.6530 |
| R1   | rn       | 8.42541E-05  | 4.03971E-05   | 2.0856 |
---table end---
因为电阻热噪声和流过电流大小无关，因此在上表中，电阻 R1 在两种电路设置下生成的热噪声的比值，与对应的闭环增益的比值相同。这与理论分析的结果相符，证明了带隙基准电压源输出噪声计算公式的正确性。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 因为 M0 和 M1 管的闪烁噪声 [desc]
仍然占较大的比重。因此增加 M0 和 M1 管的面积是有有效降低总输出噪声的方法。将 M1和 M0管的“Length”增加到“30u”；“Finger Width”增加到“100u”；将“Fingers”增加到 6。完成参数修改的“Edit Object Properties”窗口入下图所示。点击“OK”或者“Apply”保存设置。再次运行仿真，输出噪声如图 8- 72 所示。在仿真结果中，发现 M0 和 M1 的闪烁噪声约为原来的 1/3。符合理论计算。（M0 和 M1 的栅面积增大 9 倍，故噪声频谱密度为原来的 1/9，开方后则为 1/3。）
此时 M0 和 M1 管的热噪声和闪烁噪声对总输出噪声的贡献基本一致。因此可以通过减少 M0 和 M1 管的热噪声的方法，减少带隙基准电压源的输出噪声。由 4.3.3 得到，当 M0 和 M1 管的跨导（gm）增大时，其热噪声对输出噪声的贡献减小。根据 MOS 管跨导的计算公式：饱和区：(mD2/gIWLUμC=)亚阈值区：(mDTIgVIq/kT===)可以发现增大 M0 和 M1 的漏源电流能有效增加其跨导。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ M0 和 M1 的漏源电流 [desc]
是由M2 管决定的，并且 M2 管和 M9 管构成镜像电流源。M2 管镜像 M9 管的前提条件是 M2管工作在饱和区，只有在这种情况下，流过 M2 管和 M9 管的电流比值等于它们宽长比的比值。由于在“dc”仿真中保存了器件的直流工作点。
在 ADE 窗口的“Tools”下拉菜单中选择“Results Browser…”命令，启动“Results Browser”，如图 8- 73 所示。为了查看 M2管的工作区域。因此在“Results Browser”的右栏中选择“dcOpInfo-info”。“dcOpInfo-info”文件夹中的内容将按照器件名称分类，如图 8- 74 所示。
在“Results Browser”的右栏中选择并打开“M2”文件夹，在该文件架中选择“region”项。点击鼠标右键，在弹出的下拉菜单中选择“Table”命令，如图 8- 75 所示，结果如图8- 76 所示。
“region”中的数字和 MOS 管工作区域的对应关系如表 8- 6。
---table begin---
Table tile: “region”所代表的工作区域
| 数字 | 工作区域 |
|------|---------|
| 0    | 截止    |
| 1    | 线性区  |
| 2    | 饱和区  |
| 3    | 亚阈值区 |
---table end---
因此，在上述电路设置中 M2 管工作在线性区。为了让 M2管工作在饱和区，需要降低其过驱动电压（VGS，M2-VTH，M2），或者增大其漏源电压 VDS，M2。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 调整 M2 管工作区域对带隙基准电压源输出噪声的影响 [desc]
1) 减小 M2 管的栅源电压 VGS，M2，需要增加 M9 管的宽长比。在保持 M9 管栅长不变的基础上增加 M9管的栅宽，既增加了 M9管的宽长比，减小了 M2管的栅源电压 VGS，M2，同时也减小了 M9 管的闪烁噪声。
2) 根据 KCL 定理和 M5、M6 的镜像关系，流过双极型晶体管 Q2 的电流等于 M5和 M6 管的漏源电流。由于增大 Q2 管的发射极-基极电压 VBE，Q2 需要增加流过Q2 的电流，即流过 M5的电流。因此增加流过双极型晶体管 Q2电流的方法是减小 R1 电阻的阻值。根据 8.3.1 中的计算，当流过 M5管的电流增加时，M5管在带隙基准电压源的输出端产生的噪声减小。
3） 减少 M1 和 M0 管的栅源电压也可以改变 M2管的工作区域。在保持 M0和 M1管栅长不变的基础上增加 M0 和 M1 管的栅宽，即可减小 M1 和 M0 管的栅源电压，并减小 M0和 M1 管的闪烁噪声 
上述的三种方案都可以让 M2 管工作在饱和区的同时，减小带隙基准电压源的输出噪声。因为单独采用一种方案，需要大幅度的修改器件参数，所以这里同时采用三种方案，使器件的参数取值在一个合适的范围。修改后的器件参数如表 8- 7。
---table begin---
Table tile: 修改后的带隙基准电压源器件参数及修改原因
| MOS 管 | Instance Name | Model | W | L | Multiplier | 修改原因 |
|--------|---------------|-------|---|---|------------|---------|
| M0，M1 | mn          |        | 3m | 40u | 6 | 减少栅源电压；增加跨导；减小闪烁噪声|
|M2|mn| |30u|2u|5|减小闪烁噪声；减小栅源电压|
|M3，M4|mp| |2u|4u|4|增加 r0电阻，从而增加误差放大器的增益|
|M5，M6 ，M7 ，M8|mp| |6u|2u|1|减小闪烁噪声|
|M9|mn| |30u|2u|5|减小闪烁噪声；减小栅源电压|
---table end---
---table begin---
Table tile: 电阻（为了设计简化，这里使用了理想电阻）
| Instance Name | Model | W | L | Resistance | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|---------|----------|
| R1            | --    | -- | --| 6.5k       | 1 | 增加流过 M5、M6管的电流；增加 Q2的发射极-基极电压；减小电阻的热噪声 |
| R2            | --    | -- | --| 34.21k     | 1 | 根据 R1的阻值，获得最佳的温度特性 |
---table end---
---table begin---
Table tile: 双极型晶体管
| Instance Name | Model | W | L | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|----------|
| Q1            | qvp5  | -- | --| 47 | 减少闭环增益，从而减少总输出噪声 |
---table end---# 3. 调整 M2 管工作区域对带隙基准电压源输出噪声的影响：
1） 减小 M2 管的栅源电压 VGS，M2，需要增加 M9 管的宽长比。在保持 M9 管栅长不变的基础上增加 M9管的栅宽，既增加了 M9管的宽长比，减小了 M2管的栅源电压 VGS，M2，同时也减小了 M9 管的闪烁噪声。
2） 根据 KCL 定理和 M5、M6 的镜像关系，流过双极型晶体管 Q2 的电流等于 M5和 M6 管的漏源电流。由于增大 Q2 管的发射极-基极电压 VBE，Q2 需要增加流过Q2 的电流，即流过 M5的电流。因此增加流过双极型晶体管 Q2电流的方法是减小 R1 电阻的阻值。根据 8.3.1 中的计算，当流过 M5管的电流增加时，M5管在带隙基准电压源的输出端产生的噪声减小。
3） 减少 M1 和 M0 管的栅源电压也可以改变 M2管的工作区域。在保持 M0和 M1管栅长不变的基础上增加 M0 和 M1 管的栅宽，即可减小 M1 和 M0 管的栅源电压，并减小 M0和 M1 管的闪烁噪声 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 修改后的器件参数及其影响 [desc]
上述的三种方案都可以让 M2 管工作在饱和区的同时，减小带隙基准电压源的输出噪声。因为单独采用一种方案，需要大幅度的修改器件参数，所以这里同时采用三种方案，使器件的参数取值在一个合适的范围。
---table begin---
Table title:修改后的带隙基准电压源器件参数及修改原因
| MOS 管 | Instance Name | Model | W | L | Multiplier | 修改原因 |
|--------|---------------|-------|---|---|------------|---------|
| M0，M1 | mn          |        | 3m | 40u | 6 | 减少栅源电压；增加跨导；减小闪烁噪声|
|M2|mn| |30u|2u|5|减小闪烁噪声；减小栅源电压|
|M3，M4|mp| |2u|4u|4|增加 r0电阻，从而增加误差放大器的增益|
|M5，M6 ，M7 ，M8|mp| |6u|2u|1|减小闪烁噪声|
|M9|mn| |30u|2u|5|减小闪烁噪声；减小栅源电压|
---table end---
---table begin---
Table title:电阻（为了设计简化，这里使用了理想电阻）
| Instance Name | Model | W | L | Resistance | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|---------|----------|
| R1            | --    | -- | --| 6.5k       | 1 | 增加流过 M5、M6管的电流；增加 Q2的发射极-基极电压；减小电阻的热噪声 |
| R2            | --    | -- | --| 34.21k     | 1 | 根据 R1的阻值，获得最佳的温度特性 |
---table end---
---table begin---
Table title:双极型晶体管
| Instance Name | Model | W | L | Multiplier | 修改原因 |
|---------------|-------|---|---|------------|----------|
| Q1            | qvp5  | -- | --| 47 | 减少闭环增益，从而减少总输出噪声 |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在 RPN 模式下输入带隙基准电压源的温漂系数的计算公式 __ 机理讨论及器件参数整体调整 [desc]
修改后，再次通过“Results Browser”查看 M2管的工作区间，得到图 8- 77 所示结果。此时，M2管工作在饱和区。在该器件参数设置下，带隙基准电压源输出电压的温度特性和输出噪声如图 8- 78和图 8- 79 所示。输出噪声大小为 100.702μV。此时 M0、M1管的闪烁噪声和热噪声以及 M2管的闪烁噪声占总噪声的 75.75%。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 增加 M2 的并联个数对输出噪声的影响 [desc]
增加 M2 的并联个数，可以同时减少 M0和 M1管的热噪声，以及 M2 管的闪烁噪声。由于上述 5 个噪声是对输出噪声贡献很大，因此通过此方法可以有效降低输出噪声。将 M2 的并联个数改为 20 后，输出噪声如图 8- 80 所示，为 61.0795μV 。# 3.1. 传统的带隙电压基准电路示意图
在 8.2.3 中已经介绍了带隙电压基准的基本温度补偿方法。在传统的带隙电压基准结构中，通过 VBE电压和 VT进行补偿。由于运算放大器的存在，使 X 点和 Y 点拥有相同的电压，而 Q1 的并联数是 Q2的 n 倍，因而在 R3 上产生了只和温度相关的电压 VR3=VTlnn。 
VT和绝对温度成正比，是一个正温度系数的电压，而 VBE电压是一个负温度系数的电压。输出电压是这两个电压的线性组合。 
```
(
)
2
3
REF
BE,Q2
T
3
ln
R
R
V
V
V
n
R
+
=
+
⋅
(8-53) 
```
由于 VT是一个一阶温度系数的电压，通过精确调整 R2/R3 的比率，可以让输出电压的一阶温度系数被完全抵消，从而得到和温度无关的电压。但是实际应用中，还要考虑输出电压中得不到补偿的高次电压分量，结果往往如图 8- 84 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 增加 M2 的并联个数对输出噪声的影响 __ VT 和绝对温度成正比 [desc]
所以由 VT 引入的高阶温度项可以忽略。高阶温度系数主要是由于双极晶体管 VBE的温度特性： 
```
(
)
( )
(
)
C
BE
G
BE
r
G
r
r
r
C
r
(
)
ln
ln
(
)
I
T
kT
T
kT
V
T
V
T
V
T
V
T
T
q
T
q
I
T
η
⎡
⎤
⎛
⎞
⎛
⎞
⎛
⎞
⎛
⎞
=
+
−
−
+
⎡
⎤
⎜
⎟
⎜
⎟
⎜
⎟
⎜
⎟
⎢
⎥
⎣
⎦
⎝
⎠
⎝
⎠
⎝
⎠
⎝
⎠
⎣
⎦
(8-54) 
```
其中，电场因子 η 是由工艺决定的常数，Tr是一个给定的常数温度。因为 IC与温度有关，可以设 IC(T)=FTδ，则式（8-54）可写为： 
```
(
)
( )
(
)
(
)
(
)
(
)
(
)
BE
r
G
r
BE
G
r
r
C
r
ln
ln
ln
V
T
V
T
k
k
F
V
T
V
T
T
T
T
T
T
q
I
T
q
η
δ
η
δ
⎧
⎫
⎡
⎤
−
−
⎪
⎪
=
+
+
⋅
+
−
⋅
−
⋅
⎢
⎥
⎨
⎬
⎢
⎥
⎪
⎪
⎣
⎦
⎩
⎭
(8-55) 
```
最后一项是 TlnT 项的非线性的分量，所以在一阶补偿之后仍然存在。在大部分工艺下，由于工艺参数 η 的值和由电阻引入的系数 δ 不能很好抵消，最后无论如何调节电流和电阻配比，温度系数都不能达到足够的精度。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 增加 M2 的并联个数对输出噪声的影响 __ 为了得到温漂系数足够低的带隙电压基准 [desc]
高阶温度系数需要进一步的补偿。补偿的方法是采用如图 8- 85 中给出的电路结构。其中，在原来电路的基础上，加入了补偿的电路，用运放锁定电压取得 VBE/R4 的电流，通过电流镜，同等大小的电流流过双极晶体管 Q3，从而使得 Q3和 Q2的 VBE电压间产生一个带有 TlnT 项的差值。Q3和 Q2的 VBE电压作为一对输入，Q1、Q2 的 VBE 电压作为一对输入形成一个四输入运放。其中加入 VBE,Q2和 VBE,Q3 这个输入对的目的是在正常工作的时候给 Q1 和 Q2端提供一个 TlnT 项电压差值，并将这个差值项引入到输出端，修正输出电压的温度系数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 增加 M2 的并联个数对输出噪声的影响 __ 温度补偿的方法 [desc]
如下：假设 A2 的增益足够大，那么 VR4=VBE2，因此经过电流镜镜像之后，在 Q2 和 Q3 之间将产生一个 TlnT 项的电压。假设这个电压为 C1.
TlnT；另外在 Q2 和 Q3 的电压差中含有和温度成正比的项 C2.
T。因此输出电压可以表示为： 
```
(
)
1
3
M2
M2
REF
BE1
1
3
R1
BE1
2
1
3
M1
M1
ln
ln
R
R
K
n
g
g
V
V
R
R
I
V
C
T
C T
T
R
q
g
g
⎡
⎤
⎛
⎞
+
=
+
+
=
+
−
⋅
−
⋅
⎢
⎥
⎜
⎟
⎝
⎠
⎣
⎦
(8-56) 
```
其中，gM1和 gM2 分别表示 A1 运放两个输入对的跨导。在这些参数中，常数 C1 和 C2由电阻的阻值、温度系数以及几个三极管的 VBE电压控制；gM1和 gM2 的比例则由 2 个输入对的工作点和宽长比决定。实际制造中，电阻的温度系数一般不能自由选择，所以 C1 和 C2 可以通过调节 R4 来控制，同时 gM2/gM1也可以通过运放的设计人为控制。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 设计过程 [desc]
下面基于 CSMC 公司 0.5µm CMOS 混合信号工艺库，完成上述电路的实现与仿真验证。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 设计过程 __ 建立设计库和电路图 [desc]
首先在“Library Manager”中选择建立新的“Library”选项，在弹出的 “New Library”对话框中，输入库名 BG。接着弹出的“Attach Design Library to Technology File”对话框要求用户为库 BG 指定一个工艺库（Tech Library)，选择需要的工艺库 CSMC 0.5um 5V 工艺库，库名是“st02”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 设计过程 __ 建立设计库和电路图 __ 电路的绘制和初始参数的设定 [desc]
电路中 MOS 管的初始宽长比都要根据计算设定。出于功耗考虑，设定电流镜中的电流为 0.3µA。采用和低噪声带隙电压基准的例子中介绍的类似的方法，选用适当的元器件来搭建这个电路。其中使用的器件类型如下表所示。
---table begin---
Table tile:使用器件的类型
| 器件 | Library | Cell Name | Model Name |
| ------ | ------ | ------ | ------ |
| NMOS | st02 | Mn | mn |
| PMOS | st02 | Mp | mp |
| Resistance | analogLib | Res | -- |
| Bipolar | st02 | qvp5 | qvp5 |
| 电流源 | analogLib | Idc | -- |
| 电压源 | analogLib | Vdc | -- |
---table end---# 选项 
接着弹出的“Attach Design Library to Technology File”对话框要求用户为库 BG 指定一个工艺库（Tech Library)，在下拉菜单中选择需要的工艺库 CSMC 0.5um 5V 工艺库，库名是“st02”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 设计过程 __ 建立设计库和电路图 __ 选择 Technology Library [desc]
选择 OK 后在 CIW 窗口中将会显示“attach”是否成功，如果成功就可以进入下一步操作。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 设计过程 __ 建立设计库和电路图 __ 在“Library Manager”中选定新建的库 BG [desc]
在菜单中选择新建“cell view”，然后就会弹出设定“Cell View”名称和类型的“Create New File”对话框。在“Cell Name”栏输入电路的名字：bandgap；在 Tool 下拉菜单中选择“Composer-Schematic”（电路图)，这时“View Name”一栏会自动添上“schematic”，点击 OK 键，建立新的电路图。建立完成后，空的电路图的窗口会出现。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1) 器件的选用 [desc]
采用和低噪声带隙电压基准的例子中介绍的类似的方法，选用适当的元器件来搭建这个电路。其中使用的器件类型如表 8- 8 所示。
---table begin---
Table tile:使用器件的类型
| 器件 | Library | Cell Name | Model Name |
| ------ | ------ | ------ | ------ |
| NMOS | st02 | Mn | mn |
| PMOS | st02 | Mp | mp |
| Resistance | analogLib | Res | -- |
| Bipolar | st02 | qvp5 | qvp5 |
| 电流源 | analogLib | Idc | -- |
| 电压源 | analogLib | Vdc | -- |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2) 电路结构 [desc]
根据前面的电路框图和注意事项，设计中采用了电路结构。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3) 设定电流镜初始宽长比 [desc]
为了方便设计，减少不必要的仿真，电路中 MOS 管的初始宽长比都要根据计算设定。出于功耗考虑，设定电流镜中的电流为 0.3µA。在这个电路中没有画出提供基准电流的电路，而采用了理想电流基准作为输入的基准电流。图中 MN0 和 MP0 所在支路的电流就是由理想电流源提供的。NMOS 管中，MN0、MN1、MN2、MN3、MN4 组成一个电流镜；PMOS 管中，MP0、MP7、MP8、MP9、MP10 组成一组。为运放提供适当的偏置电流。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 双端输入运放的位置 [desc]
双端输入运放的位置如图 8- 98 中阴影的部分所示。由于这个运放只有一级，结构又和四输入运放相似，而且可以利用已有的共栅管栅压，所以设计相对简单。采用和四输入运放类似的方法分配好电流后，这个运放中的 MOS 管初始设定就一目了然，如表 8- 10 所示。
---table begin---
Table tile:双端输入运放 MOS 管参数设置
| MOS 管 | 
| ------ | 
---table end---# 放的稳定工作，MN1、MN2 的对地导流能力必须超过输入
放的稳定工作，MN1、MN2 的对地导流能力必须超过输入，管中流过的总电流，所以它们的每个的对地电流都被设置为(N1+N2)IBIAS。而 MP1、MP2的导流能力，则应当足够保持四输入运放的输入、输出的电流平衡。因为，从输入对管流入的电流总共有(N1+N2)IBIAS，MN1 和 MN2 的总对地电流为 2(N1+N2)IBIAS，因而 MP1、MP2、M'P1、M'P2、M'N1、M'N2 应当分别流过(N1+N2)IBIAS/2 的电流。为了保证电流精确，MOS 管被尽量设置为电流镜中的 MOS 管尺寸。综合考虑，MOS 管参数设定如表 8- 9所示。
---table begin---
Table tile: 4 输入端运放 MOS 管参数设置
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| MP7 | mp | 8u | 3u | N1 | st02 | mp | symbol |
| MP9 | mp | 8u | 3u | N2 | st02 | mp | symbol |
| M'P7 | mp | 8u | 1.5u | N1 | st02 | mp | symbol |
| M'P9 | mp | 8u | 1.5u | N2 | st02 | mp | symbol |
| MP12, MP13 | mp | 15u | 5u | N1 | st02 | mp | symbol |
| MP14, MP15 | mp | 15u | 5u | N2 | st02 | mp | symbol |
| MN1, MN2 | mn | 8u | 5u | N1 +N2 | st02 | mn | symbol |
| M'N1, M'N2 | mn | 8u | 3u | (N1 +N2) /2 | st02 | mn | symbol |
| MP1, MP2 | mp | 8u | 3u | (N1 +N2) /2 | st02 | mp | symbol |
| M'P1, M'P2 | mp | 8u | 1.5u | (N1 +N2) /2 | st02 | mp | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 双端输入运放的设定 [desc]
双端输入运放的位置如图 8- 98 中阴影的部分所示。由于这个运放只有一级，结构又和四输入运放相似，而且可以利用已有的共栅管栅压，所以设计相对简单。采用和四输入运放类似的方法分配好电流后，这个运放中的 MOS 管初始设定就一目了然，如表 8- 10 所示。
---table begin---
Table tile: 双端输入运放 MOS 管参数设置
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| MP10 | mp | 8u | 3u | 2 | st02 | mp | symbol |
| M'P10 | mp | 8u | 1.5u | 2 | st02 | mp | symbol |
| MP16, MP17 | mp | 15u | 5u | 2 | st02 | mp | symbol |
| MN3, MN4 | mn | 8u | 5u | 2 | st02 | mn | symbol |
| M'N3, M'N4 | mn | 8u | 1.5u | 1 | st02 | mn | symbol |
| MP3, MP4 | mp | 8u | 3u | 1 | st02 | mp | symbol |
| M'P3, M'P4 | mp | 8u | 1.5u | 1 | st02 | mp | symbol |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 带隙电压基准中的双极晶体管和电阻 [desc]
双极晶体管包括 Q1、Q2、Q3。其中为了精确匹配，Q1 和 Q2 一般采用 2:1、4:1、8:1、24:1 等比例这里使用的是 8:1。另外 Q3 为了和 Q2一致，配比为 1:1。
R1、R2、R3、R4 电阻的阻值和双极晶体管的电流直接相关。假设 Q1、Q2 的中的电流约为 600nA。那么 Q2管上流过的电流可以用下式表示： Q1 Q2 3 kT ln N I I q R = = (8-58)
所以，R3≈90kΩ，在电路中将 R3 的阻值设定为 90kΩ。R1 和 R2 的阻值分别设定为 “res1_2”，初始值根据 Razavi[1] 第 11 章的推算暂时设定为：res1_2=R3 .17.2/lnN=744kΩ (8-59)
R4 的阻值设定为 “res4”，阻值待定。这样，所有器件的初始参数都设定好了。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 其它一些器件的设定 [desc]
其它一些 MOS 管的初始宽长比应当尽量使用了电流镜的 MOS 管大小，具体参数如表 8- 11 所示。
---table begin---
Table tile: 其余 MOS 管参数设置
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| MN5 | mn | 5u | 5u | 1 | st02 | mn | symbol |
| MP5 /MP6 | mp | 8u | 3u | 2 | st02 | mp | symbol |
| M'P5 /M'P6 | mp | 8u | 1.5u | 2 | st02 | mp | symbol |
| MP8 | mp | 8u | 3 | 1 | st02 | mp | symbol |
| M'P8 | mp | 8u | 1.5u | 1 | st02 | mp | symbol |
| MP11 | mp | 8u | 3u | 3 | st02 | mp | symbol |
| M'P11 | mp | 8u | 1.5u | 3 | st02 | mp | symbol |
---table end---
另外，要注意电压源“vdc”要设置 5V 的直流电压。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电路仿真 [desc]
电路仿真的目的主要是在结构确定好的前提下，对电路中器件的参数进行微调，以达到需要的性能。下面是对这个电路的仿真过程。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 启动仿真器并进行基本设定 [desc]
(1) ADE 的启动
在电路图编辑窗口中选择“Tools”�“Analog Environment”，如图 8- 99 所示，弹出的 ADE 窗口如图 8- 100 所示。
(2) 设定工艺模型
首先应当设定工艺模型，在 ADE 菜单中选择“Setup”�“Model Libraries”，如图 8- 101 所示。
(3) 设置变量
在 ADE 中设置电路中的变量。在菜单中选择“Variables”�“Copy From Cellview”获得电路图中的变量列表，如图 8- 103 所示。对于需要修改的参数，可以双击“Design Variable”中的变量，如图 8- 104 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 [desc]
共源共栅电流镜中，为了保证电流基准的稳定和精确，必须保证共源管的 VDS电压"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __  [desc]
---table begin---
Table tile: MOS 管参数设置
| MOS 管 | Instance Name | Model | W | L | Multiplier | Library Name | Cell Name | View Name |
| ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ | ------ |
| MP11 | mp | 8u | 3u | 3 | st02 | mp | symbol |
| M'P11 | mp | 8u | 1.5u | 3 | st02 | mp | symbol |
---table end---
另外，要注意电压源“vdc”要设置 5V 的直流电压。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 电路仿真 [desc]
电路仿真的目的主要是在结构确定好的前提下，对电路中器件的参数进行微调，以达到需要的性能。下面是对这个电路的仿真过程。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 启动仿真器并进行基本设定 [desc]
- (1) ADE 的启动: 在电路图编辑窗口中选择“Tools”�“Analog Environment”。
- (2) 设定工艺模型: 首先应当设定工艺模型，在 ADE 菜单中选择“Setup”�“Model Libraries”。
- (3) 设置变量: 在 ADE 中设置电路中的变量。在菜单中选择“Variables”�“Copy From Cellview”获得电路图中的变量列表。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 通过仿真调节电流镜工作点 [desc]
共源共栅电流镜中，为了保证电流基准的稳定和精确，必须保证共源管的 VDS电压足够高。同时为了降低最低输入电压，VDS电压又不能太高。一般来说大于 0.3V～0.35V比较适合。电流镜中共源管 MP0及 MN0 的 VDS电压分别由 R5、R6 电阻控制。现在就通过DC 扫描确定 R5。首先是 PMOS 电流镜。在 ADE 中设定仿真方式为 DC，扫描方式设定为变量扫描，对 R5 的电阻阻值 res5 进行扫描。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 四输入运放的调节 [desc]
运放的调节首先要看静态的工作点。在其它电路还没有调好的时候，最好把运放的输入端全都接地, 如图 8- 113 所示，修改后的电路如图 8- 114 所示。注意：在对电路进行修改的时候应当经常保存备份，防止原始设计丢失的糟糕情况。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 335 [desc]
图 8- 113  需要接地的输入端（图中的叉号) 
图 8- 114  运放输入接地后的电路 
然后仿真电路的静态工作点。在 ADE 中选择仿真类型的对话框中选择下列选项, 如图 8- 115 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 336 [desc]
图 8- 115  仿真直流工作点 
点击开始仿真。仿真完成后观察哪些管子工作在不正常的状态。可以在 ADE 的菜单中选择“Results”�“Annotate”�“DC Operating Point”，这样就可以将直流仿真得到的工作点直接标注到电路图中，如图 8- 116 所示。注意在“Result”�“Annotate”子菜单中根据仿真的类型可以标注各种不同的信息。比如 DC 工作点分析后就可以选择标注器件的工作点(DC Operating Points)，显示包括 MOS 管 VGS、VDS、VTH在内的信息；也可以标注 DC 结点电压(DC Node Voltages)，显示的是各个结点的电压。瞬态仿真之后也可以将最终时刻的状态标注工作点(Transient Operating Points)或节点电压(Transient NodeVoltages)。
图 8- 116  标注子菜单 
这时再看电路图中标注出了各器件上的重要参数，例如 MOS 管就标注了 IDS、VGS、VDS、VSTAT 等重要参数。利用这些数据，在图中可以直接查看有哪些器件的工作状态不正常。经过检查，各 MOS 管工作点正常，共源共栅级中的共源管的过驱动电压都保持在 0.3V 左右。所有 MOS 管工作在饱和区。因而原电路不用再做修改。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 4) 调节带隙电压基准的一阶工作点 [desc]
调节高阶温度补偿之前，首先要将核心的带隙电压基准调节到基本稳定的状态。下面介绍调节的方法。前面已经粗略计算过了 R3 电阻和 R1、R2 电阻 res1_2 的初始值为 744kΩ。现在要进一步调整 R1 和 R2 的电阻到最优值。首先在原电路的基础上将用于高阶温度补偿的一个输入对的信号接地，也就是图 8- 117 中用○╳符号标注出来的两个信号。修改后的电路如图 8- 118 所示。
图 8- 117  电路中接地的两个结点 
图 8- 118  修改后的电路结构 
修改好电路之后，要对温度进行扫描。在 ADE 中打开分析类型对话框。选项如下图，设置为在-40~125℃之间进行 DC 扫描，如图 8- 119 所示。注意其中画圈的部分。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 338 [desc]
图 8- 119  设置分析类型 
然后选择输出。首先需要关注输出电压 VREF。VREF是电路中的一个结点，可以通过在 ADE 菜单中选择“Outputs”�“To Be Plotted”�“Select On Schematic”，如图 8- 120 所示，然后在电路图中点击 VREF节点，VREF就被加入到了输出的列表中。
图 8- 120  Select On Schematic 菜单选项"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 339 [desc]
另外就是在整个温度域内的温度漂移表达式，参照低噪声带隙电压基准例子中的介绍的方法加入总温漂表达式表达式作为输出。如图 8- 121 所示，该表达式为： (ymax(VS(""/Vref""))-ymin(VS(""/Vref"")))/average(VS(""/Vref""))/(125-(-40))*1000000
图 8- 121  输出设定窗口 
仿真结果，总的温度系数为 542ppm/℃，输出电压有负温度系数，根据输出电压的公式，VBE项的温度系数为负，第二项温度系数为正。所以应当提高 R1和 R2 的电阻。图 8- 122 显示 R1、R2 的电阻不足，因而需要采用参数扫描对 R1、R2的阻值进行选择。在 ADE 窗口中选择菜单“Tools”�“Parametric Analysis”，如图 8- 123 所示。
图 8- 122  输出电压 vs. 温度 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 340 [desc]
图 8- 123  选择参数分析 
在参数分析窗口中，对 R1、R2 的电阻 res1_2 进行扫描，扫描范围设置为 750K～1.5MΩ，点击“Analysis”�“Start”，如图 8- 124 所示。扫描的结果如图 8- 125 所示。
图 8- 124  参数分析窗口 
图 8- 125  参数扫描结果 
显然，最低的温度系数应当在 R1和 R2介于 0.94ΩM 和 1.12MΩ 之间获得。所以可以修改扫描的范围为 0.94MΩ～1.12MΩ，再进行一次参数分析。如图 8- 126 所示,结果显示在 res1_2=1.03MΩ 的时候可以得到最小的温漂，大约 20ppm/℃。将现在 ADE 的设置保存为 temp，后面还会用到."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 341 [desc]
图 8- 126  第二遍参数扫描结果 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 5) 调节双端输入运放 [desc]
调节的方法和四输入运放差不多，也是在输入被接地的情况下进行工作点分析，观察电路的工作点。这里就不详细叙述了。修改完成后在电路图中重新接上双端运放."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 6) 调整 R4电阻 [desc]
由于双端运放的钳制，R4 电阻上的电压和 Q2 的 VBE 电压相同，大约是 633mV。由于 Q2 和 Q3 管的 VBE电压被接到四输入运放的一个输入对 MP14、MP15上，所以在常温下要尽量保证 Q2 和 Q3 上的电流相当，而 Q3 上的电流又和 R4 上的电流相同。因此 R4的电阻应当是 4 BE2 / Q2 1M R V I =≈ Ω。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 7) 调整 N1、N2 [desc]
在按照上述过程调整变量之后，电路核心电路可以工作。但是并没有达到要求的温漂。原因主要是用于补偿的高阶温度分量补偿不准确，所以得不到精确的补偿。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 8) 进一步调整 N2、N1 [desc]
调整 N2、N1也就是调整 gm2/gm1。从前面的公式当中可以看出，两个输入对的比例 gM2/gM1在对高阶温度补偿有一定作用的同时。也对输出电压的总一阶温度系数有一定影响。很难用温漂来作为仿真的指标。因此输出电压的导数“Deriv”是一个更直观的指标。 Deriv=derive(VS(“/VREF”)) 另外，输出电压导数的摆幅“swing”更为重要，因为这个指标确定了一个电路的高阶温度补偿的准确度。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过仿真调节电流镜工作点 __ 342 [desc]
图 8- 127  Load State 
输出设置方面，设置了输出电压、“Deriv”和“swing”这三个输出, 如图 8- 128 所示。
图 8- 128  输出设定 
在没有补偿的时候（N2 输入对接地)，电路的电路仿真结果如图 8- 129 所示, (swing=163µ).
图 8- 129  不接入 N2输入对的输出电压导数和输出电压 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 调整 N1、N2 [desc]
在按照上述过程调整变量之后，电路核心电路可以工作。但是并没有达到要求的温漂。原因主要是用于补偿的高阶温度分量补偿不准确，所以得不到精确的补偿。 
调整 N2、N1也就是调整 gm2/gm1。从前面的公式当中可以看出，两个输入对的比例 gM2/gM1在对高阶温度补偿有一定作用的同时。也对输出电压的总一阶温度系数有一定影响。很难用温漂来作为仿真的指标。因此输出电压的导数“Deriv”是一个更直观的指标。 
Deriv=derive(VS(“/VREF”)) 
另外，输出电压导数的摆幅“swing”更为重要，因为这个指标确定了一个电路的高阶温度补偿的准确度。 
swing=ymax(derive(VS(“VREF”)))-ymin(derive(VS(“/Vref”))) 
这个指标的意义是 VREF电压的导数的起伏幅度。在高阶温度项消去做得好的时候，导数的摆幅会明显降低。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 工艺角分析 [desc]
前面的仿真都是在 TT 工艺角下进行的。在调整基本完成后需要用工艺角分析对电路的仿真结果进行检验。现在希望检验的是在不同的工艺角下输出电压的中心值和温漂是否一致。下面就是工艺角分析的过程 
---table begin---
Table tile:最终的变量优化结果
| res1_1      | res4     | res5  | res6  | N1 | N2 |
|-------------|-----------|-------|-------|----|----|
| 955.8KΩ     | 1MΩ      | 1.2Ω  | 1.5Ω  | 16 | 1  |
---table end---
工艺角分析窗口如图 8- 145 所示。 
---table begin---
Table tile:仿真中使用的工艺角组及其中的工艺角
| MOS      | BIP               |
|----------|-------------------|
| sf ss fs ff tt     | bipslow bipfast bipty |
---table end---# 8 工艺角分析
前面的仿真都是在 TT 工艺角下进行的。在调整基本完成后需要用工艺角分析对电路的仿真结果进行检验。现在希望检验的是在不同的工艺角下输出电压的中心值和温漂是否一致。下面就是工艺角分析的过程。
在 ADE 中调出前面保存的“state”，“temp”。注意不要载入原来的变量设置。这样当工艺角分析窗口打开的时候，ADE 中的输出设置会被直接导入到工艺角窗口中。然后在 ADE 中选择“Tools”�“Corners”，打开工艺角分析窗口。
建立工艺。在工艺角分析界面中选择菜单“Setup”�“Add Process”，弹出如下对话框。
其中“Process Name”可以任意取，“Base Directory”和“Model File”可以分别从 ADE 中的模型库设置对话框（在 ADE 中选择菜单“Setup”�“Model Library”打开)中拷贝过来。
在模型库设置窗口中选择一行，该模型文件的路径和文件名就显示在下面的文本框中。路径和文件名分别复制回工艺角分析的添加工艺角对话框中的“Base Directory”和“Model File”栏，选择 OK。
然后再逐一加入 MOS、双极、电阻、电容的模型，这里只以 MOS 为例。
在工艺角分析窗口中选择菜单“Setup”�“Add/update model info”，然后在对话框中选择“Group/Variants”。并在下面建立叫 MOS 的一组工艺角，并在选项中输入 MOS 的5 个工艺角的名称，中间用空格隔开。
---table begin---
Table tile:最终的变量优化结果
| res1_1     | res4 | res5 | res6 | N1 | N2 |
|------------|------|------|------|----|----|
| 955.8KΩ    | 1MΩ  | 1.2Ω | 1.5Ω | 16 | 1  |
---table end---
---table begin---
Table tile:仿真中使用的工艺角组及其中的工艺角
| MOS         | BIP                | RES                 | CAP                |
|------------|-------------------|-------------------|-------------------|
| sf ss fs ff tt| bipslow bipfast biptypical| resslow resfast restypical| capslow capfast captypical |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 加入工艺角 [desc]
在界面中点击 Add Corner 按钮，依次加入 TT FF FS SS SF 这 5 个工艺角。
这时可以通过下拉菜单修改每个工艺角使用的器件模型。
点击 Run，最后仿真结果可见温漂完全符合设计的要求，最高仅1.68ppm/℃。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 基准电流源 [desc]
基准电流源是指在模拟集成电路中用来作为其它电路的电流基准的高精度、低温度系数的电流源。电流源作为模拟集成电路的关键电路单元，广泛应用于运算放大器、A/D 转换器、D/A 转换器中。偏置电流源的设计是基于一个已经存在的标准参考电流源的复制，然后输出给系统的其他模块。因此，电流源的精度直接影响到整个系统的精度和稳定性。
基准电流源是模拟电路所必不可少的基本部件，高性能的模拟电路必须有高质量、高稳定性的电流和电压偏置电路来支撑，它的性能会直接影响到电路的功耗、电源抑制比、开环增益、以及温度等特性。在本章中，主要讨论在 CMOS 技术中电流基准的产生。首先，将研究基准电流源的工作原理，接着介绍常用的基准电流源的几种结构，最后以一种基准电流源的设计为例详细介绍基准电流源的设计流程，并引入一种输出基准电流高阶温度补偿的方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源 [desc]
基准电流源是指在模拟集成电路中用来作为其它电路的电流基准的高精度、低温度系数的电流源。电流源作为模拟集成电路的关键电路单元，广泛应用于运算放大器、A/D 转换器、D/A 转换器中。偏置电流源的设计是基于一个已经存在的标准参考电流源的复制，然后输出给系统的其他模块。因此，电流源的精度直接影响到整个系统的精度和稳定性。基准电流源是模拟电路所必不可少的基本部件，高性能的模拟电路必须有高质量、高稳定性的电流和电压偏置电路来支撑，它的性能会直接影响到电路的功耗、电源抑制比、开环增益、以及温度等特性。在本章中，主要讨论在 CMOS 技术中电流基准的产生。首先，将研究基准电流源的工作原理，接着介绍常用的基准电流源的几种结构，最后以一种基准电流源的设计为例详细介绍基准电流源的设计流程，并引入一种输出基准电流高阶温度补偿的方法。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源 __ 电源抑制比（Power Supply Reject Ratio, PSRR） [desc]
通常，基准电流源的一个重要作用就是，在正常工作电压范围内当电源电压发生变化时，输出电流基本不变，也就是其电源抑制比较高。电源抑制比是衡量电路对电源线上噪声的抑制能力的参数，换句话说，基准电流源的电源抑制比表现了输出基准电流随电源电压 VDD 变化的情况。对于基准电流源，本章采用的电源抑制比的定义为：从电源电压 VDD 到输出基准电流的增益。符号表达式为：
---table begin---
Table tile:PSRR formula
|PSRR formula=20DB(IREF/ΔIREF*VDD/ΔVDD)|
|---|
|(IREF/ΔIREF*VDD/ΔVDD)|
---table end---
---table begin---
Table tile:Param in the formula
|Param|Description|
|---|---|
|PSRR|电源抑制比，单位 dB；|
|IREF|标准电流值，A；|
|ΔIREF|电流变化值，A；|
|VDD|电源电压；|
|ΔVDD|电源电压 VDD 的变化，V。|
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源 __ 电源抑制比（Power Supply Reject Ratio, PSRR） __ 功耗 [desc]
与基准电压源类似，基准电流源中也有功耗的要求。其衡量标准也是电路在正常工作情况下的静态电流的大小。为了满足各种不同电路的要求，如精度、响应速度等，通常会增大电路的功耗。但是，受环境和电源电压的限制，如何有效的减小功耗，依然是当前芯片设计师们不断努力的研究方向。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 利用电阻 RS 在 NMOS 管源极产生电压差 V [desc]
1. 产生与电源电压 VDD 无关的电流
---table begin---
Table tile:Design methods
|Step|Description|
|---|---|
|1|产生与电源电压 VDD 无关的电流|
---table end---
2. 产生与温度无关的电流
由式（9-9）我们可以看出，输出基准电流的温度特性与工艺有关，要产生与温度无关的输出基准电流，首先，要对其温度特性进行分析。
1) 输出基准电流的温度特性分析
其中，载流子迁移率与温度的关系可以表示如下[2]  
---table begin---
Table tile:Equation
|Equation|
|---|
|μ / μ(T0) = T / T0^(-α)|
---table end---
其中，α 约等于 1.5，μT0 表示参考温度下的载流子迁移率大小。严重的是在 140℃以上时，MOS
2. 产生与温度无关的电流的要求。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 利用电阻 RS 在 NMOS 管源极产生电压差 V [desc]
1. 产生与电源电压 VDD 无关的电流
---table begin---
Table tile:Design methods
|Step|Description|
|---|---|
|1|产生与电源电压 VDD 无关的电流|
---table end---
2. 产生与温度无关的电流
由式（9-9）我们可以看出，输出基准电流的温度特性与工艺有关，要产生与温度无关的输出基准电流，首先，要对其温度特性进行分析。# 9-3
```
C
K W L
μ
μ
+
=
+
+
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 9-3-1 [desc]
如果忽略体效应的影响，可得： 
```
TH3
TH4
V
= V
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 9-4 [desc]
从而， 
```
(
)
OUT
N
N
2
1
1
OX
I
V
C
W L
K
μ
⎛
⎞
−
=
⎜
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 9-5 [desc]
因此， 
```
(
)
2
N
N
OUT
2
1
2 1
OX
V
C
W L
I
K
μ
=
⎛
⎞
⎜ −
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流源的工作原理 __ 常用基准电流源的几种结构 __ 9-6 [desc]
正如所希望的，电流与电源电压 VDD 无关，但仍旧是工艺和温度的函数。 
为了消除输出基准电流对温度的影响，我们可以根据电压差 V 产生的不同方式，分别采取不同的温度补偿方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
常用基准电流源的几种结构 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 [desc]
利用电阻 RS 在 NMOS 管源极产生电压差 V "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1 [desc]
产生与电源电压 VDD 无关的电流 
如图 9-2 所示电路中，我们用电阻 RS 产生了图 9-1 所示的 NMOS 管源端的电压差V，即 RS 两端的电压 V=IOUTRS，由于 IREF＝IOUT，我们可以得到。
```
(
)
(
)
OUT
OUT
TH3
TH4
OUT
S
N
N
N
N
2
2
OX
OX
I
I
V
V
I
R
C
W L
C
K W L
μ
μ
+
=
+
+
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-7 [desc]
忽略体效应的影响，我们有 
```
(
)
OUT
OUT
S
N
N
2
1
1
OX
I
I
R
C
W L
K
μ
⎛
⎞
−
=
⎜
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-8 [desc]
因此， 
```
(
)
2
OUT
2
N
S
N
2
1
1
1
OX
I
C
W L
R
K
μ
⎛
⎞
=
⎜ −
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-9 [desc]
这样，我们就得到了一个与电源电压 VDD 无关的输出基准电流，其温度特性与电阻 RS 和 MOS 管的工作情况有关。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 2 [desc]
产生与温度无关的电流 
由式（9-9）我们可以看出，输出基准电流的温度特性与工艺有关，要产生与温度无关的输出基准电流，首先，要对其温度特性进行分析。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 1-1 [desc]
输出基准电流的温度特性分析 
由式（9-9）输出基准电流的表达式，表明输出基准电流与载流子迁移率和电阻有关，而载流子迁移率和电阻都是与温度有关的函数。 
其中，载流子迁移率与温度的关系可以表示如下。
```
0
0
T
T
T
α
μ
μ
−
⎛
⎞
=
⎜
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-10 [desc]
其中，α 约等于 1.5，μT0 表示参考温度下的载流子迁移率大小。严重的是在 140℃以上时，MOS 管载流子迁移率还会显著地下降，导致 MOS 管最终失去作用。 
除此以外，在 CMOS 工艺中，各种电阻的阻值的温度系数一般比较高，即随着温度的变化，电阻阻值变化较大。由式（9-9）可知，在饱和区工作状态下，电流与电阻的-2 次方成反比。显然，温度对基准电流的稳定性会造成很大的影响。 
由以上分析我们可以知道，利用电阻 RS 产生基准电流的结构，如果不进行温度补偿，其温度特性很差。因此，提高图 9-2 电路结构中的输出基准电流的温度特性是必须的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 2-1 [desc]
输出基准电流温度补偿方案 
由式（9-9）输出基准电流的表达式及上文的分析可以看出，输出基准电流与电源电压无关，但是仍然与温度有关。其一阶温度系数的计算公式可以表达为：
```
OUT
1
OUT
1
dI
TC
I
dT
=
⋅
```
 # 9-11
通常，我们把温度系数 TC 乘以 106 表示成百万分之一或者说是 ppm/℃的形式。在式（9-9）中，与温度有关的参数有载流子迁移率 μN 和电阻 R。所以最终一阶温度系数可以表示为:
```
N
1
N
1
2
d
dR
TC
dT
R dT
μ
= − μ
⋅
−
⋅
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-12 [desc]
由式(9-10)我们知道 
```
0
0
T
T
T
α
μ
μ
−
⎛
⎞⎟
⎜
=
⎟
⎜
⎟
⎜⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-13 [desc]
```
1
0
0
0
N
N
0
0
1
T
T
T
d
dT
T
T
T
α
α
α μ
μ
α
μ
μ
−
−
−
⎛
⎞
−
⎜
⎟
⎝
⎠
⋅
=
= −
⎛
⎞
⎜
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-14 [desc]
其中，α 根据工艺的不同取值不同，但是常数。 
通过上述式子，我们可以得出，输出基准电流的一阶温度系数为 
```
1
R
2
TC
TC
T
= α
−
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-15 [desc]
其中，TCR 指电阻的温度系数。可见，只要电阻的温度系数能够与载流子迁移率的温度系数相抵消，输出基准电流的一阶温度系数就能够等于零，从而提高了输出基准电流的温度特性。 
在实际的工艺中，受工艺的限制，可能没有与载流子迁移率温度特性相匹配的电阻，这时，我们可以使用两种不同的电阻，通过电阻阻值的匹配来实现与载流子迁移率的温度系数的相互抵消。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-3-2 [desc]
利用电阻 RS 在 PMOS 管源极产生电压差 V 
图 9-3 电阻 RS 在 PMOS 管源极产生电压差 V 
图 9-3 为利用电阻 RS 在 PMOS 管源极产生电压差 V 的电路。与图 9-2 的工作原理相同，该电路也是利用电阻 RS 两端的电压 V＝IOUTRS 来产生电压差，不同的是，RS 的 位置在 PMOS 管的源端
```
(
)
2
OUT
2
P
S
P
2
1
1
1
OX
I
C
W L
R
K
μ
⎛
⎞
=
⎜ −
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-16 [desc]
这种结构的优点是在常用的 N 阱工艺中可以消除了体效应的影响。比较图 9-2的结构，我们假设忽略了体效应，由于图 9-2 中 M3 和 M4 的源极位于不同的电位，所以考虑体效应后，前面的假设 VTH3＝VTH4 会产生一些误差。在图 9-3 中，我们在 PMOS管 M2 的源极引入电阻，在 N 阱 CMOS 工艺中，可以通过将每个 PMOS 晶体管的源极和衬底相连来消除体效应。这样，输出基准电流 IOUT 的表达式会更加精确。 
在本小节的电路结构中，我们依然可以使用电阻与载流子迁移率的温度系数相互抵消的方法来提高输出基准电流的温度特性。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 3 [desc]
共源共栅基准电流源 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 4 [desc]
三支路基准电流源 
为了进一步提高输出基准电流的 PSRR，在图 9-2 的基础上添加了第三条支路，构成了三支路结构的基准电流源，如图 9-6 所示。输出基准电流的表达式与式（9-9）相同，M5 与 M6 管组成的第三条支路在原来的电流镜的基础上添加了一个负反馈系统，如图 9-7（a）（b）所示。 
```
位置在 PMOS 管的源端。这样，最终输出基准电流的表达式改变为:
```
(
)
2
OUT
2
P
S
P
2
1
1
1
OX
I
C
W L
R
K
μ
⎛
⎞
=
⎜ −
⎟
⎝
⎠
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-16 [desc]
这种结构的优点是在常用的 N 阱工艺中可以消除了体效应的影响[1]。比较图 9-2的结构，我们假设忽略了体效应，由于图 9-2 中 M3 和 M4 的源极位于不同的电位，所以考虑体效应后，前面的假设 VTH3＝VTH4 会产生一些误差。在图 9-3 中，我们在 PMOS管 M2 的源极引入电阻，在 N 阱 CMOS 工艺中，可以通过将每个 PMOS 晶体管的源极和衬底相连来消除体效应。这样，输出基准电流 IOUT 的表达式会更加精确。
在本小节的电路结构中，我们依然可以使用电阻与载流子迁移率的温度系数相互抵消的方法来提高输出基准电流的温度特性。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-16 __ 共源共栅基准电流源 [desc]
图 9-4 中的沟道长度调制效应在 9.2 节基准电流源的工作原理的介绍中，我们没有考虑沟道长度调制效应所引起的问题，也就是 VDS 对电路的影响。由于 M3 和 M4 管的 X 点和 Y 点的电位差很大，所以 IREF 和 IOUT 不等。在实际电路设计中这常常导致仿真或实际芯片中的基准电流和利用公式计算的预期值有很大不同。当电源电压 VDD 发生变化时，X 点和 Y 点的波动更大，输出基准电流可能会完全偏离计算表达式。
为了减小沟道长度调制效应，电路中所有晶体管一般都会采用较长的沟道。但是，对于需求电流精度较高的电路，这种方法可能无法满足要求。我们可以采用共源共栅结构来减小沟道长度调制效应的影响，如图 9-5 所示。在图 9-2 所示的电流镜结构的基础上，我们添加了 M5、M6、M7、M8 四个共源共栅管，由外接 VB1、VB2 电压提供偏置栅压。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 9-16 __ 三支路基准电流源 [desc]
为了进一步提高输出基准电流的 PSRR，在图 9-2 的基础上添加了第三条支路,构成了三支路结构的基准电流源，如图 9-6 所示。输出基准电流的表达式与式（9-9）相同，M5 与 M6 管组成的第三条支路在原来的电流镜的基础上添加了一个负反馈系统，如图 9-7（a）（b）所示。 
图 9-7 （a）普通电流源电路；（b）三支路电流源的负反馈 
对于图 9-2 所示电流源，存在一个弱的正反馈环路。当电源电压 VDD 升高时，VX 电压升高时，根据共源级的增益为负，VY 电压与 VX 电压变化相反，所以 VY 电压降低。相应地，M3 的漏端电压升高，即 VX 电压升高。形成了 VX→VY→VX 的正反馈环路。所以整个系统的 PSRR 较低，导致输出基准电流随电源电压变化较大。
而对于图 9-6 所示的三支路基准电流源来说，由于多了一条支路，它形成了负反馈，如图 9-7（b）所示。当电源电压 VDD 升高时，X 点电压 VX 升高，M2 管看作一个共源级，那么 Y 点电压 VY 降低。在 M3 管的作用下，Z 点电压 VZ 升高。同时在 M6 管共源级的作用下，X 点电压降低。形成了 VX→VY→VZ→VX 负反馈环路。所以整个系统的 PSRR 较高，输出基准电流随电源电压变化较小。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 [desc]
下面我们以低压差线性稳压器（Low Dropout Regulator，LDO）中所应用的低功耗、低温度系数的基准电流源为例来设计并仿真一个基准电流源的电路。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ LDO 中基准电流源的性能指标 [desc]
1. 低电流: LDO 由于具有低噪声、低功耗、结构简单及封装尺寸较小的优点，在便携式电子产品中作为电源转换电路得到了广泛的应用。对于低功耗 LDO 的设计来说低电流的基准电流源具有相当重要的意义和价值。在此，我们设计一个 30nA 的高精度参考电流源。
2. 宽温度范围: 该基准电流源的另一个重要的指标是电流基准在宽温度范围下的工作稳定程度。由于基准电流源为 LDO 内部各个模块提供基准电流，因此，基准电流源在工作温度范围内的稳定直接关系到整个芯片能否正常工作。我们要求输出基准电流在－40℃～ 130℃宽温度范围内稳定。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ 基准电流源结构的确定 [desc]
1. MOS 管工作区域的确定: 
由于需求设计的基准电流较小，是纳安量级的。如果仍然采用 9.2 节所述的电路，而且其 MOS 管工作在饱和区。那么，MOS 管的宽长比将是一个非常小的值（倒比管），所以芯片的面积会很大。饱和区工作的 MOS 管流过的电流一般为微安量级的，所以 9.2 节所述的计算表达式已经不能适用于我们所要求的基准电流源的设计。为了得到纳安级的输出基准电流，我们设 MOS 管工作在亚阈值区，如图 9-8 所示。  
虚线框所示的 NMOS 管工作在亚阈值区，亚阈值区 MOS 管源漏极电流表达式为[5]： 
```
GS
DS
0 exp
1 exp
T
T
V
V
W
I
L I
V
V
ζ
⎡
⎤
⎛
⎞
⎛
⎞
=
×
−
−
⎢
⎥
⎜
⎟
⎜
⎟
⎢
⎥
⎝
⎠
⎝
⎠
⎣
⎦
```             "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ 9-17 [desc]
其中，I0 为单位饱和电流，VT＝kT/q，ζ 是亚阈值斜率因子。因为 VDS>>VT，那么
```
DS
exp
T
V
V
⎛
⎞
⎜−
⎟
⎝
⎠
```
可以忽略。又因为 IREF＝IOUT，所以，
```
GS3
GS4
REF
0
OUT
0
N
N
exp
exp
T
T
V
V
W
W
I
I
I
K
I
L
V
L
V
ζ
ζ
⎛
⎞
⎛
⎞
⎛
⎞
⎛
⎞
=
=
=
⎜
⎟
⎜
⎟
⎜
⎟
⎜
⎟
⎝
⎠
⎝
⎠
⎝
⎠
⎝
⎠
```  "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ 9-18 [desc]
因此 
```
GS3
GS4
REF
S
ln
T
T
V
V
I
R
K
V
V
ζ
ζ
−
=
=
```                "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ 9-19 [desc]
从而 
```
REF
S
VT ln
K
I
R
= ζ
```                    "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 __ 基准电流源的设计实例 __ 9-20 [desc]
我们发现，在亚阈值模型的推算中，输出电流被晶体管宽长比的比值和电阻唯一确定。这说明基于传统的基准电流源的工作原理，工作在亚阈值区的 MOS 管可以用来生成和电源电压无关的基准电流。
和饱和区工作状态下的电流计算公式相比，载流子迁移率已经不会影响亚阈值电流了。在亚阈值电流公式中只有电阻 RS 和 VT 这两个与温度有关的变量。其中，VT 电压与温度成正比。而实际工艺中的电阻也有其温度系数。我们可以根据 9.3 节所述的，通过不同种类的电阻的组合以组成具有我们所需要的温度特性的电阻。如果能够组成一个与绝对温度成正比的电阻,则输出电流 IREF 就可以保持相当好的温度特性。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电路结构的确定 [desc]
为了提高输出基准电流的 PSRR，使输出基准电流随电源电压 VDD 变化较小，我们决定采用图 9-6 所示的三支路基准电流源结构。由于图 9-6 所示的三支路结构工作在饱和区，当其工作在亚阈值区时，由于流过的电流与饱和区流过的电流不在同一数量级，电流减小了很多倍，原来形成的负反馈系统是基于 MOS 管的单级放大器原理，由于电流的减小，负反馈系统已经不能很稳定地工作，所以，我们对其结构进行了稍许修改，以增强其负反馈系统的增益，如图 9-9[4]。
在图 9-9 中，我们形成了另一种负反馈系统。当 X 点电压升高时，IOUT 与 I3 均减小，由 VY＝（IOUT＋I3）RS2 得，Y 点电压降低很快，从而使 X 点电压迅速下降，最终使整个电路的电流稳定。M6 管的源端与 M4 管的源端接在一起，能够使整个电路形成更快的负反馈。
同时，与图 9-6 所示的电路相比，图 9-9 中流过 RS2 的电流变为原来的数倍，这样，如果使两种三支路结构中的 M4 管的源端电压相等，RS2 的阻值比图 9-6 中 RS 的阻值大大的减小，从而节省了芯片的面积。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管参数的粗略估计 [desc]
为了得到输出基准电流为 30nA 的基准电流源，我们要预先对各个 MOS 管的宽长约做一下初步估计。
由我们采用的 CSMC 公司 0.5µm CMOS 混合模拟信号仿真库可以知道，PMOS管和 NMOS 管的参数可以估计如下： 
ζVT＝35.9 mV；I0=42.5 fA；VTHn=750 mV；VTHp= -950 mV；μPCOX = 92 μA/V2；μnCOX=270 μA/V2。
由9.4节电路结构的确定我们得知，NMOS管工作在亚阈值区，由于VTHn＝750mV，预留 150mV 的电压裕度，我们假设 NMOS 管的 VGSn=600mV。
考虑到版图的对称性，图 9-9 中，M4 管的并联数一般为 2,4,6,8 等等偶数，在这里，我们取 K＝6。由 IREF＝ 30nA，根据公式 
```
GS
N 0
exp
T
V
W
I
K
I
L
V
ζV
⎛
⎞
⎛
⎞
=
⎜
⎟
⎜
⎟
⎝
⎠
⎝
⎠
```                 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-21 [desc]
可以计算出，M3 和 M4 管的宽长比(W/L)N＝5/10。 
同样道理，图9-9中PMOS管M1和M2工作在饱和区，我们已经知道VTHp＝950mV，由于流过的电流较小，只有纳安量级，为了使(W/L)P 不至于过小，我们尽量减小 PMOS管的过驱动电压。假设过驱动电压为 50mV，则 VGSP＝-1V。由饱和区 PMOS 管的电流公式 
```
(
)
2
P
GS
TH
P
1
2
OX
W
I
C
V
V
L
μ
⎛
⎞
=
−
⎜
⎟
⎝
⎠
```                "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-22 [desc]
可以计算出，M1 和 M2 管的宽长比为(W/L)P＝3/10。 
为了减小 RS 的阻值，节省面积，我们初步设计第三支路 M5、M6 流过的电流为基准电流源的 2 倍，所以图 9-9 中 M5 的并联数为 2。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电阻参数的估算 [desc]
假设 M1 的并联数为 K1，M5 的并联数为 K5，由 MOS 管参数的确定可知道，K1＝1，K5＝2。由电流的表达式 
```
1
S
1
5
ln
VT
K
I
K
I
R
K
K
= ς
×
×
+
```                 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-23 [desc]
可以计算出， 
```
1
S
1
5
ln
715
VT
K
R
K
K
I
K
K
= ς
×
×
≈
Ω
+
```             "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-24 [desc]
如果电阻的温度系数刚好可以与 VT 的温度系数相互抵消，则电阻的温度系数必须满足： 
```
S
1
1
5
ln
1732
/ C
T
R
V
K
K
T
T
I
K
K
ς
∂
= ∂
×
×
×
=
Ω °
∂
∂
+
```          "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-25 [desc]
也就是说，电阻的一阶温度系数为 
```
366 
3
1732
/
2.42 10
/ C
715k
C
−
Ω °
=
×
°
Ω
```                 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-26 [desc]
---table begin---
Table title:CSMC 0.5μm混合信号模型中电阻模型的温度系数 
| 电阻类型   | 一次温度系数（/℃） | 二次温度系数（/℃2）  |
|------------|------------|-------------------|
| N 阱  | 5.630×10-3      | 1.060×10-5       |
| N 扩散 | 1.705×10-3      | 1.475×10-6       |
| P 扩散 | 8.551×10-4      | 1.877×10-6       |
| 多晶硅 1(P 注入) | 3.590×10-4   | -6.661×10-7    |
| 多晶硅 1(N 注入) | 3.250×10-4   | 6.581×10-7    |
| 多晶硅 2 | 3.214×10-4   | 2.667×10-7    |
| 多晶硅高阻 1kΩ | -2.700×10-3  | 9.900×10-6       |
| 多晶硅高阻 2kΩ | -2.539×10-3  | 0              |
---table end---
```
NWELL
rhr1k
R
1,NWELL
rhr1k
N
rhr1k
R
R
TC
TC
TC
R
R
=
×
+
×
�
�
```          "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-27 [desc]
最后计算得出， 
```
NWELL
186k
R
=
Ω 
```                     "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-28 [desc]
```
rhr1k
529k
R
=
Ω 
```                    "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9-29 [desc]
根据计算出的 MOS 管和电阻的大小，最终画出的电路如图 9-10。电阻先用理想电阻代替。
注意：图 9-10 中 MOS 管的编号和图 9-6 中的不一样，后文电路仿真中的 MOS管编号以图 9-10 为准。 
---table begin---
Table tile:图 9-10 中器件参数 
| MOS 管   | Instance Name       | Model      |  W       |   L  |   Multiplier    |
|-----------|-------------|------------|-------------|-------|-----------------|
| M0       | mp          | 5u         | 10u         | 6     | st02            |
|           |             | mp         | symbol      |       |                 |
| M1       | mp          | 5u         | 10u         | 1     | st02            |
|           |             | mp         | symbol      |       |                 |
| M2       | mn          | 5u         | 10u         | 2     | st02            |
|           |             | mn         | symbol      |       |                 |
| M3       | mn          | 3u         | 10u         | 2     | st02            |
|           |             | mn         | symbol      |       |                 |
| M4       | mp          | 3u         | 10u         | 1     | st02            |
|           |             | mp         | symbol      |       |                 |
| M5       | mn          | 3u         | 10u         | 1     | st02            |              
|           |             | mn         | symbol      |       |                 |
---table end---
---table begin---
Table title: 图 9-10中电阻参数 
|   电阻    | Instance Name | Model       |   W    |    L       | Resistance   | Segments   | Libary Name       | Cell Name | View Name |
|-----------|--------------|-------------|--------|------------|--------------|------------|-----------------|-------------|-------------|
| R1       | rhr1k        | 1.3u        | 125.8u | 529K       | 5            | st02       | rhr1k        | symbol     |
| R2       | rnwell       | 4u          | 512.73u| 186K       | 1            | st02       | rnwell       | symbol     |
---table end---
``` 
---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管 [desc]
Instance Name 
Model
W
L 
M
Ω
+
```          "
"[desc] 模拟集成电路设计与仿真_何乐年 __ MOS 管 __ 4 电路仿真 [desc]
绘制完电路图之后，我们就可以对所设计的电路图进行仿真。 
## 1. 直流工作点的仿真 
首先在“Tools”下拉菜单中选择“Analog Environment”命令，打开 ADE 窗口。在 ADE窗口中，首先在“Setup”下拉菜单中选择“Model Libraries”添加模型的库文件。如图 9-11所示。 
完成库文件设置后的“Model Library Setup”窗口如图 9-12 所示。 
在 ADE 窗口中，选择“Analysis”下拉菜单中的“Choose”命令。在弹出的“Choosing Analyses”窗口中选择“dc”分析； 无需设置仿真参数和范围，只要将“Save DC Operating Point”和“Enabled”勾好，如图 9-13 所示。点击 ADE 窗口中的“ ”按键，开始仿真就可以了。 
## 2. 查看直流工作点 
如图 9- 14 所示，在 ADE 中选中“Results”→“Annotate”→“DC Operating Points”，在电路图上将会出现各个管子的直流工作点，如图 9-15 所示。 
## 3. 基准电流的 PSRR 的仿真 
### 1) PSRR 输出的设置 
在 ADE 中选择“Outputs”→“Setup”，如图 9-19 所示。进入输出设置后，出现如图 9-20 所示页面。 
接下来将设置 PSRR 的输出公式。为了仿真方便，将 PSRR 的计算公式改为： 
AC
DC
AC 1V
I
I
PSRR
= V
                        # 9-30 
式（9-30）将电源电压 VDD 定为 1V。将输出变量取名为 PSRR，点击“Open”打开 Calculator。在计算器中点击“ac”栏中的“if”选项，打开交流电流选择模式。这个模式表示从电路图中手动选择流过节点的交流电流，计算器将得到这一点的交流扫描电流的表达式，如图 9-21 所示。 
### 2) PSRR 的仿真 
设置好仿真模型后，在 ADE 窗口中选择“Analysis”→“Choose”，设置仿真类型。
按图 9-23 所示设置交流仿真类型和频率扫描范围交流电压，进行仿真。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流的 PSRR 的仿真 [desc]
1) PSRR 输出的设置 
在 ADE 中选择“Outputs”→“Setup”。进入输出设置后，接下来将设置 PSRR 的输出公式。为了仿真方便，将 PSRR 的计算公式改为： 
AC
DC
AC 1V
I
I
PSRR
= V
                        # 9-30 
式（9-30）将电源电压 VDD 定为 1V。将输出变量取名为 PSRR，点击“Open”打开 Calculator。在计算器中点击“ac”栏中的“if”选项，打开交流电流选择模式。这个模式表示从电路图中手动选择流过节点的交流电流，计算器将得到这一点的交流扫描电流的表达式。 
在电路编辑框中点击 M0 管漏端，然后在计算器的缓存区中手动输入 “/30*1000000000”，最后点击函数“dB20”。完成后计算器中显示的式子是 “dB20(((IF(""/M0/D"") / 30) * 1000000000))”。其中 IF 表示求结点交流电流的函数。 
回到输出设定对话框，点击其中的“Get Expression”按钮，计算器中的公式就会被复制到“expression”一行。
2) PSRR 的仿真 
设置好仿真模型后，在 ADE 窗口中选择“Analysis”→“Choose”，设置仿真类型。按设置交流仿真类型和频率扫描范围交流电压，进行仿真。 
由于交流电流值不能自动保存，在 ADE 中需对电流值进行保存。在 ADE 中，点击“Outputs”→“Save All”。进入的“Save Option”设置。选择应当保存的变量后，即可对电路进行仿真。 
为了方便观察 ac 电流，我们在输出设置中同样加入 ac 电流值。在 ADE 窗口中选择“Outputs”>“To Be plotted”>“Select On Schematic”。在电路编辑窗口选择 M0 管的 D 端电流。 
对电路图中的 VDD 电压加入交流值为 1V 的交流电压。含有 . 的一行在 markdown 中变为一级标题。汉字之后应该瞄准下一行开始添加内容，不需要加入额外的字符。 
3) PSRR 输出结果 
仿真结束后，会跳出的输出结果，在高频时，PSRR 存在波动，调整 MOS 管的参数，将中 M2 管子的并联数改为 1，宽长比改为 1μm/10μm，最终 PSRR 的仿真结果。 
注意：修改参数时，要再进行直流工作点的仿真，使各个 MOS 管工作在合适的区域。 
4) PSRR 的提高 
利用“Parametric Analysis”对 PMOS 管的栅长进行扫描。首先在电路图中将所有 PMOS 管的栅长设成参变量“L”。选中 PMOS 管，点击快捷键“q”，在“Edit Object Properties”窗口中，将原来“Length”栏中的“10u”改为“L”。# ametric Analysis”窗口
如图 9-32 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 9-32 选择参数分析 [desc]
在“Parametric Analysis”窗口中选择“Setup”下拉菜单中的“Pick Name For Variable”
命令，并选择“Sweep1…”，如图 9-33 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 9-33 在“Parametric Analysis”窗口中为“Sweep1”添加扫描变量 [desc]
在“Parametric Analysis Pick Sweep1”对话框中选择“L”， 将“Sweep1”的扫描变量设
置为“L”。 “Sweep1”的扫描范围为 5u~15u。“Total Step”设置为“5”。完成设置后的“Parametric Analysis”窗口如图 9-34 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 9-34 完成设置后的“Parametric Analysis”窗口 [desc]
在“Parametric Analysis-spectre”窗口选择“Analysis”下拉菜单中的“Start”命令，运行“Parametric Analysis”。得到图 9-35 的仿真结果，由仿真结果可以看出，当 PMOS 管的栅长增加时，PSRR 会增大，于是我们将 PMOS 管的栅长适当增大为 15μm，得到较高的 PSRR 仿真结果。如果需要进一步提高输出基准电流的 PSRR，我们还可以将本次设计的三支路基准电流源改为三支路共源共栅基准电流源，这样，PSRR 会进一步提高。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 基准电流的温度系数调整 [desc]
根据 9.4.3 中电阻参数的估算设置电阻阻值，对电阻的温度特性进行仿真。 ADE 中的仿真模型库不变，双击 ADE 中设置好的“ac”扫描，出现如下图 9-36 对话框，将“Enabled”后面的框勾掉。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 9-36 取消 ac 仿真 [desc]
在 ADE 窗口中选择“Analysis”→“Choose”，选择 dc 扫描，在“Sweep Variable”中选中“Temperature”，在“Sweep Range”里面将扫描范围设置为-50～150，如图 9-37 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 9-37 dc 扫描设置 [desc]
同时，参照 9.4.4 节中 PSRR 输出的设置，我们可以在输出变量中设置温度系数PPM。PPM 的表达式为 `(o MAX MIN MEAN MAX MIN PPM 1000000 (ppm/ C) I I I T T − = × −)（9-31）`。在 ADE 中选中“Outputs”→“Setup”，将变量取名为“PPM”，点击“Open”打开计算器“Calculator”，如图 9-38 所示。
---table begin---
Table tile:调整后的图 9-10 中器件参数
| MOS 管  | Instance Name | Model      | W  | L   | Multiplier | 修改原因         |
|----------|---------------|------------|----|-----|------------|------------------|
| M0       | mp            | 5u         | 10u| 6   | --         |                  |
| M1       | mp            | 5u         | 10u| 1   | --         |                  |
| M2       | mn            | 1u         | 10u| 1   | 增加高频 PSRR 稳定性 |
| M3       | mn            | 3u         | 15u| 2   | 提高 PSRR           |
| M4       | mp            | 3u         | 15u| 1   | 提高 PSRR           |
| M5       | mn            | 3u         | 15u| 1   | 提高 PSRR           |
| 电阻      | Instance Name | Model      | W   | L   | Resistance | Segments | 修改原因         |
| R1       | rhr1k         | 1.3u       | 53.52u| 350K | 5   | 降低温漂系数|
| R2       | rnwell        | 4u         | 49.42u| 330K | 18  | 降低温漂系数|
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 对比 __ 5 小结 [desc]
在这一节里，我们以一个工作在亚阈值区的基准电流源的设计为例，详细介绍了如何设计一个基准电流源。最初的计算只能估计各个 MOS 管的工作电压，在仿真过程中，需要根据实际仿真模型不断进行调整，以达到最好的特性。在实际的工程设计中，可能会牺牲一些特性以达到特殊的目的，比如牺牲功耗利用复杂电路以达到低温度系数的目的等。根据设计指标的不同，参数的仿真设计也会不尽相同。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 [desc]
假设在仿真温度范围内，基准电流的最大值 IMAX=1.015μA，最小值 IMIN=1.012167μA，温度范围是－40～125℃，平均电流 IAVE=1.01μA，求基准电流的温漂系数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 [desc]
假设我们对直流 1μA 的基准电流进行 ac 交流仿真，在交流电源电压值为 1V 时，交流电流为0.0001μA，试计算该电流的电源抑制比。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 [desc]
在图 9-2 中，(W/L)N=5，μnCOX=134 µA/V2，RS＝35.36kΩ，K＝8，试求输出基准电流的大小。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 [desc]
在 9.3.1 节中，我们忽略了 M3 管和 M4 管衬底偏置效应的影响，如果考虑到衬底偏置效应，试计算基准电流的偏差是多少。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 [desc]
在 9.3.2 节中提到，在 PMOS 管源端接电阻，同时通过将每个 PMOS 晶体管源端和衬底相连来消除体效应。这里，我们提出另一种如图 9-45 所示的消除体效应的结构。试推导 IOUT 的表达式。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 [desc]
在图 9-5 中，PMOS 与 NMOS 共源共栅管的栅压都是外接的，试画出一种提供外接偏置栅压的电路图。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 7 [desc]
在图 9-5 中，我们采用了共源共栅结构减小沟道长度调制效应的影响，PMOS 与 NMOS 共源共栅管的栅压都是外接的，这里提出一种如图 9-46 所示的自偏置共源共栅结构。试计算使电路正常工作时，电阻 R1 和 R2 两端电压的最小值和最大值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 [desc]
在 9.3.1 节中，提出了由电阻的温度系数来补偿基准电流温度系数的方案。参照第 8 章带隙基准电路，可以知道，带隙基准电路可以生成 PTAT（正比于温度）电流和负温度系数电流，如果能将这两路电流相加，就可以得到与温度无关的电流，如图 9-47 所示。试结合带隙基准电路的原理，解释图 9-47 的温度补偿原理。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 [desc]
在 9.4 节的设计实例中，从 PSRR 的仿真可以看出，当 MOS 沟道长度 L 提高时，PSRR 会提高，试解释为什么 L 值的提高会使 PSRR 提高。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 10 [desc]
在 9.4 节的设计实例中，如果选用 N 阱电阻和多晶硅高阻 2kΩ 的电阻，试计算各个电阻的大小，并在仿真器中进行验证与调试。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 11 [desc]
在 9.4 节的设计实例中，采用了 ac 仿真 PSRR 的方法检测基准电流值随电源电压变化的情况。也可以采用直流仿真方法来检测基准电流随电源电压变化的情况，即在 dc 仿真中，电源电压从 0V 变化至 5V，观察基准电流的变化情况，完成此项仿真任务。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 [desc]
如果要设计一个基准电流为 1μA 的三支路基准电流源，试计算 NMOS 和 PMOS 管的宽长比（提示：1μA 的基准电流可以工作在饱和区 λ ） "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 13 [desc]
用上题计算出的结果在仿真器里面设置参数，并进行仿真和直流工作点的验证，如果仿真结果与计算结果不符，进行参数的调节。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 14 [desc]
在 9.9 中的设计中，利用电阻的温度特性补偿基准电流的温度系数，并计算各个电阻的阻值和进行仿真。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 [desc]
仿真题 9.10 中所设计的基准电流的 PSRR。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 第 10 章 模拟与数字转换电路 [desc]
虽然这个自然世界是一个模拟信号的世界，但是现代信号处理技术的发展依赖于超大规模集成电路的高速发展，特别是像 DSP 这样的数字信号处理核心。因此，一个精确的模拟到数字（ADC）或从数字到模拟（DAC）的转换电路是现代电子系统不可或缺的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 [desc]
在上世纪 70 年代以前，模拟信号只局限于用电阻、电容、MOS 管、三极管和放大器等组成连续时间电路。随后，在标准 CMOS 工艺发展的支持下，开关电容电路得到了显著的发展，成为常用的一种数据采样技术。我们知道，对一个信号的描述在时域上是利用信号的频率和幅值为特性。在时间上，信号可以分为连续信号和离散信号。在幅值上，也可以分为连续信号和离散信号。数字信号处理中的“0”和“1”就是在幅值上离散的信号，而开关电容中处理的信号在幅值上是连续的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 1 采样开关电路[1，2] [desc]
我们知道，一个 MOS 管在大信号工作情况，利用导通或者截止的特性，本身就可以等效为一个最简单的开关。用一个 MOS 管和电容就可以构成一个简单的采样保持电路如图 10- 1 所示。
图 10- 1 简单采样电路和 MOS 开关
图 10- 2 理想开关采样波形
所谓采样，就是在一个时钟周期内输入信号通过开关对负载电容充放电，使电容上的电压值在时钟有效期结束时刻和输入信号值电压相同。一个理想的采样电路的工作波形如图 10- 2 所示。由于理想开关的导通电阻为 0，闭合电阻无穷大，因此电容的充放电不存在驱动开关过程。只要开关一打开，电容上的电压立即跟随输入信号变化。虽然我们知道这在实际情况中是不可能发生的，但图 10- 2 的波形有助于我们理解采样的过程和分析实际开关电路中会遇到的各种非理想效应。
如图 10- 1 所示，在实际电路中，通常使用 CMOS 管来实现采样开关。下面通过三种简单的情况，来理解采样电路是如何对输入信号进行采样的。
图 10- 3 输入信号为零，采样电容初始电压为高电平条件下的采样电路响应
图 10- 3 给出了输入信号为零，采样电容初始电压为高电平条件下的采样电路响应，假设开关 NMOS 管 M1 栅端的时钟信号在 t0 时刻由低电平变为高电平，从而将 M1管导通，闭合了开关。在 t0 时刻，M1 的栅端和漏端电压为 VDD，源端电压为 0，因此 M1 管工作在饱和区。忽略二级效应，电容 C 的放电电流为：
(
)
2
D
n
ox
OUT
TH
M1
1
2
W
I
C
v
V
L
μ
⎛
⎞
=
−
⎜
⎟
⎝
⎠
(10-1) 
当 vOUT端的电压下降到 VDD-VTH时，有：
DS,M1
DD
TH
GS,M1
TH
V
V
V
V
V
=
−
=
−
(10-2) 
因此 M1 管进入线形区，电容 C 继续放电，直到 vOUT的电压接近零，此时的放电电流为：
(
)
2
D
n
ox
DD
TH
OUT
OUT
M1
1
2
W
I
C
V
V
v
v
L
μ
⎛
⎞
⎡
⎤
=
−
−
⎜
⎟
⎢
⎥
⎝
⎠
⎣
⎦
(10-3) 
注意到当 vOUT<<2(VDD-VTH)时，M1管进入到深度线性区，电容 C 的放电电流为：
(
)
D
n
ox
DD
TH
OUT
M1
W# 10.1.1 采样开关电路[1，2] 
我们知道，一个 MOS 管在大信号工作情况，利用导通或者截止的特性，本身就可以等效为一个最简单的开关。用一个 MOS 管和电容就可以构成一个简单的采样保持电路如图 10- 1 所示。 
图 10- 1 简单采样电路和 MOS 开关 
图 10- 2 理想开关采样波形 
所谓采样，就是在一个时钟周期内输入信号通过开关对负载电容充放电，使电容上的电压值在时钟有效期结束时刻和输入信号值电压相同。一个理想的采样电路的工作波形如图 10- 2 所示。由于理想开关的导通电阻为 0，闭合电阻无穷大，因此电容的充放电不存在驱动开关过程。只要开关一打开，电容上的电压立即跟随输入信号变化。虽然我们知道这在实际情况中是不可能发生的，但图 10- 2 的波形有助于我们理解采样的过程和分析实际开关电路中会遇到的各种非理想效应。 
如图 10- 1 所示，在实际电路中，通常使用 CMOS 管来实现采样开关。下面通过三种简单的情况，来理解采样电路是如何对输入信号进行采样的。 
图 10- 3 输入信号为零，采样电容初始电压为高电平条件下的采样电路响应 
图 10- 3 给出了输入信号为零，采样电容初始电压为高电平条件下的采样电路响应，假设开关 NMOS 管 M1 栅端的时钟信号在 t0 时刻由低电平变为高电平，从而将 M1管导通，闭合了开关。在 t0 时刻，M1 的栅端和漏端电压为 VDD，源端电压为 0，因此 M1 管工作在饱和区。忽略二级效应，电容 C 的放电电流为： 
(
)
2
D
n
ox
OUT
TH
M1
1
2
W
I
C
v
V
L
μ
⎛
⎞
=
−
⎜
⎟
⎝
⎠
(10-1) 
当 vOUT端的电压下降到 VDD-VTH时，有： 
DS,M1
DD
TH
GS,M1
TH
V
V
V
V
V
=
−
=
−
(10-2) 
因此 M1 管进入线形区，电容 C 继续放电，直到 vOUT的电压接近零，此时的放电电流为： 
(
)
2
D
n
ox
DD
TH
OUT
OUT
M1
1
2
W
I
C
V
V
v
v
L
μ
⎛
⎞
⎡
⎤
=
−
−
⎜
⎟
⎢
⎥
⎝
⎠
⎣
⎦
(10-3) 
注意到当 vOUT<<2(VDD-VTH)时，M1管进入到深度线性区，电容 C 的放电电流为： 
(
)
D
n
ox
DD
TH
OUT
M1
W
I
C
V
V
v
L
μ
⎛
⎞
=
−
⎜
⎟
⎝
⎠
(10-4) 
此时 M1 管可以看成一个电阻，其阻值为： 
(
)
ON
n
ox
DD
TH
M1
1
R
W
C
V
V
L
μ
=
⎛
⎞
−
⎜
⎟
⎝
⎠
(10-5) 
下面考虑相反的情况，即输入信号为高电平，采样电容初始电压为零条件下的采样电路响应，假设开关 NMOS 管 M1 栅端的时钟信号在 t0时刻由低电平变为高电平，从而将 M1管导通，闭合了开关。电路图和响应结果如图 10- 4 所示。 
因为 vIN端的电压比 vOUT端的电压高，因此电流从 vIN端流向 vOUT端。对于 NMOS管 M1而言，在此电流方向下，和电容 C 相连的一端是 NMOS 管的源端。因为 M1管的栅端和漏端都有相同的电位，因此 M1 管一直工作在饱和区。根据电容两端电压和充放电电流的关系，忽略了所有二级效应后，我们得到： 
(
)
2
OUT
D
n
ox
DD
OUT
TH
M1
1
2
dv
W
C
I
C
V
v
V
dt
L
μ
⎛
⎞
=
=
−
−
⎜
⎟
⎝
⎠
          (10-6) 
图 10- 4 输入信号为高电平，采样电容初始电压为零条件下的采样电路响应 
式（10-6）可以改写为： 
(
)
OUT
n
ox
2
M1
DD
OUT
TH
1
2
dv
W
C
dt
L
V
v
V
μ
⎛
⎞
=
⎜
⎟
⎝
⎠
−
−
              (10-7) 
将式（10-7）等号两边积分，得到： 
(
)
OUT
ox
n
M1
DD
OUT
TH
0
0
1
1
2
v
t
C
W
t
V
v
V
C
L
μ
⎛
⎞
=
⎜
⎟
−
−
⎝
⎠
(10-8) 
因为电容两端的初始电压为 0，因此在 t=0 时刻，vOUT=0，从式（10-8）得到： 
OUT
DD
TH
ox
n
M1
DD
TH
1
1
1
2
v
V
V
C
W
t
C
L
V
V
μ
=
−
−
⎛
⎞
+
⎜
⎟
−
⎝
⎠
(10-9) 
从式（10-9）可以看出当 t→∞时，vOUT→VDD-VTH。这是因为当 vOUT 接近 VDD-VTH时，M1 管的过驱动电压接近零，使对电容 C 的充电电流可以忽略不计。当然，考虑二级效应，当 vOUT接近 VDD-VTH时，M1 管会先进入亚阈值区，还会传输亚阈值电流对电容 C 充电，如果时间足够长，那么 vOUT的值最终还是会达到 VDD。但是在一般的采样频率下，vOUT是不会超过 VDD-VTH的。 
假如输入电压 vIN=a，并且小于 VDD-VTH，采样电容初始电压为零条件下的采样电路响应。电路图和响应结果如图 10- 5 所示， 
图 10- 5 输入信号小于 VDD-VTH，采样电容初始电压为零条件下的采样电路响应 
在图 10- 5 中，M1 管的栅源电压和漏源电压的差值为： 
(
) (
)
GS,M1
DS,M1
DD
OUT
IN
OUT
DD
IN
TH
V
V
V
v
v
v
V
v
V
−
=
−
−
−
=
−
>
(10-10) 
由式（10-10）可以看出，当输入电压小于 VDD-VTH 时，M1 管一直工作在线性区。那么根据上文的分析，电容 C 将被充电，从而使得 vOUT接近 a。当 vOUT≈a 时，M1管等效为导通电阻，其阻值为： 
(
)
ON
n
ox
DD
IN
TH
M1
1
R
W
C
V
v
V
L
μ
=
⎛
⎞
−
−
⎜
⎟
⎝
⎠
(10-11) 
根据式（10-11）可以得到采样电压稳定时，NMOS 管的导通电阻，图 10- 6 给出了不同输入电压下，NMOS 管的导通电阻。可以发现，当输入电压接近 VDD-VTH时，NMOS管的导通电阻迅速增大，从而增大了采样电路的时间常数（RON×C），进而降低了电路的响应速度。
因此为了保证采样电路的速度，必须使得作为开关的 MOS 管有较小的导通电阻。 在图 10- 1 中的采样电路中，为了满足这一要求，将严重限制输入电压的摆幅。为了在采样电路中，获得较大的电压摆幅，我们注意到 PMOS 管在输入电压很大的正电压时，有较小的导通电阻，如图 10- 7 所示[1]。因此我们采用 CMOS 互补开关，就可以在保证较小的导通电阻的前提下获得更大的输入摆幅。 
图 10- 6 NMOS 管的导通电阻 
图 10- 7 PMOS 管的导通电阻
互补开关电容采样电路如图 10- 8 所示。除了使用 CMOS 管以外，该电路还需要互补时钟。该电路产生的导通电阻为： 
(
)
(
)
(
)
ON
ON,N
ON,P
n
ox
DD
IN
THN
p
ox
IN
THP
N
P
n
ox
DD
THN
n
ox
p
ox
IN
p
ox
THP
N
N
P
P
//
1
1
//
1
R
R
R
W
W
C
V
v
V
C
v
V
L
L
W
W
W
W
C
V
V
C
C
v
C
V
L
L
L
L
μ
μ
μ
μ
μ
μ
=
=
⎛
⎞
⎛
⎞
−
−
−
⎜
⎟
⎜
⎟
⎝
⎠
⎝
⎠
=
⎡
⎤
⎛
⎞
⎛
⎞
⎛
⎞
⎛
⎞
−
−
−
−
⎜
⎟
⎜
⎟
⎜
⎟
⎜
⎟
⎢
⎥
⎝
⎠
⎝
⎠
⎝
⎠
⎝
⎠
⎣
⎦
(10-12) 
式（10-12）中最有意义的是，如果 μnCox(W/L)n=μ# 10.1. 件下的采样电路
响应。电路图和响应结果如图 10- 5 所示，
据式（10-10）可以看出，当输入电压小于 VDD-VTH 时，M1 管一直工作在线性区。那么根据上文的分析，电容 C 将被充电，从而使得 vOUT接近 a。
根据式（10-11）可以得到采样电压稳定时，NMOS 管的导通电阻，图 10- 6 给出了不同输入电压下，NMOS 管的导通电阻。可以发现，当输入电压接近 VDD-VTH时，NMOS管的导通电阻迅速增大，从而增大了采样电路的时间常数（RON×C），进而降低了电路的响应速度。
因此为了保证采样电路的速度，必须使得作为开关的 MOS 管有较小的导通电阻。
式（10-12）中最有意义的是，如果 μnCox(W/L)n=μpCox(W/L)p，那么导通电阻 RON 将和输入电压 vIN无关。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 2 沟道电荷注入效应[1] [desc]
当 MOS 管的栅源电压 VGS大于阈值电压 VTH时，会在栅氧化层和硅的界面间产生电荷沟道。
对于图 10- 1 由 NMOS 管和电容构成的采样电路中，当 CLK 处于高电平，将 NMOS管导通，进行信号采样时，在 NMOS 管的栅氧化层和硅界面间将形成有负电荷构成的沟道。假设 vIN≈vOUT，NMOS 管中的沟道电荷为。
由于“沟道电荷注入效应”，采样保持电路的输出电压为。
因此减小和消除“沟道电荷注入效应”是使用开关电容时需要考虑的一个重要问题。这里可以给出两种减小电荷注入效应的常用电路结构。
图 10- 12 是一个差分结构的采样电路。可以想象，如果两个开关管都发生电荷注入效应，由于是相同的管子，那么电荷注入效应的抵消应该要比互补结构要好。# 10.1. 一般的 N 阱 CMOS 工艺，NMOS 管的体效应
是必须考虑的。对于体效应 VTH为： 
```
(
)
TH
TH0
B
SB
B
2
2
V
V
V
γ
φ
φ
=
+
+
−
```
(10-17)
因为在 N 阱工艺中，NMOS 管的衬底都是接地的，因此在图 10- 1 所示的开关电容采样保持电路中，有： 
```
BS
IN
V
= −V
```
(10-18) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 分析和解决开关电容的问题 [desc]
因此得到[1]： 
```
[
)
(
)
(
)
(
)
ox
OUT
IN
DD
IN
TH0
B
IN
B
ox
ox
ox
IN
B
IN
DD
TH0
B
2
2
2
1
2
2
2
2
2
WLC
V
v
V
v
V
v
C
WLC
WLC
WLC
v
v
V
V
C
C
C
γ
φ
φ
γ
φ
γ
φ
=
−
−
−
−
+
−
⎛
⎞
=
+
+
+
−
−
+
⎜
⎟
⎝
⎠
```
(10-19) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容的等效电阻和电路 [desc]
开关电容电路对电路时间常数精度的影响。
```
(
)
1
1
C
H s
R C s
s
τ
=
=
+
⋅
+
⋅       
```
(10-26) 
其中, 对应到
```
τC 称为电路的时间常数，它的精度影响信号处理电路的频率和时间的精度。τC 的精
度可以表达为： 
1
1
1
1
C
C
d
dR
dC
R
C
τ
τ
=
+
```
(10-27) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容用于提高电路精度 [desc]
图 10- 16 电源与电阻并联、电阻与电容串联，电容接地。
电源与电阻并联，电阻与电容串联，电容接地。
```
 2
2
1
c
1
1
V
V
T
R
I
C
f C
−
=
=
=
```
(10-25) 
```
D
2
2
1
c
1
1
T
C
C
C
f C
τ
⎛
⎞
⎛
⎞
=
= ⎜
⎟
⎜
⎟
⎝
⎠
⎝
⎠
```
(10-29) 
因此 τD的精度可以表示为:
```
c
D
2
1
D
2
1
c
df
d
dC
dC
C
C
f
τ
τ
=
−
−
```
(10-30) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 串联开关电容等效电阻 [desc]
类似图 10- 13 中的并联开关电容等效电阻电路，图 10- 17 给出了一种串联结构的开关电容等效电阻。除了电容的连接方式，图 10- 17 中所有期间设置和图 10- 13 中一致。 
对于串联开关电容等效电阻的设置过程以及电阻计算，可以参考之前的公式和过程。# 开关电容电路对电路时间常数精度的影响
当电容增大时，每次转移的电荷也随之提高，从而增大了平均电流，即减小了等效电阻。我们研究用开关电容电路替代电阻器件对电路时间常数精度的影响。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 10-26 [desc]
图 10- 15 给出了一个简单的低通滤波器。该滤波器的传递函数为：H(s)=1/(1+RCs) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 10-27 [desc]
τC 称为电路的时间常数，它的精度影响信号处理电路的频率和时间的精度。τC 的精度可以表达为：1/(1/R+1/C) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 设计上的考虑 [desc]
在标准 CMOS 工艺中，由于工艺偏差，电阻值最大会产生±20%的变化，因此 τC的精度在 5%和 20%间变化。这种精度对大多数信号处理系统是不够用的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容的低通滤波器及其功能 [desc]
现在我们用图 10- 13 中的开关电容电路代替图 10- 15 中的电阻，得到如图 10- 16 所示的电路结构。如果我们定义这种电路的时间常数为 τD，那么有：τD=(C1+C2)/(2*f*C1) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 计算τD的精度 [desc]
因此 τD的精度可以表示为：|df/f - dC1/C1 - dC2/C2|"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容电路的精度 [desc]
式（10-30）说明，采用开关电容电路后，时间常数的精度等于电容 C1和电容 C2 的相对精度和时钟频率的精度。由于在标准 CMOS 工艺中，由于电容 C1和 C2是采用相同工艺步骤制造的，因此他们具有相近的精度，假设时钟频率是完全准确的，则 τD的精度可以小到 0.1%。这种精度对于大多数信号处理都是足够的，这也是开关电容电路广泛运用的一个原因。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容的串联等效电阻 [desc]
对于串联开关电容等效电阻的设定过程及其计算，我们有： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 10-31 [desc]
在 1φ 相位，开关 S1 闭合，开关 S2 断开，电容 C1两极板被短接，使得极板上的电荷被中和，进而电容 C1 两极板上的电荷为 0。在 2φ 相位，开关 S1断开，开关 S2闭合，使得电容 C1被连接到电压源 V1 和 V2 之间。此时电容 C1 两极板间的压降为 V1-V2，即电容从电流源处获得的电荷为： Q1= C1*(V1 - V2)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 计算串联开关电容的等效电阻： [desc]
因此在下一个周期内，随着开关 S1的闭合，以及开关 S2 的断开，电容 C1 两极板上的电荷再次清零，所以在每一个时钟周期内，都有 ΔQ1 的电荷从电压源 V1 转移到电压源 V2.我们可以计算出串联开关电容的等效电阻为： Req = (V1 - V2) /(T * ΔQ1 / C1)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容放大器 [desc]
在第 5 章中，我们介绍了利用电阻反馈网络和运算放大器构成的放大电路。图 10- 18给出了一个连续时间反相放大电路。在 10.1.3 分析了利用开关电容电路可以比使用电阻获得更精确的电路时间常数，那么我们是否可以利用开关电容电路替代图 10- 18 中的电阻呢？"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 开关电容积分器 [desc]
积分器是很多信号处理系统中的重要组成部分，例如滤波器，过采样模数转换器等等。在第 5 章中，我们给出了连续时间积分器，如图 10- 23 所示。当运算放大器增益很大时，它的输出电压可以表示为：vOUT = - ∫vIN dt/(RC)。类似 10.1.4 中的方法，使用开关电容电路来代替连续时间积分器中的电阻器件，得到开关电容积分器。# 运算放大器的输出
运算放大器的输出端和反向输入端短接，形成单位增益负反馈结构，输出电压等于运算放大器正向输入端的电压，即为零。在2 φ 相位时，图 10- 20 的等效电路如图 10- 22 所示。因为运算放大器的“虚短”概念，运算放大器的反向输入端“虚地”，因此电容 C1上的压降为零，即电容 C1 的极板上没有电荷。由于电荷守恒定理，电容 C1 在1 φ 相位时储存的电荷ΔQ1不可能消失，并且由于CMOS运算放大器的输入阻抗很大，因此电荷ΔQ1只能转移到电容 C2的极板上，如图 10- 22 所示。因此电容 C2上的压降为： 
```
IN
1
1
C2
2
2
v C
Q
V
C
C
= Δ
=
```
(10-35)
运算放大器输出端电压为： 
```
1
1
OUT
N
C2
IN
IN
2
2
0
C
C
v
v
V
v
v
C
C
=
−
=
−
= −
```
(10-36) 
这和式（10-34）得到的结论一致。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 5 开关电容积分器 [desc]
积分器是很多信号处理系统中的重要组成部分，例如滤波器，过采样模数转换器等等。在第 5 章中，我们给出了连续时间积分器，如图 10- 23 所示。当运算放大器增益很大时，它的输出电压可以表示为： 
```
IN
OUT
C
IN
1
1
v
v
v
dt
v dt
C
R
CR
= −
= −
= −
∫
∫
```
(10-37) 
类似 10.1.4 中的方法，使用开关电容电路来代替连续时间积分器中的电阻器件，得到开关电容积分器[1]，如图 10- 24 所示。在1 φ 相位，图 10- 24 得等效电路如图 10- 25 所示。可以看出在1 φ 相位时，电容 C1 对输入电压采样，采样完成后，电容 C1 上储存的电荷为 ΔQ1，等于 vIN×C1；因为运算放大器的输入阻抗很高，随着开关 S2 的断开，上一时钟周期中电容 C2 上的电荷被保存下来，记为 Q2(n-1)，其中(n-1)用来表示上一个时钟周期。在 2 φ 相位时，图 10- 24 得等效电路如图 10- 26 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 数字到模拟信号转换器（DAC）原理和性能 [desc]
数模转换器（Digital-Analog Converter，DAC）是现代数字电路中重要的接口电路之一。在数字系统中，我们用到的是一系列用“0”，“1”这样字符串所代表的离散电平量。DAC的输入正是这样一组二进制信号，利用基准电压，将这组二进制信号转化为等效的模拟信号。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 1 理想数模转换器基本结构 [desc]
一个理想的数模转换器结构框图如图 10- 28 所示。n 位二进制序列（b0b1b2…bn－1）由数字电路提供，称其为码字。其中 b0为最高有效位（MSB），bn-1 为最低有效位（LSB）。加权比较网络是利用电压基准（VREF）将二进制序列转变为和基准电压成比例的电压，电流或电荷值。那么输出电压可以表示为[3，4]： 
```
1
2
OUT
0
1
1
REF
(2
2
...
2
)
n
n
V
K
b
b
b
V
−
−
−
−
=
⋅
+
⋅
+
+
⋅
```
(10-41)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ (10-43) [desc]
在这里LSB不是代表二进制序列中的最后一位，而是一种用于衡量电压差的单位。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 406 [desc]
图10-30有限精度DAC的输入输出曲线"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 2 DAC的基本静态特性[1~6] [desc]
1. 有限精度的DAC与量化噪声
在实际情况中，由于DAC的位数是有限的，因此，它的输出值是离散化的，不可能完全模拟出自然界中的连续信号。在图10-30中画出了一个有限精度的DAC输入输出曲线和一个无限精度的DAC的输入输出曲线。在图10-30中，这里值得注意的是数字序列“00”对应的模拟量输出为0.125V。当然我们也可以安排“00”代表模拟量输出值为0V。两种安排的对比如图10-31所示。图10-30(b)中的赋值方法是将图10-30(a)中的赋值方法垂直移动0.5LSB后的结果。图10-31中两种赋值方法的量化噪声是有区别的。所谓量化噪声，是指一个有限精度的转换器在模拟到数字或从数字到模拟的转化过程中存在固有的不确定性。对DAC来说，有限精度的DAC输出曲线和无限精度的DAC输出曲线之间的差值即为量化噪声。从图10-32中可以看出，第一种赋值方法的最大量化噪声为0.5LSB。而第二种方法的最大量化噪声为1LSB。因此，我们在实际电路设计中更趋向于采用第一种赋值方法。量化噪声是由有限的DAC位数造成的，因此无法从电路结构上优化使它降低到0.5LSB以下。因此我们只需要将DAC的其他误差优化到0.5LSB以下即可，因为这些误差会被量化噪声所覆盖。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 407 [desc]
2. 动态范围
动态范围(Dynamic Range，DR)的物理意义是指输出的最小有用信号和最大不失真信号之间的电平差，反映的是信号的幅度变化范围，常用dB作单位。动态范围是一个很好的衡量系统性能优劣的指标。动态范围大，说明该转换器能有效处理的信号的强弱范围大；动态范围小，说明该转换器本身噪声大或对细节表现差或不能承受强烈信号的冲击。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 图10-32不同的量化噪声 [desc]
DAC的动态范围用DR来表示。它等于输出的满刻度范围（FSR）和可分辨最小值（1LSB）的比：
```
FSR
DR
= LS
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ (10-44) [desc]
其中满刻度范围代表了DAC能输出的最大电压，虽然往往DAC的输出值无法取到VREF，不过为了计算方便，我们仍然可以用VREF作为最大输出电压，并不影响比较结果。因此，动态范围可以进一步表示为：
```
REF
REF
2
2
n
n
V
DR
= V
=
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ (10-45) [desc]
如果我们用功率分
接下来是表格内容：
---table begin---
Table tile:CA-IF1051S_VS器件信息表
| 器件型号      | 封装       | 封装尺寸(标称值) |
|--------------|------------|----------------|
| CA-IF1051S   | SOIC8(S)   | 4.9mm x 3.9mm  |
| CA-IF1051VS  | SOIC8(S)   | 4.9mm x 3.9mm  |
---table end---# 6. 积分非线性误差（INL）和微分非线性误差（DNL）
非线性误差是指实际转换曲线和理想转换曲线之间的最大偏差。非线性误差又分为积分非线性误差（INL）和微分非线性误差（DNL）。
积分非线性 INL 简单的说是 DNL 的累计。也就是说在某个台阶处测量的积分非线性是在此之前的所有微分非线性之和。 
微分非线性 DNL 是指每个实际输出曲线中的台阶相对于理想输出曲线的偏移量而不是在整个范围内比较。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 开关电容电路 __ 3 几种常见结构的 DAC [desc]
DAC 具有多种结构和工艺[1~4]。在本节中将简单说明几个最常见的结构。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 加权电阻 DAC [desc]
在式（10-42）中可以看到，数字的每一位都是有不同权重的。我们只需给每个数字赋予不同的权重后相加即可。一个结构简单，利用电阻和开关组成的加权电阻 DAC 电路如图 10- 37 所示。 
图中开关 Si 受相应位置的二进制码 bi 控制。当 bi＝1 是，Ri连接参考电压源 VREF；当 bi＝0 是，相应的电阻接地。图 10- 38 给出了两种不同情况下的电路结构。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 开关树 DAC [desc]
另一种简单的 DAC 是利用开关来控制电阻分压的方法获取模拟输出。一个 2bit 的开关树 DAC 的结构如图 10- 39 所示。 
图 10- 39 中，当 bi＝1 是，所有由 bi控制的开关闭合。而当 bi＝0 时，所有由 ib − 控制的开关闭合。那么，数字序列“00”所对应的输出电压值为 REF 4/2 V R × R ＝ REF 8 V ，“11”对应的输出电压值为 7 REF/8 V 。如果我们将每个电阻节点从下到上编号为 1 到 N，其中 N＝2^n，"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 加权电容 DAC [desc]
另一种和加权电阻 DAC 结构类似的 DAC 是加权电容 DAC。它的基本思想是利用电荷在电容上按比例分配的方法来实现加权。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 模拟到数字信号转换器（ADC）原理和性能 __ 1 ADC 基本概念 [desc]
与 DAC 相对应的信号转换器是模拟到数字信号转换器（Analog-Digital Converter）,简称为 ADC。它的功能是将输入的模拟信号转换为对应的二进制数字字符码。由于模拟信号在时间和幅值上都是连续的，而数字码则是离散，因此 ADC 系统中包含信号采样与保持过程。同时还需要对采样下来的信号进行量化和编码。ADC的基本结构如图10- 41所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 模拟到数字信号转换器（ADC）原理和性能 __ 2 奈奎斯特速率 ADC [desc]
奈奎斯特速率 ADC 具有多种结构和工艺[1~6]。在本节中将简单说明几个最常见的结构。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 逐次逼近型 ADC（Successive Approximation Register，SAR 结构） [desc]
逐次逼近型 ADC 因为其快速的转换时间和中等程度的电路复杂度成为实现 ADC 转换器的一种常用方法。逐次逼近型 ADC 的算法本质是二分查找法。以查找在 1 到 64 中的随机数为例，首先确定该数是否比 32 大或比 32 小。如果该数比 32 大，那么是否比 48 大或比 48 小。第三次查找在第二次查找的区间内进一步缩小范围，如此继续下去直到找到相应的数。一个逐次逼近区间划分的过程示意图如图 10- 42 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 并行 ADC（Flash 结构） [desc]
并行结构的 ADC 是一种高速转换 ADC。在我们前面介绍的逐次逼近型 ADC 中，采用二分法查找一个 1 到 64 之间的随机数需要经历 6 个时钟周期。并行 ADC 的思想是将数字码的各位数字在一个时钟周期内完成比较。然后通过数字组合逻辑确定权重。这种并行结构的 ADC 虽然速度很快，但是同时也耗费大量的比较器。这些比较器都需要较大的面积和功耗。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流水线型 ADC（Pipeline 结构） [desc]
流水线型 ADC 是也一种高速高精度 ADC。相对逐次逼近型和并行 ADC 来说，流水线型 ADC 在芯片面积和转换时间上有较好的折衷。 
流水线型 ADC 是多级比较网络的级联，每级只得到一位数字码，如果需要得到 n 位数字，那么就需要比较 n 次。输入采样信号必须从头传到尾才能完成一次量化编码。# 1. 逐次逼近型 ADC（Successive Approximation Register，SAR 结构）
逐次逼近型 ADC 因为其快速的转换时间和中等程度的电路复杂度成为实现 ADC 转换器的一种常用方法。逐次逼近型 ADC 的算法本质是二分查找法。以查找在 1 到 64 中的随机数为例，首先确定该数是否比 32 大或比 32 小。如果该数比 32 大，那么是否比 48 大或比 48 小。第三次查找在第二次查找的区间内进一步缩小范围，如此继续下去直到找到相应的数。
在 SAR 结构的 ADC 中，其系统结构是利用一个 DAC 产生一系列模拟电压值和输入信号电压比较，逐步确定最终的数字编码。其中“S/H”部分是采样保持电路，“SAR 数字控制逻辑”包括逐次逼近寄存器阵列和相应的控制电路。寄存器的输出数字码送入 DAC 产生相应的模拟电压值，和 S/H 的输出电压经过比较器比较后再反馈到 SAR 寄存器组中调整直到最后 DAC 无法再分辨为止。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流水线型 ADC（Pipeline 结构） [desc]
流水线型 ADC 是也一种高速高精度 ADC。相对逐次逼近型和并行 ADC 来说，流水线型 ADC 在芯片面积和转换时间上有较好的折衷。流水线型 ADC 是多级比较网络的级联，每级只得到一位数字码，如果需要得到 n 位数字，那么就需要比较 n 次。输入采样信号必须从头传到尾才能完成一次量化编码。显然，对某一采样值信号来说，它的转换时间较长，但是流水线型 ADC 的优势在于当某级完成对一个信号的比较后，可以立即对下一个信号比较。因此，这种 ADC 的转换速度实际上是相当快的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流水线型 ADC（Pipeline 结构） __ 过采样率 ADC [desc]
前面介绍的几种 ADC 结构都可以归结为奈奎斯特采样率 ADC。而本节介绍的 ΔΣADC 是一种以高于奈奎斯特速率采样的 ADC，一般是奈奎斯特速率的 8~512 倍。这种转换器在高分辨率，中低速的系统中（比如高质量的数字音频处理器）已经得到广泛应用。这种过采样率转换器的主要好处是减小了对模拟电路的性能要求，但这是建立在更复杂的数字逻辑电路基础上的。这在当今超大规模集成电路高速发展的背景下是相当容易的。另外，这种过采样数据转换器减小了普通 ADC 中对抗混叠滤波器的依赖。我们知道当采样速率越高时，信号频率实际上被拉的越开，滤波器的要求就越低。所以，过采样率的 ADC 在现在越来越得到重视。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流水线型 ADC（Pipeline 结构） __ 过采样率 ADC __ Δ与ΔΣ 调制 [desc]
ADC 作为一个整体结构，是需要类似采样保持、抗混叠滤波器、数字滤波器等器件。但是我们在这一节里将着重讨论Δ ΣADC 中的重点，调制器问题。实际上，以过采样为基本思想构建的调制器可以分为Δ调制器和ΔΣ 调制器两种。两种不同结构的调制器对比如图 10- 47，图 10- 48 所示。 
- 图 10- 47 Δ调制器模型 
- 图 10- 48 ΔΣ 调制器模型 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 流水线型 ADC（Pipeline 结构） __ 过采样率 ADC __ Δ与ΔΣ 调制 __ 噪声整形技术 [desc]
我们其实在在第四章介绍 KTC 噪声时就接触过“噪声整形技术”的概念。我们可以首先回忆一下 KTC 噪声的产生原因。在这里，我们有必要研究一下 H1(z)=z-1 和 H2 (z)=1-z-1 的两个系统函数的频率响应。由此可以看出，Δ调制器中信号和噪声都要通过（1-z-1）滤波器，也就是该调制器不仅对噪声整形而且对信号也整形。而相比之下，ΔΣ 调制器只是对噪声整形。因此，ΔΣ 调制器在实际中更容易实现，系统要求也简单很多。 功率谱密度和信噪比大小。 假设输入信号 vIN(n)变化很快，那么 E(n)可以近似为均匀分布在±LSB/2 之间的一个随机数。这样量化噪声的功率为 LSB2/12（见式（10-49））并且与采样频率 f# 对比前一种Δ调制器
ΔΣ 调制器是将环路滤波器放在前馈回路中，同样采用简化的 Z 域模型，如图 10- 48（b）所示，那么我们可以得到输出表达式为： 
```
OUT
IN
( )
(
1)
( )
(
1)
v
n
v
n
E n
E n
=
−
+
−
−
```
(10-58) "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 噪声整形技术 [desc]
我们其实在在第四章介绍 KTC 噪声时就接触过“噪声整形技术”的概念。我们可以首先回忆一下 KTC 噪声的产生原因。图 10- 49 KTC 噪声的产生图 10- 50 通过低通滤波器整形后的电阻热噪声。我们知道在图 10- 49 中电阻产生的噪声电压源实际是一个白噪声。但是，由于电阻和电容构成一个低通滤波器，只有在带宽内的噪声才能出现在电路输出端如图 10- 50 所示。可以看到，输出端的噪声已经不再是白噪声，而是被滤波器“整型”过的。这就是“噪声整形”的概念。
我们在来看在Δ调制器，ΔΣ 调制器中的噪声整形。将式（10-57）和式（10-58）变成 Z 域表达式： 
```
1
OUT
IN
( )
(1
)[
( )
( )]
v
z
z
v
z
E z
−
=
−
+
```
(10-59) 
```
1
1
OUT
IN
( )
( )
(1
) ( )
v
z
z v
z
z
E z
−
−
=
+
−
```
(10-60)
在这里，我们有必要研究一下 H1(z)=z-1 和 H2 (z)=1-z-1 的两个系统函数的频率响应。我们知道从 Z 域转化到频谱表达式的方法是令：z=ejω=ej2πf/fs，而|H(f)|就是幅频曲线，其中 fs是采样频率。那么，
```
( )
s
1
2
1
|
|
|
| 1
e
j
j
f
f
z e
H
f
ω
π
=
=
=   
```
(10-61) 
```
( )
s
s
2
2
2
s
e
1
|
|
|
| | 2sin(
) |
e
j
j
f
f
j
f
f
z e
f
H
f
f
ω
π
π
π
=
−
=
=
```
(10-62) 
由此可以看出，Δ调制器中信号和噪声都要通过（1-z-1）滤波器，也就是该调制器不仅对噪声整形而且对信号也整形。而相比之下，ΔΣ 调制器只是对噪声整形。因此，ΔΣ 调制器在实际中更容易实现，系统要求也简单很多。
在前面 DAC 的分析中，我们曾经介绍过量化噪声的概念和实际的计算模型。在加入噪声整形技术后，我们理所应当的想要知道这种量化噪声被整形后的功率谱密度和信噪比大小。
假设输入信号 vIN(n)变化很快，那么 E(n)可以近似为均匀分布在±LSB/2 之间的一个随机数。这样量化噪声的功率为 LSB2/12（见式（10-49））并且与采样频率 fs 无关。同样E(n)的功率谱密度 Se(f)是频率上的一个常量。根据功率的双边定义，量化噪声的所有功率都分布在±fs/2 之间，如图 10- 51 所示。
```
图 10- 51  量化噪声白噪声频谱
因为总的噪声功率等于 LSB2/12，并且双边定义的功率等于±fs/2 内 Se(f)下的面积。由此可以计算出功率谱密度的峰值 Ax。其算数表达式为： 
```
(10-63) 
解式（10-63）得到： 
```
x
s
1
12
LSB
A
f
=
```
(10-64) 
用 Sq表示输出量化噪声的功率谱密度，有： 
```
( )
( )
( )
2
2
2
2
q
2
e
s
s
1
2sin(
) |
e
j
j
f
f
j
f
f
z e
f
H
f
f
ω
π
π
π
=
−
=
=
```
(10-65) 
式（10-65）正是我们所需要的噪声功率谱表达式。那么，整形后的带内[-fb，+fb]噪声平均功率可以表达为： 
```
b
b
2
2
q
q ( )
f
f
V
S
f df
= ∫−
```
(10-66) 
```
b
b
2
2
2
q
s
s
1
2sin
12
f
f
f
LSB
V
df
f
f
π
−
⎛
⎞
=
⎜
⎟
⎝
⎠
∫
```
(10-67) 
```
3
2
2
2
b
q
s
2
36
f
LSB
V
f
π
⎛
⎞
≈ ⎜
⎟
⎝
⎠
```
(10-68) 
我们定义过采样率为： 
```
s
2 b
f
OSR
f
=
```
(10-69)
所以， 
```
2
2
2
3
q
( 1
)
36
LSB
V
OSR
π
=
```
(10-70) 
那么，当输入信号是在 0~1LSB 之间的正弦波，并且是 1bit 量化时，信噪比为： 
```
3
2
2 2
20log
6(
)
LSB
SNR
LSB
OSR
π
=
```
(10-71) 
```
20log6
20log(2 2 )
30log(
)
2.61 30log(
)
SNR
OSR
π
=
−
+
=
+
```
(10-72) 
一般的如果输入信号是 0~2nLSB 的正弦波，并且采用 n-bits 量化，那么信噪比可以表示为： 
```
3
2
2
2 2
20log
6(
)
n LSB
SNR
LSB
OSR
π
=
```
(10-73) 
```
20log 2n
20log6
20log(2 2 )
30log
6.02
3.4
30log(
)
SNR
OSR
n
OSR
π
=
+
−
+
=
−
+
```
(10-74) 
由于过采样率 OSR 一般为 2N，所以式（10-74）可以进一步表示为： 
```
6.02
3.4
9.01
SNR
n
N
=
−
+
```
(10-75) 
从式(10-75)可以看出，第一项为量化器造成的信噪比，OSR 项是从过采样率中得到的信噪比的增强。每增加一倍过采样率，直接使得信噪比提高了 9dB，或等价于输出数字信号增加了 1.5bit。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 两级ΔΣ 调制器 [desc]
一种有效增加分辨率的方法是增加调制器的环路滤波器阶数。这里介绍一种两阶的ΔΣ 调制器。图 10- 52 展示了经典的 Boser-Wooley 二阶ΔΣ 调制器结构。
- 图 10- 52 二阶ΔΣ 调制器模型
这种二阶结构的调制器 Z 域系统函数表示为： 
```
1 2
OUT
IN
( )
( )
(1
)
( )
v
z
v
z
z
E z
−
=
+
−
```
(10-76)
那么同样有量化噪声功率谱为： 
```
2
4
2
q
e
s
( )
(2sin
)
( )
f
S
f
S
f
f
π
=
```
(10-77) 
带内噪声功率为： 
```
2
4
2
5
q
( 1
)
60
LSB
V
OSR
π
=
```
(10-78)
输入信号是 0~2nLSB 的正弦波，过采样率 OSR 为 2N，那么信噪比可以表示为 
```
6.02
11.14
50log(
)
SNR
n
OSR
=
−
+
```
(10-79) 
```
6.02
11.14 15
SNR
n
N
=
−
+
```
(10-80)
也就是说如果 OSR 增大一倍，二阶调制器的信噪比提高 15dB，或等价于输出信号增加 2.5bit。
从图 10- 53 的各阶噪声整形函数(1-z-1)L的对比曲线来看（其中 L 是调制器的阶数），阶数越高，在低频信号带宽内噪声被衰减得更厉害。在这里，我们需要假设在调制器后续电路中包含数字滤波器。该滤波器的决定了信号带宽，并对带外噪声完全衰减。虽然更高的阶数使得量化噪声越小，但是当阶数在 3 阶以上时，这种调制器环路会带来不稳定性问题。在实际设计过程中，2~3 阶电路是比较普遍的。调制器的稳定是指，无论积分器的初始状态如何，只要调制器的输入信号是有界的，那么调制器的所有内部变量在整个调制过程中都是有界的[5]。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 利用电阻电容构建简单的连续时间ΔΣ 调制器 [desc]
在这里我们根据图 10- 48 所示的一阶ΔΣ 调制器模型构建一个简单的实际电路。它由一个一阶的环路滤波器，一个 1-bit 的 ADC 和一个 1-bit 的 DAC 构# 10-74 
```
0log(2 2 )
30log
6.02
3.4
30log(
)
SNR
OSR
n
OSR
π
=
+
−
+
=
−
+
```
(10-74) 
由于过采样率 OSR 一般为 2N，所以式（10-74）可以进一步表示为： 
```
6.02
3.4
9.01
SNR
n
N
=
−
+
```
(10-75) 
从式(10-75)可以看出，第一项为量化器造成的信噪比，OSR 项是从过采样率中得到的信噪比的增强。每增加一倍过采样率，直接使得信噪比提高了 9dB，或等价于输出数字信号增加了 1.5bit。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 两级ΔΣ 调制器 [desc]
一种有效增加分辨率的方法是增加调制器的环路滤波器阶数。这里介绍一种两阶的ΔΣ 调制器。图 10- 52 展示了经典的 Boser-Wooley 二阶ΔΣ 调制器结构。
- 图 10- 52 二阶ΔΣ 调制器模型
这种二阶结构的调制器 Z 域系统函数表示为： 
```
1 2
OUT
IN
( )
( )
(1
)
( )
v
z
v
z
z
E z
−
=
+
−
```
(10-76)
那么同样有量化噪声功率谱为： 
```
2
4
2
q
e
s
( )
(2sin
)
( )
f
S
f
S
f
f
π
=
```
(10-77) 
带内噪声功率为： 
```
2
4
2
5
q
( 1
)
60
LSB
V
OSR
π
=
```
(10-78)
输入信号是 0~2nLSB 的正弦波，过采样率 OSR 为 2N，那么信噪比可以表示为 
```
6.02
11.14
50log(
)
SNR
n
OSR
=
−
+
```
(10-79) 
```
6.02
11.14 15
SNR
n
N
=
−
+
```
(10-80)
也就是说如果 OSR 增大一倍，二阶调制器的信噪比提高 15dB，或等价于输出信号增加 2.5bit。
从图 10- 53 的各阶噪声整形函数(1-z-1)L的对比曲线来看（其中 L 是调制器的阶数），阶数越高，在低频信号带宽内噪声被衰减得更厉害。在这里，我们需要假设在调制器后续电路中包含数字滤波器。该滤波器的决定了信号带宽，并对带外噪声完全衰减。虽然更高的阶数使得量化噪声越小，但是当阶数在 3 阶以上时，这种调制器环路会带来不稳定性问题。在实际设计过程中，2~3 阶电路是比较普遍的。调制器的稳定是指，无论积分器的初始状态如何，只要调制器的输入信号是有界的，那么调制器的所有内部变量在整个调制过程中都是有界的[5]。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 利用电阻电容构建简单的连续时间ΔΣ 调制器 [desc]
在这里我们根据图 10- 48 所示的一阶ΔΣ 调制器模型构建一个简单的实际电路。它由一个一阶的环路滤波器，一个 1-bit 的 ADC 和一个 1-bit 的 DAC 构成。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 Sigma-Delta 调制器设计实例 [desc]
当前很多 ADC 的书籍着重阐述 ADC 的工作原理和电路结构，而缺少行为级的系统仿真。这里我们以 Verilog-A 为工具，简单阐述 ADC 行为级的系统仿真。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 Sigma-Delta 调制器设计实例 __ 1 Verilog-A 简介 [desc]
Verilog-A 是在 Verilog 语言的基础上开发的一种针对模拟电路设计的一种硬件描述语言，他继承了 IEEE 1364 Verilog HDL 中的所有定义。它允许设计者使用行为描述语言定义顶层模块，也可以使用结构描述语言，通过底层模块逐步搭建系统。当用 Verilog-A描述守恒电气系统时，模拟电路的行为需要同时遵守基尔霍夫电流定理和基尔霍夫电压定理。
由于篇幅所限，在这里我们不详细介绍 Verilog-A 的每一条语法和函数，而是以一个运算放大器的 Verilog-A 模型，简单的介绍 Verilog-A 中的常用的语法规则，和电路器件的描述方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 运算放大器的 Verilog-A 代码： [desc]
```
`include ""discipline.h"" 
`include ""constants.h"" 
`define PI   
3.14159265358979323846264338327950288419716939937511 
//-------------------- 
// diff-opamp 
// 
// - differential operational amplifier 
// 
// vin_p,vin_n:  
differential input voltage [V,A] 
// vout_p, vout_n: differential output voltage [V,A] 
// vref: 
reference voltage [V,A] 
// vspply_p: 
positive supply voltage [V,A] 
// vspply_n: 
negative supply voltage [V,A] 
// 
// INSTANCE parameters 
//    gain           = gain [] 
//    freq_unitygain = unity gain frequency [Hz] 
//    rin            = input resistance [Ohms] 
//    vin_offset     = input offset voltage referred to negative [V] 
//    ibias          = input current [A] 
//    iin_max        = maximum current [A] 
//    slew_rate      = slew rate [A/F] 
//    rout           = output resistance [Ohms] 
//    vsoft          = soft output limiting value [V] 
// 
// MODEL parameters 
//    {none} 
module diff_opamp(vout_p, vout_n, vref, vin_p, vin_n, vspply_p, vspply_n); 
input vref, vspply_p, vspply_n; 
inout vout_p, vout_n, vin_p, vin_n; 
parameter real gain = 835e3; 
parameter real freq_unitygain  = 1.0e6; 
parameter real rin = 1e6; 
parameter real vin_offset = 0.0; 
parameter real ibias = 0.0; 
parameter real iin_max = 100e-6; 
parameter real slew_rate = 0.5e6; 
parameter real rout = 80; 
parameter real vsoft = 0.5; 
   real c1; 
   real gm_nom; 
   real r1; 
   real vmax_in; 
   real vin_val; 
electrical vout_p, vout_n, vref, vin_p, vin_n, vspply_p, vspply_n; 
electrical cout_p, cout_n; 
   analog begin 
      @ ( initial_step or initial_step(""dc"") ) begin 
 c1 = iin_max/(slew_rate); 
 gm_nom = 2 * `PI * freq_unitygain * c1; 
 r1 = gain/gm_nom; 
 vmax_in = iin_max/gm_nom; 
   end 
vin_val = V(vin_p,vin_n)/2 + vin_offset;          
      //3 
4
``````markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 425 [desc]
voltage referred to negative [V] 
// ibias = input current [A] 
// iin_max = maximum current [A] 
// slew_rate = slew rate [A/F] 
// rout = output resistance [Ohms] 
// vsoft = soft output limiting value [V] 
// MODEL parameters 
// {none} 
module diff_opamp(vout_p, vout_n, vref, vin_p, vin_n, vspply_p, vspply_n); 
input vref, vspply_p, vspply_n; 
inout vout_p, vout_n, vin_p, vin_n; 
parameter real gain = 835e3; 
parameter real freq_unitygain = 1.0e6; 
parameter real rin = 1e6; 
parameter real vin_offset = 0.0; 
parameter real ibias = 0.0; 
parameter real iin_max = 100e-6; 
parameter real slew_rate = 0.5e6; 
parameter real rout = 80; 
parameter real vsoft = 0.5; 
real c1; 
real gm_nom; 
real r1; 
real vmax_in; 
real vin_val; 
electrical vout_p, vout_n, vref, vin_p, vin_n, vspply_p, vspply_n; 
electrical cout_p, cout_n; 
analog begin 
@ ( initial_step or initial_step(""dc"") ) begin 
c1 = iin_max/(slew_rate); 
gm_nom = 2 * `PI * freq_unitygain * c1; 
r1 = gain/gm_nom; 
vmax_in = iin_max/gm_nom; 
end 
vin_val = V(vin_p, vin_n)/2 + vin_offset; "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 426 [desc]
Options are processed by option statements.   
Option options vary = 1;   
Option options range = [-Inf:+Inf];  
// Input stage.   
// 
I(vin_p, vin_n) <+ (V(vin_p, vin_n) + vin_offset)/ rin; 
I(vref, vin_p) <+ ibias;  
I(vref, vin_n) <+ ibias;"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 427 [desc]
// GM stage with slewing 
// 
I(vref, cout_p) <+ V(vref, cout_p)/100e6; 
I(vref, cout_n) <+ V(vref, cout_n)/100e6;
if (vin_val > vmax_in) begin 
I(vref, cout_p) <+ iin_max; 
I(vref, cout_n) <+ -iin_max; 
end "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 [desc]
2. 
运算放大器 Verilog-A 代码详解 
1) 
文件调用 
在 Verilog-A 代码的开始，是文件调用。其中“`include”是关键字，其后的双引号
中是文件名。 
""discipline.h""中包含的是 Verilog-A 中预先定义的“discipline”，而“discipline”是用
来定义节点类型的。这一点将在后文中介绍。 
""constants.h""中包含的是 Verilog-A 中预先定义的一些常量，例如电子电荷、自然对
数、波尔兹曼常数以及普朗克常数等等。 
2) 
定义常数 
除了使用""constants.h""中的常数外，也可以自己定义常数。方法如上文所示。其中
“`define”是关键字，随后的是常数名称，然后是常数值。 
3) 
说明文档 
一个好的程序代码需要大量的文档支持，方便使用者调用该程序。在 Verilog-A 中，
可以使用“//”或者“/*”和“*/”符号对来添加说明文档。 
“//”符号表示，在该符号后的文字是说
```
```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 运算放大器 Verilog-A 代码详解 __ 文件调用 [desc]
在 Verilog-A 代码的开始，是文件调用。其中“`include”是关键字，其后的双引号中是文件名。 
""discipline.h""中包含的是 Verilog-A 中预先定义的“discipline”，而“discipline”是用来定义节点类型的。这一点将在后文中介绍。 
""constants.h""中包含的是 Verilog-A 中预先定义的一些常量，例如电子电荷、自然对数、波尔兹曼常数以及普朗克常数等等。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 运算放大器 Verilog-A 代码详解 __ 定义常数 [desc]
除了使用""constants.h""中的常数外，也可以自己定义常数。方法如上文所示。其中
“`define”是关键字，随后的是常数名称，然后是常数值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 运算放大器 Verilog-A 代码详解 __ 说明文档 [desc]
一个好的程序代码需要大量的文档支持，方便使用者调用该程序。在 Verilog-A 中，
可以使用“//”或者“/*”和“*/”符号对来添加说明文档。 
“//”符号表示，在该符号后的文字是说明的性质，不参与程序的编译。 
在“/*”和“*/”符号对中的文字是说明的性质，不参与程序的编译。 
实例中给出了运算放大器管脚的说明文档。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 模块定义 [desc]
在 Verilog-A 中，模块式通过关键字“module”和“endmodule”定义的。他们中间的内容就是模块体。需要注意的是“module”和“endmodule”是不能相互嵌套的。下面的定义就是错误的。 
在“module”的后面是模块的名称，随后的括号中是模块的管脚，各个管脚间用逗号隔开。在运算放大器的例子中，对于模块的定义如下： 
模块名称：opamp 
模块管脚：vout，vref，vin_p，vin_n，vspply_p，vspply_n。 
他们分别对应运算放大器的输出端、基准电压、同向输入端、反向输入端、正供电电源和负供电电源。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 管脚类型声明 [desc]
在定义模块管脚后，还需要声明管脚类型。关键字有： 
input ：输入管脚。 
output ：输出管脚。 
inout ：输入输出管脚简单的讲，输入管脚只能从模块外部获得电流电压信号，但不能改变这些信号的大小；输出管脚对外输出电流或者电压信号，并且这些信号的大小只受模块内部器件的影响。 可以看出在运算放大器的实例中，vref、vspply_p、vspply_n 是输入管脚；vout_p、vout_n、vin_p、vin_n 是输入输出管脚。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 参变量 [desc]
在 Verilog-A 中参变量通过关键字“parameter”来定义。在关键字后面的是参变量的类型，有两个选项“real”和“integer”，分别表示参变量的类型是实数和整数。随后是参变量的名称，参变量的默认值可以通过添加等号和数值得到。如在实例中，定义了运算放大器的增益为参变量，名称为“gain”，类型为实数，默认值是“835e3”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 节点类型定义 [desc]
如果查阅“discipline.h”文件，可以发现“electrical”是其中定义的一个“discipline”，现在使用这个名称来定义节点的类型。被“electrical”定义的节点将具有电学特性，即我们可以获得节点的电压和流过节点的电流量。因为我们后面进行的电路仿真，都是针对守恒的电路系统，因此该电路系统中的所有节点都用“electrical”来定义。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 支路 [desc]
在定义了节点之后，就可以定义支路。支路是两个节点间的一条通路，支路的类型由该支路包含的两个节点的类型决定。支路是通过关键字“branch”来定义的，关键字后面的圆括号包含一对节点，分别是支路的起始和结束节点。若圆括号中只有一个节点，那么第二个节点是公共地端。在圆括号后面的是所定义支路的名称。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 428 __ 信号获取函数 [desc]
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 节点类型定义 [desc]
在 Verilog-A 中参变量通过关键字“parameter”来定义。在关键字后面的是参变量的类型，有两个选项“real”和“integer”，分别表示参变量的类型是实数和整数。随后是参变量的名称，参变量的默认值可以通过添加等号和数值得到。如在实例中，定义了运算放大器的增益为参变量，名称为“gain”，类型为实数，默认值是“835e3”。定义的参变量将应用到电路仿真计算中，同时这些参变量在电路仿真时也可以模块调用时被重新赋值。在电路图中，选中 Verilog-A 模块的符号，点击快捷键“q”，进入“Edit Object Properties”窗口，如图 10- 55 所示，就为运算放大器 Verilog-A 模块中的参变量重新赋值。可以看出增益“gain”被重新赋值为“100”，单位增益带宽“freq_unitygain”被重新赋值为“50k”，而摆率“slew_rate”和输出限制电压“vsoft”则继续使用默认值。
```Verilog
parameter real gain = 835e3; 
parameter real freq_unitygain  = 1.0e6; 
parameter real rin = 1e6; 
parameter real vin_offset = 0.0; 
parameter real ibias = 0.0; 
parameter real iin_max = 100e-6; 
parameter real slew_rate = 0.5e6; 
parameter real rout = 80; 
parameter real vsoft = 0.5; 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 支路 [desc]
在定义了节点之后，就可以定义支路。支路是两个节点间的一条通路，支路的类型由该支路包含的两个节点的类型决定。支路是通过关键字“branch”来定义的，关键字后面的圆括号包含一对节点，分别是支路的起始和结束节点。若圆括号中只有一个节点，那么第二个节点是公共地端。在圆括号后面的是所定义支路的名称。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 信号获取函数 [desc]
```
electrical vout_p, vout_n, vref, vin_p, vin_n, vspply_p, vspply_n; 
electrical cout_p, cout_n; 
branch (p, n) b1; 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 赋值符号 [desc]
在上文定义节点时，使每个节点都含有电压量和电流量，通过信号获取函数 V( )和 I( )，可以在 Verilog-A 获取节点的电压量和电流量，或者为他们赋值。在例子中，n1 和 n2 表示两个节点，b1 表示一条支路。
```
V(n1); 
V(n1, n2) 
V(b1); 
I(n1); 
I(n1, n2) 
I(b1); 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电源和探针 [desc]
在 Verilog-A 中可以将对模块的行为级描述可以转换为受控电源和探针组成的网络。配合上文讲述的信号获取符号和赋值符号。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 压控电压源 [desc]
```Verilog
module VCVS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
V(out) <+ A * V(in);   
end
endmodule 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 压控电流源 [desc]
```Verilog
module VCCS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin 
I(out) <+ A * V(in);  
end
endmodule
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流控电压源 [desc]
```Verilog
module CCVS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
V(out) <+ A * I(in);   
end 
endmodule
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电流控电流源 [desc]
```Verilog
module CCCS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
I(out) <+ A* I(in);   
end 
endmodule 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电阻、电容及电感网络 [desc]
---table begin---
Table tile:电阻、电容及电感网络类型
|种类| Verilog-A 描述 |
| -  |  ------------  |
| 电阻（电压源形式）| module resistor_V (p, n); inout p, n; electrical p, n; parameter real R=1k; |"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电源和探针的使用实例 [desc]
下面将介绍如何使用电源和探针来实现电路中常见的受控电源和电阻、电容和电感网络。 
## 压控电压源
```Verilog
module VCVS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
V(out) <+ A * V(in);   
end
endmodule 
```
## 压控电流源
```Verilog
module VCCS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin 
I(out) <+ A * V(in);  
end
endmodule
```
## 电流控电压源
```Verilog
module CCVS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
V(out) <+ A * I(in);   
end 
endmodule
```
## 电流控电流源
```Verilog
module CCCS (pc, nc, ps, ns); 
inout pc, nc, ps, ns; 
electrical pc, nc, ps, ns;   
parameter real A=1;   
branch (pc, nc) in;   
branch (ps, ns) out;   
analog begin   
I(out) <+ A* I(in);   
end 
endmodule 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 电阻电容电感模型 [desc]
## 电阻模型
下面是电阻的两种形式：
- 电压源形式： 
```Verilog
module resistor_V (p, n); 
inout p, n; 
electrical p, n; 
parameter real R=1k; 
branch (p, n) res; 
analog begin 
V(res) <+ R* I(res); 
end 
endmodule 
```
- 电流源形式： 
```Verilog
module resistor_C (p, n); 
inout p, n; 
electrical p, n; 
parameter real R=1k; 
branch (p, n) cond; 
analog begin 
I(cond) <+ V(cond) / R; 
end 
endmodule 
```
## 电容模型
下面是电容的两种形式：
- 电压源形式：
```Verilog
module capacitor_V (p, n); 
inout p, n; 
electrical p, n; 
parameter real C=1p; 
branch (p, n) cap; 
analog begin 
V(cap) <+ idt(I(cap)) / C; 
end 
endmodule 
```
- 电流源形式：
```Verilog
module capacitor_C (p, n); 
inout p, n; 
electrical p, n; 
parameter real C=1p; 
branch (p, n) cap; 
analog begin 
I(cap) <+ ddt(C * V(cap)); 
end 
endmodule 
```
## 电感模型
下面是电感的两种形式：
- 电压源形式：
```Verilog
module induction_V (p, n); 
inout p, n; 
electrical p, n; 
parameter real L=1p; 
branch (p, n) ind; 
analog begin 
V(ind) <+ ddt(L * I(ind)); 
end 
endmodule 
```
- 电流源形式：
```Verilog
module induction_C (p, n); 
inout p, n; 
electrical p, n; 
parameter real L=1p; 
branch (p, n) ind; 
analog begin 
I(ind) <+ idt(V(ind)) / L; 
end 
endmodule 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 串联与并联电阻电容电感模型 [desc]
## 串联电阻电容电感模型
```Verilog
module serial_RCL (p, n); 
inout p, n; 
electrical p, n; 
parameter real R=1k; 
parameter real L=1p; 
parameter real C=1p; 
analog begin 
V(p, n) <+ R * I(p, n) + L *ddt(I(p, n)) + idt(I(p, n)) / C; 
end 
endmodule 
```
## 并联电阻电容电感模型
```Verilog
module paralle_RCL (p, n); 
inout p, n; 
electrical p, n; 
parameter real R=1k; 
parameter real L=1p; 
parameter real C=1p; 
analog begin 
I(p, n) <+ V(p, n) / R + idt(V(p, n)) / L + ddt(V(p, n)) * C; 
end 
endmodule 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 时间微分操作符 [desc]
电容（电流源形式）的 Verilog-A 模型中，给出:
```Verilog
I(cap) <+ C * ddt( V(cap));
```
等效的数学表达式为： 
\( I(t) = C * dV(t) / dt \)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 时间积分操作符 [desc]
例如在电容（电压源形式）的 Verilog-A 模型中，给出:
```Verilog```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 运算放大器 Verilog-A 代码描述的小信号模型 [desc]
在上文中介绍了一些在 Verilog-A 中常用的语句和语法，因此再次阅读运算放大器的 Verilog-A 代码，可以画出它所描述的运算放大器的小信号模型。
每个器件都被赋予了编号，从 1 到 16。在运算放大器的 Verilog-A 代码中，有些语句也在末尾用注释标出了相应的编号，这表示该语句表述了小信号模型中对应的器件。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 运算放大器 Verilog-A 代码描述的小信号模型 __ 2 一阶连续时间 sigma-delta ADC 系统仿真 [desc]
在 10.3.3 中介绍了一种连续时间 sigma-delta ADC，如图 10- 54 所示。下面将使用上文介绍了 Verilog-A 语言来搭建这种模数转换器，并给出基本的仿真测试方法。
主要的电路模块有 3 个：运算放大器，比较器和 D 触发器。他们都是由 Verilog-A 代码编写而成的。其中运算放大器的 Verilog-A 代码在 10.4.1 中给出，比较器和 D 触发器的代码在本章最后给出。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入为直流电平时，输出电压的变化 [desc]
在积分器的同相输入端和反向输入端之间加入直流输入信号。
当输入接入直流电平时，由于差分运算放大器两端的电容的充电速度不同，导致差分运算放大器的输出不能完全对称，于是，出现了 FF_P 不断上升的趋势。
一阶 ADC 的输入电压和输出电压之间存在着如下关系。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入信号为交流信号时，ADC 的仿真和测试 [desc]
无论是在实际测试还是电路仿真中，正弦信号都是一种十分方便的输入信号。而离散傅立叶变化（Discrete Fourier Transform，DFT）是一种常用的分析 sigma-delta ADC 的性能的工具。
```
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入为直流电平时，输出电压的变化 [desc]
输入电压是规则的方波，在＋1 与－1 之间随时钟周期转换，y 输出电压是三角波，随 FF_p 端输出电压的变化而变化斜率。接下来观察 ADC 对直流输入信号的响应情况。在积分器的同相输入端和反向输入端之间加入直流输入信号。在电路图中为在运算放大器的两个输入端之间加入一个直流电源，大小为 30mV。如图 10- 64 所示，当输入接入直流电平时，由于差分运算放大器两端的电容的充电速度不同，导致差分运算放大器的输出不能完全对称，于是，出现了 FF_P 不断上升的趋势。当 FF_P 上升到一定电压时，在一个时钟周期内，FF_P 不能下降到 0,这样，D 触发器的输出端 Q 不能翻转，于是，FF_P 继续下降，直到下一个时钟周期，Q 翻转。于是，FF_P 又处于了低电平，开始新一轮不断上升的趋势。FF_P 就是以这样的一个大周期有规律的变化。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入为直流电平时，输出电压的变化 __ 一阶 ADC 的输入电压和输出电压之间的关系 [desc]
假设输入电压为 u=a/b，如果 0<a<b，并且 a 和 b 都是奇数且没有公约数，则取 b 个输出电压，其中包括（a+b）/2个＋1, (b-a)/2 个－1，则平均数为 a/b，刚好与输入电压 u 相等。在 b 个采样周期后，输出电压又重新回归到最初的值，所以，输出电压以 b 为周期不停变化。同样，如果 a 与 b 中有一个为偶数，则 a+b 为奇数，输出电压以 2b 为周期变化，其中包括(a+b)个+1,(b-a)个－1。其中，输入电压 u 以 D 触发器的输出电压为基准进行规一化，输出电压的＋1 和－1 分别代表输出电压的符号。 
为了验证上述规律，我们对 D 触发器的输出电压 FF_p 进行积分，为了方便计算，D 触发器的输出电压分别为＋1V 和－1V。由于采样周期为 2ms,输入电压 u=0.03,取 200个采样周期也就是 400ms 进行积分，积分函数选择“Calculator”中的“integ”函数，该函数的设置如图 10- 65 所示。需要一次填入积分信号、积分起始时间和积分结束时间。计算出的结果约为 0.012，如图 10- 66 所示。因为 0.012/0.4=0.03=u。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 输入信号为交流信号时，ADC 的仿真和测试 [desc]
无论是在实际测试还是电路仿真中，正弦信号都是一种十分方便的输入信号。而离散傅立叶变化（Discrete Fourier Transform，DFT）是一种常用的分析 sigma-delta ADC 输出数据能量谱密度的方法。下面将介绍使用“Calculator”中的“dft”函数分析 ADC 对正弦输入信号的响应。在积分器的同相输入端和反向输入端之间加入输入信号。在电路图中为在运算放大器的两个输入端之间加入一个正弦信号电源，幅值为 0.3V，频率为 7.8125Hz。电路图
如图 10- 67 所示。选择 7.8125Hz 作为正弦信号的原因是，为了“dft”的计算方便，采样点一般为 2N，因此在随后的仿真结果处理中，选择了 2048 个采样点，而时钟周期为2ms，因此每个周期采一个数据，采样时间持续 0.002s×2048=4.096s。将 4.096s 做为输入信号的基波周期，将能有效减少做“dft”时产生的信号泄露，因此输入信号的频率为446 n/4.096。为了减小谐波的影响，我们这里选择较高的输入信号频率，从而拉大谐波间的间隔。这里选择 n=32，因此输入信号频率为 7.8125 Hz，中心值为 0V，幅值为 1V 的正弦波。 
图 10- 68 给出了输入为正弦信号时的仿真输出，可以发现无法通过直接观察仿真结果来评价 ADC 性能的好坏，因此需要借助“Calculator”中的“dft”函数，对输出数据进行处理。 
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 对数坐标系 ADC 输出数据的功率谱中的输入信号 [desc]
信噪比的计算十分简单，输入信号的能量除以信号带宽内的噪声能量的加和。 
虽然在“Calculator”中可以计算 ADC 输出的频谱图，但是随着数据量的上升，“Calculator”在读取和计算数据时都会花去大量的时间，并且没有直接的函数用来计算信噪比 SNR。因此更常用的方法是将 Spectre 仿真的数据直接导出到文件中，然后通过 Matlab 读取文件中的数据，在 Matlab 中通过卷积来绘制 ADC 输出数据的频谱图，并计算信噪比 SNR。
下面将介绍使用 Matlab 处理数据的方法。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 首先导出 Spectre 仿真数据到文件中 [desc]
这里直接使用 OCEAN 命令来导出数据。这是因为当数据个数大于 1500 个后不能直接从“Results Browser”或者“Calculator”中导出全部数据。OCEAN 命令为： 
```
ocnPrint(?output ""filename"" data ?from start_point ?to end_point ?step step_point)
```
在上述命令中，以“？”开头的单词是命令的关键字，斜体字为需要填入的变量名称。其中“filename”是将要接受导出数据的文件；“data”是需要导出的数据，标准格式可以从“Results Browser”导出到“Calculator”中后获得；“start_point”是开始导出数据的横坐标；“end_point”是结束导出数据时的横坐标；“step_point”是步进。 
下面的命令是针对图 10- 69 中“Calculator”中关于“dft”的设置，将“FF_P”端的电压在 12.5444 秒到 16.6404 秒范围内，以 2 毫秒的间隔时间，输出到文件“CT_ADC”中。 
在“CIW”窗口的命令行（见附录 A）中输入该命令，如图 10- 74 所示。成功输出数据后，将在“CIW”的输出窗口显示“t”。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 在“CIW”的命令行中输入数据输出命令 [desc]
输出的数据如图 10- 75 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 从 Spectre 中输出的数据 [desc]
这里需要注意的是： 
ocnPrint(?output ""~/CT_ADC"" v(""/FF_p"" ?resultsDir ""/home.fireworks/wangy/simulation/continuous-ADC/spectre/schematic/psf"" ?result ""tran-tran"") ?from 12.5444 ?to 16.6404 ?step 2m) 开头的注释内容需要删除，文件中只保留纯数据。 
在“Spectre”中使用“m”，“K”，“M”的数据格式。这里需要将他们转换成Matlab 所使用的格式。两种软件的数据格式如表 10- 1 所示。这种转换可以在“word”或者“excel”等软件中实现。 
---table begin---
Table title: Spetre 和 Matlab 的数据格式
| Spetre | Matlab |
|--------|--------|
| f      | e-15   |
| p      | e-12   |
| u      | e-9    |
| n      | e-6    |
| m      | e-3    |
| K      | e3     |
| M      | e6     |
| G      | e9     |
| T      | e12    |
---table end---
当完成数据处理后，可以运行以下 Matlab 程序，进行快速傅立叶变化，并计算信噪比 SNR。“%”后的内容是注释部分。在这个程序中，需要填入的内容有（“：”后为程序中的变量名）："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 见附录 A 对于未单独声明的 MOS 管，其参数如下。 [desc]
NMOS：6 2 n ox THn 1 n 10 120 10 A V 0.7 =0.02V W L C V V μ λ − − = = × = 
PMOS：6 2 p ox THp 1 p 10 40 10 A V 0.8V 0.01V W ```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Chapter: MatLab Code [desc]
```
```python
= 3;       %the number of signal bins that cause by signal leakage 
w1 = norm(w, 1); 
w2 = norm(w, 2); 
NBW = (w2/w1)^2;   % calculate the noise bandwidth 
V = fft(w.*v)/(w1/2);  % do the fft 
%computer SNR 
signal_bins = fbin + [-(nb-1)/2:(nb-1)/2];  %calculate the bins number that represent the signal 
inband_bins = 0 : N/(2*OSR);     %calculate the number of bins that in signal bandwidth 
noise_bins = setdiff(inband_bins, signal_bins);   %distinguish the signal from the noise 
% calculate the SNR 
snr = dbp (sum(abs(V(signal_bins+1)).^2) / sum(abs(V(noise_bins+1)).^2));  
```
```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Chapter: Running MatLab [desc]
When the Matlab program is run, an output data spectrum graph is obtained, and the signal-to-noise ratio (SNR) is calculated based on the signal frequency, sampling frequency and oversampling rate information filled in Matlab. As shown in Figure 10-76, the signal-to-noise ratio is 35.5dB. "
"[desc] 模拟集成电路设计与仿真_何乐年 __ Chapter: MOS Parameters [desc]
For MOS tubes that are not declared separately, their parameters are as follows.
---table begin---
Table title: NMOS Parameters
| Parameter | Value     |
|--------------|------------|
| n  | 6  |
| ox  | 2  |
| THn  | 1 nA/V² |
| µ | 0.02V |
| λ | 120 × 10^-10 V |
---table end---
---table begin---
Table title: PMOS Parameters
| Parameter | Value     |
|--------------|------------|
| p  | 6  |
| ox  | 2  |
| THp  | 1 pA/V² |
| µ | 0.01V |
| λ | 40 × 10^-10 V |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Chapter: MOS Parameters __  [desc]
(a) The high voltage of the clock signal is 5V, and the input voltage is 3V.
(b) The high voltage of the clock signal is 5V, and the input voltage is 1V.
```
```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 一阶调制器开关电容实现模式 [desc]
如图 10-48所示，代表了时域中的积分。在图 10-77中，给出了一阶调制器的开关电容实现模式。其中，Y为积分器的输出信号，记Q1和Q2为电容C1和C2上的电荷，并且两个电容的大小是一致的。假设运算放大器的增益是有限的，并且为A，试证明：
- 电容C2上的电荷Q2存在以下时序关系：Q[n+2] = Q[n] + ref[n] × (V[n] - Vout[n] - Q[n]/C/A)
- 积分器的输出信号 Y 和输入输出信号存在以下关系：Y = Z/Zp × (Vin - Vout)
  其中，Zp = 1 - 1/A"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 16 差分输入单端输出运算放大器代码示例 [desc]
以""diff-opamp""的Verilog-A代码为例，以下是差分输入单端输出的运算放大器的代码。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 附录 [desc]
附录中包括两段代码：一个是比较器的 Verilog-A 代码，另一个是D 触发器的 Verilog-A 代码。
## 比较器的 Verilog-A 代码
```verilog
// PARAMETERS: 
//   hys = Input voltage threshold, after offset, required for 
//   output to change state [V] 
//   n_off = Offset voltage added to vin_n pin [V]  
//   one = Analog value for a Digital 1 on output [V]  
//   p_off = Offset voltage added to vin_p pin [V] 
//   slack = The smallest time interval considered negligible (abstol for clock) [S] 
//   td = intrinsic delay  from threshold cross to output change [S] 
//   tfall = Transistion time for output fall [S] 
//   trise = Transition time for output rise [S] 
//   vth = Enable pin's threshold voltage [V] 
//   zero = Analog value for a Digital 0 on output [V] 
//  
```
## D触发器的 Verilog-A 代码 
```verilog
`include ""discipline.h"" 
`include ""constants.h"" 
// model comp - Comparator 
// enable signal is active: High  
// 
module comp (vin_p, vin_n, enable, vout) ; 
input vin_p, vin_n, enable; 
output vout; 
electrical vin_p, vin_n, enable, vout; 
parameter real td = 50.0u  from (0:inf); 
parameter real  hys = 25.0m  from (0:inf); 
parameter real p_off = 10.0u; 
parameter real n_off = -10.0u; 
parameter real trise = 20.0u  from (0:inf); 
parameter real tfall = 20.0u  from (0:inf); 
parameter real  one = 5.0; 
parameter real zero = 0.0; 
parameter real  vth = 2.4; 
parameter real slack = 10.0p from (0:inf); 
parameter integer  init = 1; 
real vin, halfhys, outstate; 
 analog begin 
  @(initial_step(""ac"",""dc"",""tran"",""xf""))  begin 
    halfhys =  hys/2.0; 
    vin =V(vin_p) + p_off - V(vin_n) + n_off; 
    outstate =  (abs(vin) - abs(halfhys) > 0.0) ?  zero : one ; 
    if (traceflag)  begin 
    end 
  end
  vin =V(vin_p) + p_off - V(vin_n) + n_off; 
  if(vin > 0&&V(enable)>vth) 
  begin 
  outstate = one; 
      if(traceflag) 
  end 
  else if(vin<0&&V(enable)>vth) 
  begin 
  outstate = zero; 
         if(traceflag) 
  end 
  V(vout) <+  transition (outstate, td, trise, tfall ); 
  end 
endmodule 
``````markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ D 触发器的 Verilog-A 代码 [desc]
```
`include ""discipline.h""
`include ""constants.h""
// d_ff -  D-type flip flop
// vin_d:
[V,A]
// vclk:
[V,A]
// vout_q,vout_qbar: [V,A]
//
// INSTANCE parameters
//    vlogic_high = output voltage for high [V]
//    vlogic_low  = output voltage for high [V]
//    vtrans      = voltages above this at input are considered high [V]
//    vtrans_clk  = transition voltage of clock [V]
//    tdel, trise, tfall = {usual} [s]
//
// Triggered on the rising edge
vin =V(vin_p) + p_off - V(vin_n) + n_off;
if(vin > 0&&V(enable)>vth)
begin
outstate = one;
        if(traceflag)
    end
else if(vin<0&&V(enable)>vth)
begin
outstate = zero;
         if(traceflag)
    end
    V(vout) <+  transition (outstate, td, trise, tfall );
    end
endmodule
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ D 触发器的 Verilog-A 代码 __ 1 命令行窗口（CIW）菜单 [desc]
CIW 菜单展开包含的选项如图 A- 2 所示，下面将介绍其中比较重要的一些选项。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “ Files”菜单 [desc]
- “New”命令：通过选择“File”�“New”，可以建立新的设计库(Design Library)或者设计的“CellView”；
- “Import”命令：通过选择“File”� “Import”。可以导入的信息包括 gds 版图、电路图、cdl 网表、模型库和 verilog 代码等。 
- “Open”命令：通过选择“File”�“Open”，可以打开“Cell”的“View”，根据不同的“View”的类型，Cadence 将选择适当的编辑器
- “Export”命令：通过选择“File”�“Export”导出文件。可以将 Cadence 设计库导出成各种文件类型。 
- “Exit”命令：通过选择“File”�“Exit”，可以退出“icfb”工作环境。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Tools”菜单 [desc]
- “Library Manager”命令：通过选择“Tools”�“Library Manager”，可以打开“Library Manager”对话框如图 A- 3 所示。后面将详细介绍其中的内容。 
- “Library Path Editor”命令：通过选择“Tools”�“Library Path Editor”，可以打开“Library Path Editor”对话框如图 A- 4所示。这是一个用来修改设计库配置文件(cds.lib)的图形化界面。 
- “Analog Environment”命令：通过选择“Tools”�“Analog Environment”中的子菜单，可以打开 4 种用于模拟电路仿真的工具
- “Technology File Manager”：通过选择“Tools”�“Technology File Manager”，可以打开“Technology File Tool Box”对话框，如图 A- 6 所示。这个对话框用于管理设计库和模型库之间的对应关系的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 [desc]
该菜单内的选项主要用于配置“icfb”的环境并保存/载入需要的配置。该菜单中还提供了用于管理产品秘钥的工具。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ 2 CIW 中的其他部分 [desc]
CIW 的输出窗口如图 A- 7 所示。主要显示一些操作的输出信息和提示，包括一些状态信息和警告信息、错误提示
```
```markdown"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Exit 命令 [desc]
通过选择“File”�“Exit”，可以退出“icfb”工作环境。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Tools 菜单 [desc]
- “Library Manager”命令：通过选择“Tools”�“Library Manager”，可以打开“Library Manager”对话框如图 A- 3 所示。后面将详细介绍其中的内容。 
- “Library Path Editor”命令：通过选择“Tools”�“Library Path Editor”，可以打开“Library Path Editor”对话框如图 A- 4所示。这是一个用来修改设计库配置文件(cds.lib)的图形化界面。在这个界面中可以直观地对 cds.lib 文件进行修改和添加。 
- “Verilog Integration”命令：通过选择“Tools”�“Verilog Integration”�“Verilog-XL”/“NC-Verilog”，可以在两种集成的 Verilog 仿真环境中切换，以适用于不同的模拟电路和数字电路的混合仿真。
- “Analog Environment”命令：通过选择“Tools”�“Analog Environment”中的子菜单，可以打开 4 种用于模拟电路仿真的工具，4 个工具包括： “Simulation”：  打开 Virtuoso® Analog Design Environment（ADE），如图 A- 5所示。 “Calculator”： 用于对仿真结果进行进一步计算的计算器工具。 “Result Browser”： 仿真结果浏览器。 “Waveform”： 仿真结果绘图程序。 这些工具的使用将在各个章节中介绍。
- “Technology File Manager”：通过选择“Tools”�“Technology File Manager”，可以打开“Technology File Tool Box”对话框，如图 A- 6 所示。这个对话框用于管理设计库和模型库之间的对应关系的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Options 菜单 [desc]
该菜单内的选项主要用于配置“icfb”的环境并保存/载入需要的配置。该菜单中还提供了用于管理产品秘钥的工具。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Options 菜单 __ CIW 中的其他部分 [desc]
CIW 的输出窗口如图 A- 7 所示。主要显示一些操作的输出信息和提示，包括一些状态信息和警告信息、错误提示。这些提示有助于分析操作中的问题。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Options 菜单 __ 设计库浏览面板 [desc]
设计库浏览面板如图 A- 10 所示。面板处于设计库浏览器的中部，从左到右共分有 4栏，分别为设计库（Library）、类别（Category）、单元（Cell）、显示（View）栏。右面的3 栏中每一栏中显示的都是该栏的左邻栏中选定的项目的展开。例如，图中的分类栏中显示的就是设计库“analogLib”中的内容，而单元栏中显示的就是分类“Parasitics”包含的内容，同样“View”栏中列出的就是单元“pcapacitor”所包含的内容。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Options”菜单 __ Options 菜单 __ 设计库浏览器菜单 [desc]
菜单中有很多命令和设计库管理器面板的右键菜单中的命令是相同的，这里主要介绍其中只有菜单中才有的命令。
- “ Files”菜单
    - “New”命令：通过选择“File”�“New”�“Library”/“Cell View”/“Category”命令，可以新建设计库/单元View/分类。
    - “Save Defaults”命令：通过选择“File”�“Save Defaults”命令，可以将当前设置作为默认值保存在.cdsenv 文件中。
    - “Load Defaults”命令：通过选择“File”�“Load Defaults”命令，可以从.cdsenv 文件中读取默认设置。 
    - “Open Shell Window”命令：通过选择“File”�“Open Shell Window”命令，可以打开 Shell 命令行窗口，在管理设计库的时候经常要用到一些文件操作，这时可以打开 Shell 窗口，在命令行中进行文件操作。 
- “Edit”菜单
    - “Copy”命令：通过选择“Edit”�“Copy”，可以对在“Library Manager”窗口中选中的设计库（Library）、单元（Cell）、显示（View）进行拷贝。需要注意的是，设计库（Library）、单元（Cell）
```"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 单元（Cell）设计 [desc]
单元（Cell）则是一个电路的基础单位，一个单元就相当于电路的一个模块，这个模块即可以是底层模块，表示部分电路；也可以是由子单元构成的，中层或者顶层模块。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 单元（Cell）表示方法 [desc]
同一个单元（Cell）在设计中需要不同的表示方法，例如一个模拟电路模块，在设计内部结构的时候可能需要将它表示为电路图，而在引用该模块的时候则需要将其表示为一个器件符号。在绘制版图的时候可能需要将该模块表示为版图的一个部分。所以一个单元就必须有多种表示方式，称为“Views”。上面举例的模块就可以有电路图（schematic）、器件符号（symbol）、版图（layout）三个（View）。在设计中应当保证同一个“Cell”的各个“View”是等效的。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 分类（Category） [desc]
分类是在设计库（Library）和单元（Cell）之间人为增加的一个虚拟层次，当一个设计库的规模比较大的时候，可以用分类的方式理清设计库中单元的组织。在小规模的设计中分析往往不必要，这时可以在面板显示选项栏取消显示分类（Show Category）选项，分类就会被跳过。
在图 A- 10 的面板中，用鼠标右键点击设计库、单元或者“View”都会有弹出菜单出现。其中包含了很多常用命令，比如打开、删除、移动、复制、属性等。这些操作都有完整的图形界面向导，这里就不再详细介绍。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “ Files"" 菜单 [desc]
- “New”命令：通过选择“File”-“New”-“Library”/“Cell View”/“Category”命令，可以新建设计库/单元View/分类。
- “Save Defaults”命令：通过选择“File”-“Save Defaults”命令，可以将当前设置作为默认值保存在.cdsenv 文件中。
- “Load Defaults”命令：通过选择“File”-“Load Defaults”命令，可以从.cdsenv 文件中读取默认设置。
- “Open Shell Window”命令：通过选择“File”-“Open Shell Window”命令，可以打开 Shell 命令行窗口，在管理设计库的时候经常要用到一些文件操作，这时可以打开 Shell 窗口，在命令行中进行文件操作。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “Edit”菜单 [desc]
- “Copy”命令：通过选择“Edit”-“Copy”，可以对在“Library Manager”窗口中选中的设计库（Library）、单元（Cell）、显示（View）进行拷贝。需要注意的是，设计库（Library）、单元（Cell）、显示（View）之间的包容关系。
#endif# A. 正文
对比图 A- 11 中的“Copy Library”窗口和图 A- 15 中的“Copy Cell”窗口，可以发现，在“Copy Cell”窗口的“Options”栏中多了很多新的选项，下面我们依次介绍这些选项的功能。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 图 A- 15 [desc]
只选择“Library”和“Cell”以及“Copy Cell”窗口。“Copy Hierarchical”表示结构拷贝，即拷贝选中单元中所有直接和间接引用的子单元。继续使用上文中的例子，在设计库“old”的单元“top”中引用了子单元“down”，并将单元“top”拷贝到新的设计库“new 中”。假如，在“Copy Cell”窗口中不选择“Copy Hierarchical”，那么被单元“top”引用的子单元“down”就不会被拷贝到新的设计库“new”中，结果如图 A- 16 所示。假如，在“Copy Cell”窗口中选择“Copy Hierarchical”，因为单元“down”被单元“top”引用，因此在拷贝单元“top”时会将子单元“down”一同拷贝到设计库“new”中，结果如图 A- 17 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 图 A- 16 [desc]
没有选择“Copy Hierarchical”的拷贝结果"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 图 A- 17 [desc]
选择“Copy Hierarchical”的拷贝结果
在“Copy Hierarchical”中包含一个子选项“Skip Libraries”，在这个子选中注明了结构拷贝中的排除设计库，即来自排除设计库的单元在结构拷贝时不会被拷贝的新的设计库中，而是在新的设计库中继续引用排除设计库中的单元。例如在“top”单元中还包含一个来自设计库“analogLib”的子单元“gnd”，如图 A- 18 所示。如图 A- 15 所示，“analogLib”属于默认的排除设计库，因此在结构拷贝单元“top”后，在设计库“new”下的单元“top”仍然使用来自设计库“analogLib”的子单元“gnd”，如图 A- 19 所示。
之所以有排出单元库，是因为“Spectre”软件自己定义了一些设计库如“analogLib”、“basic”等，用来实现电路中的公共地、引脚等功能。这些设计库中的单元除了常见的“schematic”、“symbol”等显示方式外还有用于仿真器的显示方式“spectre”、“spectreS”等等，因此简单的拷贝会造成这些单元中的数据不完整，进而造成电路仿真不能继续。
所以在拷贝时专门提供了排除设计库，将这些软件自己定义的设计库排除在拷贝范围之外，从而保证了单元数据的完整性，保证了仿真能够顺利进行。建议读者在使用结构拷贝时不要修改“Skip Libraries”中的默认排除设计库，并且保证“Skip Libraries”选项处于选中状态。
在“Copy Hierarchical”中还包含一个子选项“Exact Hierarchy”，表示精确结构拷贝，即在结构拷贝时，仅仅拷贝使用到的子单元的显示方式。继续使用上文的例子，在设计库“old”的“top”单元中引用了子单元“down”，并将单元“top”精确结构拷贝到新的设计库“new”中。
注意，在单元“top”中引用的是子单元“down”的“symbol”显示方式，如图 A- 12 所示。因此在使用精确结构拷贝时，子单元“down”只有“symbol”显示方式被拷贝到新的设计库“new”中，如图 A- 20 所示。在“Exact Hierarchy”选项下，还有“Extra Views”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 图 A- 18 [desc]
设计库“old”里单元“top”中的“gnd”子单元"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 5 图 A- 19 [desc]
设计库“new”里单元“top”中的“gnd”子单元
栏，在该栏中填入的是需要而外拷贝的显示类型。例如在“Extra Views”栏填入“veriloga”，那么在精确结构拷贝时，除了拷贝在单元“top”中使用的子单元“down”的“symbol”显示方式，还会将子单元“down”的“veirloga”显示方式作为额外拷贝一同拷贝到设计库“new”中，如图 A- 21 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 图 A- 20 [desc]
精确结构拷贝后的子单元“down”（“Extra Views”栏中无内容）"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 7 图 A- 21 [desc]
精确结构拷贝后的子单元“down”（“Extra Views”栏中为“veirloga”）
“Copy All Views”选项表示拷贝单元的所有显示方式。当使用结构拷贝时，这个选项也作用的所有被拷贝的子单元上，即将子单元的所有显示方式拷贝到新的设计库中。当“Copy All Views”选项没有选中时，可以在“Views To Copy”栏中直接指定需要拷贝的显示方式，只有在该栏中标明的显示类型才会被拷贝到新的设计库中。
同样在使用结构拷贝时，“Views To Copy”栏中的设置也作用的所有被拷贝的子单元上。需要注意的是“Copy All Views”选项和“Exact Hierarchy”选项不能同时作用，因为他们都是用来指定显示方式的拷贝范围。在使用“Exact Hierarchy”选项时，软件会自动关闭“Copy All Views”选项和“Views To Copy”栏。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 “Rename Reference Library”命令 [desc]
通过选择“Edit”�“Rename Reference Library”弹出“Rename Reference Library”窗口如图 A- 23 所示。这个命令可以用于批量修改设计中的单元之间的引用，例如，图中演示的就是将设计库SDIC_bandgap中所有引用自analogLib中的单元改为引用自设计库tsmc35mm。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 9 “Delete by view”命令 [desc]
通过选择“Edit”�“Delete by view”弹出“Delete by View”窗口如图 A- 24 所示。这个菜单命令提供了一个过滤器用于删除设计库中指定的“View”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 10 图 A- 22 [desc]
选择“View”以及“Copy View”窗口"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 11 “Access Permission” [desc]
通过选择“Edit”�“Access Permission”弹出“Access Permission”窗口如图 A- 25 所示，用来修改设计单元或者设计库的所有权和权限."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 “Catagories…”命令 [desc]
通过选择“Edit”�“Catagories…”用来建立、修改、删除分类的命令"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 13 “Library Paths” [desc]
通过选择“Edit”�“Library Paths”弹出图 A- 4 中的“Library Path Editor”，从而修改设计库的路径。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 14 图 A- 23 [desc]
“Rename Reference Library”窗口"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 15 图 A- 24 [desc]
“Delete By View”窗口"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 16 图 A- 25 [desc]
“Access Permission”窗口"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 18 “Filter”命令 [desc]
通过选择“View”�“Filter”来显示视图的过滤。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 19 View�Refresh [desc]
通过选择“View”�“Refresh”来刷新显示."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 20 Virtuoso® Schematic Editor 电路图编辑器简介 [desc]
在电路设计的过程中，模拟电路的设计主要是依靠电路图编辑器(Schematic Editor)完成。电路图编辑器可以通过在 CIW 或者设计库管理器中新建或者打开单元的电路图 (schematic)“View”打开，其基本界面如图 A- 26。下面介绍电路图编辑器的使用方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 21 图 A- 26 [desc]
电路编辑器"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 [desc]
电路编辑器界面主要包括状态栏、菜单、工具栏、工作区、鼠标命令栏、提示栏组成。
状态栏：如图，界面标题之下的第一行是状态栏，内容包括正在运行的命令，命令的帮助信息等。例如图中第一行中“Create Wire”就是当前正在运行的命令，后面的英文就是该命令的简短帮助信息。端口 
通过选择“Edit”�“Access Permission”弹出“Access Permission”窗口如图 A- 25 所示，用来修改设计单元或者设计库的所有权和权限。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 __ “Catagories…”命令 [desc]
通过选择“Edit”�“Catagories…”用来建立、修改、删除分类的命令 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 __ “Library Paths” [desc]
通过选择“Edit”�“Library Paths”弹出图 A- 4 中的“Library Path Editor”，从而修改设计库的路径。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 __ 图 A- 23 [desc]
 “Rename Reference Library”窗口 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 __ 图 A- 24 [desc]
 “Delete By View”窗口 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 22 电路编辑器界面简介 __ 图 A- 25 [desc]
 “Access Permission”窗口 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “View”菜单 __ “Filter”命令 [desc]
通过选择“View”�“Filter”来显示视图的过滤。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “View”菜单 __ View�Refresh [desc]
通过选择“View”�“Refresh”来刷新显示. "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 Virtuoso® Schematic Editor 电路图编辑器简介 [desc]
在电路设计的过程中，模拟电路的设计主要是依靠电路图编辑器(Schematic Editor)完成。电路图编辑器可以通过在 CIW 或者设计库管理器中新建或者打开单元的电路图 (schematic)“View”打开，其基本界面如图 A- 26。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 Virtuoso® Schematic Editor 电路图编辑器简介 __ 1 电路编辑器界面简介 [desc]
电路编辑器界面主要包括状态栏、菜单、工具栏、工作区、鼠标命令栏、提示栏组成。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： [desc]
1) 点击快捷键“i”；或者选择菜单“Add”�“Instance”；或者点击按钮“ ”，弹出“Add Instance”对话框如图 A- 27 所示。在“Library”和“Cell”栏输入需要引用的单元，也可以点击“Browse”按钮，打开一个设计库浏览器，从中选择希望引用的器件或者单元，界面和如图 A- 10 所示的“Libraries Manager”窗口一样。
2) 输入"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 添加端口 [desc]
点击快捷键“p”；或者选择菜单“Add”�“Pin”；或者点击按钮，弹出“Add Pin”对话框如图 A- 30 所示。根据对话框中的提示，可以选择端口的名称、类型、是否总线、用途、放置方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 添加标签(Label) [desc]
1) 点击快捷键“i”；或者选择菜单“Add”�“Label”；或者点击按钮，探出“Add Wire Name”对话框，如图 A- 31 所示。
2) 在“Add Wire Name”对话框中输入标签名字之后，如果将鼠标指向电路图，则会出现随鼠标移动的标签；鼠标点击后标签位置被确定。如果标签被放置在连线上，则该连线会被用标签的名字命名。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 移动、拷贝器件 [desc]
1) 这里有 3 种类似的命令：拷贝(Copy)：将选定部分复制；拖动(Stretch)：移动选定部分，该部分与电路其他部分保持连接；移动(Move)：移动选定部分，该部分与其余部分不保持连接。
2) 点击快捷键 “c”/“m”/“M” 分别表示拷贝/拖动/移动；或者选择菜单“Edit”�“Copy”/“ Stretch”/“Move”分别是拷贝/拖动/移动；或者点击按钮分别是拷贝/拖动。 
3) 首先选定需要操作的电路部分，包括器件、连线、标签、端口等；然后调用命令；这时点击鼠标左键确定基准点；这时移动鼠标发现选定部分随鼠标指针移动，移动量相当于基准点到现在指针所在点之间的距离；再次点击鼠标左键放下选定的电路或者按 ESC 键取消本次操作。
4) 在确定基准点之后，拖动的过程中，可以点击 F3 键选择详细属性，其界面如图A- 32 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 删除器件 [desc]
1) 选择电路的一部分。
2) 点击键盘“del”键；或者选择菜单“Edit”�“Delete”，将选中的部分删除。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 修改器件属性 [desc]
1) 选择电路中需要修改属性的器件.
2) 点击键盘“q”键；或者选择菜单“Edit”�“Properties�Objects…”；或者点击按钮，弹出“Edit Object Properties”窗口，如图 A- 33 所示."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 下降层次和回退 [desc]
可以通过这几个命令在相互引用的母、子模块之间切换 
1) 这里有 3 个命令：下降编辑： 用编辑模式进入一个子模块（如果没有足够的权限会自动为只读模式）；下降只读：用只读模式进入一个子模块；回退：如果下降到了子模块中，可以用这个命令回到上一层. 
2) 操作快捷键： “E”/“e”/“Ctrl+e”分别是下降编辑、下降只读、回退菜单：“Design”�“Hierarchy”�“Descend Edit ”/“Descend Read” /“Return”分别是编辑/只读/回退."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 [desc]
如果找不到这个“Libaray”，则应该按前面 A.1.5 节最后介绍的方法加入这个库。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 1 gnd [desc]
在电路中表示 0 电位，和它相连的线线名为 gnd，没有设置参数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 2 vdd [desc]
和它相连的线线名为 vdd。这个器件只用来标示等电位，而不是电源。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 3 vdc/idc [desc]
直流电压/电流源，用于为电路提供直流电压/电流。同时还可以提供交流电流，在交流（AC）分析中使用。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 4 vpulse [desc]
时变电流源， 在 DC 分析中可以输出固定的 DC 电压，AC 分析中可以输出固定的 AC 电压，在瞬态分析中可以生成不同占空比的方波、三角波、梯形波、锯齿波。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 5 nmos4 / pmos4 / pnp [desc]
通用 4 端口 NMOS 管 / PMOS 管 / PNP 三极管 注意：在模型名称(Model Name)一栏需要根据不同的工艺库(Model Library)中的定义来指定。例如：在某个模型中将 NMOS 模型定名为 nvn，PMOS 管模型定名为 nvp，PNP 三极管则为 pnp5，则在 nmos4 器件实例的 Model Name 栏应当填上 nvn、pmos4 填 nvp、pnp 填 pnp5，否则电路将不能正确进行仿真。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 5 __ 6 res / cap / ind [desc]
这三个器件分别是电阻、电容、电感。如果进行简单仿真，这些器件参数设置中不需要指定模型名称，这是这些器件将表现为理想器件。如果需要根据工艺详细仿真，则可以在器件参数设置中，根据工艺模型库中的电阻、电容、电感的模型定义这些器件。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 1 [desc]
使用 ADE 进行仿真的基本流程
选择仿真的电路 如果是从 CIW 窗口中打开的仿真环境，则需要设置仿真的电路。这时可以：在菜单中选择：“Setup”�“Design” 图形界面中点击按钮“ ” 选择之后弹出如图 A- 35 所示窗口，在其中可以设置需要仿真的电路图在设计库中的路径。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 1 [desc]
仿真参数设置 打开“Analog Design Environment”�“Analyses”�“tran”，基本参数设置界面如图 A- 44所示。主要内容包括用于控制仿真时间的“Stop Time”和用于控制仿真速度和精度的 “Accuracy Defaults（errpreset）”设定。
“Stop Time”仿真终止时间的设定。 在默认设置中瞬态分析总是从 t = 0 时刻开始仿真。所以只需设置仿真终止时间，时间单位是秒。所以，如果要表示毫秒数量级，在数据后面需要跟上毫秒的单位缩写“m”。其他时间数量级单位类似。# 置输出 
输出控制的是仿真结束后需要用图线或者数值体现出来的结果。主要有 2 种方法进行设置： 
- 在菜单中选择“Output”�“To be ploted”�“Select on the Schematic”，电路图窗口就会出现。在电路图中选择连线会在输出中添加该线的电压；选择一个器件的端口则会添加这个端口的电流作为输出；直接选择一个器件则会把该器件的所有端口电流都加入输出。
- 也可以手动添加输出，在菜单中选择“Output”�“Edit”或按钮“”可以打开如图A- 40所示的窗口。在该窗口中可以添加需要的输出的表达式。如果表达式比较复杂，还可以点击“Calculator”栏的“open”按钮，打开“Calculator”(附录中有详细介绍使用方法)，在其中编辑好表达式后，在上图窗口中点击“Calculator”栏的“Get Expression”按钮，表达式就会被截取到“Expression”栏。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 瞬态分析（Transient Analysis） [desc]
瞬态仿真分析是在给定的输入激励下，在设定的时间范围内计算电路的时域瞬态响应性能。要验证设计电路的稳定性、速度、精确度等问题必须经过各种情况下的瞬态分析才能做出正确的判断。在本节中介绍如何设定瞬态仿真以及瞬态分析。读者在具体的电路设计中需要根据实际情况，合理地设置激励源和仿真参数才能真正评估电路性能。在瞬态仿真的参数设置过程中，主要是在仿真精度和仿真速度之间做出合理的折衷。读者可以按设计电路的要求指定仿真器计算时的容差、积分方式、步进大小等控制精度。同时，还可以对电路初始状态，输出数据保存量等条件参数设置。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 瞬态分析（Transient Analysis） __ 仿真参数设置 [desc]
打开“Analog Design Environment”�“Analyses”�“tran”，基本参数设置界面如图 A- 44所示。主要内容包括用于控制仿真时间的“Stop Time”和用于控制仿真速度和精度的“Accuracy Defaults（errpreset）”设定。 
- “Stop Time”仿真终止时间的设定。 在默认设置中瞬态分析总是从 t = 0 时刻开始仿真。所以只需设置仿真终止时间。时间单位是秒。所以，如果要表示毫秒数量级，在数据后面需要跟上毫秒的单位缩写“m”。其他时间数量级单位类似。 
- “Accuracy Defaults”（errpreset）：仿真精确度和速度设定。 可选择三种仿真精确度：宽松的（liberal），适中的（moderate），保守的（conservative）。其中，“liberal”的仿真速度最快，但是精确度最低。这种精度的仿真适合于数字电路或者是变化速度较低的模拟电路；“moderate”作为仿真器默认的设置，其精确度类似于用 SPICE2 计算的仿真结果；“conservative”的具有最高的精确度但速度最慢，适合于敏感的模拟电路仿真。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 直流分析（DC Analysis） [desc]
直流分析是其他所有仿真的基础。在瞬态分析（Tran Analysis）、交流分析（AC Analysis）等分析的过程中，首先就是先要计算直流工作点。在这里介绍的直流分析（DC Analysis）中，实际包括两个方面的分析：
- 一个是直流工作点计算；
- 另一个是直流特性扫描。
对于直流工作点分析，仿真器将计算各个节点的电压，各支路电流，包括 MOS 管的各个直流参数，例如跨导（gm），阈值电压（VTH），工作区域（region）等。而在直流特性扫描中包含了电路的温度（Temperature），设计变量（Design Variable），器件参数（Component Parameter），器件模型参数（Model Parameter）等多个参数的特性仿真。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加器件： __ 信号“vpwl”的参数设定 [desc]
---table begin---
Table title: 信号“vpwl”的参数设定
| 参数 | 含义 | 实例 | 单位 |
|------|------|------|------|
| Number of pairs of points | 转折点数目 | 4 | - |
| Time 1 | 第 1 个转折点时间 | 0 | s |
| Voltage 1 | 第 1 个转折点电压 | 2 | V |
| Time 2 | 第 2 个转折点时间 | 250μ | s |
| Voltage 2 | 第 2 个转折点电压 | 2 | V |
| Time 3 | 第 3 个转折点时间 | 500μ | s |
| Voltage 3 | 第 3 个转折点电压 | 5 | V |
| Time 4 | 第 4 个转折点时间 | 1m | s |
| Voltage 4 | 第 4 个转折点电压 | 5 | V |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 正弦信号“vsin” [desc]
正弦信号也是一种在瞬态仿真中常用的信号。在该信号的参数中，“Damping factor”的单位是“1/s”。正弦信号也是在交流小信号分析（AC Analysis）中重要的激励源。用户需要区别的是瞬态信号激励和交流信号激励不同的含义。表 A-3 和图 A-48 分别是正弦信号。
---table begin---
Table title: 正弦信号“vsin”的设定参数
| 参数 | 含义 | 实例 | 单位 |
|------|------|------|------|
| Amplitude | 振幅 | 3 | V |
| Frequency | 振荡频率 | 10 | Hz |
| Delay time | 延迟时间 | 0 | s |
| Damping factor | 阻尼因子 | 1 | 1/s |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” [desc]
“vsource”激励源是一种通用型电压源，可以用于完成上述所有激励源的功能。在图 A-49 中“source type”菜单中选择所需要的激励源即可，同时按前述的方式填写各激励源的关键参数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” __ 瞬态仿真实例 [desc]
采用最简单的 RC 充放电电路来完成一次瞬态仿真，该电路图如图 A-50 所示。电阻和电容都采用“analogLib”中的理想电阻模型和理想电容模型。激励源是“vpluse”周期性方波。采用“conservative”的精度。由于没有设置初始条件，仿真器会先执行直流分析，将其结果作为初始解。仿真的结果如图 A-51 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” __ 瞬态仿真实例 __ 仿真参数设置 [desc]
如果需要将直流工作点信息保存下来，在“DC Analysis”中确定“Save DC Operating Point”。如果要绘制特性曲线，需要设置扫描变量和扫描范围。参数设置选项如图 A-52 所示。
- “Temperature”：温度扫描，观察电路直流工作点随温度漂移情况。
- “Design Variable”：设计变量扫描，在设计电路时，设计师往往需要将某些设计参数设置为变量，方便设计和修改。比如，可以将电源电压（VDD），MOS 的栅长（L）和栅宽（W）设置为变量，使用变量扫描，观察电路在各种设计下的工作情况。
- “Component parameter”：器件参数扫描，和“Design Variable”扫描比较类似。不过，器件参数扫描不用预先将电路中某器件参数设置为变量（Variable）。
- “Model Parameter”：如果用户能够对库文件模型进行修定，可以使用该参数扫描。但是，由于库文件都是直接由生产工厂直接提供，所以，不推荐使用这项扫描。
在选定扫描参数后，用户需要进一步设置扫描范围（Sweep Range），扫描方式（Sweep Type）等。以点击扫描“Temperature”为例，如图 A-53 所示，可以看到可选参数包括扫描范围（Sweep Range）和扫描方式（Sweep Type），以及是否加入特殊点计算（Add Specific Points）。
- “Sweep Range”：指定扫描范围，可以包括指定起始值（Start-Stop）或指定中点值
（Center-Span）两种方式。
- “Sweep Type”：指定扫描方式。步进可以是线性的（Linear），也可以以对数方式
（Logarithmic）步进。如果采用“Linear”模式，用户需要通过步进大小（Step Size）
或是步进点数（Number of Steps）来控制仿真精度和仿真时间。而如果采用
“Logarithmic”模式，仿真器默认的是以 10 为底的对数。用户也需要通过每个数量
级所需步进数（Points Per Decade）或总步进数（Number of Steps）来控制仿真精
度和时间。当用户对输出模式没有特殊要求时，可以采用系统默认设置
（Automatic）。系统默认的设置是在当终值与初值比小于 10 时，采用线性模式输
出。而在该比例大于 10 时，采用对数模式输出。三种模式的设置窗口见图 A-54。
- “Add Specific Points”：加入特殊点计算。在仿真过程中，用户可以指定某些点一定需要计算，在该选项中添加即可。各点之间用空格隔开。如果用户选择“Design Variable”或“Component Parameter”扫描，还需要设置扫描的变量名（Variable Name）或器件名（Component Name）和该器件的参数名（Parameter Name），图 A-55 是设定界面。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” __ 瞬态仿真实例 __ 设计实例 [desc]
以一个简单共源级放大器为例说明“DC Analysis”的仿真过程，电路如图 A-56 所示。直流仿真的激励源使用普通的“analogLib” “vdc”即可。
1. 设计变量扫描“Design Variable”
在图 A-56 中，将对 M0 的偏置电压由 3V 改变设置为变量“VBIAS”。点击“Design Variable” “Select Design Variable”后会弹出变量选择窗口图 A-57。由于电路中只设置了一 个变量，所以点击该变量后选择“OK”后，该变量名会出现在“Variable Name”中，再设置好 “Sweep Range”和“Sweep Type”后即可仿真。图 A-58 的仿真曲线表示当变量“VBIAS”从 0V 到 5V 变化时输出电压的变化情况。
2. 器件参数扫描“Component”
器件参数扫描和设计变量扫描相类似。点击 “Component Parameter” “Select Component”后弹出原理图窗口。用户可以选择 MOS 管、激励源、地线等各种器件作为仿真对象。如果点击图 A-56 中的 NMOS 管 M0，会弹出该器件的参数表，如图 A-59# A.7.2 设计实例  
以一个简单共源级放大器为例说明“DC Analysis”的仿真过程，电路如图 A- 56 所示。
直流仿真的激励源使用普通的“analogLib” “vdc”即可。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” __ 瞬态仿真实例 __ 1设计变量扫描“Design Variable” [desc]
在图 A- 56 中，将对 M0 的偏置电压由 3V 改变设置为变量“VBIAS”。点击“Design 
Variable” “Select Design Variable”后会弹出变量选择窗口图 A- 57。由于电路中只设置了一个变量，所以点击该变量后选择“OK”后，该变量名会出现在“Variable Name”中，再设置好“Sweep Range”和“Sweep Type”后即可仿真。图 A- 58 的仿真曲线表示当变量“VBIAS”从 0V到 5V 变化时输出电压的变化情况。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 激励源信号“vsource” __ 瞬态仿真实例 __ 2器件参数扫描“Component” [desc]
器件参数扫描和设计变量扫描相类似。点击 “Component Parameter” “Select 
Component”后弹出原理图窗口。用户可以选择 MOS 管、激励源、地线等各种器件作为仿真对象。如果点击图 A- 56 中的 NMOS 管 M0，会弹出该器件的参数表，如图 A- 59 所示。
图中的引号部分是对相应参数的解释。可以对该 MOS 的栅长变化作参数扫描。图 A- 60仿真表示 M0管的栅长从 1μm 到 20μm 变化时，输出电压变化情况。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） [desc]
交流小信号分析（AC Analysis）是用来计算电路的小信号频率响应特性。在分析时，仿真器首先计算电路的直流工作点，然后将电路在工作点附近线性化，并以此计算电路的频率响应。仿真时需要设置专门的交流信号源。类似于直流分析（DC analysis），在交流小信号分析中，设计者同样有“Frequency”、“Design Variable”、“Temperature”、“Component Parameter”，“Model Parameter”等参数扫描选项。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 1 仿真参数设置 [desc]
点击“Analog Design Environment” “AC Analysis”，弹出如图 A- 62 所示的交流小信号仿真参数设置窗口。扫描参变量的设定如所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 2 设计实例输出结果观察 [desc]
以图 A- 64 所示简单放大器作为实例进行交流小信号分析。在放大器设置中，最关心的是它的增益和相位随频率变化的情况。在实际设计中，往往用波特图来表示该放大器的频率特性。
在做“AC Analysis”时，必须先给电路设置一个交流信号源。常以“AnalogLib” “vsin”信号为激励源。在图 A- 64 中，由于交流信号是直接从“M0”管的栅极加入，那么在具有交流信号的同时，必须要给该 MOS 管设置一个直流偏置电压。在信号源中需要设置交流振幅和直流偏置。如图 A- 65，在“vsin”信号的设置中包括交流信号幅值（AC magnitude），交流信号相位（AC phase），直流偏置电压（DC voltage）等多个选项。“AC magnitude”通常都设置为 1V，“-1”表示 180°相位翻转。当然，设计者也可以通过设置“AC phase”来表示相位，“AC phase”缺省设置为 0。“DC voltage”根据实际电路设置偏置即可。该电路中以 1μF电容和 1MΩ电阻为负载。
仿真结果可以使用“Tool” “Results Browser”观察，如图 A- 66 所示。在图 A- 66 中的下拉菜单中，表示多种方式输出： 
“Mag”：幅度绝对值曲线。 
“Phase”&“WPhase”：相位曲线，两者不同之处在于“Phase”是从 360°开始作图，而“WPhase”是从 0°开始作图，如图 A- 67 所示。 “Real”，“Imag”：由于频域在数学上往往可以用 exp 的指数形式表示，所以可以用实虚数来表示。 
“dB10”，“dB20”：在波特图中幅频特性通常换算成分贝表示。“dB10”，“dB20”表示对幅度 A 以 10logA 和 20logA 计算结果。如果是电压幅值采用“dB10”，如果是功率增益则需采用“dB20”。一般# 仿真参数设置
在做“AC Analysis”时，必须先给电路设置一个交流信号源。常以“AnalogLib” “vsin”信号为激励源。在图 A- 64 中，由于交流信号是直接从“M0”管的栅极加入，那么在具有交流信号的同时，必须要给该 MOS 管设定一个直流偏置电压。在信号源中需要设定交流振幅和直流偏置。如图 A- 65，在“vsin”信号的设定中包括交流信号幅值（AC magnitude），交流信号相位（AC phase），直流偏置电压（DC voltage）等多个选项。“AC magnitude”通常都设定为 1V，“-1”表示 180°相位翻转。当然，设计者也可以通过设定“AC phase”来表示相位，“AC phase”缺省设定为 0。“DC voltage”根据实际电路设定偏置即可。该电路中以 1μF电容和 1MΩ电阻为负载。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 仿真结果分析 [desc]
如果“M0”的直流偏置电压设定为 1.5V，交流幅值设定为 1V，该 MOS 管阈值电压 1V。那么“M0”会不会进入到截止区呢（1.5V-1V<1V）？实际上仿真结果显示“M0”管不可能进入截止区。在本章最开头陈述过，“AC Analysis”的前提是先进行了“DC Analysis”。所以，电路状态固定，加入交流信号后不会影响直流工作点。在计算电路交流增益时，仿真器是将输出端的交流信号幅值除以输入交流信号幅值。所以，“AC magnitude”设定为 1V 是为了方便计算和观察结果，不影响电路工作。那么，如果在实际电路设计输入信号较大，会影响到电路直流工作点该如何仿真呢？这需要设计者在瞬态时域的仿真中进行仔细设计多种最
差情况，并做出合理的分析。
仿真结果可以使用“Tool” “Results Browser”观察，如图 A- 66 所示。在图 A- 66 中的下拉菜单中，表示多种方式输出： 
“Mag”：幅度绝对值曲线。 
“Phase”&“WPhase”：相位曲线，两者不同之处在于“Phase”是从 360°开始作图，而“WPhase”是从 0°开始作图 
“Real”，“Imag”：由于频域在数学上往往可以用 exp 的指数形式表示，所以可以用实虚数来表示。 
“dB10”，“dB20”：在波特图中幅频特性通常换算成分贝表示。“dB10”，“dB20”表示对幅度 A 以 10logA 和 20logA 计算结果。如果是电压幅值采用“dB10”，如果是功率增益则需
采用“dB20”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 表 B- 1 “Results Browser”中的所有菜单和它们的功能 [desc]
---table begin---
Table Title: B- 1 
| 菜单选项      |具体操作 |
|--------------|------------|
| File   |打开仿真的输出结果|
| Open Results | |
| Open Graph |以图表的形式打开保存图形|
| Open Graph as Plot… | |
| Open Graph as Template… |以模板的形式打开保存图形 |
| Open Table |打开保存的表格 |
| Clear |将选中的仿真结果，从“Results Browser”中清除。当只有一个仿真结果时，无需选择，即可将其清除。 |
| Reload |重新读取仿真结果 |
| Save Session |保存当前“Results Browser”的设置 |
| Close |关闭“Results Browser”窗口 |
| Setting |选择输出数据，在运行了“Corner Analysis”或者“Parametric Analysis”后，该选项被激活。可以通过它选择特定功能角或者设计变量值下的仿真结果|
| Plot Style | |
| Append |在原来窗口的基础上显示新的波形。 |
| Replace |清楚原来的窗口中的数据，显示新的波形。 |
| New SubWin |在原来的窗口中，建立子窗口，用来显示新的波形。 |
| New Win |创建一个新的窗口显示新的波形。 |
| Graph Type | |
| Default |默认方式 |
| Rectangular |直角坐标系 |
| Polar |极坐标 |
| Impedance |阻抗圆图 |
| Admittance |导纳圆图 |
| RealVsImag |实部 VS 虚部 |
| Tools | |
| Calculator |打开“Calculator” |
| Table |打开表格 |
| Help |获取帮助文档 |
---table end---# B.1.2.
## “Results Browser”窗口中的快捷键
“Results Browser”窗口中的快捷键的功能如下：
- 各个快捷键的功能如下：
    1. 打开仿真的输出结果，等同于“File”，“Open Results”
    2. 按照“Plot Style”中选择的方式，以图形的方式显示选中的仿真结果
    3. 打开“Calculator”，如果在“Results Browser”中选择仿真结果。那么该结果的表达式将直接送到“Calculator”的缓存中。
    4. 选择两个仿真结果，将它们的差值以图像的形式输出。
    5. 注意：该快捷键在一个仿真结果表达式存在多个值的情况下失效，例如运行了“Corner Analysis”或者“Parametric Analysis”后。
    6. 选择两个仿真结果，以“YvsY”的方式输出仿真结果
    7. 注意：该快捷键在一个仿真结果表达式存在多个值的情况下失效，例如运行了“Corner Analysis”或者“Parametric Analysis”后。
    8. 选择输出数据，在运行了“Corner Analysis”或者“Parametric Analysis”后，该选项被激活。可以通过它选择特定功能角或者设计变量值下的仿真结果，等同于“Setting”，“Select Data”。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 表 B- 1 “Results Browser”中的所有菜单和它们的功能 __  [desc]
## 仿真结果保存路径
如上所示，“Location”栏中显示了当前仿真结果的保存路径。
以前打开的仿真结果的路径将保存在该下拉菜单中，可以通过点击下拉菜单中对应路径，把该仿真结果引入到“Results Browser”中。
例如在上图中，在下拉菜单中选择了“~/simulation/BIAS_P/spectre/schematic/psf”，发现该仿真结果出现在“Result Browser”中，如图中左栏内的高亮部分所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 表 B- 1 “Results Browser”中的所有菜单和它们的功能 __  [desc]
## “Results Browser”窗口的主体部分
“Results Browser”窗口的主体分为左右两栏，左边一栏是资源管理器，以树形结构分级保存仿真结果。右边一栏显示当前选中文件夹中的内容。假如该文件夹还包含子文件夹，则在其之前出现“+”标记。
仿真结果通常包含以下内容，如上图中左栏所示。
---table begin---
Table Title:仿真数据结果名称及其内容
|名称|内容|
|-|-|
|tran-tran|瞬态仿真中所有节点电压值和选择保存端口的电流值|
|finalTimeOP-info|仿真结束时器件参数的工作点|
|ac-ac|交流仿真中所有节点电压值和选择保存端口的电流值|
|dcOp-dc|工作点的直流仿真，所有节点的电压值和选择保存的端口电流值|
|dcOpInfo-info|工作点的直流仿真，所有器件的参数。在该文件夹下有以器件名命名的子文件夹，分别保存各个器件的直流工作点参数|
|dc-dc|直流扫描仿真时，所有节点电压值和选择保存端口电流值|
|modelParameter-info|仿真采用模型的参数|
|element-info|设计电路图中所有元素的器件参数|
|outputParameter-info|输出参数信息。该文件夹下包含以器件名命名的子文件夹，分别包含该器件经仿真器处理后的参数，例如:有效长度（leff），有效宽度（weff），有效电阻值（reff），有效电容值（ceff）等等|
|designParamVals-info|设计参数值|
|variables|设计变量。该文件夹下包含以设计变量名命名的子文件夹，分别保存各个设计变量的信息|
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 1 直接输出仿真结果到“Waveform”窗口。 [desc]
不对仿真结果进行任何预处理，可以通过以下方法将结果直接输出到“Waveform”窗口中显示。
1. 在选中需要的仿真结果后，点击快捷按键，即按照“Plot Style”中选择的方式，以图形的方式显示选中的仿真结果。
2. 在选中需要的仿真结果后，点击鼠标右键，弹出一个选项菜单。下拉菜单中各个选项的功能为：
---table begin---
Table tile:仿真结果选项菜单
| 选项      | 功能       |
|--------------|------------|
| “Append”   | 以“Plot Style”为“Append”的方式，显示选中的仿真结果   |
| “Replace”   | 以“Plot Style”为“Replace”的方式，显示选中的仿真结果  |
| “New SubWin” | 以“Plot Style”为“New SubWin”的方式，显示选中的仿真结果 |
| “New Win”  | 以“Plot Style”为“New Win”的方式，显示选中的仿真结果  |
|“Table” | 以列表的方式显示选中的仿真结果 |
| “Calculator”  | 将仿真结果直接送到“Calculator”的缓存中 |
---table end---
注意：对于“Calculator”选项，送到“Calculator”中的数据未经处理。例如，在选取幅角的功能项时，需要在“Calculator”中对数据使用“phase”函数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 4 将两个仿真结果采用 YvsY 的方式输出 [desc]
在选择第一个仿真结果后，点击快捷按键，此时“Results Browser”将会提示选择第二个仿真结果，然后以其作为横轴，输出两个仿真结果。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ info [desc]
中都保存了电路器件参数。下面将就 MOS 管的一些常用参数名称进行解释。 
1. type：MOS 管类型，可能值为 n 或 p。 
2. region：MOS 管的工作区域，可能值为 0~4，分别对应：
---table begin---
Table tile:MOS 管工作区域的数字表示
| Region      | 工作区       |
|--------------|------------|
| 0   | 关断   |
| 1   | 线性区  |
| 2 | 饱和区 |
| 3  | 亚阈值区 |
| 4 | 击穿 |
---table end---
3. reversed：MOS 管是否反向，可能值为 yes 或 no。 
4. ids (A)： 阻性漏源电流 
5. lx4 (A)： ids 的别名，当 MOS 管反向时有相反的符号。 
6. lx50 (A)：衬源电流。 
7. vgs / lx2 (V)：栅源电压。 
8. vds / lx3 (V)：漏源电压。 
9. vbs / lx1 (V)：衬源电压。 
10. vth (V)：有效阈值电压。 
11. lv9 (V)：vth 的别名。 
12. vdsat (V)：漏源饱和电压。 
13. lv26 (V)：平带电压（Flat-band voltage）。 
14. lv10 (V)：vdsat 的别名。 
15. gm / lx7 (S)：共源跨导。 
16. gds / lx8 (S)：共源输出跨导。 
17. gmbs / lx9 (S)：衬底跨导。 
18. betaeff (A/V2)：有效 β 值。 
19. cjd / lx29 (F)：漏区衬底结电容。 
20. cjs / lx28 (F)：源区衬底结电容。 
21. lx12 (Coul)：衬底电荷（Qb） 
22. lx14 (Coul)：栅极电荷（Qg） 
23. lx16 (Coul)：漏区电荷（Qd） 
24. lx24 (Coul)：漏区 PN 结电荷。 
25. lx26 (Coul)：源区 PN 结电荷。 
26. cgg / lx18 (F)：dQg_dVg 
27. cgd / lx19 (F)：dQg_dVd 
28. cgs / lx20 (F)：dQg_dVs 
29. cgb (F)：dQg_dVb 
30. cdg / lx32 (F)：dQd_dVg 
31. cdd / lx33 (F)：dQd_dVd 
32. cds / lx34 (F)：dQd_dVs 
33. cdb (F)：dQd_dVb 
34. csg (F)：dQs_dVg 
35. csd (F)：dQs_dVd 
36. css (F)：dQs_dVs 
37. csb (F)：dQs_dVb 
38. cbg / lx21 (F)：dQb_dVg 
39. cbd / lx22 (F)：dQb_dVd 
40. cbs / lx23 (F)：dQb_dVs 
41. cbb (F)：dQb_dVb 
42. ron()：导通电阻。 
43. id / i1 (A)：漏端电流。 
44. is / i3 (A)：源端电流。 
45. ibulk / i4 (A)：衬底电流。 
46. lx5 (A)：源端 PN 结电流。 
47. lx6 (A)：漏端 PN 结电流。 
48. pwr (W)：处于工作点时的功耗。 
49. gmoverid (1/V)：Gm/Ids 
50. lv36 (F)：栅源交叠电容。 
51. lv37 (F)：栅漏交叠电容。 
52. lv38 (F)：栅衬底交叠电容。 
53. lx10 (S)：漏区二极管跨导。 
54. lx11 (S)：源区二极管跨导."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 交流小信号分析（AC Analysis） __ 附录 C  Waveform [desc]
所有仿真结果的波形都将在“Waveform”窗口中显示。在“Waveform”窗口中可以完成图形的缩放、坐标轴的调整、数据的读取和比表、YvsY 比较，还可以对仿真结果做简单的处理，例如取 20dB 值，取幅值，取幅角等等。因此熟练掌握“Waveform”窗口的使用，可以大幅提高对仿真结果的分析能力。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 1 [desc]
 “Waveform”窗口界面。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 2 [desc]
 “Waveform”窗口的菜单 
图 C- 2 列出了“Waveform”中的所有菜单（除“Bus”字菜单），它们的功能见表
C- 1 
---table begin---
Table tile:“Waveform”中的所有菜单和它们的功能
|菜单选项|具体操作|
|'File'|'Open':打开“Open Grap”对话框，从而打开一个已保存的波形文件。|
|'Save':打开“Save Graph”对话框，从而将当前波形以 XML 形式保存。|
|'Save as Image':打开“Save Image”对话框，从而将当前波形以图片形式保存。|
|'Reload':重新读取当前窗口中波形的仿真数据。|
|'Print':打印当前窗口中的图表。|
|'Save Session':保存当前“Waveform”窗口的设置。|
|'Close':关闭当前“Waveform”窗口。|
|'Exit':关闭所有“Waveform”窗口。|
|'Edit'|'Move':移动选中的标签或记号.|
|'Swap':移动两个波形、相关坐标轴或者图表。|
|'Delete':删除选中的标签、记号、图例、波形或者图表。|
|'Hide':隐藏选中的标签、记号、图例、波形或者图表。|
|'Reveal':显示隐藏的标签、记号、图例、波形或者图表。|
|'Undo':撤销上一步操作。|
|'Graph'|'Grids On':选中表示显示网格。|
|'Layout':子窗口布局。|
|'Auto':自动选择合适的模式，根据子窗口的高和宽的比值设置布局方式。|
|当子窗口的宽度大于高度，采用竖排布局的方式。当子窗口的宽度小于高度，则采用横排布局的方式。|
|'Vertical':竖排显示子窗口。|
|'Horizontal':横排显示子窗口。|
|'Card':层叠显示子窗口。|
|'Display Type':图标类型。|
|'Rectangular':直角坐标系。|
|'Histogram':柱形图。|
|'RealVsImag':实部 VS 虚部。|
|'Polar':极坐标。|
|'Impedance':阻抗圆图。|
|'Admittance':导纳圆图。|
|'Font':字体大小选择，影响标题、子标题和坐标轴。|
|'Small':小字体。|
|'Medium':中等字体。|
|'Large':大字体。|
|'Lable':标签选项。|
|'Create':打开“Lable Attributes”对话框，从而创建标签。|
|'Edit':修改选中标签。|
|'Freeze On':选中后，“Waveform”窗口中的波形不再因为相应仿真结果改变而改变。|
|'Show Tool Bar':选中将显示工具栏。|
|'Snap Off':选中后，波形上的数据读取框追随系统鼠标。|
|'Snap-to-Data':选中后，标记仅仅作用在仿真数据点上。|
|'Snap-to-Peaks':选中后，标记仅仅作用在波形峰值上。|
|'Color Schemes':设置背景色。|
|'Defualt':使用默认背景色，通常为白色。|
|'Gray':背景色设为灰色。|
|'Black':背景色设为黑色。|
|'Template':模板设置。|
|'Set Default':使用“.cdsenv”中设置的默认模板。|
|'Set Current':将当前窗口设置保存为默认值。|
|'Load':打开一个特定的波形文件作为模板。|
|'Edit':打开“Graph Attributes”对话框。|
|'Axis'|'Major Grids On':选中后将显示选中坐标轴的主网格。|
|'Minor Grids On':选中后将显示选中坐标轴的次网格。|
|'Log':选中后将选中的坐标轴切换到对数模式。|
|'Strip':将每条波形单独分栏显示。|
|'Edit':打开“Axis Atrributes”对话框。|
|'Trace'|'Symbols On':选中将在在选中波形上的仿真点上显示符号.|
|'Assign to Axis':将选中波形赋予一个新的 Y 轴，或者使用其他波形的 Y 轴。|
---table end---# Layout
子窗口布局。
## Auto
自动选择合适的模式，根据子窗口的高和宽的比值设置布局方式。当子窗口的宽度大于高度，采用竖排布局的方式。当子窗口的宽度小于高度，则采用横排布局的方式。
## Vertical
竖排显示子窗口。
## Horizontal
横排显示子窗口。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Card [desc]
层叠显示子窗口.  "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Display Type [desc]
XY Delta
标记显示 Δx 和 Δy 值."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Admittance [desc]
导纳圆图."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Font [desc]
字体大小选择，影响标题、子标题和坐标轴.
## Small
小字体.
## Medium
中等字体.
## Large
大字体."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Lable [desc]
标签选项.
## Create
打开“Lable Attributes”对话框，从而创建标签.
## Edit
修改选中标签."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Freeze On [desc]
选中后，“Waveform”窗口中的波形不再因为相应仿真结果改变而改变."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Show Tool Bar [desc]
选中将显示工具栏."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Snap Off [desc]
选中后，波形上的数据读取框追随系统鼠标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Snap-to-Data [desc]
选中后，标记仅仅作用在仿真数据点上."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Snap-to-Peaks [desc]
选中后，标记仅仅作用在波形峰值上."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Color Schemes [desc]
设置背景色.
## Default
使用默认背景色，通常为白色.
## Gray
背景色设为灰色."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Black [desc]
背景色设为黑色."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Template [desc]
模板设置."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Set Default [desc]
使用“.cdsenv”中设置的默认模板."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 523 [desc]
Set Current
将当前窗口设置保存为默认值."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Load [desc]
打开“Load”对话框，从而添加一条新的波形."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Edit [desc]
打开“Graph Attributes”对话框."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Axis [desc]
Major Grids On
选中后将显示选中坐标轴的主网格。该选项只在坐标轴选中后才被激活.
Minor Grids On
选中后将显示选中坐标轴的次网格。该选项只在坐标轴选中后才被激活.
Log
选中后将选中的坐标轴切换到对数模式。该选项只在坐标轴选中后才被激活.
Strip
将每条波形单独分栏显示."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Edit [desc]
打开“Marker Attributes”对话框，从而编辑选中的标记."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Trace [desc]
Symbols On
选中将在在选中波形上的仿真点上显示符号.
Assign to Axis
将选中波形赋予一个新的 Y 轴，或者使用其他波形的 Y 轴。该选项只有在“Waveform”窗口中存在多个波形时才有效."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ New Graph [desc]
Copy New Window
将选中波形拷贝到一个新建的“Waveform”窗口中.
Move New Window
将选中波形移动到一个新建的“Waveform”窗口中.
Copy New SubWindow
将选中波形拷贝到一个新建的“Waveform”子窗口中."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Move New SubWindow [desc]
将选中波形移动到一个新建的“Waveform”子窗口中."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Bus [desc]
Create
根据选中的数字波形，创造一条总线."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Expand [desc]
将总线中的数据分开显示."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Trace Cursor [desc]
开启或关闭波形光标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Vert Cursor [desc]
开启或关闭垂直光标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Horiz Cursor [desc]
开启或关闭水平光标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Delta Cursor [desc]
开启或关闭差值光标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Cut [desc]
将选中的波形剪切."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Copy [desc]
将选中的波形复制."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Paste [desc]
粘贴剪切或复制的波形."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Save [desc]
打开“Save”对话框，从而以 ASCII 格式保存波形."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 524 [desc]
Edit
打开“Trace Attributes”对话框。该选项只有在波形被选中时才有效."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Select All [desc]
选中当前“Waveform”窗口中的所有标记."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Mark [desc]
Place
Trace Marker
在波形上添加一个标记，包含该点的横竖坐标."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Vert Marker [desc]
在波形上添加一个标记，包含该点的横竖坐标，并做一条通过该点的垂直线."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Horiz Marker [desc]
在波形上添加一个标记，包含该点的横竖坐标，并做一条通过该点的水平线."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Add Delta [desc]
添加一个标记显示两个点间的横竖坐标差."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ X Delta [desc]
标记显示 Δx 值."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Y Delta [desc]
标记显示 Δy 值."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Attach to Trace [desc]
标记附着在波形上"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Find Max [desc]
将标记移动到选中波形的最大值处."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Find Min [desc]
将标记移动到选中波形的最小值处."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Create [desc]
打开“Marker Attributes”对话框，从而创建一个新的标记."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Zoom [desc]
Zoom
缩放图表."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ X-Zoom [desc]
沿 X 轴缩放图表."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Y-Zoom [desc]
沿 Y 轴缩放图表."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Unzoom [desc]
撤销上一步的缩放操作."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Fit [desc]
将图表还原至初始大小."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Zoom In [desc]
放大图表."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Zoom Out [desc]
缩小图表."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Pan Left [desc]
将图表左边的部分移至显示区域."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Pan Up [desc]
将图表上边的部分移至显示区域."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Pan Down [desc]
将图表下边的部分移至显示区域."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 525 [desc]
Tools
Browser
打开“Results Browser”."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Calculator [desc]
打开“Calculator”."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Help [desc]
Help
获取帮助文档."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ Accelerator Key [desc]
显示所有菜单命令中的快捷键."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1  “Waveform”窗口简介 __ 3 [desc]
工具栏快捷键
- “Waveform”窗口的工具栏如图 C-3 所示。  
图 C-3“Waveform”窗口的工具栏
各个快捷键的功能如下：
## Keyboard_1
打印当前窗口中的图表，等同于“File”�“Print”.
## Keyboard_2
撤销上一步操作，等同于“Edit”�“Undo”.
## Keyboard_3
显示/隐藏网格，等同于“Graph”�“Grids On”.
## Keyboard_4
将每条波形单独分栏显示，等同于“Axis”�“Strip”.
## Keyboard_5
层叠显示子窗口，等同于“Graph”�“Layout”�“Card”.
## Keyboard_6
将选中波形移动到一个新建的“Waveform”子窗口中，等同于“Trace”�“New 
Graph”�“Copy New SubWindow”.
## Keyboard_7
将选中波形移动到一个新建的“Waveform”窗口中，等同于“Trace”�“New 
Graph”�“Copy New Window”.
## Keyboard_8
将“Lable”中写入的标签，通过点击鼠标左键放置到当前鼠标的位子.
## Keyboard_9
“Lable”栏：显示或编辑选中的标签."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 打开“Waveform”窗口 [desc]
通过下面的方法可以打开“Waveform”窗口。
- 在 CIW 窗口中，选择“Tools”�“Analog Environment”�“Waveform”.
- 在 ADE 窗口中，选择“Tools”�“Waveform”.
- 当仿真完成后，在 ADE 窗口中，点击“Plot Output”快捷键.
- 在“Results Browser”中，选择将仿真结果送至“Waveform”显示.
- 在“Calculator”中，选择将仿真结果送至“Waveform”显示.
通过后三种方式打开“Waveform”窗口时，将同时显示选中的仿真结果."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 设置“Waveform”窗口 [desc]
当打开一个“Waveform”窗# Table
Unzoom 
撤销上一步的缩放操作."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Fit [desc]
将图表还原至初始大小."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right [desc]
将图表右边的部分移至显示区域."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __  [desc]
工具栏快捷键
“Waveform”窗口的工具栏如图 C- 3 所示。
图 C- 3“Waveform”窗口的工具栏
各个快捷键的功能如下： 
- 打印当前窗口中的图表，等同于“File”�“Print”.
- 撤销上一步操作，等同于“Edit”�“Undo”.
- 显示/隐藏网格，等同于“Graph”�“Grids On”.
- 将每条波形单独分栏显示，等同于“Axis”�“Strip”.
- 层叠显示子窗口，等同于“Graph”�“Layout”�“Card”.
- 将选中波形移动到一个新建的“Waveform”子窗口中，等同于“Trace”�“New Graph”�“Copy New SubWindow”.
- 将选中波形移动到一个新建的“Waveform”窗口中，等同于“Trace”�“New Graph”�“Copy New Window”.
- 将“Lable”中写入的标签，通过点击鼠标左键放置到当前鼠标的位子.
- “Lable”栏：显示或编辑选中的标签."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __  [desc]
打开“Waveform”窗口
通过下面的方法可以打开“Waveform”窗口.
- 在 CIW 窗口中，选择“Tools”�“Analog Environment”�“Waveform”.
- 在 ADE 窗口中，选择“Tools”�“Waveform”.
- 当仿真完成后，在 ADE 窗口中，点击“Plot Output”快捷键.
- 在“Results Browser”中，选择将仿真结果送至“Waveform”显示.
- 在“Calculator”中，选择将仿真结果送至“Waveform”显示.
通过后三种方式打开“Waveform”窗口时，将同时显示选中的仿真结果."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __  [desc]
设置“Waveform”窗口
当打开一个“Waveform”窗口后，可以设置图表显示模式，以帮助对仿真结果的分析."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __ 526 __  [desc]
设置图表布局
在""Waveform""窗口中可能包括多个子窗口。可以通过以下设置改变子窗口的排列方式.
- 选择“Graph”�“Layout Auto”：这是系统默认子窗口排列方式，将根据窗口高和宽的比值自动选择合适的模式，当子窗口的宽度大于高度，采用竖排布局的方式。当子窗口的宽度小于高度，则采用横排布局的方式.
- 选择“Graph”�“Layout Vertical”：如图 C- 4 所示，采用该方式时，子窗口将成纵向排列.
- 选择“Graph”�“Layout Horizontal”：如图 C- 5 所示，采用该方式时，子窗口将成横向排列.
- 选择“Graph”�“Layout Card”：选择这种方式后，每个子窗口都将拥有和“Waveform”窗口同等的大小。因此子窗口堆叠在一起，只有最上面一个被显示。此时通过右上角处的图表编号选择显示的子窗口。选中子窗口的编号将变成绿色，如图 C- 6 所示."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __ 526 __ 527 [desc]
#527.
如图 C- 7 设置背景颜色"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __ 526 __  [desc]
设置背景颜色
对于 ADE WaveScan 和标准 SKILL WaveScan 程序，默认的背景颜色是黑色。但是可以通过选择“Graph”�“Color Schemes”来设置背景颜色。候选项如图 C- 7 中所示:
- Default：将背景色设置为白色.
- Grey：设置背景色为灰色
- Black：设置背景色为黑色
背景色的设置将同时作用于所有已经打开的，以及后来打开的“Waveform”窗口."
"[desc] 模拟集成电路设计与仿真_何乐年 __ Pan Right __ 526 __  [desc]
编辑“Waveform”窗口中的对象
在这一节中，将介绍如何选择、隐藏、重现和删除图表以及图表中的对象，包括波形、坐标轴、标记和标签."
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 缩放图表 [desc]
通过以下方式可以完成图表的缩放操作.
- 直接使用鼠标选择新窗口的大小
- “Zoom”命令
通过选择“Zoom”�“Zoom”，通过点击、拖拽和释放鼠标左键，在图表中形成一个矩形框，该矩形框确定了新图表的大小.
- “X-Zoom”命令
通过选择“Zoom”�“X-Zoom”命令可以仅仅缩放 X 轴。选择“Zoom”�“X-Zoom”后，鼠标变为“”。点击鼠标确定 X 轴缩放的起始点，拖拽鼠标确定缩放范围，释放鼠标确定缩放的结束点。然后根据选择的 X 轴范围重新显示图表.
- “Y-Zoom”命令
通过选择“Zoom”�“Y-Zoom”命令可以仅仅缩放 Y 轴。选择“Zoom”�“Y-Zoom”后，鼠标变为“”。点击鼠标确定 Y 轴缩放的起始点，拖拽鼠标确定缩放范围，释放鼠标确定缩放的结束点。然后根据选择的 Y 轴范围重新显示图表.
- “Unzoom”命令
通过选择“Zoom”�“Unzoom”，可以依次撤销以前的一系列# 1.
选中对象
1) 选中对象；
2) 选择“Edit”�“Hide”。
则选中的对象不再在“Waveform”窗口中显示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 缩放图表 __  [desc]
缩放图表
通过以下方式可以完成图表的缩放操作：
- 直接使用鼠标选择新窗口的大小
- “Zoom”命令
通过选择“Zoom”�“Zoom”，通过点击、拖拽和释放鼠标左键，在图表中形成一个矩形框，该矩形框确定了新图表的大小。
- “X-Zoom”命令
通过选择“Zoom”�“X-Zoom”命令可以仅仅缩放 X 轴。选择“Zoom”�“X-Zoom”后，鼠标变为“”。点击鼠标确定 X 轴缩放的起始点，拖拽鼠标确定缩放范围，释放鼠标确定缩放的结束点。然后根据选择的 X 轴范围重新显示图表。
- “Y-Zoom”命令
通过选择“Zoom”�“Y-Zoom”命令可以仅仅缩放 Y 轴。选择“Zoom”�“Y-Zoom”后，鼠标变为“”。点击鼠标确定 Y 轴缩放的起始点，拖拽鼠标确定缩放范围，释放鼠标确定缩放的结束点。然后根据选择的 Y 轴范围重新显示图表。
- “Unzoom”命令
通过选择“Zoom”�“Unzoom”，可以依次撤销以前的一系列缩放操作。
- “Fit”命令
通过选择“Zoom”�“Fit”将图表还原成初始大小
- “ZoomIn”命令
通过选择“Zoom”�“ZoomIn”，以图表中心点为坐标放大图表。
- “ZoomOut”命令
通过选择“Zoom”�“ZoomOut”，以图表中心点为坐标缩小图表。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 缩放图表 __  __  [desc]
分栏显示波形
当“Waveform”窗口中的一个图表包含多个波形时，可以将每个波形分栏显示。分栏后的波形成纵向排列，所有的波形有其独立的 Y 坐标轴，但共用同一个 X 坐标轴。这种分栏显示只对直角坐标系有效。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 缩放图表 __  __  [desc]
显示符号
通过在波形上添加符号，可以有效地将波形区分开。选择“Trace”�“Symbols On”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 4 缩放图表 __  __  [desc]
给波形赋予坐标轴
当“Waveform”窗口或者子窗口中包含多个波形时，可以为波形设置一个新的 Y 轴或一个已经存在的 Y 轴。如果该 Y 轴的单位和波形不符，则在坐标轴名称中出现一串问号，表示该坐标轴没有明确的物理单位。# C.7. 关于波形的操作
通过拖拽和释放波形，可以完成以下操作：
- 从一个图表到另外一个图表。如果将一个 AC 仿真波形拖拽到瞬态波形中，X坐标轴的坐标将用一串问号显示，表示当前坐标没有单位。
- 从一个子窗口到另一个子窗口
- 从一个分栏到另一个分栏。
当拖拽波形时，鼠标下方会显示拖拽波形的名称。当选中一条波形后，可以通过以下菜单命令对创建新的波形窗口，括号中为对应菜单命令的快捷键。
- “Trace”�“New Graph”�“Copy New Window” 
- “Trace”�“New Graph”�“Move New Window” 
- “Trace”�“New Graph”�“Copy New SubWindow”
- “Trace”�“New Graph”�“Move New SubWindow” 
这些命令在需要从“Parametric Analysis”的大量仿真结果中选择一条特定波形研究的时候十分有用。"
"[desc] 模拟集成电路设计与仿真_何乐年 __  [desc]
“Foreground”中选择波形的颜色"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 [desc]
坐标轴的默认属性是通过“.cdsenv”中的选项设置的。如果需要修改坐标轴属性，可以通过以下步骤来实现。
1. 通过选择“Axis”�“Edit”，或者双击坐标轴，打开“Axis Attributes”对话框。
2. 在“Label”栏中填入坐标中的名称，或者选择“Default”使用默认值。
3. 在“Scaling”中选择下面的一种模式，来设置坐标轴范围和网格划分。
    1. Auto：自动选择坐标轴范围和网格划分。
    2. Min-Max：手动设置坐标轴范围，自动设置网格划分。
    3. Manual：手动设置坐标轴范围和网格划分。
4. 选择“Log”使用对数坐标
5. 选择“Origin”，迫使坐标轴包含原点。
6. 在“Max/Min”中填入坐标轴的范围。当“Scaling”中选择“Auto”时，此栏变灰，失效。
7. 在“Major/Minor Division”中填入主网格和次网格的划分方式。前者表示把整个图表划分的个数，后者表示在把一个主网格划分的个数。此项只在“Scaling”中选择“Manual”时有效。
8. “Significant Digits”中填入坐标轴刻度的有效位数。选择“Default”使用默认有效位数，同时使“Significant Digits”栏中填入的数字失效。
9. 在“Foreground”中选择坐标轴的颜色。
10. 当编辑 X 轴属性时，还有以下选项：# 1.0. 设置坐标轴属性
坐标轴的默认属性是通过“.cdsenv”中的选项设置的。如果需要修改坐标轴属性，可以通过以下步骤来实现。 
1. 通过选择“Axis”�“Edit”，或者双击坐标轴，打开“Axis Attributes”对话框。
2. 在“Label”栏中填入坐标中的名称，或者选择“Default”使用默认值。 
3. 在“Scaling”中选择下面的一种模式，来设置坐标轴范围和网格划分。 
    - Auto：自动选择坐标轴范围和网格划分。 
    - Min-Max：手动设置坐标轴范围，自动设置网格划分。 
    - Manual：手动设置坐标轴范围和网格划分。 
4. 选择“Log”使用对数坐标 
5. 选择“Origin”，迫使坐标轴包含原点。 
6. 在“Max/Min”中填入坐标轴的范围。当“Scaling”中选择“Auto”时，此栏变灰，失效。 
7. 在“Major/Minor Division”中填入主网格和次网格的划分方式。前者表示把整个图表划分的个数，后者表示在把一个主网格划分的个数。此项只在“Scaling”中选择“Manual”时有效。 
8. “Significant Digits”中填入坐标轴刻度的有效位数。选择“Default”使用默认有效位数，同时使“Significant Digits”栏中填入的数字失效。 
9. 在“Foreground”中选择坐标轴的颜色。 
10. 当编辑 X 轴属性时，还有以下选项：
---table begin---
Table tile:属性设置表
| 属性   | 描述                                                                       |
|-------|----------------------------------------------------------------------------|
| Plot vs     | 来自于非参变量扫描仿真结果，所有该类型仿真结果图标中波形转换到该X轴下显示 |
| Sweep Var   | 扫面变量，如“temp”是 ADE 中的扫描变量，而“res”是“Parametric Analysis” 中设置的扫描变量 |
---table end---
注意：这种功能只有在以下两个条件都满足的情况下才能使用： 
- 参变量仿真类型不是瞬态仿真。 
- 最内层的仿真变量的数据点少于 200 个。 
11. 点击“OK”完成对坐标轴的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于鼠标的操作 [desc]
## 1.1.1. 使用波形光标 
波形光标是一个沿着波形移动的光标，该光标的坐标在图表的左下角显示。同时图表的右下角显示了鼠标光标的坐标值。
1. 选择“Trace”�“Trace Cursor”，开启波形光标。 
2. 通过以下方法移动波形光标： 
    - 移动鼠标光标，波形光标自动跟踪鼠标光标。在波形的两侧有一个范围，只有鼠标进入该范围后波形光标才跟随鼠标光标移动。在一个图表中只存在一个波形光标。当有多个波形存在时，如果鼠标进入一个波形两侧的范围内，波形光标自动切换到该光标处。假如鼠标处于两个波形的范围内，则波形光标处于最靠近鼠标的波形上。 
    - 按住“Crtl”键，点击左右方向键也可以移动波形光标 
3. 通过以下菜单命令可以控制波形光标的移动方式： 
    - “Graph”�“Snap Off”：波形光标在数据点间平滑的移动。 
    - “Graph”�“Snap-to-Data”：波形光标从一个数据点跳跃到下一个数据点。 
    - “Graph”�“Snap-to-Peaks”：波形光标从一个峰值跳跃到下一个峰值。 
## 1.1.2. 使用垂直光标 
垂直光标是一个可以移动的垂直直线，这条直线和波形的交汇处用一个红色的空心矩形显示。交汇处的 X/Y 坐标在图例区波形名称后对应显示。通过拖拽垂直光标直线上方的三角形来移动垂直光标，当垂直光标移动时，交汇处的 X/Y 坐标值也实时更新。选择“Trace”�“Vert Cursor”，开启垂直光标。 
## 1.1.3. 使用水平光标 
水平光标是一个可以移动的水平直线，这条直线和波形的交汇处用一个红色的空心矩形显示。交汇处的 X/Y 坐标在图例区波形名称后对应显示。通过拖拽水平光标直线左边的三角形来移动水平光标，当水平光标移动时，交汇处的 X/Y 坐标值也实时更新。选择“Trace“�“Horiz Cursor”，开启水平光标。 
## 1.1.4. 使用差值光标 
差值光标由一个红色和一个蓝色的可以移动的三角形光标构成。同时这两光标各自包含一条从光标出发和 Y 轴相交的水平线，和一条从光标出发和 X 轴相交的垂直线。可以通过点击点击和拖拽三角形可以使差值光标沿着波形移动。光标对应的 X/Y 坐标显示在图表的左下角，它们的 X/Y 坐标的差值和斜率显示在右下角。选择“Trace”�“Delta Cursor”，开启差值光标。 
差值的计算为： 
- dX=红色三角形的 X 坐标-蓝色三角形的 X 坐标。 
- dY=红色三角形的 Y 坐标-蓝色三角形的 Y 坐标。 
- S=dY/dX "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于标签的使用 [desc]
“Waveform”窗口中有多个标签，这些标签都可以通过下面的方法进行编辑。 
## 1.2.1. 添加标签 
这一章节中将介绍如何通过“Graph”菜单和快捷键中的标签栏添加标签。通过“Graph”菜单添加标签时，选择“Graph”�“Label�Edit”进行编辑。点击“Add”完成编辑。在图表中通过点击，将刚才编辑好的标签加入到鼠标点击的位置。 
使用快捷键中的标签栏添加标签时，如果“Waveform”中有多个子窗口，通过点击子窗口右上角的数字框，来选择需要的窗口。被选中的窗口的数字框呈绿色。然后在快捷键中的标签栏填入需要的标签内容，点击“
”，此时标签随着鼠标移动。通过点击鼠标左键，将编辑好的标签放到图表中。 
## 1.2.2. 编辑标签 
在这一章节中将介绍如何通过“Graph”菜单和快捷键中的标签栏编辑标签。通过“Graph”菜单编辑标签的方法是选中需要编辑的标签，然后选择“Graph”�“Label”�“Edit”或者双击需要编辑的标签。在“String”栏中填入标签的内容。“WaveScan”提供了多种变量，这些变量可以嵌入到标签内容中。当嵌入变量的标签被加入到图表中后，这些变量被估值，计算后的结果将替代标签中的相应表达式，以数据的形式出现在图表中。 
---table begin---
Table tile:标签中的表达式
| 变量   | 描述       |
|--------|-----------|
| %X     | X 坐标     |
| %Y     | Y 坐标     |
| %W     | ΔX 值    |
| %H     | ΔY 值    |
---table end---# 5.4. 使用水平光标及其数据显示 
水平光标是一个可以移动的水平直线，这条直线和波形的交汇处用一个红色的空心矩形显示。交汇处的 X/Y 坐标在图例区波形名称后对应显示。通过拖拽水平光标直线左边的三角形来移动水平光标，当水平光标移动时，交汇处的 X/Y 坐标值也实时更新。选择“Trace“�“Horiz Cursor”，开启水平光标。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 使用差值光标及其数据显示 [desc]
差值光标由一个红色和一个蓝色的可以移动的三角形光标构成。同时这两光标各自包含一条从光标出发和 Y 轴相交的水平线，和一条从光标出发和 X 轴相交的垂直线。可以通过点击点击和拖拽三角形可以使差值光标沿着波形移动。光标对应的 X/Y 坐标显示在图表的左下角，它们的 X/Y 坐标的差值和斜率显示在右下角。选择“Trace”�“Delta Cursor”，开启差值光标。 
差值的计算为： 
- dX=红色三角形的 X 坐标-蓝色三角形的 X 坐标。 
- dY=红色三角形的 Y 坐标-蓝色三角形的 Y 坐标。 
- S=dY/dX "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于标签的使用 [desc]
“Waveform”窗口中有多个标签，这些标签都可以通过下面的方法进行编辑。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于标签的使用 __ 添加标签 [desc]
这一章节中将介绍如何通过“Graph”菜单和快捷键中的标签栏添加标签。通过“Graph”菜单添加标签时，选择“Graph”�“Label�Edit”进行编辑。点击“Add”完成编辑。在图表中通过点击，将刚才编辑好的标签加入到鼠标点击的位置。 
使用快捷键中的标签栏添加标签时，如果“Waveform”中有多个子窗口，通过点击子窗口右上角的数字框，来选择需要的窗口。被选中的窗口的数字框呈绿色。然后在快捷键中的标签栏填入需要的标签内容，点击“ ”，此时标签随着鼠标移动。通过点击鼠标左键，将编辑好的标签放到图表中。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于标签的使用 __ 编辑标签 [desc]
在这一章节中将介绍如何通过“Graph”菜单和快捷键中的标签栏编辑标签。通过“Graph”菜单编辑标签的方法是选中需要编辑的标签，然后选择“Graph”�“Label”�“Edit”或者双击需要编辑的标签。在“String”栏中填入标签的内容。“WaveScan”提供了多种变量，这些变量可以嵌入到标签内容中。当嵌入变量的标签被加入到图表中后，这些变量被估值，计算后的结果将替代标签中的相应表达式，以数据的形式出现在图表中。 
---table begin---
Table tile:标签中的表达式
| 变量   | 描述       |
|--------|-----------|
| %X     | X 坐标     |
| %Y     | Y 坐标     |
| %W     | ΔX 值    |
| %H     | ΔY 值    |
| %S     | 斜率（ΔX/ΔY）|
| %N     | 波形名称  |
| %E     | 表达式    |
---table end--- "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 关于标签的使用 __ 添加标记 [desc]
和 Y 坐标，用以确定标记在图表中放置的位子。这种方法有利于在波形上精确的方式标记。例如：需要在波形上 X 坐标为 10nS 的位子放置标记，则在 X 栏中填入 10n，而将 Y 栏空缺。“WaveScan”自动计算出相应得 Y 坐标，并放置标记。 
选择“Use Cursor”，在鼠标的位子放置标记。在“Constraints”中选择“Trace”将把标记附着在最近的波形上；选择“Data Points”将把标记附着在最近的波形上的数据点上。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 标记类型和显示方式 [desc]
在“Type/Display”栏中选择标记的类型和显示方式：
- Trace：波形标记 
- Vertical：垂直标记 
- Horizontal：水平标记 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 符号类型选择 [desc]
在“Symbol Style”中选择符号的类型。选择“Arrow”将显示标记和其标签间的连线。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 字体选择 [desc]
在“Font”三个下拉菜单中依次选择标记的标签中文字的字体、字形和字号。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 标记颜色选择 [desc]
在“Foreground”中选择标记的颜色。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 8 设置坐标轴属性 __ 完成标记设置 [desc]
点击“OK”完成对标记的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 通过鼠标添加标记 [desc]
通过下面的方法，可以通过鼠标在图表中添加波形标记、垂直标记和水平标记。 
选择“Marker”�“ Place” �“ Trace Marker”、“Marker ”� “Place” � “Vert Marker”或者“Marker” � “Place ”�“Horiz Marker”，然后在图表中点击鼠标添加相应的记号。 
将鼠标指向图表中需要放置标记的位子，然后点击快捷键“m”（添加波形标记）、“V”（添加垂直标记）或者“H”（添加水平标记）。 “WaveScan”会自动将标记添加到离鼠标最近的波形上。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 多波形下的标记添加 [desc]
假如图表中有多条波形，“WaveScan”将按照下面的规则添加标记： 
- 如果在“.cdsenv”中“autoTraceSelect”选项为“true”，那么标记将添加到离鼠标最近的波形上。 
- 如果在“.cdsenv”中“autoTraceSelect”选项为“false”，那么标记将添加最后选中（或者最好添加）的波形上。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 [desc]
差值标记用来标记图表中两个点之间的差值。差值标记需要配合波形标记使用。在添加差值标记前，必须刚刚添加或者选中一个波形标记。差值标记可以单独移动或删除它所包含的两个波形标记中的一个。当差值标记的两个波形标记移动时，两个波形标记XY 坐标的差值也实时更新。 差值标记可以用来测量信号间的延时，也可以配合 min\max 函数测量波形的峰峰值。通过下面的步骤添加差值标记：
1. 采取下面任意一个操作： 
  - 选择“Marker”�“Place”�“Trace Marker”，或者通过快捷键“m”添加一个新的波形坐标。 
  - 选择一个已经存在的波形标记。 
2. 选择“Marker”�“Add Delta”。 
3. 点击鼠标添加第二个波形标记从而构成差值标记。或者跳过第二步，将鼠标移动到合适的位子，通过点击快捷键“a”，加入波形标记，该波形标记自动和第一步中的波形的坐标形成差值坐标。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 多条波形下的差值标记 [desc]
当图表中存在多条波形时，如果在“.cdsenv”中“autoTraceSelect”选项为“true”，那么差值标记的两个波形坐标可以分别作用在不同波形上。如果在“.cdsenv”中“autoTraceSelect”选项为“false”， 那么差值标记的两个波形坐标只能作用在同一个波形上。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 修改标记显示方式 [desc]
所有的标记（包括波形标记、垂直标记、水平标记和差值标记）拥有三种显示模式：XY 模式、X 模式和 Y 模式。通过下面的步骤可以修改标记的显示模式： 
1. 选择一个标记 
2. 选择“Marker”�“Display Type”，或者选择“Marker”�“Edit”打开“Marker Attributes”对话框，在“Type/Display”的下拉菜单中根据表 C- 3 中的内容选择一个合适波形模式。 
---table begin---
Table title: 三种显示模式的显示方式 
| 选项    | 显示方式 |
|---------|----------|
| XY Model| 如果选择的标记是在波形标记、垂直标记或者水平标记的时候，在标记的标签中显示标记的 X 坐标和 Y 坐标。如果选择的标记是差值标记，在标记的标签中将显示两个波形坐标的 X 坐标差值和 Y 坐标差值。并且标记和标签间的连线采用斜线。 | 
| X Model | 如果选择的标记是在波形标记、垂直标记或者水平标记的时候，在标记的标签中显示标记的 X 坐标。 如果选择的标记是差值标记，在标记的标签中将显示两个波形坐标的 X 坐标差值。并且标记和标签间的连线采用折线，折线垂直通标记  | 
| Y Model | 如果选择的标记是在波形标记、垂直标记或者水平标记的时候，在标记的标签中显示标记的 Y 坐标。 如果选择的标记是差值标记，在标记的标签中将显示两个波形坐标的 Y 坐标差值。并且标记和标签间的连线采用折线，折线水平通标记  | 
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 编辑标记 [desc]
标记的默认属性通过“.cdsenv”中的变量进行设置。可以通过下面的步骤修改标记的属性。 
1. 采取下面任意一种方法： 
  - 双击需要编辑的标记 
  - 选中需要编辑的标记，然后选择：“Marker“�“Edit”
2. 通过 C.11.1 中介绍的内容修改标记的属性。 
3. 点击“OK”完成对标记的编辑。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 移动标记 [desc]
通过以下的方法可以移动一个标记 
1. 选择需要移动的标记。 
2. 采用下面任意一种方法： 
  - 在标记上按住鼠标左键，拖拽标记到需要的位子，松开鼠标左键来释放标 记。 
  - 选择“Edit”�“Move”，在需要的位子点击鼠标左键重新放置标记。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 移动标记 __ 多波形下的标记移动 [desc]
如果在图表中存在多条波形，标记将按照下面的规则移动： 
- 如果在“.cdsenv”中“autoTraceSelect”选项为“true”，那么标记将可以在多个波形间切换。 
- 如果在“.cdsenv”中“autoTraceSelect”选项为“false”，那么标记只能沿着波形移动，不能切换到其他的波形上。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 保存与载入波形 [desc]
用户可以将波形文件保存为二进制文件。用户能够将这些二进制文件导入到“WaveScan”中和仿真波形进行比较，也能够利用这些文件重新生成波形文件。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 保存与载入波形 __ 保存波形 [desc]
用户可以将波形文件保存为二进制文件。用户能够将这些二进制文件导入到“WaveScan”中和仿真波形进行比较，也能够利用这些文件重新生成波形文件。通过下面的步骤可以保存波形文件： 
1. 选择一条曲线，在控制面板中选择“Trace”�“Save”，将会弹出“Save”对话框。 
2. 在文件类型选项中，将保存类型可以设置为.grf 格式。 
3. 在“Save In”下拉菜单中选择所要保存的文件路径。 
4. 在“File name”中填写保存文件名。 
5. 点击“Save”，保存文件。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加差值标记 __ 保存与载入波形 __ 载入波形 [desc]
通过下面的步骤可以载入波形文件： 
1. 在图形界面窗口，选择“Trace”�“Load”，将会弹出“Open”对话框。 
2. 在“Look In”下拉菜单中选择所要保存的文件路径。 
3. 采用下面任意一种操作： 
  - 在“File name”中填写保存文件名。 
  - 在“Look In”下方的窗口中选择需要载入的波形文件 
4. 点击“Open”，载入文件。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 冻结图表 [desc]
当图表被冻结后，仿真结果的重新载入将不会改变图表中的波形。可以通过以下方法冻结图表。在图形界面中，选择“Graph”�“Freeze On” "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 重新载入图表 [desc]
通过以下方法可以重新为图表中的波形重新载入数据。选择“File”�“Reload” "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 保存图表 [desc]
使用“XML”格式保存图表，可以通过保存的对话设置完全恢复恢复该图片的信息。以“XML”格式保存的图表保存如下信息： 
- 数据保存位置，包含数据路径，数据设置，波形名称等，而不是具体的数据。因此，由于仿真时的不同设置造成的数据的变化，将在图表载入中反映出来。 
- 大部分的图表设置属性，如网格，背景颜色，标注，标记等。 
通过以下步骤以“XML”格式保存图表： 
1. 选择“File”�“Save”，此时“Save Graph”窗口弹出。
2. 在文件类型选项中，将保存类型可以设置为.grf 格式。 
3. 在“Save In”下拉菜单中选择所要保存的文件路径。 
4. 采用下面任意一种操作： 
  - 在“Save In”下拉菜单下面的窗口中选择一个已有的波形文件，用新的数据将其覆盖。
  - 在“File Name”栏中键入一个新的名称，从而保存一个新的波形文件。 
5. 点击“Save”，保存文件。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 以图像格式保存图表 [desc]
用户也能够以图像格式保存图表。所有的格式都是无损模式保存。通过以下步骤可以将图表以图片的形式保存下来： 
1. 选择“File”�“Save as Image”。 
2. 选择所需要保存的图片格式。 
3. 填写需要保存的文件名，默认的文件名为“snapshot.png”。点击“Browser”可以选择保存路径。 
4. 点击“Save”，以图片模式保存图表。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 打开保存的图表文件 [desc]
通过以下步骤可以打开一个保存的图表文件： 
1. 在“Results Browser“中选择“File”�“Open Graph”�“Open Graph as Plot”。
2. 在“Look In”下拉菜单中选择所要保存的文件路径。 
3. 在“Files of Type”下拉菜单中根据文件的拓展名选择需要显示的波形文件。 
4. 采用下面任意一种操作： 
  - 在“File name”中填写保存文件名。 
  - 在“Look In”下方的窗口中选择需要载入的波形文件 
5. 点击“Open”，载入文件。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 12 保存与载入波形 __ 建立一个图表模版 [desc]
当创建一个新的图表时，“WaveScan”会调用“.cdsenv”中的设置来决定该图表的属性，如背景颜色，网格，字体等。 可以将一个保存的波形文件，或者将当前“Waveform”窗口设置为模板。以后创建的“Waveform”窗口都采用这个模板的设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Calculator简介 [desc]
“Waveform Calculator”是一个科学计算器，有代数和逆波兰（RPN， Reverse Polish Notation）两种工作模式。通过 Calculator 可以实现以下功能： 
- 可以在“Calculator”中创建、打印和显示包含仿真输出数据的表达式。 
- 在缓存中输入包含节点电压、端口电流、直流工作点、模型参数、噪声参数、设计变量、数学公式以及算法控制变量的表达式。 
- 把缓存中的内容保存的存储器中，并可以把存储器中保存的内容重新读入到缓存中。 
- 把存储器中的内容保存到文件中，并可以把文件中保存的内容重新读入到存储器中。# D.1. Calculator简介
“Waveform Calculator”是一个科学计算器，有代数和逆波兰（RPN， Reverse Polish Notation）两种工作模式。通过 Calculator 可以实现以下功能： 
- 可以在“Calculator”中创建、打印和显示包含仿真输出数据的表达式。 
- 在缓存中输入包含节点电压、端口电流、直流工作点、模型参数、噪声参数、设计变量、数学公式以及算法控制变量的表达式。 
- 把缓存中的内容保存的存储器中，并可以把存储器中保存的内容重新读入到缓存中。 
- 把存储器中的内容保存到文件中，并可以把文件中保存的内容重新读入到存储器中。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ Calculator简介 __ 2 “Calculator”的菜单 [desc]
---table begin---
Table tile: ""Calculator""菜单的功能
| 菜单选项      | 具体操作       | 
|--------------|------------|
| Window Close | 关闭“Calculator” |
| Tools Browser | 打开“Results Browser” |
| Edit | 编辑已有存储项。 |
| New Memories | 创建新的存储项。 |
| Copy | 拷贝存储项。 |
| Delete | 删除存储项。 |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ Calculator简介 __ 5 设置快捷键 [desc]
可以通过以下方法，为“Calculator”置快捷键 
在 Command Interactive Window（CIW）窗口中键入。 
hiSetBindKey( “encap” “<Key>x” “calCalculatorFormCB()”)，即可用所希望的按键代替 x。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ sqrt2 [desc]
对于两种模式，在缓存中加入的常数都出现在光标的位子。对于逆波兰模式，如果需要将常数单独压入堆栈中，需要点击缓存控制钮中的“Clear”将当前缓存中的内容清空。 
注意：“Calculator”中的表达式需要按照正确的语法规则输入。例如在“Calculator”表达式中，“2k”和“2p”所代表的是“2 kilo”（2000）和“2 pico”（2 e-12）。如果表达式想包含“2 倍 p”项，则需要在表达式中按以下的方式键入“2*p”。如果在“2p”后面紧跟一个不带数字的字符串，例如“2pfsfeg”，那么这个表达式将仅仅被认作“2p”，而不会报语法错误。但是在紧跟得字符串中带有数字。例如“2psdfs23vsdf”，那么“Calculator”将会报一个语法错误。因此在使用圆周率常数“pi”的时候需要特别注意。例如“4 倍圆周率”需要表示为“4*pi”，而“4pi”将被认作“4p”，即 4 e-12。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ sqrt2 __ 6 开启“Calculator” [desc]
有三种方法可以打开“Calculator”
在“Waveform”窗口或者“Simulation”窗口中选择“Tools”�“Calculator”，如图 D- 5 所示。 
在 CIW 窗口中选择“Tools”�“Analog Environment”�“Calculator”，如图 D- 6 所示 
在“Analog Design Environment”窗口中选择“Tools”�“Calculator”，如图 D- 7所示 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ sqrt2 __ 7 关闭“Calculator” [desc]
选择“Window”�“Close” "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 [desc]
在“Calculator”中有以下四种输入数据的方式，
通过键盘，按照 SKILL 语言规范直接在缓存中输入表达式。详细内容参见 Cadence文档中的 SKILL 语言部分。本文不推荐使用这种方式。
通过电路图表达式按键，点击电路图中的节点和端口从而获得相关数据。
从“Waveform”窗口中获得数据
使用“Results Browser”从仿真结果输出文件中获得数据。请参考附录 B。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 1 通过电路图表达式按键，点击电路图中的节点和端口从而获得相关数据 [desc]
电路图表达式按键，可以通过在电路图中点击目标对象，从而获得相应得表达式在缓存中显示出来。图 D- 8 显示了常用的“Calculator”中常用的电路图表达式按键。 
注意这些按键已经按照仿真类型进行了分类。例如在运行了瞬态仿真（tran）后，需要从电路图中获得节点电压的仿真数据，则在电路图表达式按键中的“tran”页面（如图D- 8 中第一栏所示）里选择“vt”，然后在电路图中选择相应的节点，即可获得。如果选择了其它页面中的按键，例如“ac”中的“vf”，并且没有进行交流(ac)未来，那么“Calculator”将会报错，说无法获得数据。因此在使用电路图按键获取数据时，按键和未来类型的匹配十分重要。表 D- 2 显示了各个电路图表达式按键获取的数据类型。 
---table begin---
Table tile:电路图表达式按键获取的数据类型
| 表达式按键 | 获取的数据类型 | 表达式按键 | 获取的数据类型 |
|-----------|--------------|------------|--------------|
| vt        | 瞬态仿真节点电压  | iv         | 瞬态仿真端口电流  |
| vf        | 交流节点电压    | if         | 交流端口电流   |
| vdc       | 直流工作点节点电压 | idc        | 直流工作点端口电流 |
| vs        | 直流扫描节点电压  | is         | 直流扫描端口电流  |
| op        | 直流工作点     | opt        | 瞬态工作点    |
| var       | 设计变量      | mp         | 模型参数     |
| vn        | 噪声电压     |            |              |
---table end---
通过以下的方法利用电路图表达式按键在电路图中获得需要的数据 
1)保持“Select Mode”处于选中状态。 
2)选择合适的电路表达式按键，并点击，使其保持选中状态。 
3)在电路图中点击所需要的目标 如果对于选择的目标的表达式存在多个合适的参数，那么一个包含所有合适参数的窗口将弹出，在该窗口中选择需要的参数。
4)完成数据获得后，在电路图窗口保持激活的状态下，点击“Esc”键，退出数据获取模式。
在电路图数据中选择器件参数 
下面的内容适合使用“op”，“opt”，“mp”，“vn”或者“var”来获取数据，并且在获取数据之前必须运行一次对应得仿真。 
1)在点击“op”，“opt”，“mp”，“vn”或者“var”电路图表达式按键中任意一个后，“Select an instance”窗口弹出，如图 D- 9 所示。 
2)在电路图中选择需要的器件，例如一个名为“M0”的 MOS 管，点击该器件后，图 D- 9 中的窗口变为“OP parameter for M0”（因为在第一步中选择的是“op”键），如图 D- 10 所示。 
3)在“List”下拉菜单中显示了所有合适的器件参数，如图 D- 11 所示。在该菜单中选择需要的参数，例如 MOS 管的跨导“gm”
4)点击图 D- 10 窗口中的“OK”后，该参数被“Calculator”获取，并在缓存中显示，如图 D- 12 所示 
选择电压或者电流
通过以下方法在电路图中选择电压或者电流。以一个电容为例，如图 D- 13 所示： 
获得节点电压：点击和该节点连接的任意连线。 
获得端口电流：点击器件上方形端口，从而获得流过该端口的电流。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 2 在“Waveform”窗口选择曲线 [desc]
保持“Select Mode”处于选中状态，在“Waveform”窗口中选择所需要的曲线。“Calculator”中输入的表达式，是“Waveform”窗口中鼠标所在曲线的标题表达式，如图D- 14 中，窗口底部状态栏中显示的“graph-1.trace():gain”。 
但是因为这个表达式仅仅是一个描述性的标题，不能被“Calculator”估值，因此系统自动创建 SKILL 函数来表示选中的波形。最终“Calculator”获得的表达式如图 D- 15 所示。
当我们使用“Corner Analysis”或者“Parametric Analysis”时，在 ADE 窗口中定义的输出波形实际上对应了一组曲线。该组曲线和不同的工艺角或者设计变量值一一对应。例如我们运行了一次“Parametric Analysis”，根据不同的电阻值（res）获得了一组曲线，如图 D- 16 所示。 
我们可以通过以下的方法，将其中的一条而不是一组曲线捕获到“Calculator”中。 
1)在“Calculator”中取消“Family”选项。如图 D- 17 所示。 
2)保持“Select Mode”选中，在“Waveform”窗口中选择需要的曲线。“Calculator”捕获曲线后如图 D- 17 所示。# D.2.2. 在“Waveform”窗口选择曲线 
选择曲线 
保持“Select Mode”处于选中状态，在“Waveform”窗口中选择所需要的曲线。“Calculator”中输入的表达式，是“Waveform”窗口中鼠标所在曲线的标题表达式，如图D- 14 中，窗口底部状态栏中显示的“graph-1.trace():gain”。 
但是因为这个表达式仅仅是一个描述性的标题，不能被“Calculator”估值，因此系统自动创建 SKILL 函数来表示选中的波形。最终“Calculator”获得的表达式如图 D- 15 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 2 在“Waveform”窗口选择曲线 __ 在一组波形中选择一条波形曲线 [desc]
当我们使用“Corner Analysis”或者“Parametric Analysis”时，在 ADE 窗口中定义的输出波形实际上对应了一组曲线。该组曲线和不同的工艺角或者设计变量值一一对应。例如我们运行了一次“Parametric Analysis”，根据不同的电阻值（res）获得了一组曲线，如图 D- 16 所示。 
我们可以通过以下的方法，将其中的一条而不是一组曲线捕获到“Calculator”中。 
1)在“Calculator”中取消“Family”选项。如图 D- 17 所示。 
2)保持“Select Mode”选中，在“Waveform”窗口中选择需要的曲线。“Calculator”捕获曲线后如图 D- 17 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 绘制显示结果 [desc]
“Calculator”缓存中的表达式的值，可以使用一个独立变量作为坐标，以图形或者列表的形式显示出来。独立变量是由仿真类型和仿真设置所决定的。例如，仿真器运行了一次交流仿真，扫描对象是“频率”，扫描范围是“1~100k Hz”，扫描步进是“1 Hz”；那么图形的坐标轴或者列表的编号将以“Hz”作为单位，范围是“1~100k Hz”，两个坐标点或者编号间的间隔为“1 Hz”。 
点击表达式以图形的方式显示和以列表的方式显示常用的2个按键分别是："
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 绘制显示结果 __ 绘制表达式 [desc]
在绘制缓存中表达式之前，需要选择绘制方式。在绘制表达式按键旁有一个下拉菜单，用来选择创建波形窗口的方式。下拉菜单如图 D- 18 所示。 
---table begin---
Table tile:下拉菜单中各个选项的功能
| 下拉菜单   | 功能                                             |
|-----------|------------------------------------------------|
| Append    | 在原来窗口的基础上显示新的波形。               |
| Replace   | 清楚原来的窗口中的数据，显示新的波形。           |
| New SubWin| 在原来的窗口中，建立字窗口，用来显示新的波形。 |
| New Win   | 创建一个新的窗口显示新的波形。                 |
---table end---
在选择好波形窗口创建方式后，点击按键即可将缓存中的表达式值在波形窗口中显示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 选择数据 __ 绘制显示结果 __ 以文本的形式输出“Calculator”缓存中表达式的值 [desc]
点击“ ”按键，将把“Calculator”缓存中表达式的值以列表的形式输出。 点击“ ”按键后，“Display Results”窗口将弹出，如图 D- 21 所示。点击“OK”后将按照“Display Results”窗口中的设置，选择性的将 “Calculator”缓存中表达式的值以列表的形式在“Results Display Window”窗口中输出，如图 D- 22 所示。 
若将“Display Results”窗口中的“Data”选择为“Value”，则表示将“Calculator”缓存中表达式在坐标轴上所有的值都显示。输出结果如图 D- 22 所示。 
如果“X Intercept”栏中填入的值不在仿真范围内，那么“Calculator”将输出仿真扫描范围内，最靠近该数值的坐标点上的表达式的值。例如，扫描范围是“1~100”，在“X Intercept”栏中填入“110”，则“Calculator”输出的值是“expr（100）”。 
此时“Start/End”、“Step/Scale”和“Log”窗口被激活。在“Start/End”中填入坐标轴上的起始点和结束点，从而圈定输出范围。 如果“Log”栏没有选中，那么“Step/Scale”中填入的是步进数，“Calculator”将按照该栏中设置数为步进，从“Start/End”中确定的起始点开始，依次取数据，直到跨过结束点为止。按照图 D- 25 中的设置，输出结果如图 D- 26 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 [desc]
“average”函数用来计算整个仿真范围内波形的平均值。# D.5. 函数
在“Calculator”中有很多函数，可以对数据进行大量的处理，从而获得有用的信息。只需要点击函数窗口中的函数项，就可以对当前缓存中的表达式使用相应的函数。在以下的章节中将针对使用“RPN”模式的“Calculator”，介绍一些常用实用的函数，及其使用方法。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 __ 简单函数 [desc]
下面这些函数适合缓存中只有一个表达式的情况。
---table begin---
Table title: 表 D- 4 简单函数的功能
| 函数              | 功能           |
|---------------|--------------|
| mag             | 取幅值         |
| exp             | ex            |
| phase         | 取幅角         |
| 10**x         | 10x           |
| real           | 取实部         |
| x**2           | x2            |
| imag          | 取虚部         |
| abs            | 取绝对值       |
| ln              | 取自然对数     |
| int             | 取整           |
| log10         | 以10为底取对数 |
| 1/x            | 取反           |
| dB10          | 对功率表达式取dB值 |
| sqrt           | x1/2         |
| dB20          | 对电压电流取dB值 |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 __ 简单函数 __ 作用两个表达式的函数和操作符 [desc]
在“RPN”模式中，一些函数或操作符同时作用于缓存和堆栈中最上层的表达式。对于这些函数或操作符而言，堆栈中的表达式永远在缓存中表达式的左边。
---table begin---
Table title: 表 D- 5 用两个表达式的函数和操作符及其功能
| 函数           | 功能             |
|--------------|----------------|
| y**x          | stackbuffer     |
| +               | stack + buffer  |
| -               | stack - buffer  |
| *               | stack * buffer  |
| /               | stack / buffer  |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 __ 简单函数 __ 三角函数 [desc]
“Calculator”中也有三角函数。包括 sin，asin，cos，acos，tan，atan，sinh，asinh,cosh，acosh，tanh，atanh。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 __ 简单函数 __ 特殊函数 [desc]
特殊函数对于分析仿真结果有很大的帮助。在选择某些特殊函数时，函数窗口将转换成对话框，在其中填入该函数所需要的其它数据。一些特殊函数如 “average”, ""bandwidth"", ""clip"", ""convolve"", ""cross"", ""delay"" 直接作用于缓存中的表达式。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “average”函数 [desc]
“average”函数用来计算整个仿真范围内波形的平均值。“average”的定义是在范围x内对表达式f(x)进行积分，然后除以范围 x。例如，如果 y=f(x)，那么 average(y)为 `( ) to from f x dx to − from ∫`"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “bandwidth”函数 [desc]
“bandwidth”函数计算“Calculator”缓存中表达式的带宽。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “clip”函数 [desc]
“clip”函数用来确定“Calculator”缓存中表达式的输出范围。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “convolve”函数 [desc]
“convolve”函数用来实现两个表达式间的卷积。""( )( ) 1 2 to from f s ft − s ds ∫"" 中 f1() 和 f2() 分别代表“Signal1”和“Signal2”中的两个表达式。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “cross”函数 [desc]
“cross”函数计算了表达式第 n 次穿过特定形式波形边沿阈值时的 x 轴坐标。具体步骤操作如下。 
1. 将所需要的表达式捕捉到“Calculator”的缓存中。 
2. 在函数窗口中点击“cross”函数。然后函数窗口将变为“cross”对话框。 
3. 在“cross”对话框中：“Signal”栏中填入的是需要处理的节点电压表达式。通过上述方法，该栏值将直接从“Calculator”的缓存中获得。也可以按照 SKILL 语法规范输入其它的节点电压表达式。“Threshold Value”栏中填入的是阈值。“Edge Number”栏中填入的是穿越特定形式波形边沿的次数。“Edge Type”下拉菜单有以下选项：“rising”：上升沿。“falling”：下降沿。“either”：上升或下降沿。 
4. 点击“OK”。完成对“cross”函数的设置。 
5. 点击，输出电流的平均值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “delay”函数 [desc]
“delay”函数利用“cross”函数，计算两个表达式分别穿过特定值时的时间差。具体操作步骤如下： 
1. 在函数窗口中点击“delay”函数。然后函数窗口将变为“delay”对话框。 
2. 在“Signal1”和“Signal2”栏中填入需要计算延时的两个表达式。软件默认在这两栏中填入当前“Calculator”缓存中的表达式。因此需要按照 SKILL 语法规范填入需要的两个表达式。 
3. 按照上文介绍的关于“cross”函数的介绍，完成针对两个表达式的“cross”函数设置。 
4. 点击“OK”，完成对“delay”函数的设置。 
5. 点击，输出延时值。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “deriv”函数 [desc]
“deriv”函数用来对“Calculator”缓存中的表达式求微分。在函数窗口中选择“deriv”函数，然后点击输出微分后的表达式波形。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “gainBwProd”函数 [desc]
“gainBwProd”函数计算表达式的增益带宽积。它要求“Calculator”缓存中的表达式是一个频率响应，并且拥有足够大的频率扫描范围。增益带宽积通过如下的方法计算。 
```
(
)
0
Pr
*
2
gainBw
od gain
A
f
=
``` 
其中 A0是直流增益，f2 是增益大小为 1/(21/2)时的最小频率。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “gainMargin”函数 [desc]
“gainMargin”函数给出“Calculator”缓存中的频率响应表达式相移为 180 度时的增益大小（dB 值）。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “iinteg”函数 [desc]
“iinteg”函数对“Calculator”缓存中的表达式对 X 轴上的变量进行不定积分。积分结果可以在“Waveform”窗口中显示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “integ”函数 [desc]
“integ”函数对“Calculator”缓存中的表达式对 X 轴上的变量进行定积分。积分结果是波形曲线在规定范围内和 X 轴所包围的范围。具体步骤如下： 
1. 将所需要的表达式捕捉到“Calculator”的缓存中。 
2. 在函数窗口中点击“integ”函数。然后函数窗口将变为“integ”对话框。 
3. 在“Initial Value”和“Final Value”中填入定积分的开始和结束值。 注意：上述两个值必须同时定义，或者都不定义。当没有限定定积分范围时，“integ”函数将自动将积分范围设置为整个扫面范围。 
4. 点击“OK”，完成“integ”函数设置。 
5. 点击，输出积分结果。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “lshift”函数 [desc]
“lshift”函数将“Calculator”缓存中的表达式平移后输出到“Waveform”窗口中。平移量在“lshift”对话窗口的“Delta X”栏中设置。正值表示向左平移，负值表示向右平移。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 最大值、最小值函数 [desc]
“Calculator”中有求最大值和最小值的函数，分别针对 X 轴和 Y 轴上的数据，这些函数为：“xmax”，“ xmin”，“ ymax”，“ymin”。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ “overshoot”函数 [desc]
“overshoot”函数将计算“Calculator”缓存中的表达式的过冲值相对跳变值的比例。假如表达式的峰值为 M，跳变初始值为 I，跳变结束值为 F，如图 D- 42 所示。那么“overshoot”函数的计算为：
```
(
)*100
M
F
overshoot
F
I
−
=
−
```
- 将所需要的表达式捕捉到“Calculator”的缓存中。
- 在函数窗口中点击“integ”函数。然后函数窗口将变为如图 D- 43 所示的“integ”对话框。
- 如果“Initial/Final Value Type”中选择的是“y”，则直接在“Initial/Final Value”中填入表达式跳变前后的值。
- 如果“Initial/Final Value Type”中选择的是“x at y”，则直接在“Initial/Final Value”中填入响应的 X 轴坐标值，用来标明表达式跳变前后的时间。系统自动根据 X轴左边计算出响应得 y 值。
- 点击“OK”完成“overshoot”函数的设置。
- 点击，输出结果。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “phaseMargin”函数 [desc]
“phaseMargin”函数可以计算“Calculator”缓存中的表达式的相位裕度。但是要求表达式是一个频率响应。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “settlingTime”函数 [desc]
“settlingTIme”函数可以计算“Calculator”缓存中的表达式的稳定时间。通过指定开始值、结束值以及百分比计算出一个容差范围，当信号波动幅度在容差范围之内时，返回这个时间作为函数的输出。
- 将所需要的表达式捕捉到“Calculator”的缓存中。
- 在函数窗口中点击“settlingTime”函数。然后函数窗口将变为如图 D- 44 所示的“settlingTime”对话框。
- 如果“Initial/Final Value Type”中选择的是“y”，则直接在“Initial/Final Value”中填入表达式跳变前后的值。
- 如果“Initial/Final Value Type”中选择的是“x at y”，则直接在“Initial/Final Value”中填入响应的 X 轴坐标值，用来标明表达式跳变前后的时间。系统自动根据 X轴左边计算出响应得 y 值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ “slewRate”函数 [desc]
“slewRate”函数可以计算“Calculator”缓存中的表达式的转换速率。它计算信号在开始值和结束值范围内从低百分比转换到高百分比的平均速率。
- 将所需要的表达式捕捉到“Calculator”的缓存中。
- 在函数窗口中点击“slewRate”函数。然后函数窗口将变为如图 D- 45 所示的“slewRate”对话框。
- 如果“Initial/Final Value Type”中选择的是“y”，则直接在“Initial/Final Value”中填入表达式跳变前后的值。
- 如果“Initial/Final Value Type”中选择的是“x at y”，则直接在“Initial/Final Value”中填入响应的 X 轴坐标值，用来标明表达式跳变前后的时间。系统自动根据 X轴左边计算出响应得 y 值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 附录 E  Parametric Analysis [desc]
“Parametric Analysis”在电路设计和验证过程中是一个非常实用的工具。它允许你对器件参数、电路参数进行赋值。这种赋值可以是对一个变量在一定范围内的赋多个值，也可以是对多个变量进行多组的同时赋值。然后对电路在这些特定值或者特定值组合上的性能进行分析。分析的结果将在波形窗口以一组曲线的形式输出，曲线的个数等于“Parametric Analysis”中赋值的次数。
“Parametric Analysis”，需要将所需要赋值的参数在电路图上以“变量（Variable）”的形式表明，以区别于其它固定值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 图 E- 1 MOS 管阈值电压测试电路 [desc]
使用Analog Design Environment（ADE）窗口来配置仿真环境、仿真类型、输出结果的设置。运行Parametric Analysis之前，建议先进行一次仿真，保证各个设置都是正确的。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ Parametric Analysis的仿针环境设置 [desc]
“Parametric Analysis”的仿真环境、仿真类型、输出结果的设置直接从 Analog Design Environment（ADE）中获得。首先，我们绘制一个简单的电路图，包含一个二极管连接的NMOS 管，和一个电压源。我们将电压源的大小，和 NMOS 管的宽和长设为变量：“VDD”，“W_N”,“L_N”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ Parametric Analysis的启动 [desc]
在 ADE 中选择“Tools”“Parametric Analysis”。这时“Parametric Analysis”窗口将会弹出，如图 E- 4 所示。图 E- 5 列出了“Parametric Analysis”的所有下拉菜单，它们的功能将在后文一一列出。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ Parametric Analysis的设置 [desc]
## E.3.1. Parametric Analysis中获得变量
我们要获得 MOS 管阈值电压的温度曲线，因此需要把温度作为扫描的变量。在参变量扫描窗口打开的时候，就有一个默认的空缺扫描，我们通过以下步骤，将温度作为变量加入到扫描中。
## E.3.2. 设置变量的变化范围
接下来选择“Range Type”，有三种类型可选：
- “From/To”：从 A 值开始，到 B 值结束，从而确定一个范围。
- “Center/Span”：以 A 值为中心，以 B/2 值为正负方向的变化量，确定一个范围。
- “Center/Span%”：以 A 值为中心，以 A*（B/2）%为正负方向的变化量，确定一个范围。
我们选择“From/To”模式，范围从-20 0C 到 20 0C。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ Parametric Analysis的设置 __ 给一个变量添加多个扫描范围 [desc]
如果我们还想添加另外一个范围：40 0C 到 100 0C。也是在每个整数温度点上做一次仿真。点击“Add Specification”下拉菜单，选择“Range”。
我们看到在 Sweep1 中，有多了一个“Range Type”和“Step Control”供我们设置另一个扫描范围。我们这次选择“Range Type” 为“Center/Span”，“Step Control”为“Linear”，“Total Steps”为 61。
对于这两个范围，我们可以通过点击它们对应得“select”选项，来标识它们的选种情况，以便在后面的分析时，可以分开处理。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ 查看仿真点 [desc]
在进行参变量分析之前，我们可以查看我们选择的仿真点。
选择“Analysis-Show Sweep Sets”“All Sorted”。
- All Sorted ：显示全部仿真点，并按顺序排列 
- All ：显示全部仿真点，不排序 
- Select Sorted ：显示选中的范围，并排序 
- Select ：显示选中的范围，不排序 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ 多个变量的“Parametric Analysis”的设置 [desc]
如果我们还想看 MOS 管尺寸对阈值电压的影响，可以重复上面的步骤，将“L_N”或“W_N”作为变量，扫描它们的大小。
回到“Parametric Anlysis”窗口。选择“Setup”下拉菜单，然后选择“Add New Variable To Bottom”。
这时我们看到在“Sweep1”下面出现了一个新的“Sweep2”。
按照 E.3 的方法，将“L_N”加入到“Variable Name”中，扫描范围从 5um 到 15um。这次“Range Type”采用“Center/Span%”，“Step Control”采用“Logarithmic”的方式，共扫描 5 个点。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Parametric Analysis”的设置 __ 加入或者排除特定仿真点 [desc]
如果我们向扫描几个特定的值，例如 27.5 0C 和 55.2 0C 时的 MOS 管的阈值电压。可以通过下面的方法得到。
在“temp”所在的“Sweep1”中，选择“Add Specification”下拉菜单，然后选择“Inclusion List”。
这时会在“Sweep1”的最下端出现一个“Inclusion List”栏，我们将“27.5”和“55.2”填入其中，以空格隔开。这样就把这两个特定的温度加入到扫描范围内了。
反之，如果我们在“Add Specification”中选择“Exclusion List”，那么将会有一个“Exclusion List”栏会出现在“Sweep1”的最下端，在这一栏中填入的值，将从扫描范围内排出。我们填入“15”，“16”和“17”，以空格隔开，将“Inclusion List”， “Exclusion List”和“-20~20”的范围选中，如图 E- 28 所示。# 1.
注意，这次我们通过“Select”选中的是“temp”的“-20~20”范围和“L_N”的“5um~15um”的范围。通过“Analysis”�“Show Sweep Sets”�“Selected sorted”查看选中的仿真点。
可以看出“Parametric Analysis”是先固定“Sweep1”的值，对“Sweep2”的值进行循环，然后再变化“Sweep1”的值。这说明在“N”个“Sweep”中“SweepN”是最内圈的循环。按照“Sweep”从小到大的顺序，由外而内构成循环的嵌套。
通过“Analysis”�“Start Selected”运行仿真。仿真后，通过“Results Browser”观察 M0 的阈值电压。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除变量和扫描范围 [desc]
设置的范围或者变量不再需要，通过下面的方法进行删除。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除变量和扫描范围 __ 删除扫描范围 [desc]
选择“Setup”�“Delete Range Specification”，接着“Parametric Analysis Delete Setting”窗口将弹出。我们在里面选择要删除的仿真范围，例如“Sweep1”的“-20~20”范围。
点击“OK”后，我们可以看到，在“Sweep1”，“-20~20”的扫描范围被删除了。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除变量和扫描范围 __ 删除一个变量 [desc]
再次选择“Setup”�“Delete Range”，“Parametric Analysis Delete Variable”窗口将弹出，我们在里面选择要删除的变量，例如“temp”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除变量和扫描范围 __ Case 4 [desc]
```
66.5 
0.6u 
```
在“Sweep”菜单中选择“Parametric Set”，如图 E- 34。这时“Parametric Analysis”的界面将切换到下面的状态，如图 E- 35 所示。这时我们需要填入“Variable Name”和“Value List”。
其 中 “Variable Name” 的 选 择 方 法 和 E.3 中 一 样 ， 在 “Setup”�“Pick Name For Variable-Sweep1”中选择“temp”。 在“Value”中依次填入“-15.1”，“23.5”，“12.8”，“66.5”，并以空格隔开。接着用 E.6 中的方法添加一个新的变量“L_N”。在对应的“Value List”中填入“4u”，“3.2u”，“1.8u”，“0.6u”，也是以空格隔开，如图 E- 36 所示。查看仿真点，如图 E- 37 所示。 
---table begin---
Table title: E- 2 “Parametric Set”模式的仿真点组合
|          | Var1  | Var2  | ...  | VarN  |
|--------  |-------|-------|------|-------|
| Case1    | S1V1  | S2V1  | ...  | SnV1  |
| Case2    | S1V2  | S2V2  | ...  | SnV2  |
| Case3    | S1V3  | S2V3  | ...  | SnV3  |
| ...      | ...   | ...   | ...  | ...   |
| CaseM    | S1Vm  | S2Vm  | ...  | SnVm  |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 10 保存“Parametric Analysis”的设置 [desc]
“Parametric Analysis”的设置有两种保存模式：�暂时保存： “Parametric Analysis”的设置将通过“Tool”下拉菜单中的“Checkpoint”项保存到缓存中，然后通过“Tool”下拉菜单中的“Revert”项调出。这种保存方式不需要用户设置保存路径和文件名，但是当“Parametric Analysis”窗口关闭后，该方法保存的设置就会丢失。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 附录 F  Optimization [desc]
优化是一种通过自动调整设计变量，从而达到设计指标的过程。实现这个过程的工具叫做优化器（Optimizer）。
---table begin---
Table title:共源极放大器电路图
| 器件     | 变量名 | 初始值 |
|---------|-------|-------|
| 电压源1 | VDD   | _VDD_  |
| 电压源2 | VG    | _VG_   |
| NMOS 管 | W_N   | _W_N_  |
| NMOS 管 | L_N   | _L_N_  |
| 电阻    | res   | _res_  |
| 电容    | cap   | _cap_  |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 “Optimization”的仿真环境设置 [desc]
图 F- 2 完成设置后的 ADE 窗口。图 F- 3 是设计变量在上述赋值下，单级放大器的幅频特性。可以发现此时的增益小于 1。在后面的内容中，通过使用“Optimization”，将获得增益大于 20dB，3dB 带宽大于 100Hz 的共源级放大器。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Optimization”的启动和关闭 [desc]
在 ADE 中选择“Tools”�“Optimization”，如图 F- 4 所示。此时“Optimizer”窗口将会弹出，如图 F- 5 所示。选择“Session”�“Quit ”将退出该窗口。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Optimization”的启动和关闭 __ 4 ""Optimizer""窗口简介 [desc]
图 F- 6 是“Optimizer”窗口，里面包含 5 个工作区域：“Status Display”，“Menu”，“Goals Pane”，“Variables Pane”和“Tool Bar”。
- Status Display
在“Status Display”中显示的当前优化器所处的工作状态。例如，“Status Display”中的显示表明优化器是在进行仿真，还是处于其他的工作状态。
- Menu
图 F- 7 显示了“Optimizer”中的菜单。“Menu”中包含了优化准备，进行优化，显示优化结果所需要的命令。表 F- 1 给出了“Menu”中各个下拉菜单的具体操作。
---table begin---
Table tile: ""Menu""中的选项及其功能
| 菜单选项       | 具体操作                                      |
|--------------|---------------------------------------------|
| Session      | Save State: 保存当前对话的设置。                       |
| Session      | Load State: 读取以前对话的设置。                        |
| Session      | Save Script: 把当前对话的设置以 Ocean 脚本的形式保存。   |
| Session      | Option: 修改优化的选项。                            |
| Session      | Reset: 删除所有设置。                              |
| Session      | Quit: 关闭“Optimizer”窗口。                       |
| Goals        | Retrieve Output: 将 ADE 中设置的仿真输出作为对象。        |
| Goals        | Add: 直接添加新的对象，或者通过“Waveform Calculator”添加新的对象。|
| Goals        | Edit: 编辑对象。                                 |
| Goals        | Delete: 删除对象。                                |
| Goals        | Enable: 开启对象。                                |
| Goals        | Disable: 关闭对象。                               |
| Variables    | Add/Edit: 添加/编辑设计变量。                        |
| Variables    | Delete: 删除设计变量。                             |
| Variables    | Enable: 开启设计变量。                            |
| Variables    | Disable: 关闭设计变量。                           |
| Optimizer    | Run: 运行优化从设置的初始值开始，直到达到停止标准。       |
| Optimizer    | Step: 运行优化从最近的一个停止点开始，运行一次循环，然后停止。 |
| Optimizer    | Run n: 运行优化从最近的一个停止点开始，运行有限的 n 次循环。  |
| Optimizer    | Stop: 在当前循环完成后，停止优化。                    |
| Optimizer    | Stop Now: 马上停止优化，可以不用完成当前的循环。           |
| Optimizer    | Reset: 所有的仿真结果都将被删除，而对象，设计变量和显示设置保持不变。 |
| Result       | Plot History: 显示输出数据。                         |
| Result       | Set Plot Options: 设置显示选项。                      |
| Result       | Update Design: 更新设计。                          |
| Help         | Contents: 打开在线的帮助文档。                       |
| Help         | About Analog Circuit Optimization: 显示具体的软件名称和版本号。|
---table end---
- Goals Pane
在“Goals Pane”中包含了当前定义对象的信息，提供了具体内容。
---table begin---
Table tile: ""Goals Pane""中的项目及其功能
| 项目       | 功能                                                                                                                                                                                                                                               |
|--------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Name        | 给对象赋予的名称                                                                                                                                                                                                                                      |
| Direction   | 包含以下几个选择:maximize, minimize, match,>=或者<=                                                                                                                                                                                                 |
| Target      | 1）如果 Direction 是 match，那么优化器将会去匹配一个具体的数值或者波形。2）如果 Direction 是 maximize 或者 minimize，那么一个具体的数值或者波形将会决定对象的重要性。3）如果 Direction 是>=，那么一个具体的数值或者波形将会决定下限。4）如果 Direction 是<=，那么一个具体的数值或者波形将会决定上限。 |
| Initial     | 显示由设计变量初始值所计算出的对象表达式的值                                                                                                                                                                                                      |
| Prev        | 显示由上一次循环中设计变量的值所计算出的对象表达式的值                                                                                                                                                                                              |
| Current     | 显示由当前设计变量的值所计算出的对象表达式的值                                                                                                                                                                                                      |
| Enable      | 显示“yes”或者“no”。 “yes”表示这个对象包含在当前优化中，“no”则反之。                                                                                                                                                                                  |
---table end---
- Variables Pane
在“Variables Pane”中包含了当前定义设计变量的信息，具体内容见表 F- 3。
---table begin---
Table tile: ""Variables Pane""中的项目及其功能
| 项目       | 功能                                                                              |
|--------------|-------------------------------------------------------------------------|
| Name        | 给设计变量赋予的名称                                                                       |
| Min         | 设计变量变化的下限                                                                       |
| Max         | 设计变量变化的上限                                                                       |
| Initial     | 设计变量的初始值                                                                         |
| Prev        | 显示上一次循环中设计变量所使用的值                                                               |
| Current     | 显示由当前循环中设计变量所使用的值                                                               |
| Enable      | 显示“yes”或者“no”。 “yes”表示这个设计变量可以在当前优化中进行修改。“no”则反之。           |
---table end---
- Tool Bar
Tool Bar 中包含的按键实现了优化中最重要的功能。按照通常的使用顺序，按键从上至下排列，依次为：
- 添加/编辑对象（Add/Edit Goals）
- 添加/编辑设计变量（Add/Edit Variables）
- 删除（Delete）
- 运行优化器（Run 优化器）
- 停止优化器（Stop 优化器）
- 显示优化历程 (Plot History)
- 更新设计 (Update Design)"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 3 “Optimization”的启动和关闭 __ 4 ""Optimizer""窗口简介 __ 运行一次优化 [desc]
以下内容介绍运行优化的 4 个重要步骤 
## F.5.1. 定义对象
在运行优化设计之前，必须为优化和分析定义一个对象。对象将包含下面几个特征：
- 对象的表达式可以通过仿真来确定一个输出值或者波形。
- 定义对象表达式在优化中变化的方向。 (见表 F- 4)
例如，将共源级放大器的在 1Hz 频率下的增益定位对象，需要给出表达式: 20""/1dBvalueVFOUT。接着需要给出在优化中，为了获得最大的增益，对象的方向为：maximize。
下面介绍几种创建对象的方法。
1. 将仿真输出作为对象：
   1. 在“Optimizer”窗口菜单中选择 “Goals”�“Retrieve Outputs”。然后在 ADE 窗口中定义的输出，将作为对象出现在“Goals Pane”中，这个对象默认是关闭的，即在“Enable”栏中显示“no”。
   2. 选中对象“gain”，此时对象高亮，然后选择“Goals”�“Edit”，对象编辑窗口弹出 (对象编辑窗口的具体内容见 F.5).
   3. 在按照 F.5.1 要求完成对象编辑后，即建立了一个新的对象。
注意：直到编辑了从 ADE 窗口中直接获得的对象，该对象才和 ADE 输出栏中的表达式相关联起来。并且在编辑完该对象后，选择“Goal”�“Retrieve Outputs”将不会对对象造成任何影响。
2. 直接输入一个新的对象或利用“Waveform Calculator”建立一个新的对象:
  1. 选择“Goals”�“Add”，或者点击“Tool Bar”中的“Add”/“Edit Goals”。“Adding Goal”窗口弹出。
  2. 在“Name”栏中填入对象名称
  3. 直接输入新的对象：在“Expression”栏中按照 Cadence® SKILL 语言的表达式规范写入对象的表达式。表达式可以是一个标量，也可以是一个波形完成后直接跳到第 7 步。
  4. 如果利用“Waveform Calculator”建立一个新的对象：点击“Open”按键，此时“Calculator”窗口弹出。
  5. 在“Waveform Calculator”中建立所需要的表达式。
  6. 将光标移回“Optimizer”窗口中的“Expression”栏。
  7. 点击“Get Expression”按键，此时在“Waveform Calculator”中的表达式将在“Expression”栏中出现，作为对象的表达式。
  8. 在“Direction”下拉菜单中，选择对象表达式的值在优化过程中的变化趋势。
  9. 在“Target”栏中按照 Cadence SKILL 语言的表达式规范写入目标的表达式。或将光标移至“Target”栏中，按照 4~6 步的方法从“Waveform Calculator”中获得目标的表达式。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么目标的表达式也要是一个标量。反之，如果对象的表达式是一个波形，那么目标的表达式也要是一个波形。
10. 在“Acceptable”栏填入优化的允许范围。在 F.5.1 中将具体描述优化器是如何利用对象的优化允许范围来决定优化对象优先级的。这里有两种方法来定义这一个值。
可以在“Acceptable”栏中直接填入符合 Cadence SKILL 语言规范的表达式。或者按照 4~6 步的方法从“Waveform Calculator”中获得表达式。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么允许范围的表达式也要是一个标量。如果对象的表达式是一个波形，那么允许范围的表达式可以是一个波形，也可以是一个标量。
- 如果允许范围是一个标量，那么他需要满足表 F- 4 的要求；如果允许范围是一个波形，那么这个波形上的每一点都要满足表 F- 4 的要求。
---table begin---
Table tile: 优化方向和允许值的范围
| 定义的优化方向（Direction） | 优化允许范围值必须满足的要求 |
|-----------------------------|--------------------------------|
| minimize                    | 必须比目标表达式的值大          |
| maximize                    | 必须比目标表达式的值小          |
| match                       | 除了目标表达式以外的任何值。总得对于允许范围是波形的情况，允许范围波形在任何点上都比目标表达式大，或者在任何点上都比目标表达式小 |
| >=                          | 必须比目标表达式的值小          |
| <=                          | 必须比目标表达式的值大          |
---table end---
- 如果选择了“% wihin Target”，可以在“Acceptable”栏中确定一个标量或者波形变化的百分比。一个小的百分比说明这个对象的优先级更高。
注意：如果在第 3、6 步中获得的对象的表达式是一个标量，那么填入的百分比也要是一个标量。如果对象的表达式是一个波形，那么填入的百分比可以是一个波形，也可以是一个标量。
如果使用了一个标量百分比，那么可以保证优化的结果在目标值极大和极小的情况下都保持一致。如果使用了一个波形百分比，则可清晰地表明在对象波形在各段的重要性。# 7.
点击“Get Expression”按键，此时在“Waveform Calculator”中的表达式将在“Expression”栏中出现，作为对象的表达式。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 等级权重的计算 [desc]
目标值作为对象优先级的权重。当优化方向定为“minimize”和“maximize”时，目标值作为各个对象优先级权重的作用更加明显。在这两种情况下，目标值和优化允许范围的值仅仅作为各个对象优先级的权重。相对的，在优化方向为“match”，“>= ”或者 “<=” 时，目标值同时作为对象的优化目标和优先级的权重。
---table begin---
Table tile: 表 F- 6 优化对象 
|对象名称       |优化方向     |目标值      |允许值     |
|-------------|-------------|----------|----------|
| power       | <=          | 50 mW    | 80 mW    |
| delay       | <=          | 50 ns    | 60 ns    |
---table end---
在上述例子中，如果当前状态下，power 的表达式值为 90 mW，那么他的权重是：
90mW/(50mW) - 80mW/(50mW) = 1.333
如果当前状态下，delay 的表达式值为 90 ns，那么他的权重是：
90ns/(50ns) - 60ns/(50ns) = 4
这表明在这种情况下，delay 有更高的权重。因此优化器将优先减小 delay，然后再减小 power。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 准备设计变量 [desc]
在使用优化器进行优化之前，需要指名哪些设计变量可以被优化器在优化过程中改变。这些被选中的设计变量必须是仿真环境变量，例如器件参数和器件的模型参数。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 添加设计变量 [desc]
通过以下步骤，可以在“Optimizer”窗口中添加设计变量：
1. 在菜单栏中选择 “Variables” > “Add”/“Edit” 或者点击 Toolbar 上的 “Add”/“Edit Variables” 按钮。此时，“Editing Variables”窗口将会出现。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 编辑设计变量 [desc]
在“Optimizer”窗口中，有以下步骤可以编辑设计变量：
1. 在窗口中选择需要编辑的设计变量，这个设计变量将会被高亮显示。
2. 选择 “Variables” > “Add”/“Edit” 或者点击 Toolbar 上的 “Add”/“Edit Variables” 按钮，此时，“Editing Variables”窗口将会出现。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除设计变量 [desc]
在“Optimizer”窗口中，有以下步骤可以删除设计变量：
1. 在窗口中选择需要删除的设计变量，这个设计变量将会被高亮显示。
2. 选择“Variables” > “Delete”，或者点击 Toolbar 上的 “Delete” 按钮。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 优化器的控制命令 [desc]
完成对象定义和设定设计变量之后，我们就可以开始使用优化器工作了。以下的章节会介绍如何运行和停止优化，以及如何删除不需要保存的仿真结果。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 运行优化器 [desc]
以下是运行优化器的步骤：
1. 如果上一次的优化因为某些错误而被中断，则需要点击 Toolbar 中的“Stop” 按钮，用以清除已有状态。
2. 在“Optimizer”窗口中选择以下命令的一种进行运行命令。
  * 选择“Optimizer” > “run” 或者点击 Toolbar 上的 “Run” 按钮：从设置的起始值开始运行优化过程，一直到满足停止条件为止。
  * 选择“Optimizer” > “Step”：从最近的停止点开始，运行一轮迭代，然后停止。如果想要从起始值开始，则在选择“Optimizer” > “Step”前先选择“Optimizer” > “Reset”。
  * 选择“Optimizer” > “Run n”：从最近的一个停止点开始，运行 n 轮迭代，这时会出现一个对话框，可以通过拖动滑块来设定 n 的值。
在进行 ""Run n"" 操作选择并开始循环次数的设置后，设计变量的修改完成，如图 F- 28 所示。在所有设置完成后窗口如图 F- 27 所示。开启或者关闭优化对象都在“Optimizer”窗口中做选择设计变量后进行“Variables”�“Enable”或者“Variables”�“Disable”操作后完成。# 5. 新的开始值
在“Minimum Value”中填入设计变量新的下限，优化器永远不会给设计变量设置小于下限的值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 设计变量的上限 [desc]
在“Maximum Value”中填入设计变量新的上限，优化器永远不会给设计变量设置大于上限的值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 启用设计变量 [desc]
如果想在当前优化中包含这个设计变量，请确定“Enable”栏被选中。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 设计变量的修改 [desc]
点击“OK”。此时，到“Optimizer”窗口中的设计变量被修改。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 删除设计变量 [desc]
1. 在“Optimizer”窗口中选择需要删除的设计变量。设计变量选中后将被高亮显示。
2. 选择“Variables” > “Delete”，或者点击“Tool Bar”中的“Delete”按键。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 开启或者关闭优化对象 [desc]
1. 在“Optimizer”窗口中选择需要开启或关闭的设计变量。设计变量选中后将被高亮显示。
2. 选择“Variables” > “Enable”，或者“Variables” > “Disable”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 开启或者关闭优化对象 __ 3 优化器的控制命令 [desc]
备对象定义和制定设计变量后，优化器可以开始优化工作了。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 运行优化器 [desc]
1. 如果上一次的优化因为错误而停止，需要点击“Tool Bar”中的“Stop”按键，来清除已有的状态。
2. 在“Optimizer”窗口中选择下面运行命令的一种。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 停止优化器 [desc]
在“Optimizer”窗口中选择下面停止命令的一种。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 停止优化器 __ 4 显示优化结果 [desc]
最简单的追踪优化器优化进程的方法是显示每一次循环中产生的数据。当优化器获得可接受的结果时，可以将对应设计的参数更新为优化后的值。在下面的章节中将介绍如何设置显示选项，如何显示输出数据，以及如何将设计中的参数更新为优化后的值。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 设置显示选项 [desc]
选择下面至少一种信息包含在需要显示的输出数据中。
如果在显示选项中选中了“Auto Plot After Each Iteration”，那么“Waveform Window”将自动打开，并自动显示每次优化的结果。如果优化结果没有自动显示，可以在优化完成后通过以下的步骤将其显示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 [desc]
通过下面的步骤，将优化后的设计变量拷贝的电路图中。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 保存，修改和读取对话设置信息 [desc]
在“Optimizer”窗口的对话（Session）下拉菜单中，我们可以保存当前对话状态，读取以前保存的对话状态，或者改变优化选项设置，以及清除当前窗口中的所有信息。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 6 保存，修改和读取对话设置信息 __ 2 读取以前保存的对话状态 [desc]
按照以下的步骤读取以前保存的对话状态。
1. 选择“Session” > “Load State”，然后“Loading State”窗口弹出，如图 F- 34 所示。
2. 在“Library”下拉菜单中选择保存需要读取状态的文件库。
3. 在“Cell”下拉菜单中选择保存需要读取状态的单元。
4. 在“State Name”中按照保存时的名称，选择需要读取的状态。
5. 在“What to Load”中选择需要读取的子状态。
6. 点击“OK”完成状态的读取。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 [desc]
通过下面的步骤，将优化后的设计变量拷贝的电路图中。 
1. 在“Optimizer”窗口中选择“Results” > “Update Design”或者点击“Tool bar”中的“Update Design”按键。 
2. 在 ADE 窗口中选择“Variables” > “Copy to Cellview”。 
3. 在 ADE 窗口中选择“Design” > “Check and Save”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 1 保存当前对话状态 [desc]
通过下面的步骤保存当前对话状态（对象，设计变量，显示选项设置，以及优化选项设置）。
1. 选择“Session” > “Save State”，然后“Saving State”窗口弹出，如图 F- 33 所示
2. 如果不想用默认名称，可以在“Save As”栏中填入状态名称。
3. 在“Existing State”栏中选择一个已经存在的状态，此时“Save As”栏中将显示选中的状态名称。子状态将在“What to Save”栏中显示。通过开启和关闭这些子状态，可以决定在保存对话状态时，这些子状态是否被保存。
注意：只有保存了的子状态，才能在下次读取该状态时被恢复。
优化器保存状态的默认路径是：
在这个路径中，“LibraryName”和“CellName”将从被优化的设计中获取。而“StateName”则是保存状态时赋予的状态名称。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 3 保存脚本 [desc]
使用“Open Command Environment for Analysis”（OCEAN）命令，可以实现电路的分析和仿真。OCEAN 是一个基于命令行程序，可以在 Unix 内核的操作系统或者在“Command Interactive Window”（CIW）中运行。通过在交互对话窗口中直接键入 OCEAN 命令，或者在 OCEAN 软件中载入一个包含 OCEAN 命令的脚本，都可以实现电路的分析和仿真。
我们可以在 ADE 窗口，和相关的图形化工具（例如“Parametric Analysis”， “Optimization”）完成仿真和分析的设置，然后把设置内容按照脚本的形式保存下来。并且可以在保存的脚本中加入进一步或者后处理的命令。
通过下面的步骤可以将设置以脚本的形式保存下来。
1. 选择“Session” > “Save Script”，然后“Save Ocean Script”窗口弹出，如图 F- 35 中所示。
2. 在“File Name”栏中填入脚本名称。
3. 点击“OK”完成保存脚本。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 4 改变优化选项设置 [desc]
大多数情况下，都不需要改变优化选项的初始设置。但是，如果想制定一个特定 的 算法，或者需要改变控制算法的选项时，可以按照下面的操作进行。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 5 删除所有设置信息 [desc]
选择“Session”，“Reset”即可以删除所有设置的信息，包括对象、设计变量和显示选项。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 附录 G  Corner Analysis [desc]
“Corner Analysis”（工艺角分析）提供了一种分析电路性能的方便的方法，可以一次性用一组制造工艺的极限偏差参数来仿真电路。利用 Virtuoso®模拟工艺角分析 (Virtuoso® Analog Corners Analysis)，可以将每组工艺偏差参数的仿真结果与可接受的范围进行比较，以确定电路制造出来后可能出现的最大误差。根据误差通过修正电路，保证所有参数值都可以接受。本章讲解使用工艺角分析的详细选项，具体内容如下：
工艺角分析工作的基本方法； 
了解工艺角分析窗口； 
手动运行工艺角分析的实例演示； 
使用工艺、设计和模型文件； 
使用配置文件运行工艺角分析的实例演示。 
另外，本章还总体解释工艺角分析的理论背景，介绍怎样得到帮助以及如何打开Virtuoso®模拟工艺角分析窗口。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 化的最终结果和目标值一致 [desc]
因此，若果在 LSQ 算法中获得最大和最小值，则需要将目标值设置的足够大或者足够小。 
如果“Algorithm Selection”选择的是“Auto”，那么在大多数情况下，优化器选选择 CFSQP 算法。LSQ 算法仅仅在下面两种情况都成立时才使用。
开启对象的优化方向是 match。 
所有开启对象的目标都是波形。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 3) 输入需要改变的优化器控制选项 [desc]
“Percentage Finite Difference Perturbation”：将决定敏感度（见 F.1）是如何决定的。
注意：在一些优化对这个值十分敏感，改变它可能造成算法失效。推荐用户使用默认值。如果用户对步长分析的影响有深刻的理解，在“Percentage Finite Difference Perturbation”栏中提供了设置合适步长的方法。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ “Relative Design Variable Tolerance”的值仅仅影响 LSQ 算法的停止条件 [desc]
对CFSQP 算法没有影响。例如，如果该值被定为：0.05，将使的 LSQ 算法在设计变量的相对变化小于 5%时，停止优化。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ “Relative Function Value Tolerance”的值影响所有算法的停止条件 [desc]
例如，如果该值被定为：0.05，将使得所有算法，在“Optimizer”窗口中所有表达式的相对变化小于 5%时，停止优化。 
注意：当“Relative Design Variable Tolerance”和“Relative Function Value Tolerance”栏中填入数据后，优化器将使用用户定义的条件作为优化的停止条件，而不再继续使用默认值。此外，在这两栏中必须填入绝对数字。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 更新设计 __ 4) 设置“Warning Message for Long Simulation” [desc]
在优化的初始仿真运行时，“Optimization”工具和 ADE 窗口被锁死，此时不能中断优化以及观察输出结果。如果希望在一个长时间的优化完成后被提醒，只需要将“Warning Message for Long Simulation”选中。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 工艺角分析如何工作 [desc]
工艺角分析关注的是当工艺偏差参数达到极限时(称为“Corner”，或工作角)，或者温度、电压等参数达到极限时的电路性能。有了这些信息可以确定在工艺参数有随机偏差时，甚至是最不希望出现的偏差的组合方式下，电路的性能是否满足规格要求。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 1 工艺角分析如何工作 __ 1 打开和关闭工艺角分析窗口 [desc]
要准备使用工艺角分析，需要：
1) 电路采用普通的设计参数值，并可以仿真； 
2) 在 Virtuoso ADE (Analog Design Environment)窗口中根据分析类型设置一个仿真任务； 
3) 保证电路中所有的设计变量都设置了初始值； 
4) 在 ADE 窗口中选择“Tools”，“Corners”选项。
图 G- 1 打开和关闭工艺角分析窗口 
如果已经按照前文定义了自动载入的定制文件，工艺角分析窗口就会出现。要关闭工艺角分析窗口，则选择“File”，“Close”。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 [desc]
如图 G- 2 所示，Virtuoso®工艺角仿真分析窗口分为几个区域，用来设置工艺角和分析的输出。
图 G- 2 工艺角分析窗口 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 1 菜单 [desc]
菜单如图 G- 3 所示，相应的选项和功能在表 G- 1 中给出。
---table begin---
Table tile:功能在表 G- 1 中给出
| 器件型号      | 封装       | 封装尺寸(标称值) |
|:-------------:|:----------:|:----------------:|
|   Add Corner  | 在已有的工艺角的右边添加新的可编辑列 |
|  Add Variable | 点击添加新的变量（行）于现有变量列表下方 |
|  Copy Corner  | 复制选择的工艺角（列）到最右边 |
|    Delete     | 删除选定的工艺角（列）或者变量 |
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 2 设置工艺角分析 [desc]
打开工艺角分析的窗口是如图 G- 10 所示的空窗口的形式，此时可按下列方法进行工艺角分析的手动设置。
图 G- 10 工艺角分析的设定 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） [desc]
如果被选定的是被禁用的工艺角，则该按钮会变为使能（Enable）。点击启用选定的工艺角。
Run/Stop没有仿真运行的时候显示为运行（Run），点击对所有没有禁用的工艺角运行分析；分析运行过程中该按钮显示为停止（Stop），点击停止正在运行的分析。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 输出设置界面—“Performance Measurement” [desc]
输出界面位于工艺角的分析窗口的下半部，显示的是当前定义的输出信息。
这个界面的信息一般是从.cdsinit 文件中用 loadDcf 命令定义的设计定制文件（Design Customization Files，DCF）读取的。另外，在第一次打开工艺角分析窗口的时候，ADE 中定义的输出都会自动导入到该界面中；使用 Calculator 也可以得到一个输出表达式。
点击“Add Measurement”—添加输出按钮可以添加一个输出。如果要改变输出方式，可以通过修改本界面中的内容实现。通过点击输出界面中的任何一列都可以选择所在列的输出。
剪切、复制、粘贴快捷键在表格中都可以使用，可以利用它们对输出表达式进行编辑。
输出界面中的各项目的功能描述如表 G- 3。
---table begin---
Table title: 表 G- 3 输出界面中的各项目的功能
| 项目          | 功能描述      | 
|--------------|------------|
| Measurement 列 | 点击选定输出的“Measurement”列，修改这个输出的名字。该名字在出图的时候用来标明输出系列。 
| Expression 列 | 点击选定输出的“Expression”列，修改该输出的表达式。 
| Target  列  | 点击选定输出的“Target”列可以该输出的理想值。这个值只有在余量分析（residual plot）的时候需要。 
| Lower 列 | 点击选定输出的“Target”列可以该输出的下限。这个值只有在余量分析的时候需要。 
---table end---"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 设置工艺角分析 [desc]
打开工艺角分析的窗口是如图 G- 10 所示的空窗口的形式，此时可按下列方法进行工艺角分析的手动设置。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 建立一个工艺使用的工艺叫配置 [desc]
1) 在菜单中选择“Setup”���“Add Process…”；
3) 选择“Apply”，就加入了一组工艺角；
4) 重复上面 3 项操作可添加多组工艺角；
5) 全部结束后点击 Cancel 退出；
6) 如果点击 OK，会添加最后一组工艺角并关闭对话框。
注意：有的工艺中，多个工艺角组有固定的添加顺序，这些顺序决定于模型的相互引用顺序。所以添加工艺角组的时候应当参照 ADE 当中模型设置(Model Setup)对话框中的模型添加顺序。
例如，在 Group Name 栏输入 MOS；在 Variants 栏中输入 tt ss sf ff fs，也就是 5 个工艺角的名称，中间用空格隔开；点击 Apply 键，这一组工艺角就添加到了工艺角的分析界面中。
将 Group Name 栏改为 RES；在 Variants 栏中输入 restypical resfast resslow；然后点击 Apply，这时 RES 的工艺角组就添加到了界面中；
点击 Cancel 退出刚才的对话框，界面中多了 2 行，分别表示 2 组工艺角的选项。这样，就可以对不同的 MOS 管和电阻的工艺角进行仿真。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 添加工艺角 [desc]
上面定义了工艺角的组，下面要设定需要仿真的工艺角，主要有以下几个： "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 1 建立新的工艺角 [desc]
1） 从菜单选择“Edit”���“Corner Definition”���“Add Corner”，或者点击按钮“Add Corner”；
2） 在弹出的对话框中输入工艺角的名字；
3） 再在表格中对其他栏进行编辑。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 2 复制并修改已有的工艺角 [desc]
1） 首先选定一个工艺角；
2） 从菜单选择“Edit”���“Corner Definition”���“Copy Corner” 或者点击按钮“Copy Corners”；
3） 在弹出的对话框中输入工艺角的名字；
4） 然后再在表格中对其他栏进行编辑。
注意：在“IC 5.1.41”中工艺角分析中有一个 bug，工艺角的名字不能带有数字，否则在仿真中会报语法错误。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 3 使能工艺角 [desc]
1） 选定一个禁用的工艺角；
2） 选择“Edit”���“Corner Definition”���“Enable Corner”或“Enable”按钮。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 4 禁用工艺角 [desc]
1） 选择一个没有被禁用的工艺角；
2） 选择“Edit”���“Corner Definition”���“Disable Corner”或“Disable”按钮。
注意：PCF 中载入的工艺角不能禁用。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 5 加入新设计变量 [desc]
有三类变量：组变量、工艺变量和设计变量。这里介绍的是用界面添加设计变量。# 7. 删除设计变量
- 选定需要删除；
- 然后在菜单中选择“Edit”�“CornerDefinition”�“Delete Selected”或者点击“Delete”按钮，选定的列就会从界面上消失。
注：PCF 中载入的工艺角和变量是不能删除的。 
在所有工艺角都设置完成之后界面如图 G- 16 所示。"
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 设置输出 [desc]
输出设置主要有以下几种操作 
## 1.通过直接输入建立一个新的输出 
- 选定“Edit”�“Performance Measurements”�“Add Measuments” 或点击“Add Measurement”按钮；
- 在对话框中输出新输出的名字并点击确定；
- 在“Expression”—表达式栏输入需要的输出表达式；
- （可选）如果表达式的输出结果是标量，且需要将结果画成余量图(Residual Plot)的形式，还要输入“Target”—目标值、“Lower”—下限和“Upper”—上限这三栏。
## 2.用 Calculator 建立新的输出
- 选定“Edit”�“Performance Measurements”�“Add Measuments” 或点击“Add Measurement”按钮；
- 在对话框中输出新输出的名字并点击确定；
- 选定菜单“Tools”�“Calculator”或者点击“Calculator”按钮；
- 利用 Calculator 建立需要的表达式，详见 Calculator 的章节；
- 在工作角分析窗口将输入光标定在需要修改的输出的“Expression”栏；
- 点击“Get Expression”按钮或者选择菜单中的“Tools”�“Get Expression”，Calculator中的表达式就会被截取过来；
- （可选）如果表达式的输出结果是标量，且需要将结果画成余量图(Residual Plot)的形式，还要输入“Target”—目标值、“Lower”—下限和“Upper”—上限这三栏。
## 3.删除输出
- 选定一个输出；
- 选择菜单中的“Edit”�“Performance Measurement”�“Delete Measurement”或者点击按钮“Delete Measurement”
采用上面列出的方法，建立了 2 个输出，也就是 Vout，表达式为 dB20(VF(“/Vout”))；另一个是 PM，表示相位裕度，表达式为 phaseMargin(VF(“/Vout”))。结果如图 G- 17 所示。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 控制工艺角分析的运行 [desc]
在运行工艺角分析之前，可以有这些选项：
- 禁用不想运行的工艺角；
- 选择每个输出是采用文本还是用图输出。可以利用“Plot”和“Print”复选框控制。
- 全部设置完毕，点击按钮“Run”或者菜单“Simulation”�“Run”运行分析；
- 分析过程中，还可以点击“Stop”或者菜单“Simulation”�“Stop”停止分析；
注：“Run”和“Stop”按钮按照是否有仿真运行自动切换。 "
"[desc] 模拟集成电路设计与仿真_何乐年 __ 2 工艺角分析用户界面 __ 真的时候不会被分析。） __ 控制工艺角分析的输出 [desc]
仿真成功后结果会按照之前的选项绘图或者输出文字结果。
## 1.输出仿真结果
如果要定义不同的输出，可以重新定义输出的表达式然后选择“Tools”�“Plot or Print Output”或者“Plot# 2.2. 
如果是手动输入的工艺角配置或不想覆盖元配置文件，可以选择“File”�“Save Setup As..”—另存配置。下次使用 Corner Analysis 的时候就可以调用以前的配置了。“Save As”窗口如图 G- 22 所示。"
